/// Copyright Erik Weitnauer 2014.
(function(){gmath={expressions:{}};gmath.version="0.1.3x";(function(){var t=4294967296,e=15,i=[];str=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(){var r=0;var n=Math.random()*t;i[r++]=str[n&e];i[r++]=str[n>>>4&e];i[r++]=str[n>>>8&e];i[r++]=str[n>>>12&e];i[r++]=str[n>>>16&e];i[r++]=str[n>>>20&e];i[r++]=str[n>>>24&e];i[r++]=str[n>>>28&e];n=Math.random()*t;i[r++]=str[n&e];i[r++]=str[n>>>4&e];i[r++]=str[n>>>8&e];i[r++]=str[n>>>12&e];i[r++]=str[n>>>16&e];i[r++]=str[n>>>20&e];i[r++]=str[n>>>24&e];i[r++]=str[n>>>28&e];return"_"+i.join("")}gmath.uid=r})();gmath.inherit=function(t,e){var i=e.prototype;e.prototype=Object.create(t.prototype);for(var r in i){e.prototype[r]=i[r]}e.prototype.constructor=e;Object.defineProperty(e.prototype,"constructor",{enumerable:false,value:e})};gmath.object={};gmath.object.extend=function(t,e){if(typeof e==="object")for(var i in e)t[i]=e[i];return t};gmath.object.merged=function(t,e){return gmath.object.extend(gmath.object.extend({},t),e)};gmath.extend=gmath.object.extend;gmath.deepCopy=function(t){var e=t;if(Array.isArray(t)){e=[];for(var i=0;i<t.length;i++)e[i]=gmath.deepCopy(t[i])}else if(typeof t==="object"){e={};for(var r in t)if(t.hasOwnProperty(r))e[r]=gmath.deepCopy(t[r])}return e};gmath.array={};gmath.array.containsAll=function(t,e){if(e.length>t.length)return false;for(var i=0;i<e.length;i++)if(t.indexOf(e[i])===-1)return false;return true};gmath.array.equals=function(t,e){if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return false;return true};gmath.array.isPermutation=function(t,e){if(e.length!==t.length)return false;for(var i=0;i<e.length;i++){var r=t.indexOf(e[i]);if(r===-1)return false;else t[r]=undefined}return true};gmath.array.mergedNew=function(t,e){var i=t.slice();for(var r=0;r<e.length;r++)if(t.indexOf(e[r])===-1)i.push(e[r]);return i};gmath.array.xor=function(t,e){var i=[];for(var r=0;r<t.length;r++)if(e.indexOf(t[r])===-1)i.push(t[r]);for(var r=0;r<e.length;r++)if(t.indexOf(e[r])===-1)i.push(e[r]);return i};gmath.array.flatten=function(t){var e=[];for(var i=0;i<t.length;i++)e=e.concat(t[i]);return e};gmath.getURLParameter=function(t){var e=RegExp(t+"="+"(.+?)(&|$)").exec(location.search);return e?decodeURIComponent(e[1]):null};if(typeof Object.create!=="function"){Object.create=function(t){function e(){}e.prototype=t;return new e}}if(!Array.isArray){Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}}var t={version:"1.3.1"};if(typeof exports!="undefined"){exports.Tree=t}t.parse=function(e){var i=new t.Node;var r=i.append(new t.Node);var n;r.value="";for(n=0;n<e.length;n++){var o=e[n];if(o=="["){r=r.append(new t.Node);r.value=""}else if(o=="]"){r=r.parent;if(r===i)throw"parse error"}else if(o==","){r=r.parent.append(new t.Node);r.value=""}else{r.value+=o}}for(n=0;n<i.children.length;n++)i.children[n].parent=null;if(i.children.length===1)return i.children[0];return i.children};t.stringify=function(t){var e=function(t){var i="";if("value"in t)i+=t.value;if(t.children&&t.children[0]){i+="["+t.children.map(e).join(",")+"]"}return i};if(!Array.isArray(t))t=[t];return t.map(e).join(",")};(function(){var e=4294967296,i=15,r=[],n=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function o(){var t=0;var o=Math.random()*e;r[t++]=n[o&i];r[t++]=n[o>>>4&i];r[t++]=n[o>>>8&i];r[t++]=n[o>>>12&i];r[t++]=n[o>>>16&i];r[t++]=n[o>>>20&i];r[t++]=n[o>>>24&i];r[t++]=n[o>>>28&i];o=Math.random()*e;r[t++]=n[o&i];r[t++]=n[o>>>4&i];r[t++]=n[o>>>8&i];r[t++]=n[o>>>12&i];r[t++]=n[o>>>16&i];r[t++]=n[o>>>20&i];r[t++]=n[o>>>24&i];r[t++]=n[o>>>28&i];return"_"+r.join("")}t.uid=o})();t.clone=function(e,i,r){var n=function(e){var o;var s=new e.constructor;if(r){for(o=0;o<r.length;o++)s[r[o]]=e[r[o]]}else{for(var a in e){if(a[0]!=="_")s[a]=e[a]}}delete s.ls;delete s.rs;delete s.parent;if(e.id&&!i)s.id=t.uid();if(e.children){s.children=[];for(o=0;o<e.children.length;o++){s.children.push(n(e.children[o]));s.children[o].parent=s}for(o=0;o<e.children.length;o++){s.children[o].ls=s.children[o-1];s.children[o].rs=s.children[o+1]}}return s};if(!Array.isArray(e))return n(e);var o=e.map(n);if(e.length>1)for(var s=0;s<e.length;s++){if(s>0&&e[s].ls===e[s-1])o[s].ls=o[s-1];if(s<e.length-1&&e[s].rs===e[s+1])o[s].rs=o[s+1]}return o};t.get_mapping_between=function(t,e){var i={};function r(t,e){if(t.id in i)throw"duplicate id in source tree";i[t.id]=[e];if(t.children.length!==e.children.length){if(!t.has_children())i[t.id]=e.select_all();else if(!e.has_children())t.for_each(function(t){i[t.id]=[e]});else throw"tree structures don't match"}else{for(var n=0;n<t.children.length;n++)r(t.children[n],e.children[n])}}if(Array.isArray(t)){if(t.length!==e.length)throw"tree structures don't match";for(var n=0;n<t.length;n++)r(t[n],e[n])}else r(t,e);return i};t.get_1to1_mapping_between=function(t,e,i){var r={};if(arguments.length<3)i=true;function n(t,e){if(i&&t.id in r)throw"duplicate id in source tree";r[t.id]=[e];if(i&&t.children.length!==e.children.length)throw"tree structures don't match";var o=t.children.length,s=e.children.length;for(var a=0;a<o;a++){if(a<s)n(t.children[a],e.children[a]);else t.children[a].for_each(function(t){r[t.id]=[]})}}if(Array.isArray(t)){if(i&&t.length!==e.length)throw"tree structures don't match";var o=t.length,s=e.length;for(var a=0;a<o;a++){if(a<s)n(t[a],e[a]);else t[a].for_each(function(t){r[t.id]=[]})}}else n(t,e);return r};t.nodes_to_range=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0]];var r=e[0];while(r.parent)r=r.parent;var n=e.map(function(e){return t.get_path(e)});var o=function(t){var e=n[0][t];for(var i=0;i<n.length;i++){if(n[i].length<=t+1)return false;if(n[i][t]!==e)return false}return true};var s=0;while(o(s))s++;var a=t.get_child(n[0].slice(0,s),r);var h=-1,l=a.children.length,u;for(u=0;u<i;u++){var c=t.get_child(n[u].slice(0,s+1),r);var d=a.children.indexOf(c);if(d>h)h=d;if(d<l)l=d}var p=[];for(u=l;u<=h;u++)p.push(a.children[u]);return p};t.insert=function(t,e,i){i.ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i;i.rs=t.children[e];if(t.children[e])t.children[e].ls=i;i.parent=t;t.children.splice(e,0,i);return i};t.insert_range=function(t,e,i){var r=i.length;if(r===0)return;i[0].ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i[0];i[r-1].rs=t.children[e];if(t.children[e])t.children[e].ls=i[r-1];for(var n=0;n<r;n++)i[n].parent=t;t.children=t.children.slice(0,e).concat(i,t.children.slice(e));return i};t.append_range=function(t,e){var i=e.length;if(i===0)return;var r=t.children[t.children.length-1];if(r)r.rs=e[0];e[0].ls=r;e[i-1].rs=null;for(var n=0;n<i;n++)e[n].parent=t;t.children=t.children.concat(e);return e};t.filterRange=function(t,e){var i=[];var r=Array.isArray(e)?e:[e];var n=function(e,r){var o=[];for(var s=r;s<e.length;s++){o.push(e[s]);if(t(o))i.push(o.slice())}if(e[r].children)for(var s=0;s<e[r].children.length;s++)n(e[r].children,s)};for(var o=0;o<r.length;o++)n(r,o);return i};t.append=function(t,e){var i=t.children[t.children.length-1];if(i)i.rs=e;e.ls=i;e.rs=null;e.parent=t;t.children.push(e);return e};t.remove=function(t){var e;var i=t.parent.children;e=i.indexOf(t);if(i[e-1])i[e-1].rs=t.rs;if(i[e+1])i[e+1].ls=t.ls;i.splice(e,1);return e};t.remove_range=function(t){var e=t.length;if(e===0)return;var i=t[0].parent.children;var r=i.indexOf(t[0]);if(i[r-1])i[r-1].rs=t[e-1].rs;if(i[r+e])i[r+e].ls=t[0].ls;i.splice(r,e);return r};t.replace=function(e,i){if(i.parent)t.remove(i);var r=t.remove(e);return t.insert(e.parent,r,i)};t.switch_siblings=function(t,e){if(t.parent!=e.parent)throw"Called switch_siblings on nodes that are no siblings!";var i=t.parent;var r=i.children.indexOf(t);var n=i.children.indexOf(e);i.children[r]=e;i.children[n]=t;var o;if(t.rs==e){if(t.ls)t.ls.rs=e;if(e.rs)e.rs.ls=t;t.rs=e.rs;e.ls=t.ls;t.ls=e;e.rs=t}else if(t.ls==e){if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;t.ls=e.ls;e.rs=t.rs;t.rs=e;e.ls=t}else{if(t.ls)t.ls.rs=e;if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;if(e.rs)e.rs.ls=t;o=t.ls;t.ls=e.ls;e.ls=o;o=t.rs;t.rs=e.rs;e.rs=o}};t.validate=function(t){var e=function(t,i){if(t.parent!=i)throw"wrong parent information";if(t.children){for(var r=0;r<t.children.length;r++){var n=t.children[r];if(n.ls!=t.children[r-1])throw"wrong ls information";if(n.rs!=t.children[r+1])throw"wrong rs information";e(n,t)}}};if(!Array.isArray(t))t=[t];for(var i=0;i<t.length;i++)e(t[i],null)};t.get_child=function(t,e){for(var i=0;i<t.length;i++){if(!e.children||e.children.length<=t[i])throw"invalid path";e=e.children[t[i]]}return e};t.get_parent=function(t,e){for(var i=0;i<t;i++){if(e.parent)e=e.parent;else throw"invalid path"}return e};t.get_path=function(t){var e=[];while(t.parent){e.unshift(t.parent.children.indexOf(t));t=t.parent}return e};t.for_each=function(t,e){var i=Array.isArray(e)?e:[e];var r=function(e){t(e);if(e.children)for(var i=0;i<e.children.length;i++)r(e.children[i])};for(var n=0;n<i.length;n++)r(i[n])};t.map=function(t,e){var i=Array.isArray(e)?e:[e];var r=[];var n=function(e){r.push(t(e));if(e.children)for(var i=0;i<e.children.length;i++)n(e.children[i])};for(var o=0;o<i.length;o++)n(i[o]);return r};t.filter=function(t,e){var i=[];var r=Array.isArray(e)?e:[e];var n=function(e){if(t(e))i.push(e);if(e.children)for(var r=0;r<e.children.length;r++)n(e.children[r])};for(var o=0;o<r.length;o++)n(r[o]);return i};t.select_all=function(e){return t.filter(function(){return true},e)};t.select_first=function(t,e){var i=function(e){var i=e;for(;;){if(t(i))return i;if(i.children&&i.children[0]){i=i.children[0];continue}if(i===e)return null;while(!i.rs){i=i.parent;if(i===e)return null}i=i.rs}};var r=Array.isArray(e)?e:[e];for(var n=0;n<r.length;n++){var o=i(r[n]);if(o)return o}return null};t.get_cca=function(e){var i=e.map(function(e){return t.get_path(e)});var r=function(t){var e=i[0][t];for(var r=0;r<i.length;r++){if(i[r].length<=t+1)return false;if(i[r][t]!==e)return false}return true};var n=0;while(r(n))n++;var o=i[0].length-n,s=e[0];for(var a=0;a<o;a++)s=s.parent;return s};t.get_leaf_nodes=function(e){return t.filter(function(t){return!(t.children&&t.children.length)},e)};t.is_root=function(t){return!t.parent};t.is_range=function(t){for(var e=1;e<t.length;e++){if(t[e-1].rs!==t[e])return false}return true};t.get_root=function(t){while(t.parent)t=t.parent;return t};t.get_by_value=function(e,i){return t.filter(function(t){return t.value===e},i)};t.get_by_id=function(e,i){return t.select_first(function(t){return t.id===e},i)};t.Node=function(){this.children=[];this.parent=null;this.ls=null;this.rs=null;this.id=t.uid()};t.Node.prototype.stringify=function(){return t.stringify(this)};t.Node.prototype.clone=function(e,i){return t.clone(this,e,i)};t.Node.prototype.get_mapping_to=function(e){return t.get_mapping_between(this,e)};t.Node.prototype.get_1to1_mapping_to=function(e,i){return t.get_1to1_mapping_between(this,e,i)};t.Node.prototype.insert=function(e,i){return t.insert(this,e,i)};t.Node.prototype.insert_range=function(e,i){return t.insert_range(this,e,i)};t.Node.prototype.append_range=function(e){return t.append_range(this,e)};t.Node.prototype.append=function(e){return t.append(this,e)};t.Node.prototype.remove=function(){return t.remove(this)};t.Node.prototype.remove_range=function(e){return t.remove_range(e)};t.Node.prototype.replace_with=function(e){return t.replace(this,e)};t.Node.prototype.switch_with_sibling=function(e){return t.switch_siblings(this,e)};t.Node.prototype.validate=function(){return t.validate(this)};t.Node.prototype.get_child=function(e){return t.get_child(e,this)};t.Node.prototype.get_parent=function(e){return t.get_parent(e,this)};t.Node.prototype.get_path=function(){return t.get_path(this)};t.Node.prototype.for_each=function(e){return t.for_each(e,this)};t.Node.prototype.map=function(e){return t.map(e,this)};t.Node.prototype.filter=function(e){return t.filter(e,this)};t.Node.prototype.filterRange=function(e){return t.filterRange(e,this)};t.Node.prototype.select_all=function(){return t.select_all(this)};t.Node.prototype.select_first=function(e){return t.select_first(e,this)};t.Node.prototype.get_leaf_nodes=function(){return t.get_leaf_nodes(this)};t.Node.prototype.is_root=function(){return t.is_root(this)};t.Node.prototype.get_root=function(){return t.get_root(this)};t.Node.prototype.get_by_value=function(e){return t.get_by_value(e,this)};t.Node.prototype.get_by_id=function(e){return t.get_by_id(e,this)};t.Node.prototype.has_children=function(){return this.children&&this.children.length>0};var e=function(t){var e=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)");var i=new RegExp("^\\s*([a-zA-Z])");var r=new RegExp('^\\s*"([^"]+)"');var n=new RegExp("^\\s*(\\*\\*|[-\\–+*/=();,^{}_])");var o=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)");var s=new RegExp("^(\\s+)");var a=[];var h=0;if(t){h=t.length}for(var l=0;l<h;){var u=t.substr(l);var c;if(c=e.exec(u)){a.push({type:"number",value:parseFloat(c[1]),from:l+(c[0].length-c[1].length),to:l+c[0].length});l+=c[0].length}else if(c=i.exec(u)){a.push({type:"name",value:c[1],from:l+(c[0].length-c[1].length),to:l+c[0].length});l+=c[0].length}else if(c=r.exec(u)){a.push({type:"name",value:c[1],from:l+(c[0].length-c[1].length),to:l+c[0].length});l+=c[0].length}else if(c=n.exec(u)){a.push({type:"operator",value:c[1],from:l+(c[0].length-c[1].length),to:l+c[0].length});l+=c[0].length}else if(c=o.exec(u)){a.push({type:"latex",value:c[1],from:l+(c[0].length-c[1].length),to:l+c[0].length});l+=c[0].length}else if(c=s.exec(u)){l+=c[0].length}else{throw"can't tokenize '"+u+"'"}}return a};var i=function(e,n){t.Node.call(this);if(!i.defaultParser)i.defaultParser=r(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","param"]);this.id=gmath.uid();this.events=d3.dispatch("create","change","mistake","end-of-interaction","node-changed");this.options=gmath.extend({hide_mult_op:true,hide_leading_op:true,parser:i.defaultParser,no_history:true,auto_simplify_distributions:true},n);this.hide_rules=[];this.watchedAspects=[];this.parser=this.options.parser;this.init_hide_rules();this.parseAndSet(e)};gmath.inherit(t.Node,i);gmath.AlgebraModel=i;i.prototype.clone=function(e){var r=new i(null,this.options);r.hide_rules=this.hide_rules.slice();t.append(r,t.clone(this.children[0],e,["id","value","bp","associative","commutative",,"selected","dragging","fixed","hidden","simplify","deleted","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]));return r};i.prototype.move_actions=[];if(typeof exports!=="undefined")exports.AlgebraModel=i;i.is_top_most=function(t){return!t.parent||t.parent instanceof i};i.prototype.init_hide_rules=function(){for(var t=0;t<this.parser.symbols.length;t++){var e=gmath.expressions[this.parser.symbols[t]];if(e.hide_rule)this.hide_rules.push(e.hide_rule)}};i.prototype.parseAndSet=function(e,r){this.children=[];var n=this.parser.parse(e);if(!n)return false;t.append(this,n);if(!r)this.remove_brackets();this.hide_nodes();this.events.change(new i.ChangeEvent(this));return true};i.prototype.parse=function(t,e){var i=this.parser.parse(t);if(!i)return null;if(!e)this.remove_brackets([i]);return i};i.prototype.to_ascii=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_ascii()}).join("")};i.prototype.to_latex=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_latex()}).join("")};i.select_range_by_value=function(t,e){return function(r){if(!r[0].parent)return false;if(r[0].parent.parent&&i.range_contains_all_siblings(r))return false;return i.rangeToAscii(r)===t||i.rangeToAsciiNoLeadingOp(r,e)===t||r.length===1&&i.fractionToAscii(r[0])===t}};i.rangeToAscii=function(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")};i.isLeadingCommutativeOp=function(t){return t.is_group()&&t.commutative&&t.associative};i.rangeToAsciiNoLeadingOp=function(t,e){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var r=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1&&!e)return r;if(i.isLeadingCommutativeOp(t[0]))return r.substring(t[0].children[0].to_ascii().length);return r};i.fractionToAscii=function(t){if(!t.is_group("fraction"))return"";var e=t.to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e};i.range_contains_all_siblings=function(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length};i.select_node_by_value=function(t){return function(e){return!e.is_root()&&!e.hidden&&e.to_ascii()===t}};i.getRanges=function(e,r,n){var o=t.filterRange(i.select_range_by_value(e),n);return typeof r==="number"?o[r]:o};i.prototype.getRanges=function(t,e,r){return i.getRanges(t,e,r||this.children)};i.getNodes=function(e,r,n){var o=t.filter(i.select_node_by_value(e,true),n);return typeof r==="number"?o[r]:o};i.prototype.getNodes=function(t,e,r){return i.getNodes(t,e,r||this.children)};i.prototype.replace_with=function(t){var e=this.children[0].get_1to1_mapping_to(t.children[0],false);this.events.change(new i.ChangeEvent(this,t,e))};i.ChangeEvent=function(t,e,i,r){this.type="change";this.old_model=t;this.new_model=e||t;this.node_map=i||[];this.action=r};i.prototype.created=function(t,e){this.events.create({type:"create",term:t&&t.newTree&&t.newTree.to_ascii(),action:t,sender_id:e||this.id})};i.prototype.finishInteraction=function(){var t=this.children[0].filter(function(t){return t.simplify}),e=this.options.auto_simplify_distributions,i=gmath.actions.PostInteractionSimplificationAction.createBoundAction(this,{nodes:t,simplify_distributions:e}),r=this;if(i.run()){r=i.newTree;i.newTree.hide_nodes();this.created(i)}t.forEach(function(t){t.simplify=false});this.events["end-of-interaction"]({type:"end-of-interaction",mathObject:r})};i.prototype.root=function(){return this.children[0]};i.prototype.is_group=function(){return false};i.prototype.is_leading_num_in_sub_product=function(t){var e=t.parent;if(t instanceof n&&e.is_group("mul")&&!e.ls&&e.parent.is_group("product")&&e.parent.parent.is_group("sub"))return e.parent.parent;else return false};i.prototype.numeric_value=function(e,r){var o=e;var s=e.parent,a;if(e instanceof n&&s&&(s.is_group("sign")||s.is_group("add")||s.is_group("sub")))e=s;a=n.get_value(e);if(isNaN(a))return NaN;var h=this.is_leading_num_in_sub_product(e);if(h)a=-a;if(arguments.length<2)return a;var l=a>0||a===0&&(e instanceof n||e.is_group("add"));var c=r>0||r===0&&(e instanceof n||e.is_group("add"));if(l&&!c){if(e.is_group("add")){e.invert();this.hide_nodes()}else{var d=t.remove(e);var p=new u(e);p.children[0].no_anim=true;t.insert(s,d,p);p.selected=e.selected;e=p}}else if(!l&&c){if(e.is_group("sign")){var f=e.children[1];t.replace(e,f);e.children[0].no_anim=true;f.selected=e.selected;e=f}else if(e.is_group("sub")){e.invert();this.hide_nodes()}else if(h){h.invert();this.hide_nodes()}}else if(this.f_eqls(a,r))return e;if(e.is_group())e.children[1].value=Math.abs(r);else e.value=Math.abs(r);var g=this.children[0].get_mapping_to(this.children[0]);g[o.id]=[e];this.events.change(new i.ChangeEvent(this,this,g));return e};i.prototype.f_eqls=function(t,e){return Math.abs(t-e)<1e-6};i.prototype.remove_brackets=function(e){t.for_each(function(t){if(t.is_group("fraction")&&t.parent.is_group("brackets"))l.handle(t.parent,true)},e||this.children)};i.prototype.process_operator=function(t,e){if(t.fixed){if(e)e(false);return false}if(!t.getBestMatchingAction&&t.parent)t=t.parent;if(!t.getBestMatchingAction){if(e)e(false);return false}var i=t.getBestMatchingAction();var r=i?i.createBoundAction(this,{actor:t}):null;this.performAction(r,e);return r};i.prototype.performAction=function(t,e,r){if(t&&t.makes_no_changes){t.doInPlace();return this}if(typeof r==="undefined")r=this.options.no_history;var n=this;var o=function(t){if(!t){n.events.mistake(n);if(e)e(false);return}if(r){n.hide_nodes();n.events.change(new i.ChangeEvent(n,n,t.node_map,t))}else{t.newTree.hide_nodes();n.created(t)}if(e)e(t.newTree)};if(!t){o();return null}if(r)t.doInPlace(o);else t.run(o);return t.newTree};i.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)};i.prototype.performSplitAction=function(t){var e=new W;e.split(this,t||this.children)};i.prototype.getMoveActions=function(t){if(t.length===0)return[];if(t.some(function(t){return t.fixed}))return[];var e=[];for(var i=0;i<this.move_actions.length;i++){e=e.concat(this.move_actions[i].getAllAvailableActions(t))}return e};i.groupNodeRanges=function(t){var e=[];var i=[t[0]];e.push(i);for(var r=1;r<t.length;r++){if(t[r-1].rs===t[r]){i.push(t[r])}else{i=[t[r]];e.push(i)}}return e};i.prototype.make_flat=function(){var e=t.get_leaf_nodes(this);var r=new a("flat",0);r.commutative=true;e.forEach(function(e){if(e.hidden)return;e.commutative=true;e.associative=true;t.append(r,e)});this.children=[];t.append(this,r);this.events.change(new i.ChangeEvent)};var r=function(t){var i={};var r;var n;var o;var s;var a=function(){return this};var h=function(t,e){e=e||this;e.name="SyntaxError";e.message=t;throw e};var l=function(){this.def={}};l.prototype.find_or_define=function(t){var e=this.def[t.value];if(!e||typeof e=="function")e=i[t.value];if(e&&typeof e!=="function")return e;e=Object.create(i["(name)"]);e.lpb=0;this.def[t.value]=e;return e};var u=function(t,e){var a,l,u,c;if(t&&r.id!==t){if(e)return;else h("Expected '"+t+"'.",r)}if(o>=n.length){r=i["(end)"];return}u=n[o];o+=1;c=u.value;a=u.type;if(a==="name"){l=s.find_or_define(u)}else if(a==="operator"){l=i[c];if(!l){h("Unknown operator.",u)}}else if(a==="latex"){l=i[c];if(!l){h("Unknown latex command.",u)}}else if(a==="string"||a==="number"){l=i["(number)"];a="number"}else{h("Unexpected token.",u)}r=Object.create(l);r.from=u.from;r.to=u.to;r.value=c;r.type=a;return r};var c=function(t){o--;r=t};var d=function(t,e){var i;var n=e||r;if(!e)u();i=n.nud();while(t<r.lbp){n=r;u();i=n.led(i)}return i};var p={nud:function(){h("Undefined.",this)},led:function(t){h("Missing operator.",this)}};var f=function(t,e){var r=i[t];e=e||0;if(r){if(e>r.lbp){r.lbp=e}}else{r=Object.create(p);r.id=r.value=t;r.lbp=e;i[t]=r}return r};f("(end)");var g=function(t){n=e(t);if(n.length==0)return null;s=new l;o=0;u();var i=d(0);u("(end)");return i};var v={};v.parse=g;v.parseExpression=d;v.advance=u;v.regress=c;v.registerSymbol=f;v.symbols=t;for(var m=0;m<t.length;m++){var _=gmath.expressions[t[m]];if(_&&_.registerAtParser)_.registerAtParser(v)}return v};gmath.AlgebraParser=r;LinkCoordinator={links:[]};gmath.LinkCoordinator=LinkCoordinator;AlgebraModelLink=function(t,e,i){this.id=gmath.uid();this.source=t;this.target=e;this.action=i;this.source.events.on("change."+this.id,this.onChange.bind(this));this.target.events.on("change."+this.id,this.onTargetChange.bind(this))};AlgebraModelLink.prototype.onChange=function(t){if(t.old_model!==this.source)throw"wrong old_model";if(t.new_model!==t.old_model){this.source.events.on("change."+this.id,null);this.source=t.new_model;this.source.events.on("change."+this.id,this.onChange.bind(this))}this.action.rebind(t.new_model,t.node_map,t.old_model);this.action.run();this.action.newTree.hide_nodes();this.action.newTree.for_each(function(t){t.selected=false});this.target.replace_with(this.action.newTree)};AlgebraModelLink.prototype.onTargetChange=function(t){if(t.old_model!==this.target)throw"wrong old_model";if(t.new_model!==t.old_model){this.target.events.on("change."+this.id,null);this.target=t.new_model;this.target.events.on("change."+this.id,this.onTargetChange.bind(this))}};var n=function(e){t.Node.call(this);if(typeof e!=="number")e=0;if(e>=0)this.value=e;else return new u(new n(-e))};gmath.inherit(t.Node,n);n.prototype.nodeFromPast=function(t){return this};n.prototype.nodeFromFuture=function(e){var i=t.get_root(this).timeState;if(i.children.length==0){return this}else{if(i.children[0].generatingAction.length){console.log("Because action composition is not working, previewed actions that compose naturally cannot be tracked through interventions.")}else{var r=i.children[0].generatingAction.mapNodes([this]);if(r.length==1){this.matchFutureNode(r[0]);return this}else{console.warn("not implemented yet");return this}}}};n.prototype.matchFutureNode=function(e){var i=t.get_root(this);var r=t.get_root(e);i.numeric_value(this,r.numeric_value(e))};n.is_num=function(t){return t instanceof n||t.is_group("sign")&&t.children[1]instanceof n};n.get_value=function(t){if(!t)return NaN;if(t instanceof n)return t.value;if(t.is_group("sign")&&t.children[1]instanceof n)return-t.children[1].value;if(t.is_group("add")&&t.children[1]instanceof n)return t.children[1].value;if(t.is_group("sub")&&t.children[1]instanceof n)return-t.children[1].value;return NaN};n.prototype.to_string=function(){if(this.scrubbingThisNum==true)return this.value.toFixed(this.precision);var t=this.value.toFixed(2);var e=0;for(var i=t.length-1;i>0;i--){if(t[i]=="0")e++;else if(t[i]=="."){e++;break}else break}return t.substring(0,t.length-e)};n.prototype.to_ascii=n.prototype.to_string;n.prototype.to_latex=n.prototype.to_string;n.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="num")return true}return false};n.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new n(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.num=n;var o=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,o);o.mappings={"-":"−","*":"·","/":"·","//":""};o.prototype.to_string=function(){if(this.parent&&this.parent.is_group("sign"))return"-";if(this.value in o.mappings)return o.mappings[this.value];return this.value};o.prototype.to_ascii=function(){return this.value};o.prototype.to_latex=function(){if(this.value==="/")return"\\cdot ";if(this.value==="*")return"\\cdot ";if(this.value==="(")return"\\left(";if(this.value===")")return"\\right)";return this.value};o.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="sym")return true}return false};gmath.expressions=gmath.expressions||{};gmath.expressions.sym=o;var s=function(e,i){t.Node.call(this);this.bp=100;if(arguments.length<2){this.value=e;return this}else if(arguments.length===2){if(e instanceof s)this.append(e);else this.append(new s(e));this.append(i);i.for_each(function(t){t.fixed=true});this.children[0].fixed=true;this.value=this.to_ascii()}else throw"wrong number of arguments"};gmath.inherit(t.Node,s);s.prototype.to_string=function(){return this.value};s.prototype.to_ascii=function(){if(!this.has_children())return this.value;var t=this.children[0].value;var e=this.children[1].to_ascii();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};s.prototype.to_latex=function(){if(!this.has_children())return this.value;var t=this.children[0].value;var e=this.children[1].to_latex();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};s.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="var")return true}return false};s.is_var=function(t){return t instanceof s||t.is_group("power")&&t.children[0]instanceof s};s.registerAtParser=function(t){var e=t.registerSymbol("_",100);e.led=function(e){var i=t.parseExpression(99);return new s(e,i)};var i={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"};var r=function(){if(this.type==="name")return new s(this.value);else return new s(i[this.value])};var n=function(e){var i=t.parseExpression(f.prototype.bp,this);return f.createProduct(e,i)};for(var o in i){var a=t.registerSymbol(o,30);a.nud=r;a.led=n}};gmath.expressions=gmath.expressions||{};gmath.expressions.var=s;var a=function(e,i){t.Node.call(this);if(arguments.length>1)this.bp=i;if(arguments.length>0)this.value=e};gmath.inherit(t.Node,a);a.prototype.to_ascii=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_ascii();return t.to_ascii()}).join("")};a.prototype.to_latex=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_latex();return t.to_latex()}).join("")};a.prototype.is_group=function(t){if(arguments.length===0)return true;for(var e=0;e<arguments.length;e++){if(this.value===arguments[e])return true}return false};var h=function(e,i){gmath.inherit(a,this);this.prototype.bp=i.bp||0;this.prototype.associative=i.associative||false;this.prototype.commutative=i.commutative||false;this.prototype.has_inverse=i.has_inverse||false;this.prototype.inverse_group_name=i.inverse_group_name;this.prototype.group_name=i.group_name;this.prototype.group_class=i.group_class||null;this.prototype.value=e;this.prototype.action_handlers=[];this.prototype.vertical_notation=i.vertical_notation||false;this.prototype.add_action_handler=function(t){if(this.action_handlers.indexOf(t)==-1)this.action_handlers.push(t)};this.prototype.getBestMatchingAction=function(){var t=null;for(var e=0;e<this.action_handlers.length;e++){var i=this.action_handlers[e];if(i instanceof Action){if(i.match(this)&&(t==null||i.priority>t.priority)){t=i}}else{console.warn("old action style not supported anymore",i)}}return t};this.prototype.createGroup=function(){if(this.group_class)return new this.group_class;var t=new a(this.group_name,this.bp);t.cleanupAction=this.getGroupCleanupAction();return t};this.createGroup=this.prototype.createGroup;this.prototype.getInverse=function(){return this.inverse&&gmath.expressions[this.inverse]};this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var e=this.children[1];t.replace(this.parent,e);l.handle(e);return true}if(this.merge_nested_group())return true};this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var e=this.parent;var i=this.children[1];if(t.get_child([1,0,0],this).value===t.get_child([0],this).value){t.replace(t.get_child([1,0,0],this),t.get_child([0],this))}var r=t.remove(this);for(var n=0;n<i.children.length;n++){t.insert(e,r+n,i.children[n])}return true}};gmath.expressions[e]=this};var l=function(e){a.call(this);if(e){t.append(this,new o("("));t.append(this,e);t.append(this,new o(")"))}};h.call(l,"brackets",{bp:0});l.registerAtParser=function(t){var e=t.registerSymbol("(",30);e.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance(")");return new l(e)};t.registerSymbol("\\left").nud=function(){t.advance("(");return e.nud()};t.registerSymbol("\\right");t.registerSymbol(")");t.registerSymbol("{").nud=function(){var e=t.parseExpression(0);t.advance("}");return e};e.led=function(e){var i=t.parseExpression(f.prototype.bp,this);return f.createProduct(e,i)};t.registerSymbol("\\left",30).led=function(i){t.advance("(");return e.led(i)};t.registerSymbol("{");t.registerSymbol("}")};l.handle=function(e,i){if(e.is_group("brackets")){if(i&&l.is_optional(e)){t.replace(e,e.children[1]);return true}return false}if(!l.is_optional(e)){var r=t.remove(e);t.insert(e.parent,r,new l(e));return true}return false};l.is_optional=function(t,e){if(t.is_group("brackets")&&t.children[1].is_group("brackets"))return true;var r=t instanceof l?t.children[1]:t;var e=e||t.parent;if(r.is_group("tuple"))return false;if(!r.has_children())return true;if(e instanceof i)return true;if(e.is_group("sign")&&r.is_group("fraction"))return true;if(e.bp>r.bp)return false;if(e.bp<r.bp)return true;
if(e instanceof u&&r instanceof u)return true;if(e.associative&&r.is_group(e.group_name))return true;if(r.commutative&&e.is_group(r.group_name))return true;if(r.is_group("product")&&e.is_group("div")&&e.parent&&e.parent.is_group("fraction"))return true;if(r.is_group("fraction")&&e.is_group("mul","div"))return true;return false};var u=function(e){a.call(this);if(e){t.append(this,new o("-"));t.append(this,e);l.handle(e)}};h.call(u,"sign",{bp:40,associative:true,commutative:false,inverse:"sign"});u.registerAtParser=function(t){t.registerSymbol("+").nud=function(){return t.parseExpression(u.prototype.bp)};var e=t.registerSymbol("-");e.nud=function(){var e=t.parseExpression(u.prototype.bp);return new u(e)};t.registerSymbol("–").nud=e.nud};u.prototype.deconstruct=function(){var t=[];t.push(this);return t};var c=function(){a.call(this)};h.call(c,"sum",{bp:20});var d=function(e,i){a.call(this);if(e){if(i=="add")this.value="add";else if(i=="sub")this.value="sub";else{if(e.is_group("sign")){this.value="sub";e=e.children[1]}else this.value="add"}this.value=this.value;t.append(this,new o(this.value=="add"?"+":"-"));t.append(this,e);l.handle(e)}else{this.value=i=="sub"?"sub":"add"}this.associative=this.value=="add";this.nodeFromPast=function(t){return this};this.nodeFromFuture=function(t){return this}};h.call(d,"add-sub",{group_class:c,group_name:"sum",bp:20,associative:true,commutative:true,has_inverse:true});d.prototype.invert=function(){if(this.value=="add"){this.value="sub";if(this.children[0])this.children[0].value="-";this.associative=false}else{this.value="add";if(this.children[0])this.children[0].value="+";this.associative=true}};d.registerAtParser=function(t){var e=t.registerSymbol("+",d.prototype.bp);e.led=function(e){var i=t.parseExpression(d.prototype.bp);if(e.is_group("sum")){e.append(new d(i,"add"));return e}else{var r=d.prototype.createGroup();r.append(new d(e));r.append(new d(i,"add"));return r}};var i=t.registerSymbol("-",d.prototype.bp);var r=t.registerSymbol("–",d.prototype.bp);i.led=function(e){var i=t.parseExpression(d.prototype.bp);if(e.is_group("sum")){e.append(new d(i,"sub"));return e}else{var r=d.prototype.createGroup();r.append(new d(e));r.append(new d(i,"sub"));return r}};r.led=i.led};d.split=function(e,i){var r=1,o;if(e.is_group("product")&&e.children.length>1){if((e.children[0].children[1]instanceof n||e.children[0].children[1]instanceof u)&&!i){r=n.get_value(e.children[0].children[1]);o=e.children.slice(1)}else{o=e.children.slice()}}else o=[new f(t.clone(e))];return{num:r,variables:o}};d.prototype.absorbNegative=function(){var t=this.is_group("sub");var e=this.children[1];if(e.is_group("sign")){var i=e.children[1];e.remove();i.remove();this.append(i);this.invert()}};var p=function(){a.call(this)};h.call(p,"product",{bp:30,vertical_notation:false});p.prototype.invert=function(){var e=this.children.length;if(this.value=="product"){this.value="fraction";this.vertical_notation=true;var i=this.children[e-1],r=e-1;while(i&&i.value=="div"){i=i.ls;r--}if(!i||i.value!=="//")t.insert(this,r+1,new o("//"))}else{this.value="product";this.vertical_notation=false;if(e>0){var n=this.children[0];while(n){if(n.value=="//")t.remove(n);n=n.rs}}}};p.prototype.append=function(e){if(this.value=="product"&&e.value=="div"){this.invert();t.append(this,e)}else if(this.value=="fraction"&&e.value=="mul"){var i=0;while(i<this.children.length&&this.children[i].value!=="//")i++;t.insert(this,i,e)}else{t.append(this,e)}return this};p.prototype.get_top=function(){var t=this.children[0],e=[];while(t){if(t.value=="mul")e.push(t);t=t.rs}return e};p.prototype.get_bottom=function(){var t=this.children[0],e=[];while(t){if(t.value=="div")e.push(t);t=t.rs}return e};p.prototype.get_fraction_bar=function(){var t=this.children[0];while(t){if(t.value=="//")return t;t=t.rs}return null};p.is_lone_fraction_part=function(t){if(!t.parent)return false;return t.parent.is_group("fraction")&&(t.is_group("mul")&&!t.ls&&t.rs.value==="//"||t.is_group("div")&&!t.rs&&t.ls.value==="//")};p.prototype.group_nodes=function(){var t=this.children[0],e=[],i=[],r;while(t){if(t.value=="div")i.push(t);else if(t.value=="mul")e.push(t);else r=t;t=t.rs}return{top:e,bottom:i,bar:r}};p.prototype.to_latex=function(){var t=this.get_top(),e=this.get_bottom();var i=e.length>0?"\\frac{":"";for(var r=0;r<t.length;r++){i+=r==0?t[r].children[1].to_latex():t[r].to_latex()}if(e.length>0){i+="}{";for(var r=0;r<e.length;r++){i+=r==0?e[r].children[1].to_latex():e[r].to_latex()}i+="}"}return i};p.prototype.to_ascii=function(){var t=this.get_top(),e=this.get_bottom();var i="",r="";for(var n=0;n<t.length;n++){i+=n==0?t[n].children[1].to_ascii():t[n].to_ascii()}if(e.length==0)return i;for(var n=0;n<e.length;n++){r+=(n==0?"":"*")+e[n].children[1].to_ascii()}if(t.length>1)i="("+i+")";if(e.length>1)r="("+r+")";var o=i+"/"+r;if(!l.is_optional(this)||this.parent.is_group("sign")||this.parent.commutative)return"("+o+")";else return o};var f=function(e,i){a.call(this);this.value=i=="div"?"div":"mul";if(e){t.append(this,new o(this.value=="mul"?"*":"/"));t.append(this,e);l.handle(e)}this.associative=this.value=="mul";this.bp=this.value=="mul"?30:30};h.call(f,"mul-div",{group_class:p,group_name:"product",inverse_group_name:"fraction",bp:30,associative:true,commutative:true,has_inverse:true});f.createProduct=function(t,e){if(t.is_group("product")){t.append(new f(e));return t}else{var i=f.prototype.createGroup();i.append(new f(t));i.append(new f(e));return i}};f.registerAtParser=function(t){var e=t.registerSymbol("*",f.prototype.bp);e.led=function(e){var i=t.parseExpression(f.prototype.bp);return f.createProduct(e,i)};var i=t.registerSymbol("\\cdot",f.prototype.bp);i.led=e.led;var r=t.registerSymbol("\\times",f.prototype.bp);r.led=e.led;var n=t.registerSymbol("/",f.prototype.bp+1);n.led=function(e){var i=t.parseExpression(f.prototype.bp+1);if(e.is_group("fraction")){e.append(new f(i,"div"));return e}else{var r;if(e.is_group("brackets")&&e.children[1].is_group("product")){e=e.children[1]}if(e.is_group("product")){r=e}else{r=f.prototype.createGroup();r.append(new f(e))}if(i.is_group("brackets")&&i.children[1].is_group("product")){i=i.children[1]}if(i.is_group("product")){var n=i.children;for(var o=0;o<n.length;o++){n[o].invert();r.append(n[o])}}else{r.append(new f(i,"div"))}return r}};var o=function(){var e=t.parseExpression(f.prototype.bp+1);var i=t.parseExpression(f.prototype.bp+1);var r;if(e.is_group("product"))r=e;else{r=f.prototype.createGroup();r.append(new f(e))}if(i.is_group("product")){i.children.forEach(function(t){t.invert();r.append(t)})}else r.append(new f(i,"div"));return r};t.registerSymbol("\\frac").nud=o;t.registerSymbol("\\dfrac").nud=o;t.registerSymbol("\\tfrac").nud=o};f.hide_rule={name:"hide multiplication sign between variables",disabled:false,apply:function(t){if(!(t instanceof o)||t.value!=="*"&&t.value!=="/")return false;var e=t.parent;if(!e||!(e.is_group("mul")||e.is_group("div")))return false;if(!e.ls||e.ls.value!==e.value||!t.rs)return false;var i=e.ls.children[1];if(t.rs instanceof s||t.rs.is_group("power")&&t.rs.children[0]instanceof s){if(n.is_num(i)||i instanceof s||i.is_group("sign")&&i.children[1]instanceof s){if(e.dragging)t.hide_after_drop=true;else t.hidden=true}}}};f.prototype.invert=function(){if(this.value=="mul"){this.value="div";if(this.children[0])this.children[0].value="/";this.associative=false;this.bp=30}else{this.value="mul";if(this.children[0])this.children[0].value="*";this.associative=true;this.bp=30}};var g=function(t,e){a.call(this);if(t&&e){this.append(t);if(e.is_group("exponent"))this.append(e);else this.append(new v(e));l.handle(t)}};h.call(g,"power",{bp:50,vertical_notation:false});var v=function(e){a.call(this);if(e){t.append(this,e);l.handle(e)}};h.call(v,"exponent",{group_class:g,group_name:"power",bp:50,vertical_notation:true});v.prototype.to_ascii=function(){if(this.children.length===0)return"";return"^"+this.children[0].to_ascii()};v.registerAtParser=function(t){t.registerSymbol("^",v.prototype.bp).led=function(e){var i=t.parseExpression(v.prototype.bp-1);return new g(e,i)};t.registerSymbol("\\sqrt").nud=function(){var e=t.parseExpression(Infinity);var i=f.prototype.createGroup();i.append(new f(new n(1)));i.append(new f(new n(2),"div"));var r=new g(e,i);return r};t.registerSymbol("\\scriptscriptstyle").nud=function(){var e=t.parseExpression(v.prototype.bp);return e}};var m=function(e){t.Node.call(this);if(e===1||e==="T"||e==="t"||e===true)this.value="T";else this.value="F";this.id=gmath.uid()};gmath.inherit(t.Node,m);m.prototype.to_string=function(){return this.value};m.prototype.to_ascii=m.prototype.to_string;m.prototype.is_group=function(){return false};m.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new m(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.bool=m;var _=function(){a.call(this)};h.call(_,"disjunction",{bp:30});var y=function(e){a.call(this);if(e){t.append(this,new o("∧"));t.append(this,e);l.handle(e)}};h.call(y,"and",{group_name:"disjunction",group_class:_,bp:30,associative:true,commutative:true});y.registerAtParser=function(t){var e=t.registerSymbol("*",y.prototype.bp);e.led=function(e){var i=t.parseExpression(y.prototype.bp);if(e.is_group("disjunction")){e.append(new y(i));return e}else{var r=y.prototype.createGroup();r.append(new y(e));r.append(new y(i));return r}}};var w=function(){a.call(this)};h.call(w,"conjunction",{bp:30});var x=function(e){a.call(this);if(e){t.append(this,new o("∨"));t.append(this,e);l.handle(e)}};h.call(x,"or",{group_name:"conjunction",group_class:w,bp:20,associative:true,commutative:true});x.registerAtParser=function(t){var e=t.registerSymbol("+",x.prototype.bp);e.led=function(e){var i=t.parseExpression(x.prototype.bp);if(e.is_group("conjunction")){e.append(new x(i));return e}else{var r=x.prototype.createGroup();r.append(new x(e));r.append(new x(i));return r}}};var b=function(e,i){a.call(this);if(e&&i){t.append(this,e);t.append(this,new o("="));t.append(this,i)}};h.call(b,"equals",{bp:10});b.registerAtParser=function(t){var e=t.registerSymbol("=",b.prototype.bp);e.led=function(e){var i=t.parseExpression(b.prototype.bp);if(e.is_group("equals")||i.is_group("equals")){throw"Parser will not allow multiple equals in an equation."}return new b(e,i)}};b.prototype.getSideOfNode=function(t){while(!(t.parent instanceof b))t=t.parent;return t};b.prototype.getOppositeSideOfNode=function(t){return this.isOnLeftSide(t)?this.getRightSide():this.getLeftSide()};b.prototype.getLeftSide=function(){return this.children[0]};b.prototype.getRightSide=function(){return this.children[2]};b.prototype.isOnLeftSide=function(t){return this.getSideOfNode(t)==this.getLeftSide()};b.prototype.isOnRightSide=function(t){return this.getSideOfNode(t)==this.getRightSide()};b.prototype.areOnSameSide=function(t,e){var i=this.isOnLeftSide(t),r=this.isOnLeftSide(e);return i&&r||!i&&!r};var A=function(){a.call(this);this.bp=100;this.value="tuple";for(var t=0;t<arguments.length;t++){var e=arguments[t];if(e instanceof N)this.append(e);else this.append(new N(e))}};gmath.inherit(a,A);A.is_tuple=function(t){return t instanceof A||t.is_group("brackets")&&t.children[1]instanceof A};A.prototype.to_ascii=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_ascii()}else{return t.to_ascii()}}).join("")};A.prototype.to_latex=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_latex()}else{return t.to_latex()}}).join("")};var N=function(t){a.call(this);this.value="param";if(t){this.append(new o(","));this.children[0].fixed=true;this.append(t)}this.group_class=A;this.group_name="tuple";this.associative=false;this.commutative=false};gmath.inherit(a,N);N.prototype.bp=5;N.createTuple=function(t,e){if(t.is_group("tuple")){t.append(new N(e));return t}else{var i=new A;i.append(new N(t));i.append(new N(e));return i}};N.prototype.append=function(e){t.append(this,e);if(e instanceof o){e.fixed=true}};N.registerAtParser=function(t){var e=t.registerSymbol(",",N.prototype.bp);e.led=function(e){var i=t.parseExpression(N.prototype.bp);return N.createTuple(e,i)};var i=t.registerSymbol("\\,",N.prototype.bp);i.led=e.led};N.hide_rule={name:"Do not show the first comma in a tuple set.",disabled:false,apply:function(t){if(!(t instanceof o)||t.value!==",")return false;var e=t.parent;if(!e||!e.is_group("param"))return false;if(!e.ls||e.ls.value!==e.value){t.hidden=true}}};gmath.expressions.param=N;gmath.actions={};Action=function(t){this.name=t;this.priority=0;this.node_map={};this.initial_node_map={};this.touched_nodes={};this.new_selection=null;this.timeoutID=null};Action.prototype.printMap=function(t){if(t)console.log(t);for(var e in this.node_map){var i=this.oldTree.get_by_id(e);console.log(i?i.to_ascii():"?","==>",this.node_map[e].map(function(t){return t.to_ascii()}).join(", "))}};Action.prototype.createBoundAction=function(t,e){var i=new this.constructor(e);i.oldTree=t;i.newTree=t;return i};Action.prototype.rebind=function(t,e,i){if(this.oldTree!==i)throw"wrong old tree during rebinding an action!";var r=new Action;r.node_map=e;this.oldTree=t;if(this.nodes)this.nodes=r.mapNodes(this.nodes);if(this.target)this.target=r.mapNodes(this.target)[0];if(this.actor)this.actor=r.mapNodes(this.actor)[0]};Action.prototype.createAndRun=function(t,e,i){var r=new this.constructor(e);r.oldTree=t;r.run(i);return r};Action.prototype.createAndDoInPlace=function(t,e,i){var r=new this.constructor(e);r.oldTree=t;r.newTree=t;r.doInPlace(i);return r};Action.prototype.initNodeMap=function(){this.initial_node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0]);this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])};Action.prototype.removeDeletedNodesFromNodeMap=function(){var t=this.newTree.select_all();var e=function(e){return t.indexOf(e)!==-1};for(var i in this.node_map){this.node_map[i]=this.node_map[i].filter(e)}};Action.prototype.updateNodeMap=function(t,e){if(arguments.length===1)gmath.extend(this.node_map,t);else{var i=t;if(Array.isArray(i)){for(var r=0;r<i.length;r++){this.node_map[i[r].id]=Array.isArray(e)?e:[e]}}else this.node_map[i.id]=Array.isArray(e)?e:[e]}};Action.pushNew=function(t,e){for(var i=0;i<e.length;i++){if(t.indexOf(e[i])===-1)t.push(e[i]);else{t.splice(t.indexOf(e[i]),1);t.push(e[i])}}};Action.prototype.extendNodeMap=function(t,e){if(arguments.length===2){var i=t;var r=Array.isArray(e)?e:[e];if(i.id in this.node_map)Action.pushNew(this.node_map[i.id],r);else this.node_map[i.id]=r;return}else{var n=t;for(var o in n){if(!n.hasOwnProperty(o))continue;if(o in this.node_map)Action.pushNew(this.node_map[o],n[o]);else this.node_map[o]=n[o]}}};Action.prototype.getNewTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.newTree)};Action.prototype.getOldTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.oldTree)};Action.prototype.getCorrespondingNodeFromTree=function(t,e){var i=function(t){return e.get_child(t.get_path())};if(Array.isArray(t))return t.map(i);else return i(t)};Action.prototype.addTouchedNodes=function(t){var e=this;t.for_each(function(t){e.touched_nodes[t.id]=true})};Action.prototype.reselectNodeAfterAction=function(t){if(!this.new_selection)this.new_selection=[];if(Array.isArray(t))this.new_selection=this.new_selection.concat(t);else this.new_selection.push(t)};Action.prototype.cleanup=function(t){if(!t.cleanupAction)return false;if(!t.cleanupAction.match(t))return false;var e=t.cleanupAction.createAndDoInPlace(this.newTree,{actor:t});this.compose(e,false);return e};Action.prototype.cleanup_cascade=function(t){var e=false;for(;;){var i=this.cleanup(t);if(!i)return e;e=true;var r=i.mapNodes(t);if(r.length===0)return e;t=r[0].parent}};Action.prototype.compose=function(t,e){if(arguments.length<2)e=true;for(var i in this.node_map){var r=this.node_map[i];this.node_map[i]=t.mapNodes(r);var n=r.filter(function(e){return!t.node_map[e.id]});if(n.length>0&&e)throw"Second mapping does not mention all nodes from first mapping.";this.node_map[i]=this.node_map[i].concat(n);if(t.touched_nodes[i])this.touched_nodes[i]=true}this.newTree=t.newTree};Action.prototype.run=function(t){this.newTree=this.oldTree.clone();return this.doInPlace(t)};Action.prototype.match=function(){throw"called abstract method Action.match()"};Action.prototype.transform=function(t){throw"called abstract method Action.transform()"};Action.prototype.doInPlace=function(t){this.initNodeMap();var e=this.transform(t);this.removeDeletedNodesFromNodeMap();return e};Action.prototype.wasNodeTouched=function(t){return this.touched_nodes[t.id]};Action.prototype.mapNodes=function(t){var e=[],i=this;if(!Array.isArray(t))t=[t];t.forEach(function(t){var r=i.node_map[t.id]||[];r.forEach(function(t){if(e.indexOf(t)===-1)e.push(t)})});return e};Action.prototype.unmapNodes=function(t){var e=[];if(!Array.isArray(t))t=[t];for(var i in this.node_map){if(gmath.array.isPermutation(t,this.node_map[i]))e.push(this.oldTree.get_by_id(i))}return e};Action.createComposedAction=function(t,e){var i=new Action(e);function r(){function e(r,n,o){if(o>=t.length)return r;if(!i.touched_nodes[n]){i.touched_nodes[n]=r.some(t[o].wasNodeTouched.bind(t[o]))}return e(t[o].mapNodes(r),n,o+1)}i.node_map={};i.touched_nodes={};for(var r in t[0].node_map){i.touched_nodes[r]=t[0].touched_nodes[r];i.node_map[r]=e(t[0].node_map[r],r,1)}}r();i.updateNodesFromFutureAndPast=function(){t.forEach(function(t){t.updateNodesFromFutureAndPast()})};return i};gmath.actions.CloneAction=function(){var t=function(){Action.call(this,"clone")};gmath.inherit(Action,t);t.prototype.transform=function(t){if(typeof t==="function")t(this);else return true};return new t}();gmath.actions.PostInteractionSimplificationAction=function(){var t=function(t){Action.call(this,"simplify terms after interaction");this.priority=0;if(t){this.nodes=t.nodes;if("simplify_distributions"in t)this.simplify_distributions=t.simplify_distributions;else this.simplify_distributions=true}};gmath.inherit(Action,t);t.prototype.match=function(t){return true};t.prototype.transform=function(t){this.changed=false;var e=this.getNewTreeNode(this.nodes);for(var r=0;r<e.length;r++){var n=e[r],o=n.parent;if(n.is_group("brackets")){if(l.handle(n,true))this.changed=true;if(this.cleanup_cascade(o))this.changed=true}else if(this.productWithNumbers(n)&&this.simplify_distributions){if(this.multiplyAllNumbers(n)){this.changed=true;this.applyNegatives(o)}}else if(this.muldiv1(n)||this.addsub0(n)){var s=o.parent;this.updateNodeMap(this.nodes[r].select_all(),n.ls||n.rs);n.remove();this.cleanup(o);this.cleanup(s);if(!i.is_top_most(s))l.handle(s,true);this.changed=true}else if(this.exp1(n)){var a=n.parent,h=a.children[0],o=a.parent,u=a.remove();h.remove();o.insert(u,h);this.changed=true}}if(typeof t==="function")t(this);else return this.changed};t.prototype.productWithNumbers=function(t){return t.is_group("product")&&t.children.some(function(t){return n.is_num(t.children[1])})};t.prototype.multiplyAllNumbers=function(t){var e=this.collectNumberTerms(t.children);if(e.nodes.length===0)return false;for(var i=0;i<e.nodes.length;i++){e.target=this.multiplyNumbers(e.target,e.nodes[i])}return true};t.prototype.collectNumberTerms=function(t){var e,i=[];for(var r=0;r<t.length;r++){var o=t[r].children[1];if(n.is_num(o)){if(!e)e=o.parent;else i.push(o.parent)}}return{target:e,nodes:i}};t.prototype.multiplyNumbers=function(t,e){var i=gmath.actions.MultiplyNumbersAction.createBoundAction(this.newTree,{nodes:[e],target:t,interactionType:"drag"});i.doInPlace();this.compose(i,false);var r=i.mapNodes([t]);return r[0]?r[0]:[]};t.prototype.applyNegatives=function(t){var e=["PlusMinusProductToMinusProductAction","AddNegativeAction"];for(var i=0;i<e.length;i++){var r=gmath.actions[e[i]];if(r.match(t)){this.compose(r.createAndDoInPlace(this.newTree,{actor:t}),false);return}}};t.prototype.muldiv1=function(t){return t.is_group("mul","div")&&n.is_num(t.children[1])&&n.get_value(t.children[1])===1};t.prototype.addsub0=function(t){return t.is_group("add","sub")&&n.is_num(t.children[1])&&n.get_value(t.children[1])===0};t.prototype.exp1=function(t){return t.is_group("exponent")&&n.is_num(t.children[0])&&n.get_value(t.children[0])===1};return new t}();gmath.actions.AddSubNumbersAction=function(){var e=function(t){Action.call(this,"add or subtract numbers");this.priority=1;this.is_join_action=true;if(t){if(t.interactionType==="drag"){this.interactionType=t.interactionType;this.delay=300;this.margin={x:.1};this.side="inside";this.nodes=t.nodes;this.target=t.target}else{this.interactionType="tap";this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("add","sub"))return[];if(!n.is_num(t[0].children[1]))return[];var e=this.getOtherNumberAddendsInSum(t[0]);return this.bindActionForEachTarget(t,e)};e.prototype.getOtherNumberAddendsInSum=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group("add","sub")&&n.is_num(i.children[1])&&i.parent===e});return i};e.prototype.bindActionForEachTarget=function(t,e){var i=[];var r=t[0].get_root();for(var n=0;n<e.length;n++){i.push(this.createBoundAction(r,{nodes:t,target:e[n],interactionType:"drag"}))}return i};e.prototype.match=function(t){if(!t.parent.is_group("sum"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return n.is_num(e)&&!(e.is_group("sign")&&e.parent.is_group("sub"))&&n.is_num(i)&&!(i.is_group("sign")&&i.parent.is_group("sub"))};e.prototype.transform=function(t){if(this.interactionType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var e=this.getNewTreeNode(this.sourceAddend),i=this.getNewTreeNode(this.targetAddend),r=e.parent;var o=e.children[1],s=i.children[1];var a=(e.is_group("sub")?-1:1)*n.get_value(o)+(i.is_group("sub")?-1:1)*n.get_value(s);var h=i.is_group("add")&&i.children[1].is_group("sign");var l=new d(new n(a),h?"add":"auto");this.updateNodeMap(this.sourceAddend,l);this.updateNodeMap(this.sourceAddend.children[0],l.children[0]);this.updateNodeMap(this.sourceAddend.children[1].get_mapping_to(l.children[1]));this.updateNodeMap(this.targetAddend,l);this.updateNodeMap(this.targetAddend.children[0],l.children[0]);this.updateNodeMap(this.targetAddend.children[1].get_mapping_to(l.children[1]));var u=i.remove();r.insert(u,l);e.remove();this.cleanup(r);if(typeof t==="function")t(this);return this};e.prototype.updateNodesFromFutureAndPast=function(){var e,i;if(this.interactionType==="drag"){e=this.target,i=this.nodes[0]}else{e=this.actor.ls,i=this.actor}var r=t.get_root(e);var n=r.numeric_value(e);var o=r.numeric_value(i);var s=this;function a(t){return s.mapNodes([t])[0]}function h(t,e,i){return[i-e,e]}e.nodeFromFuture=function(t){var e=a(this);var i=r.numeric_value(e);if(t.type=="changeNumber"){r.numeric_value(this,h(n,o,i)[0])}return this};e.children[0].nodeFromFuture=function(){return this};e.children[1].nodeFromFuture=function(){return this};i.nodeFromFuture=function(t){var e=a(this);var i=r.numeric_value(e);if(t.type=="changeNumber"){r.numeric_value(this,h(n,o,i)[1])}return this};i.children[0].nodeFromFuture=function(){return this};i.children[1].nodeFromFuture=function(){return this};if(t.get_root(e).timeState.children[0]){var l=s.mapNodes(e)[0];var u=r.timeState.children[0].mathObject;l.nodeFromPast=function(t){console.log("Tell me what you want");u.numeric_value(this,r.numeric_value(e)+r.numeric_value(i))};if(l.children&&l.children.length==2){l.children[0].nodeFromPast=function(t){return this};l.children[1].nodeFromPast=function(t){return this}}}return true};d.prototype.add_action_handler(new e);return new e}();i.prototype.move_actions.push(gmath.actions.AddSubNumbersAction);(function(){var e=function(t){Action.call(this,"sum cleanup action");if(t)this.sum=t.actor};gmath.inherit(Action,e);gmath.actions.SumCleanupAction=e;e.prototype.match=function(t){return t.is_group("sum")&&t.children.length<=1};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.sum);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var r=i.children[0],n=this.sum.children[0],o;if(r.is_group("add")){o=r.children[1];this.updateNodeMap(n.children[0],o)}else if(r.is_group("sub")){if(r.children[1].is_group("product")){var s=r.children[1].children[0].children[1],a=s.parent;s.remove();var h=new u(s);a.append(h);o=r.children[1]}else{o=new u(r.children[1])}this.updateNodeMap(n.children[0],o.children[0])}this.updateNodeMap(n,o);this.updateNodeMap(n.parent,o);t.replace(r.parent,o);if(o.parent&&o.parent.is_group("brackets"))l.handle(o.parent,true);else l.handle(o)}if(typeof e==="function")e(this);else return this};c.prototype.cleanupAction=new e})();gmath.actions.AssociateIntoFractionAction=function(){var e=function(t){Action.call(this,"associative property of multiplication--move into fraction");this.priority=0;if(t){if(t.actor)t=this.getSettingsFromActor(t.actor);this.nodes=t.nodes;this.target=t.target;this.side=t.side;if(t.margin)this.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],i=t[0],r=t[t.length-1],n=t[0].parent,o=this,s=i.get_root(),o=this;function a(i){if(i.is_group("mul"))i=i.children[1];if(!i.is_group("fraction"))return;for(var r=0;r<i.children.length;r++){var n=i.children[r];if(!n.is_group("mul"))return;if(o.match(t,n,"left"))e.push(o.createBoundAction(s,{nodes:t,target:n,side:"left-of"}));if(o.match(t,n,"right"))e.push(o.createBoundAction(s,{nodes:t,target:n,side:"right-of"}))}}if(i.parent!==r.parent)return[];var h=n.children[0];while(h!==i){a(h);h=h.rs}h=n.children[n.children.length-1];while(h!==r&&h){a(h);h=h.ls}return e};e.prototype.getSettingsFromActor=function(t){var e,i,r;if(t&&t.children[1]&&t.children[1].is_group("fraction")){e=t.children[1].children[0];i=[t.ls];r="left-of"}else if(t&&t.ls&&t.ls.children[1]&&t.ls.children[1].is_group("fraction")){var n=t.ls.children[1];var o=n.get_top();e=o[o.length-1];i=[t];r="right-of"}return{target:e,nodes:i,side:r}};e.prototype.match=function(e,i,r){if(arguments.length==1){var n=this.getSettingsFromActor(e);e=n.nodes;i=n.target;r=n.side}if(!e||e.length==0)return false;if(!r)return false;if(!i||!i.is_group("mul")||!i.parent.is_group("fraction"))return false;if(!i.parent.parent||i.parent.parent.parent!==e[0].parent)return false;if(!e.every(function(t){return t.is_group("mul")&&t.children[1]!==i.parent}))return false;if(!t.is_range(e))return false;return true};e.prototype.transform=function(e){var i=this.oldTree===this.newTree;var r=i?this.nodes:this.getNewTreeNode(this.nodes);var o=i?this.target:this.getNewTreeNode(this.target);var s=o.parent;var a=s.children.indexOf(o);if(this.side==="right-of")a++;var h=s.get_top();if(h.length===1&&n.get_value(h[0].children[1])===1){h[0].remove();if(this.side==="right-of")a--}t.remove_range(r);s.insert_range(a,r);this.cleanup(s);this.cleanup(s.parent);if(typeof e==="function")e(this);else return true};f.prototype.add_action_handler(new e);return new e}();i.prototype.move_actions.push(gmath.actions.AssociateIntoFractionAction);gmath.actions.AssociateOutOfFractionAction=function(){var e=function(t){Action.call(this,"associative property of multiplication--move out of fraction");if(t){this.nodes=t.nodes;this.target=t.target;this.side=Array.isArray(this.target)?"around":t.side;this.target_is_left=t.side==="left-of";this.priority=t.priority||0;this.margin=this.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.is_group("mul")||!e.parent.is_group("fraction"))return[];if(this.match(t,e.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var r=[];if(this.fractionIsPartOfProduct(t)){r=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:r.length>0?r:t[0].parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("mul")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,r=i.parent,n=r.parent;if(e==="left-of")return n.children.slice(0,n.children.indexOf(r));else return n.children.slice(n.children.indexOf(r)+1)};e.prototype.match=function(e,i){if(e.length===0)return false;if(!this.allNodesAreMuls(e)||!t.is_range(e))return false;return e[0]&&e[0].parent===i&&i.is_group("fraction")};e.prototype.allNodesAreMuls=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul"))return false}return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);t.remove_range(i);var r=i[0].parent;var n=new p;r.replace_with(n);n.append(new f(r));n.insert_range(this.target_is_left?0:1,i);this.cleanup(r);this.cleanup(n.parent);if(typeof e==="function")e(this);else return true};return new e}();i.prototype.move_actions.push(gmath.actions.AssociateOutOfFractionAction);gmath.actions.AssociateOutOfDenominatorAction=function(){var e=function(t){Action.call(this,"associative property of division--move out of fraction denominator");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.margin=this.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25};if(t.margin)this.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;if(e.length===0)return[];if(!t.is_range(e))return[];var r=e[0].parent;if(!r.is_group("fraction"))return[];var o=r.get_top();var s=r.get_bottom();if(o.length===1&&n.get_value(o[0].children[1])===1&&e.length===s.length)return[];if(!e.every(function(t){return i.match(t,r)}))return[];return this.bindActions(e)};e.prototype.match=function(t,e){if(!t.is_group("div"))return false;if(e&&t.parent!==e)return false;return true};e.prototype.bindActions=function(t){var e=this;var i=t[0].get_root(),r=t[0].parent;return[this.createBoundAction(i,{nodes:t,side:"left-of",target:r}),this.createBoundAction(i,{nodes:t,side:"right-of",target:r})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes[0].parent);if(this.side==="outside")this.target=this.nodes[0].parent;var i=this.getNewTreeNode(this.nodes),r=i[0].parent,n=this.getNewTreeNode(this.target);t.remove_range(i);var o=this.putDivsInNewFraction(i);var s=this.replaceTargetWithProductContainingTargetAndFraction(n,o);this.cleanupSourceFraction(r);this.cleanup(s.parent);if(typeof e==="function")e(this);else return this};e.prototype.putDivsInNewFraction=function(t){var e=new p;e.append(new f(new n(1)));t.forEach(function(t){e.append(t)});return e};e.prototype.replaceTargetWithProductContainingTargetAndFraction=function(t,e){var i=new p;var r=t.is_group("mul")?t.children[1]:t;r.replace_with(i);i.append(new f(r));i.insert(this.side==="left-of"||this.side==="outside"?0:1,new f(e));return i};e.prototype.cleanupSourceFraction=function(t){var e=t.parent;this.cleanup(t);this.cleanup(e)};return new e}();i.prototype.move_actions.push(gmath.actions.AssociateOutOfDenominatorAction);gmath.actions.AssociateIntoDenominatorAction=function(){var e=function(t){Action.call(this,"associative property of denominator--move into denominator");this.priority=0;if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;if(e.length===0)return[];if(!t.is_range(e))return[];var r=e[0].parent;if(!r.is_group("fraction"))return[];if(!r.parent.is_group("mul"))return[];if(!e.every(function(t){return i.match(t,r)}))return[];return this.bindActionsForAssociateIntoDenominatorAction(e)};e.prototype.match=function(t,e){if(!t.is_group("div"))return false;if(t.parent!==e)return false;return true};e.prototype.bindActionsForAssociateIntoDenominatorAction=function(t){
var e=[];var i=t[0].get_root(),r=t[0].parent,n=r.parent,o=n.parent;var s=o.children.slice().filter(function(t){return t!==n});for(var a=0;a<s.length;a++){var h=s[a];if(h.children[1].is_group("fraction")){var l=h.children[1].get_bottom();for(var u=0;u<l.length;u++){e.push(this.createBoundAction(i,{nodes:t,target:l[u],side:"left-of"}))}e.push(this.createBoundAction(i,{nodes:t,target:l[l.length-1],side:"right-of"}))}else{e.push(this.createBoundAction(i,{nodes:t,target:h.children[1],side:"inside"}))}}return e};e.prototype.transform=function(e){var i=this;this.nodes.map(this.addTouchedNodes.bind(i));this.addTouchedNodes(this.target);var r=this.getNewTreeNode(this.nodes),n=r[0].parent,o=this.getNewTreeNode(this.target);t.remove_range(r);this.insertDivsInNewLocation(r,o);this.cleanupSourceFraction(n);if(typeof e==="function")e(this);else return this};e.prototype.insertDivsInNewLocation=function(t,e){if(e.is_group("div")){this.insertDivRangeIntoDenominator(t,e)}else{this.replaceTargetWithFractionContainingTargetAndDivs(t,e)}};e.prototype.insertDivRangeIntoDenominator=function(t,e){var i=e.parent;i.insert_range(i.children.indexOf(e)+(this.side==="left-of"?0:1),t)};e.prototype.replaceTargetWithFractionContainingTargetAndDivs=function(t,e){var i=e.parent,r=new p;e.replace_with(r);r.append(new f(e));t.forEach(function(t){r.append(t)})};e.prototype.cleanupSourceFraction=function(t){var e=t.parent,i=e.parent;this.cleanup(t);var r=this.cleanup(e);if(!r&&n.is_num(e.children[1])&&n.get_value(e.children[1])===1){e.remove();this.cleanup(i)}};return new e}();i.prototype.move_actions.push(gmath.actions.AssociateIntoDenominatorAction);(function(){var e=function(t){Action.call(this,"add or subtract a bracketed sum");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("add")&&!t.is_group("sub"))return false;if(!t.children[1].is_group("brackets")||!t.children[1].children[1].is_group(t.group_name))return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var r=this.actor.children[0];this.addTouchedNodes(this.actor);var n=i.children[1];var o=i.children[1].children[1];t.replace(n,o);if(i.is_group("sub")){i.invert();var s=[];for(var a=0;a<o.children.length;a++){o.children[a].invert();s.push(o.children[a].children[0])}this.updateNodeMap(r,s)}this.cleanup(i);if(typeof e==="function")e(this);else return this};d.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"addsub cleanup action");if(t)this.addsub=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("add","sub")&&t.children[1].is_group("sum")};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.addsub);if(i.is_group("add","sub")&&i.children[1].is_group("sum")){var r=i.is_group("sub");var n=i.parent;var o=i.children[1];var s=t.remove(i);if(r)for(var a=0;a<o.children.length;a++)o.children[a].invert();n.insert_range(s,o.children)}if(typeof e==="function")e(this);else return this};d.prototype.cleanupAction=new e})();gmath.actions.AddVariablesAction=function(){var e=function(t){Action.call(this,"add variables");this.priority=0;this.is_join_action=true;if(t){if(t.interactionType==="drag"){this.interactionType=t.interactionType;this.delay=250;this.margin={x:.1};this.side="inside";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length>1)return[];var r=e[0];if(!r.is_group("add","sub"))return[];var n=r.parent;var o=this.analyzeAddendStructure(r);if(o.range.length<1)return[];var s=this.prepareRangeForSearch(o.range),h;if(s.length<1)return[];h=t.filterRange(c(i(s)),n);h=h.concat(t.filter(p(a(s)),n));h=h.filter(g(r));h=h.filter(v(s));return this.bindActionForEachTarget(e,h)};e.prototype.match=function(e){if(!e.ls)return false;var r=e;if(!r.is_group("add","sub"))return false;var n=this.analyzeAddendStructure(r);if(n.range.length<1)return false;var o=this.prepareRangeForSearch(n.range),s;if(o.length<1)return false;s=t.filterRange(c(i(o)),r.ls);s=s.concat(t.filter(p(a(o)),r.ls));if(s.length!==1)return false;s=s.filter(g(r));s=s.filter(v(o));if(s.length!==1)return false;return true};e.prototype.prepareRangeForSearch=function(e){if(!Array.isArray(e))return[new f(t.clone(e))];else return e};e.prototype.analyzeAddendStructure=function(t){var e=t.children[1];if(s.is_var(e)||e.is_group("brackets"))return{range:e,coefficientLocation:"none"};else if(e.is_group("product"))return this.analyzeProductStructure(e);else return{range:[]}};e.prototype.analyzeProductStructure=function(t){var e=[t.children[0].children[1],t.children[t.children.length-1].children[1]];var i;if(n.is_num(e[0])&&n.is_num(e[1]))return{range:[]};else if(!n.is_num(e[0])&&!n.is_num(e[1])){i="none"}else{i=n.is_num(e[0])?"front":"back"}var r,o;if(i==="none"){r=0;o=t.children.length}else if(i==="front"){r=1;o=t.children.length}else{r=0;o=t.children.length-1}var a=[];for(var h=r;h<o;h++){var l=t.children[h].children[1];if(s.is_var(l)||l.is_group("brackets")||l.is_group("sign")&&s.is_var(l.children[1]))a.push(l.parent);else return{range:[]}}return{range:a,coefficientLocation:i}};e.prototype.bindActionForEachTarget=function(t,e){var i=[];var r=t[0].get_root();for(var n=0;n<e.length;n++){var o={};o.interactionType="drag";o.nodes=t;var s=e[n];if(!Array.isArray(s)){o.target=s.parent}else{o.target=s[0].parent.parent;o.range=s}i.push(this.createBoundAction(r,o))}return i};e.prototype.transform=function(t){var e=this;if(this.interactionType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.analyzeAddendStructure(this.sourceAddend),r=this.analyzeAddendStructure(this.targetAddend);i.addend=this.sourceAddend;r.addend=this.targetAddend;var o=this.getNewTreeNode(this.sourceAddend),s=this.getNewTreeNode(this.targetAddend),a=o.parent;var h=o.children[1],l=s.children[1];if(i.coefficientLocation==="none"){h=this.reinterpretTermAsProductWithCoefficientOfOne(h)}if(r.coefficientLocation==="none"){l=this.reinterpretTermAsProductWithCoefficientOfOne(l)}if(s.parent.children.indexOf(s)===0&&r.coefficientLocation==="none"&&l.children[1].children[1].is_group("sign")){this.absorbNegativeIntoAddend(s)}var u=this.splitProduct(h),c=this.splitProduct(l);var p=u.coefficient*(o.is_group("sub")?-1:1)+c.coefficient*(s.is_group("sub")?-1:1);var g=f.prototype.createGroup();g.append(new f(new n(Math.abs(p))));g.append_range(u.variables);var v=p<0?new d(g,"sub"):new d(g,"add");var m=s.remove();a.insert(m,v);o.remove();if(!this.interactionType){if(Math.abs(p)===1){g.children[0].remove();this.cleanup(g)}else if(Math.abs(p)===0){var _=gmath.actions.ZeroAction.createBoundAction(this.newTree,{actor:g.children[1]});_.doInPlace();this.compose(_,false)}}var y={parentOfSum:v.parent.parent,idxOfSum:v.parent.parent.children.indexOf(v.parent),resultingAddend:v,idxOfResultingAddend:v.parent.children.indexOf(v)};this.cleanup(v.parent);this.mapOldStructureToNewStructure(i,y);this.mapOldStructureToNewStructure(r,y);if(!y.parentOfSum.children[y.idxOfSum].is_group("sum")){this.reselectNodeAfterAction(y.parentOfSum.children[y.idxOfSum])}if(typeof t==="function")t(this);return true};e.prototype.reinterpretTermAsProductWithCoefficientOfOne=function(t){if(!t.is_group("product")){var e=t.parent;t.remove();var i=f.prototype.createGroup();i.append(new f(new n(1)));i.append(new f(t));e.append(i);return i}else{t.insert(0,new f(new n(1)));return t}};e.prototype.splitProduct=function(e){var i=this.findIndexOfCoefficient(e);var r,o;if(i===0){r=n.get_value(e.children[i].children[1]);o=t.clone(e.children.slice(1))}else{r=n.get_value(e.children[i].children[1]);o=t.clone(e.children.slice(0,i))}return{coefficient:r,variables:o}};e.prototype.findIndexOfCoefficient=function(t){var e=t.children;for(var i=0;i<e.length;i++){if(n.is_num(e[i].children[1]))return i}};e.prototype.absorbNegativeIntoAddend=function(t){var e=t.children[1].children[1].children[1];var i=e.parent,r=e.remove();var n=e.children[1];n.remove();i.insert(r,n);t.invert()};e.prototype.mapOldStructureToNewStructure=function(t,e){var i=e.parentOfSum.children[e.idxOfSum],r;if(i.is_group("sum")){r=i.children[e.idxOfResultingAddend]}else{r=i}if(n.is_num(r)){this.updateNodeMap(t.addend.get_mapping_to(r))}else{this.mapAddendGroup(t.addend,r);var o=this.mapNegatives(t.addend,t.coefficientLocation,r);this.mapCoefficients(t.addend,t.coefficientLocation,r);this.mapVariables(t.range,r,o)}};e.prototype.mapAddendGroup=function(t,e){if(e.is_group("add","sub")){this.updateNodeMap(t,e);this.updateNodeMap(t.children[0],e.children[0])}};e.prototype.mapNegatives=function(t,e,i){if(!i.is_group("add","sub","sign","product")){return}var r,n;if(t.is_group("sub")){r=t.children[0]}var o;var s=e==="front"||e==="none"&&t.children[1].children[0]?t.children[1].children[0]:t.children[1].children[t.children[1].children.length-1];if(s&&s.children[1]&&s.children[1].is_group("sign")){n=s.children[1].children[0];o=e==="none"}if(r&&n||!r&&!n){return}if(i.is_group("sub")&&n){this.updateNodeMap(n,i.children[0]);return}if(i.is_group("sign")){if(r){this.updateNodeMap(r,i.children[0])}if(n){this.updateNodeMap(n,i.children[0])}return}if(i.is_group("add")){i=i.children[1]}if(i.is_group("product")&&i.children[0].children[1].is_group("sign")){var a=i.children[0].children[1].children[0];if(r){this.updateNodeMap(r,a)}if(n){this.updateNodeMap(n.parent,a.parent);this.updateNodeMap(n,a)}return o}};e.prototype.mapCoefficients=function(t,e,i){var r,o,s,a;if(e==="none"){return}if(e==="front"){r=t.children[1].children[0]}else if(e==="back"){r=t.children[1].children[t.children[1].children.length-1]}o=r.children[1];if(o.is_group("sign")){o=o.children[1]}if(i.is_group("add","sub")){i=i.children[1]}if(i.is_group("product")){if(n.is_num(i.children[0].children[1])){s=i.children[0];a=i.children[0].children[1]}else{return}if(a.is_group("sign")){a=a.children[1]}}else{return}this.updateNodeMap(r,s);this.updateNodeMap(o,a)};e.prototype.mapVariables=function(t,e,i){if(e.is_group("add","sub")){e=e.children[1]}if(e.is_group("product")){var r=n.is_num(e.children[0].children[1])?e.children.slice(1):e.children.slice();if(Array.isArray(t)){for(var o=0;o<t.length;o++){var s=o===0&&i?t[o].children[1].children[1]:t[o].children[1];var a=r[o].children[1].is_group("sign")?r[o].children[1].children[1]:r[o].children[1];this.updateNodeMap(t[o],r[o]);this.updateNodeMap(t[o].children[0],r[o].children[0]);this.updateNodeMap(s.get_mapping_to(a))}}else{var a=r[0].children[1].is_group("sign")?r[0].children[1].children[1]:r[0].children[1];this.updateNodeMap(t.get_mapping_to(a))}}else{var s=Array.isArray(t)?t[0]:t;this.updateNodeMap(s.get_mapping_to(e.is_group("sign")?e.children[1]:e))}};function i(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function r(t){return t.is_group()&&t.commutative&&t.associative}function o(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(r(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function a(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(r(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function h(t){if(t.is_group("product")&&t.children[0].children[1].is_group("sign")){return t.children[0].children[1].children[1].to_ascii()+t.children.slice(1).map(function(t){return t.to_ascii()}).join("")}return""}function l(t){return t.length===t[0].parent.children.length}function u(t){return t.parent}function c(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(u(e[0].parent)&&l(e))return false;return i(e)===t||o(e)===t}}function p(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t||h(e)===t}}function g(e){var i=e.parent;return function(r){var n,o;try{if(Array.isArray(r)){n=t.get_parent(3,r[0]);o=t.get_parent(2,r[0])}else{n=t.get_parent(2,r);o=t.get_parent(1,r)}if(!i.is_group("sum")||!n.is_group("sum")||i!==n||o===e)return false}catch(s){if(s==="invalid path")return false;throw s}return true}}function v(t){return function(t){if(!Array.isArray(t))return true;var e=t[0].parent;if(e.children.length!==t.length+1)return false;for(var i=0;i<e.children.length;i++){var r=e.children[i];if(t.indexOf(r)===-1&&!n.is_num(r.children[1]))return false}return true}}d.prototype.add_action_handler(new e);return new e}();i.prototype.move_actions.push(gmath.actions.AddVariablesAction);gmath.actions.AddNegativeAction=function(){var e=function(t){Action.call(this,"rearrange signs");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.children[1];if(e.is_group("sign"))return true;return false};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var r=this.actor.children[1].children[0];this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(r);var n=i.children[1];i.invert();this.updateNodeMap(r,i.children[0]);t.replace(n,n.children[1]);if(typeof e==="function")e(this);else return true};d.prototype.add_action_handler(new e);return new e}();gmath.actions.PlusMinusProductToMinusProductAction=function(){var e=function(t){Action.call(this,"x+-y*z=x-y*z");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.children[1].is_group("product"))return false;var e=t.children[1].children[0].children[1];if(!e.is_group("sign"))return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var r=i.children[1].children[0].children[1];var n=this.getOldTreeNode(r.children[0]);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(n);this.updateNodeMap(n,i.children[0]);t.replace(r,r.children[1]);i.invert();if(typeof e==="function")e(this);else return true};d.prototype.add_action_handler(new e);return new e}();RemoveBracketsAction=function(){var e=function(t){Action.call(this,"remove optional brackets");this.priority=4;if(t){this.actor=t.actor}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("brackets")&&l.is_optional(t)};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[2]);var r=t.replace(i,i.children[1]);this.cleanup(r.parent);if(typeof e==="function")e(this);else return true};var i=new e;l.prototype.add_action_handler(i);return i}();gmath.actions.editLineAction=function(){var t=function(t){Action.call(this,"rewrite dl line");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,t);t.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};t.prototype.removeAllNodesFromNodeMap=function(){var t=this.newTree.select_all();for(var e in this.node_map){this.node_map[e]=[]}};t.prototype.transform=function(t){var e;var i=Keyboard();i.caption("What do you want to change in this line?").on("done",n).on("cancel",o)();var r=this;function n(e){var n=r.newTree;var o=n.parse(e,true);if(!o)return;n.children[0].remove();n.append(o);i.visible(false);i.on("done",null).on("cancel",null);r.removeAllNodesFromNodeMap();t(r)}function o(){console.log("cancelled");i.visible(false);i.on("done",null).on("cancel",null);t(false)}i.latex(r.newTree.to_latex()).visible(true)};return new t}();gmath.actions.DirectFactoringAction=function(){var e=function(t){Action.call(this,"direct factor");if(t){this.nodes=t.nodes;this.target=t.target;this.side="inside";this.priority=t.priority||0;this.delay=300;this.margin={x:.1}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var r=[];var n=e.filter(function(t){return t.is_group()});if(e.length===0||n.length===0)return r;var o=e[0].get_root();var a,h;var l;if(this.nodesAreAFractionResultingFromAPreviousFactoringAction(e)){a=e[0].children[1].get_bottom();l=true}else if(this.nodesArePartOfAProductWithinASum(e)){if(!t.is_range(e))return r;a=e}else if(this.nodesAreASingleAddend(e)){a=this.getEntireRangeFromAddend(e);if(a.length===1)a=this.temporarilyReinterpretRangeAsMulDiv(a)}else{return r}h=o.filterRange(u(i(a)));h=h.concat(o.filter(c(s(a))));h=h.filter(p(e));h=h.filter(g(e));r=r.concat(this.bindActionsFromRanges(e,h));if(l){this.useFractionsInsteadOfDenominatorsAsTargets(r)}return r};e.prototype.nodesAreAFractionResultingFromAPreviousFactoringAction=function(t){if(!t[0].is_group("mul"))return false;var e=t[0].children[1];if(!e.is_group("fraction"))return false;var i=e.get_top();if(i.length!==1||!n.get_value(i[0].children[1])===1)return false;var r=t[0].parent;if(r.children.length!==2)return false;var o=r.children[r.children.indexOf(t[0])===0?1:0].children[1];if(!o.children[1]||!o.children[1].is_group("sum"))return false;return true};e.prototype.nodesArePartOfAProductWithinASum=function(t){var e=t[0];if(e.parent&&e.parent.is_group("fraction")&&e.parent.parent.is_group("mul"))e=e.parent.parent;var i=e;if(!i.parent)return false;var r=i.parent;if(!r.parent)return false;var n=r.parent;if(!n.parent)return false;var o=n.parent;return i.is_group("mul","div")&&r.is_group("product","fraction")&&(n.is_group("add")||n.is_group("sub"))&&o.is_group("sum")};e.prototype.bindActionsFromRanges=function(t,e){var i=t[0].get_root();var r=[];for(var n=0;n<e.length;n++){r.push(this.createBoundAction(i,{nodes:t,target:e[n]}))}return r};e.prototype.nodesAreASingleAddend=function(t){if(t.length!==1)return false;return t[0].is_group("add")||t[0].is_group("sub")};e.prototype.getEntireRangeFromAddend=function(t){var e=t[0],i=e.children[1];var r;if(i.is_group("product")){r=i.children}else{r=[i]}return r};e.prototype.useFractionsInsteadOfDenominatorsAsTargets=function(t){for(var e=0;e<t.length;e++){var i=t[e];if(i.target.length===i.target[0].parent.get_bottom().length){i.target=i.target[0].parent.parent;i.prevFracState=true}}};e.prototype.temporarilyReinterpretRangeAsMulDiv=function(e){return[new f(t.clone(e[0]))]};e.prototype.transform=function(e){var i=this;if(this.prevFracState){this.target=this.target.children[1].get_bottom().slice()}var r=Array.isArray(this.target)?this.target:[this.target],o=this.nodes;var s=this.getNewTreeNode(r),a=this.getNewTreeNode(o);if(p(a)){a=g(a)}if(p(s)){s=g(s)}var h=v(a),u=v(s);h.left_of_target=h.idxOfAddendInSum<u.idxOfAddendInSum;if(!m(h)){h=_(h)}else{h.addend.remove();h.sumOfCoefficients=h.left_of_target?h.product.children[0].children[1].children[1]:h.product.children[h.product.children.length-1].children[1].children[1]}A(u);N(u,h);u.sum.insert(h.left_of_target?u.idxOfAddendInSum-1:u.idxOfAddendInSum,h.addend);k(o,r,a);M(h);T(h);this.cleanup_cascade(u.sum);var c=L(h);D(c);if(typeof e==="function")e(this);else return true;function p(t){var e=t[0];return e.is_group("add")||e.is_group("sub")||e.parent.is_group("add")||e.parent.is_group("sub")}function g(t){var e=t[0].parent.is_group("add")||t[0].parent.is_group("sub");var r=e?t[0].parent:t[0],o=r.children[1];o.remove();var s=f.prototype.createGroup();s.append(new f(new n(1)));s.append(new f(o));r.append(s);i.cleanup(s);i.cleanup(s.children[1]);i.updateNodeMap(i.getOldTreeNode(r),s.children.slice(1));return s.children.slice(1)}function v(t){var e={};e.range=t;var i=t[0];if(i.parent.is_group("product")){e.product=i.parent;e.addend=e.product.parent}else if(i.parent.is_group("fraction")){e.fraction=i.parent;if(e.fraction.parent.is_group("mul")){e.product=e.fraction.parent.parent;e.addend=e.product.parent}else{e.addend=e.fraction.parent}}else{throw"Can't identify structure for direct factoring."}e.sum=e.addend.parent;e.idxOfAddendInSum=e.sum.children.indexOf(e.addend);return e}function m(t){if(t.fraction)return false;if(t.addend.is_group("sub"))return false;if(!t.product.children[0].children[1].is_group("brackets")&&t.left_of_target||!t.product.children[t.product.children.length-1].children[1].is_group("brackets")&&!t.left_of_target)return false;if(t.product.children.length-1!==t.range.length)return false;return true}function _(t){y(t);var e=w(t);return e}function y(t){var e=t.range;for(var i=0;i<e.length;i++){e[i].remove()}}function w(t){var e=f.prototype.createGroup();x(e,t.range);b(t);var i=d.prototype.createGroup();t.addend.remove();t.addend.dragging=false;t.addend.selected=false;i.append(t.addend);var r=new l(i);var n=f.prototype.createGroup();if(t.left_of_target){n.append(new f(r));n.append(new f(e))}else{n.append(new f(e));n.append(new f(r))}var o=new d(n);var s={};s.addend=o;s.product=n;s.sumOfCoefficients=i;s.left_of_target=t.left_of_target;return s}function x(t,e){for(var i=0;i<e.length;i++){t.append(e[i])}return t}function b(t){var e,r;if(t.fraction){e=t.fraction.parent;i.cleanup(t.fraction);if(e.is_group("mul")&&n.get_value(e.children[1])===1){e.remove();r=true}}if(t.product){if(e&&!r)i.cleanup(e);i.cleanup(t.product)}}function A(t){t.addend.remove();y(t)}function N(t,e){if(e.left_of_target)e.sumOfCoefficients.append(t.addend);else e.sumOfCoefficients.insert(0,t.addend)}function k(t,e,r){if(e[0].is_group("div")){for(var n=0;n<t.length;n++){i.updateNodeMap(t[n].get_mapping_to(r[n]))}if(r[0].is_group("div")){for(var n=0;n<e.length;n++){i.updateNodeMap(e[n].get_mapping_to(r[n]))}}else{var o=r[0].children[1].get_bottom();for(var n=0;n<e.length;n++){i.updateNodeMap(e[n].get_mapping_to(o[n]))}}}else if(t[0].is_group("mul","add","sub")&&!e[0].is_group("mul","add","sub")){for(var n=0;n<t.length;n++){i.updateNodeMap(t[n].children[1].get_mapping_to(r[n].children[1]))}if(!e[0].is_group("product")){i.updateNodeMap(e[0].get_mapping_to(r[0].children[1]))}else{for(var n=0;n<e[0].children.length;n++){i.updateNodeMap(e[0].children[n].get_mapping_to(r[n]))}}}else{for(var n=0;n<t.length;n++){i.updateNodeMap(t[n].get_mapping_to(r[n]));i.updateNodeMap(e[n].get_mapping_to(r[n]))}}}function M(t){var e=t.sumOfCoefficients;for(var r=0;r<e.children.length;r++){var n=e.children[r].children[1];i.cleanup(n)}for(var r=0;r<e.children.length;r++){var n=e.children[r];l.handle(n,true);i.cleanup(n)}for(var r=0;r<e.children.length;r++){var n=e.children[r].children[1];if(n.is_group("brackets")&&n.children[1].is_group("sum")){n.replace_with(n.children[1])}i.cleanup(e.children[r])}}function T(t){var e=t.product;for(var r=0;r<e.children.length;r++){i.cleanup(e.children[r].children[1])}for(var r=0;r<e.children.length;r++){i.cleanup(e.children[r])}}function L(t){var e;var r=t.product.children.indexOf(t.sumOfCoefficients.parent.parent);if(r===0){e=t.product.children.slice(1)}else{e=t.product.children.slice(0,t.product.children.length-1)}i.reselectNodeAfterAction(e);return e}function D(e){t.for_each(function(t){t.update_y_during_dragging=true},e[0])}};function i(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function r(t){return t.is_group()&&t.commutative&&t.associative}function o(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(r(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function s(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(r(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function a(t){return t.length===t[0].parent.children.length}function h(t){return t.parent}function u(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(h(e[0].parent)&&a(e))return false;return i(e)===t||o(e)===t}}function c(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t}}function p(t){return function(e){if(t[0].is_group("add")||t[0].is_group("sub"))return t[0].children[1]!==e;for(var i=0;i<e.length;i++){for(var r=0;r<t.length;r++){if(e[i]===t[r])return false}}return true}}function g(e){return function(i){try{var r,n;if(e[0].is_group("mul")||e[0].is_group("div")){var o=e[0];if(o.parent.is_group("fraction")&&o.parent.parent.is_group("mul"))o=o.parent.parent;r=t.get_parent(1,o);n=t.get_parent(2,r)}else if(e[0].is_group("add")||e[0].is_group("sub")){r=null;n=t.get_parent(1,e[0])}else{return false}var s,a;var h=Array.isArray(i)?i[0]:i;if(h.is_group("mul")||h.is_group("div")){if(h.parent.is_group("fraction")&&h.parent.parent.is_group("mul"))h=h.parent.parent;s=t.get_parent(1,h);a=t.get_parent(2,s)}else{s=null;a=t.get_parent(2,h)}if(r&&s&&r===s){return false}if(n!==a){return false}}catch(l){if(l==="invalid path")return false;throw l}return true}}return new e}();i.prototype.move_actions.push(gmath.actions.DirectFactoringAction);gmath.actions.CommuteAction=function(){var e=function(t){Action.call(this,"commute terms");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.margin={y:-1}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var r=[];var n=e[0].parent.is_group("flat"),o;if(n)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e,o,"left-of"))r.push(this.createBoundAction(i,{nodes:e,target:o,side:"left-of"}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e,o,"right-of"))r.push(this.createBoundAction(i,{nodes:e,target:o,side:"right-of"}))}return r};e.prototype.match=function(t,e,i){if(e.parent!==t[0].parent)return false;if(!t[0].commutative)return false;if(i==="left-of"&&e.ls===t[t.length-1])return false;if(i==="right-of"&&e.rs===t[0])return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var r=this.getNewTreeNode(this.target);var n=r.parent,o=n.children.indexOf(r);if(i.length===1){i[0].remove();n.insert(o,i[0])}else{if(this.side==="right-of")o++;var s=t.remove_range(i);n.insert_range(s<o?o-i.length:o,i)}if(typeof e==="function")e(this);else return true};return new e}();i.prototype.move_actions.push(gmath.actions.CommuteAction);gmath.actions.EqInvertAction=function(){var e=function(t){Action.call(this,"invert terms across equation");if(t){this.nodes=t.nodes;this.target=t.target;this.side=this.nodes[0].is_group("mul")?"around":t.side;this.priority=t.priority||0;this.clean=[]}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;var r=[];if(o())return r;var n={};a();h();return r;function o(){return e.length===0||!s()||!t.is_range(e)}function s(){var t=e[0];var i=t.get_root();var r=t.get_path();if(r[1]!==0&&r[1]!==2)return false;return i.children[0].is_group("equals")&&n();function n(){if(t.is_group("add","sub")){return t.parent.parent&&t.parent.parent.is_group("equals")}else if(t.is_group("mul","div")){var e=t.parent;if(e.is_group("product")){return e.parent&&e.parent.is_group("equals")||e.parent&&e.parent.is_group("add","sub")&&e.parent.parent.parent.is_group("equals")}else if(e.is_group("fraction")){if(e.parent.is_group("sign")){e=e.parent}return e.parent.is_group("equals")||e.parent&&e.parent.is_group("add","sub")||e.parent&&e.parent.is_group("mul")&&e.parent.parent.is_group("product")&&e.parent.parent.parent.is_group("equals")||e.parent&&e.parent.is_group("mul")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("add","sub")}}else{return t.parent.is_group("equals")}}}function a(){n.tree=e[0].get_root();n.targetSide=n.tree.children[0].getOppositeSideOfNode(e[0])}function h(){r.push(i.createBoundAction(n.tree,{nodes:e,target:n.targetSide,side:"inside"}))}};e.prototype.transform=function(t){var e=this;var i=this.getNewTreeNode(this.nodes);var r=this.analyzeStructureOfEquation(i);this.invertModifiers(r.modifiers);this.modifyAnyOtherTermsOnOriginSide(r.modifiers,r.originChanges);this.removeModifiersFromOriginSide(r.modifiers);this.modifyTargetSide(r.oldModifiers,r.modifiers,r.otherSideOfEquation,r.oldOtherSideOfEquation);if(typeof t==="function")t(this);return this};e.prototype.analyzeStructureOfEquation=function(t){var e=this;var i={};var r=t[0].get_root().children[0];var n=t[0].get_path(),o=n[1]?0:2;i.modifiers=t;i.oldModifiers=t.map(e.getOldTreeNode.bind(e));i.originChanges=this.getOtherTermsFromSide(r.children[n[1]],t,n);i.otherSideOfEquation=r.children[o];i.oldOtherSideOfEquation=this.getOldTreeNode(i.otherSideOfEquation);return i};e.prototype.getOtherTermsFromSide=function(t,e,i){if(t===e[0]||e[0].is_group("div")&&e[0].parent===t){return[]}else{return t.children.slice().filter(function(t){var e=t.get_path();return e[2]!==i[2]})}};e.prototype.invertModifiers=function(t){var e=[];for(var i=0;i<t.length;i++){var r=t[i];if(r.is_group("mul")&&r.children[1].is_group("fraction")){this.convertToReciprocal(r.children[1])}else{if(r.invert&&!r.is_group("product","fraction"))r.invert()}e.push(r)}return e};e.prototype.convertToReciprocal=function(e){var i=e.parent,r=e.remove();var o;if(e.is_group("product")){var s=e.children.slice();t.remove_range(e.children);s.forEach(function(t){t.invert()});var a=f.prototype.createGroup();s.forEach(function(t){a.append(t)});o=a}else{var h=e.get_top(),l=e.get_bottom();if(h.length===1&&n.get_value(h[0].children[1])===1){var u=f.prototype.createGroup();t.remove_range(l);l.forEach(function(t){t.invert()});u.append_range(l);o=u}else{t.remove_range(h);t.remove_range(l);h.forEach(function(t){t.invert()});l.forEach(function(t){t.invert()});l.forEach(function(t){e.append(t)});h.forEach(function(t){e.append(t)});o=e}}i.insert(r,o);this.cleanup(o)};e.prototype.modifyAnyOtherTermsOnOriginSide=function(t,e){if(e.length===0)return;var i=e[0].parent;if(t[0].is_group("mul","div")&&i.is_group("sum")){for(var r=0;r<e.length;r++){var n=e[r].children[1];var o=this.removeRedundantTerms(n,t);n=e[r].children[1];this.insertModifiersIntoTerm(n,o)}}};e.prototype.removeRedundantTerms=function(e,i){var r=i.slice();if(e.is_group("product","fraction")){for(var n=0;n<e.children.length;){var o=e.children[n];for(var s=0;s<r.length;){if(this.invertModifiers([t.clone(r[s])])[0].to_ascii()===o.to_ascii()){this.extendNodeMap(this.getOldTreeNode(o).get_mapping_to(r[s]));o.remove();r.splice(s,1);break}else{n++;s++}}if(r.length===0)break}this.cleanup(e)}return r};e.prototype.insertModifiersIntoTerm=function(t,e){if(this.termIsAProductContainingAFraction(t)&&e[0].is_group("div")){this.insertModifierDivsAsNewFractionIntoProduct(t,e)}else if(t.is_group("product","fraction")){this.insertModifiersIntoProductFraction(t,e)}else{this.replaceTermWithProductContainingModifiedTerm(t,e)}};e.prototype.termIsAProductContainingAFraction=function(t){if(!t.is_group("product"))return false;return t.children.some(function(t){return t.children[1].is_group("fraction")})};e.prototype.insertModifierDivsAsNewFractionIntoProduct=function(e,i){var r=this;var o=f.prototype.createGroup();o.append(new f(new n(1)));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;r.extendNodeMap(r.getOldTreeNode(e).get_mapping_to(i));o.append(i)});e.append(new f(o))};e.prototype.insertModifiersIntoProductFraction=function(e,i){var r=this;i.forEach(function(i){var n=t.clone(i);n.dragging=false;n.selected=false;r.extendNodeMap(r.getOldTreeNode(i).get_mapping_to(n));e.append(n)})};e.prototype.replaceTermWithProductContainingModifiedTerm=function(e,i){var r=this;var n=f.prototype.createGroup(),o=e.parent,s=e.remove();n.append(new f(e));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;r.extendNodeMap(r.getOldTreeNode(e).get_mapping_to(i));n.append(i)});o.insert(s,n)};e.prototype.removeModifiersFromOriginSide=function(e){var i=e[0].get_root().get_child(e[0].get_path().slice(0,2));if(this.modifierIsTheOnlyTermOnOriginSide(e,i)){this.removeModifierAndReplaceWithZero(e)}else if(e[0].is_group("div")||e[0].is_group("mul")&&e[0].parent.is_group("fraction")){
var r=e[0].parent,n=r.parent;t.remove_range(e);var o=r.get_top(),s=this.cleanup(r);if(s&&o.length===1)n.simplify=true;this.cleanup(n)}else{var n=e[0].parent;t.remove_range(e);this.cleanup(n)}};e.prototype.modifierIsTheOnlyTermOnOriginSide=function(t,e){return t[0]===e};e.prototype.removeModifierAndReplaceWithZero=function(t){var e=t[0].parent,i=t[0].remove();e.insert(i,new n(0))};e.prototype.modifyTargetSide=function(t,e,i,r){if(e.length===1&&!e[0].is_group("mul","div")&&!e[0].is_group("add","sub")){if(e[0].is_group("sign")){var n=e[0].children[1];n.remove();e[0]=new d(n);this.updateNodeMap(t[0],e[0]);this.updateNodeMap(t[0].children[0],e[0].children[0])}else if(e[0].is_group("sum")){var n=e[0];n.children.forEach(function(t){t.invert()});e[0]=new d(n)}else{var n=e[0];e[0]=new d(n,"sub")}}var o=i.parent,s=i.remove();var a;if(!i.is_group("product","fraction")&&e[0].is_group("mul","div")){var h=f.prototype.createGroup();var l=new f(i);h.append(l);for(var u=0;u<e.length;u++){h.append(e[u])}o.insert(s,h);this.cleanup(h.children[0]);h.children[0].simplify=true}else if(!i.is_group("sum")&&e[0].is_group("add","sub","sum")){var c=d.prototype.createGroup();var p;if(i.is_group("sign")){p=new d(i);this.extendNodeMap(r,p);this.extendNodeMap(r.children[0],p.children[0])}else{p=new d(i)}c.append(p);for(var u=0;u<e.length;u++){c.append(e[u])}o.insert(s,c);this.cleanup(c.children[0]);if(e[0].children[1].is_group("sum")){var g=e[0].children[1].children.slice();this.cleanup(e[0]);e=g}c.children[0].simplify=true}else{var v=i;for(var u=0;u<e.length;u++){v.append(e[u])}o.insert(s,v);if(e.length===1&&e[0].children[1].is_group("sum")){e=e[0].children[1].children.slice();this.cleanup(v.children[v.children.length-1])}}this.reselectNodeAfterAction(e)};return new e}();i.prototype.move_actions.push(gmath.actions.EqInvertAction);gmath.actions.EqInvertAndCommuteTermAction=function(){var t=function(t){Action.call(this,"composed action of inverting terms across an equation and commuting");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.priority=t.priority||0;this.margin={y:-1}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i=this.getAndPerformAvailableInversionActionOnClone(e,t);if(!i){return[]}var r=this.getAvailableCommuteActionsOnInversionResult(i);if(r.length===0){return[]}var n=this.unmapToGetTargets(e,i,r);return this.adjustTargets(this.bindActionForEachTarget(t,n))};t.prototype.getAndPerformAvailableInversionActionOnClone=function(t,e){var i=t.clone(),r=[];e.forEach(function(t){r.push(i.get_child(t.get_path()))});var n=gmath.actions.EqInvertAction.getAllAvailableActions(r);if(n.length===0){return false}var o=n[0];i.performAction(o,null,false);if(o.newTree===o.oldTree){return false}return o};t.prototype.getAvailableCommuteActionsOnInversionResult=function(t){var e=[];var i=t.nodes;if(i.length===1&&i[0].is_group("sum")){i=i[0].children.slice()}for(var r=0;r<i.length;r++){var n=i[r];var o=this.getTheNodesOnTheSameSideAsTheTarget(t.mapNodes(n),t.target);e.push(this.getCommutativeTermFromNode(o)[0])}return gmath.actions.CommuteAction.getAllAvailableActions(e)};t.prototype.getTheNodesOnTheSameSideAsTheTarget=function(t,e){var i=[];var r=e.get_path()[1];t.forEach(function(t){if(t.get_path()[1]===r)i.push(t)});return i};t.prototype.unmapToGetTargets=function(t,e,i){var r=[];i.forEach(function(t){r.push(t.target)});var n=this;var o=[];r.forEach(function(t){o.push(n.getCommuteTargetBeforeInversion(t,e))});var s=[];o.forEach(function(e){s.push(t.get_child(e.get_path()))});return s};t.prototype.getCommuteTargetBeforeInversion=function(t,e){var i=e.unmapNodes(t);if(i.length===1){return i[0]}else{if(t.is_group("mul")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("sum")){var r=t.children[1];i=e.unmapNodes(r);if(i.length!==0){return i[0]}else{var n=r.children[1];i=e.unmapNodes(n);return i[0]}}else if(t.is_group("add","sub","mul")){var o=t.children[1];return e.unmapNodes(o)[0]}}};t.prototype.getCommutativeTermFromNode=function(t){if(t.length!==1)throw"What's happening here?";if(t[0].parent.commutative){return[t[0].parent]}else if(t[0].is_group("sum")&&t[0].parent.is_group("brackets")&&t[0].parent.parent&&t[0].parent.parent.commutative){return[t[0].parent.parent]}else{return t}};t.prototype.bindActionForEachTarget=function(t,e){var i=[];for(var r=0;r<e.length;r++){var n=e[r];if(!n.ls||!n.commutative){i.push(this.createBoundAction(t[0].get_root(),{nodes:t,target:n,side:"left-of"}))}i.push(this.createBoundAction(t[0].get_root(),{nodes:t,target:n,side:"right-of"}))}return i};t.prototype.adjustTargets=function(t){for(var e=0;e<t.length;e++){var i=t[e];if((!i.target.ls&&i.side==="left-of"||(!i.target.rs||i.target.rs instanceof o)&&i.side==="right-of")&&i.target.parent.is_group("fraction")){i.target=i.target.parent}}return t};t.prototype.doInPlace=function(t){this.initNodeMap();if(this.target.is_group("fraction")&&this.nodes[0].is_group("div")){var e=this.target.get_top();this.target=this.side==="left-of"?e[0]:e[e.length-1]}var i=this;this.nodes.forEach(function(t){i.addTouchedNodes(t)});var r=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var o=gmath.actions.EqInvertAction.getAllAvailableActions(r)[0];o.doInPlace();this.compose(o);var s=this.getTheNodesOnTheSameSideAsTheTarget(o.mapNodes(r.length===1&&r[0].is_group("sum")?r[0].children.slice():r),o.mapNodes(n)[0]),n=o.mapNodes(n);if(s.length===1){s=this.getCommutativeTermFromNode(s)}n=this.getCommutativeTermFromNode(n)[0];var a=gmath.actions.CommuteAction.getAllAvailableActions(s);var h;if(!(this.side==="right-of"&&!this.target.rs)){for(var l=0;l<a.length;l++){var u=a[l];if(this.side==="right-of"&&u.side==="left-of"&&n.rs===u.target){h=u;u.doInPlace();this.compose(u);break}else if(this.side==="left-of"&&n===u.target){h=u;u.doInPlace();this.compose(u);break}}}this.reselectNodeAfterAction(h?this.getTheNodesOnTheSameSideAsTheTarget(h.mapNodes(s),n):this.getTheNodesOnTheSameSideAsTheTarget(s,n));this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();i.prototype.move_actions.push(gmath.actions.EqInvertAndCommuteTermAction);gmath.actions.EqInvertPowerAction=function(){var e=function(t){Action.call(this,"invert power across equation");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.nodesAreASingleExponent(t)&&!this.nodesAreARangeOfMulsInAnExponent(t))return[];if(!this.expressionIsAnEquation(t))return[];if(!this.powerIsTheTopLevelGroupOnThisSideOfTheEquation(t))return[];return[this.createBoundAction(t[0].get_root(),{nodes:t,target:this.getOtherSideOfEquation(t),side:"around"})]};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreARangeOfMulsInAnExponent=function(e){try{return t.is_range(e)&&e.every(function(e){return e.is_group("mul")&&t.get_parent(2,e).is_group("exponent")})}catch(i){if(i!=="invalid path")throw i;return false}};e.prototype.expressionIsAnEquation=function(t){var e=t[0].get_root();return e.children[0].is_group("equals")};e.prototype.powerIsTheTopLevelGroupOnThisSideOfTheEquation=function(t){var e=t[0].get_root().children[0],i=t[0];while(!i.is_group("power"))i=i.parent;return e.children[0]===i||e.children[2]===i};e.prototype.getOtherSideOfEquation=function(t){var e=t[0].get_root().children[0];var i=t[0].get_path();return i[1]===0?e.children[2]:e.children[0]};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes[0].get_root());var e=this.getNewTreeNode(this.nodes),i=this.getOtherSideOfEquation(e);this.extractRangeFromExponent(e);var r=this.convertNodesToReciprocalAndPrepareExponent(e);this.wrapTermInPower(i,r);r.update_y_during_dragging=true;this.reselectNodeAfterAction(r);if(typeof t==="function")t(this);else return true};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,r=e[0].parent,n=r.children[0],o=e[0];var s=r.remove();n.remove();o.remove();i.insert(s,n);return n}else{var r=e[0].get_parent(4),o=r.children[1],a=o.children[0],h=a.children[1];t.remove_range(e);this.cleanup(h);l.handle(a,true);return r}};e.prototype.convertNodesToReciprocalAndPrepareExponent=function(t){var e;if(t[0].is_group("exponent")){this.invertContentsOfExponent(t[0]);e=t[0]}else{e=this.invertMulsAndPutInProductFractionExponentStructure(t)}return e};e.prototype.invertContentsOfExponent=function(t){var e=t.children[0];if(e.is_group("brackets")&&e.children[1].is_group("product","fraction")){this.convertToReciprocal(e.children[1]);l.handle(e,true)}else{var i=f.prototype.createGroup();e.remove();i.append(new f(new n(1)));i.append(new f(e,"div"));t.append(i);l.handle(i)}};e.prototype.convertToReciprocal=function(e){var i=e.parent,r=e.remove();var o;if(e.is_group("product")){var s=e.children.slice();t.remove_range(e.children);s.forEach(function(t){t.invert()});var a=f.prototype.createGroup();s.forEach(function(t){a.append(t)});o=a}else{var h=e.get_top(),l=e.get_bottom();if(h.length===1&&n.get_value(h[0].children[1])===1){var u=f.prototype.createGroup();t.remove_range(l);l.forEach(function(t){t.invert()});u.append_range(l);o=u}else{t.remove_range(h);t.remove_range(l);h.forEach(function(t){t.invert()});l.forEach(function(t){t.invert()});l.forEach(function(t){e.append(t)});h.forEach(function(t){e.append(t)});o=e}}i.insert(r,o)};e.prototype.invertMulsAndPutInProductFractionExponentStructure=function(t){var e=f.prototype.createGroup();t.forEach(function(t){t.invert()});t.forEach(function(t){e.append(t)});return new v(e)};e.prototype.wrapTermInPower=function(t,e){var i=t.parent,r=t.remove(),n=t;var o=new g(n,e);i.insert(r,o);l.handle(o);if(e.children[0].is_group("brackets")){this.cleanup(e.children[0].children[1]);l.handle(e.children[0],true)}return e};return new e}();i.prototype.move_actions.push(gmath.actions.EqInvertPowerAction);i.prototype.hideNodesAction=function(){var t=function(t){Action.call(this,"apply hide rules")};gmath.inherit(Action,t);t.prototype.doInPlace=function(e,i){var r=false;if(e.children.length>0){e.children[0].for_each(function(i){var n=i.hidden,s=i.hide_afer_drop;i.hidden=false;i.hide_after_drop=false;if(e.options.hide_leading_op&&i instanceof o&&i.parent&&i.parent.commutative){if(i.parent.associative&&!i.parent.ls||i.parent.value=="div"&&i.parent.ls&&i.parent.ls.value=="//"){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}if(i instanceof o&&p.is_lone_fraction_part(i.parent)){i.hidden=true}if(i.value==="("||i.value===")"){var a=i.parent;if(a.parent.vertical_notation||a.parent.parent&&a.parent.parent.vertical_notation){var h=a;while(h.is_group("brackets"))h=h.children[1];if(!l.is_optional(h,a.parent)&&t.isLoneMulDivInNumeratorOrDenominator(a.parent)){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}}for(var u=0;u<e.hide_rules.length&&!i.hidden;u++){var c=e.hide_rules[u];if(!c.disabled)c.apply(i)}r=r||i.hidden!=n||i.hide_after_drop!=s})}if(typeof i==="function")i(this);else return r};t.isLoneMulDivInNumeratorOrDenominator=function(t){return!(t.ls&&t.ls.is_group(t.value)||t.rs&&t.rs.is_group(t.value))};return new t}();gmath.actions.SwitchAction=function(){var e=function(t){Action.call(this,"switch terms in a flat representation");if(t){this.node=t.node;this.target=t.target;this.side=t.side;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var r=[];var n=e[0].parent.is_group("flat"),o;if(!n)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e[0],o))r.push(this.createBoundAction(i,{node:e[0],side:"around",target:o}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e[0],o))r.push(this.createBoundAction(i,{node:e[0],side:"around",target:o}))}};e.prototype.match=function(t,e){return t.parent===e.parent&&t!==e&&!(e instanceof o)&&!(t instanceof o)};e.prototype.transform=function(e){var i=tree===this.target.get_root();var r=i?this.node:tree.get_child(this.node.get_path());var n=i?this.target:tree.get_child(this.target.get_path());t.switch_siblings(r,n);if(typeof e==="function")e(this);else return true};return new e}();i.prototype.move_actions.push(gmath.actions.SwitchAction);(function(){var t=function(t){Action.call(this,"flip equation");if(t)this.actor=t.actor;this.priority=1};gmath.inherit(Action,t);t.prototype.match=function(t){return t.is_group("equals")};t.prototype.transform=function(t){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(e(this.actor));this.addTouchedNodes(i(this.actor));var n=e(r),o=i(r);n.remove();o.remove();var s=0,a=2;r.insert(s,o);r.insert(a,n);if(typeof t==="function")t(this);return this};b.prototype.add_action_handler(new t);var e=function(t){return t.children[0]};var i=function(t){return t.children[2]}})();gmath.actions.RewriteNumberWithKeyboardAction=function(){var t=function(t){Action.call(this,"split a number");this.priority=0;if(t){this.actor=t.actor;this.asynchronous=true}};gmath.inherit(Action,t);t.prototype.match=function(t){if(!n.is_num(t)&&!(t.is_group("sign")&&n.is_num(t.children[1])))return false;if(typeof Keyboard==="undefined"||Keyboard===null)return false;return true};t.prototype.transform=function(e){var r=Keyboard();r.caption("Enter an expression equivalent to this number.").on("done",s).on("cancel",a)();var o=this;function s(s){var a=o.newTree;var h=a.parse(s,true),l=new i(s);var u=o.getNewTreeNode(o.actor);if(t.evalExpression(l.children[0])!==n.get_value(u)){return o.endKeyboardInteraction(r)}o.replaceNumWithExpression(u,h);o.updateNodeMap(o.actor.get_mapping_to(h));r.visible(false);r.on("done",null).on("cancel",null);if(typeof e==="function")e(o);else return true}function a(){r.visible(false);r.on("done",null).on("cancel",null);e(false)}r.caption("Enter an expression with which to replace the selected number.");r.latex("").visible(true)};t.evalExpression=function(e){if(!e)return NaN;if(n.is_num(e))return n.get_value(e);var i=t.evalExpression;if(e.is_group("mul","add","brackets"))return i(e.children[1]);if(e.is_group("sign","sub"))return-i(e.children[1]);if(e.is_group("div"))return 1/i(e.children[1]);if(e.is_group("exponent"))return i(e.children[0]);if(e.value==="//")return 1;var r=function(t,e){return t+e},o=function(t,e){return t*e};if(e.is_group("product","fraction"))return e.children.map(i).reduce(o,1);if(e.is_group("sum"))return e.children.map(i).reduce(r,0);if(e.is_group("power"))return Math.pow(i(e.children[0]),i(e.children[1]));return NaN};t.prototype.replaceNumWithExpression=function(t,e){var i=t.parent,r=t.remove();i.insert(r,e);this.cleanup_cascade(i)};t.prototype.endKeyboardInteraction=function(t){t.visible(false);t.on("done",null).on("cancel",null);return false};return new t}();gmath.actions.EquationFountain=function(){var e=function(t){Action.call(this,"rewrite equation");if(t)this.target=t.target;this.priority=0;this.asynchronous=true};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("equals")};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root(),r=this;return t.filter(this.match,e).map(function(t){return r.createBoundAction(i,{target:t})})};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.target);var n=this;var o=Keyboard();o.on("done",s).on("cancel",a)();function s(s){var a=new i(s).children[0];var h=r.children[0],u=r.children[2];var c=i.getNodes("E",0,a);if(!c)return;var d=a.clone();var p=i.getNodes("E",0,d);if(!p)return;t.replace(h,a);h.parent=null;t.replace(c,h);l.handle(h);n.cleanup(h.parent);t.replace(u,d);u.parent=null;t.replace(p,u);l.handle(u);n.cleanup(u.parent);o.visible(false);o.on("done",null).on("cancel",null);e(n)}function a(){console.log("cancelled");o.visible(false);o.on("done",null).on("cancel",null);e(false)}o.caption("Enter an operation to apply to both sides of the equation.");o.latex("E").visible(true)};return new e}();gmath.actions.FractionExtendAction=function(){var e=function(t){Action.call(this,"extend fraction");if(t)this.target=t.target;this.priority=0;this.asynchronous=true};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("fraction")};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root(),r=this;return t.filter(this.match,e).map(function(t){return r.createBoundAction(i,{target:t})})};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.target),i=e.get_root(),r=this;var n=Keyboard();n.on("done",o).on("cancel",s)();function o(o){var s=i.parse(o,true);if(!s)return;r.extend_fraction(e,s);n.visible(false);n.on("done",null).on("cancel",null);t(r)}function s(){console.log("cancelled");n.visible(false);n.on("done",null).on("cancel",null);t(false)}n.latex("").visible(true)};e.prototype.extend_fraction=function(t,e){t.append(new f(e,"mul"));t.append(new f(e.clone(),"div"));this.cleanup(t)};return new e}();gmath.actions.SplitNumeratorAction=function(){var e=function(t){Action.call(this,"split numerator into new fractions with same denominators");if(t){this.nodes=t.nodes;this.target=t.target;this.side=Array.isArray(this.target)?"around":t.side;this.target_is_left=t.side==="left-of";this.offset={x:this.target_is_left?-10:10,y:0};this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.parent||!e.parent.parent||!e.parent.parent.parent||!e.parent.parent.parent.parent)return[];if(!(e.is_group("add")||e.is_group("sub"))||!e.parent.parent.parent.is_group("mul")||!e.parent.parent.parent.parent.is_group("fraction"))return[];if(this.match(t,e.parent.parent.parent.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var r=[];if(this.fractionIsPartOfProduct(t)){r=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:r.length>0?r:t[0].parent.parent.parent.parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("sum")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,r=i.parent,n=r.parent;if(e==="left-of")return n.children.slice(0,n.children.indexOf(r));else return n.children.slice(n.children.indexOf(r)+1)};e.prototype.match=function(t,e){if(t.length===0)return false;return t[0]&&(t[0].is_group("add")||t[0].is_group("sub"))&&t[0].parent.parent.parent.parent===e&&e.is_group("fraction")};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var r=this.nodes[0].parent.parent.parent.parent.get_bottom(),n=this.nodes[0].parent.parent.parent.parent.children[1];var o=i[0].parent.parent.parent.parent;t.remove_range(i);var s=d.prototype.createGroup();o.replace_with(s);s.append(new d(o));var a=o.get_bottom();var h=new p;h.invert();var u=d.prototype.createGroup();u.append_range(i);h.insert(0,new f(u));for(var c=0;c<a.length;c++){var g=t.clone(a[c]);h.append(g);this.extendNodeMap(r[c].get_mapping_to(g))}this.extendNodeMap(n,h.children[1]);var v=new d(h);s.insert(this.target_is_left?0:1,v);var m=this.rearrangeSumIfNumeratorIsASingleTerm(s,0),_=this.rearrangeSumIfNumeratorIsASingleTerm(s,1);if(this.target_is_left&&!m||!this.target_is_left&&!_){for(var c=0;c<i.length;c++){this.updateNodeMap(i[c],v)}}var y=o.get_top(),w=h.get_top();if(y.length===1)this.cleanup(y[0]);if(w.length===1)this.cleanup(w[0]);this.cleanup(s.parent);l.handle(s);if(typeof e==="function")e(this);else return true};e.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(t,e){var i=t.children[e],r=i.children[1];if(r.children[0].children[1].children[1].children.length===1){var n=r.children[0].children[1].children[1],o=n.children[0],s=o.children[1],a=n.parent.parent;n.parent.remove();o.remove();s.remove();n.remove();r.remove();i.remove();t.insert(e,o);o.append(r);a.append(s);return true}return false};return new e}();i.prototype.move_actions.push(gmath.actions.SplitNumeratorAction);(function(){var e=function(t){Action.call(this,"group cleanup action");if(t)this.group=t.actor};gmath.inherit(Action,e);gmath.actions.CommutativeGroupCleanup=e;e.prototype.match=function(t){return t.is_group()&&(!t.has_children()||t.children.length===1)};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.group);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var r=i.children[0],n=this.group.children[0],o=r.children[1];this.updateNodeMap(n.children[0],o);this.updateNodeMap(n,o);this.updateNodeMap(n.parent,o);t.replace(r.parent,o);if(o.parent.parent)l.handle(o.parent,true);l.handle(o,true)}if(typeof e==="function")e(this);else return this};w.prototype.cleanupAction=new e;_.prototype.cleanupAction=new e})();(function(){var e=function(t){Action.call(this,"--x=x");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children.length==2&&(t.children[1].is_group("sign")||t.parent.is_group("sign"))};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);if(i.children[1].is_group("sign")){this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[1].children[0]);t.replace(i,i.children[1].children[1])}else if(i.parent.is_group("sign")){this.addTouchedNodes(this.actor.parent.children[0]);this.addTouchedNodes(this.actor.children[0]);t.replace(i.parent,i.children[1])}if(typeof e==="function")e(this);else return true};e.prototype.updateNodesFromFutureAndPast=function(){};u.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"-0=0");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[1]instanceof n&&t.children[1].value===0};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),r=i.children[1];this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(r));t.replace(i,r);if(typeof e==="function")e(this);else return this};u.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"integer exponents");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.parent;if(!e.is_group("power"))return false;var i=e.children[0],r=t.children[0];if(i.is_group("brackets"))i=i.children[1];if(!n.is_num(i))return false;return n.is_num(i)&&r instanceof n&&Math.round(r.value)==r.value&&r.value!==0};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var r=i.parent,o=r.children[0],s=i.children[0];if(o.is_group("brackets"))o=o.children[1];var a=new n(Math.pow(n.get_value(o),s.value));this.updateNodeMap(this.actor.parent.get_mapping_to(a));t.replace(r,a);if(typeof e==="function")e(this);else return true};v.prototype.add_action_handler(new e)})();(function(){function e(t,i,r,n){var o=r;n[t]=[i];if(o.has_children()){for(var s=0;s<o.children.length;s++){e(t.concat(s),i.concat(s),r.children[s],n)}}}var i=function(t){Action.call(this,"x^1=x");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,i);i.prototype.match=function(t){return t.children[0]instanceof n&&t.children[0].value===1};i.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var r=i.ls;t.remove(r);i.parent.replace_with(r);l.handle(r);this.updateNodeMap(this.actor.parent,r);this.updateNodeMap(this.actor,r);this.updateNodeMap(this.actor.children[0],r);if(typeof e==="function")e(this);else return true};v.prototype.add_action_handler(new i)})();(function(){var e=function(t){Action.call(this,"x^0=1");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[0]instanceof n&&t.children[0].value===0&&t.ls.to_ascii()!=="0"};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var r=new n(1);this.updateNodeMap(this.actor.parent.get_mapping_to(r));t.replace(i.parent,r);if(typeof e==="function")e(this);else return true};v.prototype.add_action_handler(new e)})();gmath.actions.CollectExponentsForFactoring=function(){var t=function(t){Action.call(this,"collect exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side="inside"}this.makes_no_changes=true};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root(),i=this;try{var r=this.analyzeNodeStructure(t);if(r.length===0)return[];var n=r[0].prod,o=[];for(var s=0;s<n.children.length;s++){try{var a=n.get_child([s,1,1]);var h=this.getTargetRangesInExponent(a,r);h.forEach(function(r){o.push(i.createBoundAction(e,{nodes:t,target:r[0].is_group("product")?[r[0].parent.parent]:r}))})}catch(l){if(l!=="invalid path")throw l}}return o}catch(l){if(l!=="invalid path"&&l!=="wrong structure")throw l}return[]};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes[0]),i=this.getNewTreeNode(this.target);this.updateNodeMap(this.nodes[0],[e].concat(i));if(typeof t==="function")t(this);else return true};t.prototype.analyzeNodeStructure=function(t){var e=i.groupNodeRanges(t);if(e.length===0)return[];var r=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];if(e.is_group("brackets")&&e.children[0].hidden){e=e.children[1]}return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:i.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<r.length;n++){var o=r[n];if(o.ascii!==r[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==r[0].prod)return[];for(var s=n+1;s<r.length;s++){if(o.exp===r[s].exp)return[]}}return r};t.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var r=e[0].ascii;for(var n=0;n<e.length;n++)if(e[n].exp===t)return[];var o=i.getRanges(r,null,t.children);if(o.length===0)return[];o=o.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul")&&i.get_parent(4)===t});return o.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};return new t}();i.prototype.move_actions.push(gmath.actions.CollectExponentsForFactoring);gmath.actions.FactorPowerAction=function(){var e=function(t){Action.call(this,"factor power");if(t){this.nodes=t.nodes;this.target=t.target;this.side="outside";this.margin=t.margin?t.margin:null}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e,i=this.getEncompassingRange(t);if(this.thereIsALonePower(t)){if(this.transformationWouldLeaveExponentOfOne(t)){return[]}e=this.bindActionForLonePowerCases(t,i.length-1)}else if(i.length>0){e=this.bindActionForMultiplePowerCases(t,i)}else{return[]}return e};e.prototype.transform=function(t){if(Array.isArray(this.target)){for(var e=0;e<this.target.length;e++){this.addTouchedNodes(this.target[e])}}else{this.addTouchedNodes(this.target)}var r=i.groupNodeRanges(this.nodes);var n=this.getNewTreeNode(this.nodes),o=i.groupNodeRanges(n);var s;if(this.thereIsOneRange(o)){s=this.factorFromALonePower(n)}else{s=this.factorFromMultiplePowers(o)}this.mapOldRangesToNewRange(r,s);if(typeof t==="function")t(this);else return true};e.prototype.factorFromALonePower=function(t){var e=this.extractRangeFromExponent(t);return this.wrapTermInPower(e,t)};e.prototype.factorFromMultiplePowers=function(t){var e=this.getParentGroupOfPowers(t[0][0]);var i;if(!this.productFractionHasUnaffectedTerms(e,t)){i=this.performTransformationWithoutUnaffectedTerms(t,e)}else{i=this.performTransformationWithUnaffectedTerms(t,e)}return i};e.prototype.productFractionHasUnaffectedTerms=function(t,e){if(t.is_group("product")){return t.children.length>e.length}else{return t.children.length-1>e.length}};e.prototype.performTransformationWithoutUnaffectedTerms=function(t,e){for(var i=0;i<t.length;i++){this.extractRangeFromExponent(t[i])}return this.wrapTermInPower(e,t[0])};e.prototype.performTransformationWithUnaffectedTerms=function(t,e){var i=this.getAffectedTerms(t);var r=this.getIDXForFactoredStructure(i);var n=this.putAffectedTermsIntoASeparateProduct(i);var o;if(n.is_group("product")){e.insert(r,new f(n,e.is_group("fraction")&&r>e.get_top().length?"div":"mul"))}else{var s=e.parent,a=e.remove();var h=f.prototype.createGroup();h.append(new f(e));h.append(new f(n));s.insert(a,h);this.cleanup(e);this.cleanup(h.children[0])}for(var l=0;l<t.length;l++){this.extractRangeFromExponent(t[l])}o=this.wrapTermInPower(n,t[0]);return o};e.prototype.getIDXForFactoredStructure=function(t){var e;for(var i=0;i<t.length;i++){var r=t[i],n=r.parent.children.indexOf(r);if(!e&&e!==0)e=n;else if(n<e)e=n}return e};e.prototype.putAffectedTermsIntoASeparateProduct=function(t){var e=f.prototype.createGroup();t.forEach(function(t){t.remove()});if(t.every(function(t){return t.is_group("div")})){t.forEach(function(t){t.invert()})}for(var i=0;i<t.length;i++){e.append(t[i])}return e};e.prototype.mapOldRangesToNewRange=function(t,e){for(var i=0;i<t.length;i++){var r=t[i];for(var n=0;n<r.length;n++){if(r[n].is_group("exponent")){this.updateNodeMap(r[n].get_mapping_to(e))}else if(r[n].is_group("mul")){if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.updateNodeMap(r[n].get_mapping_to(e.children[0].children[1].children[n]))}else{this.updateNodeMap(r[n],e);if(this.newTree!==this.oldTree){this.updateNodeMap(r[n].children[1],e.children[0])}}}}}};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,r=e[0].parent,n=r.children[0],o=e[0];var s=r.remove();n.remove();o.remove();i.insert(s,n);return n}else{var r=e[0].get_parent(4),o=r.children[1],a=o.children[0],h=a.children[1];t.remove_range(e);this.cleanup(h);return r}};e.prototype.wrapTermInPower=function(t,e){var i,r,n;if(t.parent.is_group("brackets")){i=t.parent;r=i.parent;n=i.remove()}else{r=t.parent;n=t.remove();i=new l(t)}var o;var s;if(e[0].is_group("exponent")){o=e[0]}else if(e[0].is_group("mul")&&e.length===1){o=e[0].children[1];o.remove();o=new v(o)}else{s=f.prototype.createGroup();for(var a=0;a<e.length;a++){s.append(e[a]);e[a].update_y_during_dragging=true}o=new v(s)}var h=new g(i,o);if(i.is_group("brackets"))i.simplify=true;r.insert(n,h);l.handle(h);if(s)this.cleanup(s);return o};e.prototype.getParentGroupOfPowers=function(t){if(t.is_group("exponent"))return t.parent.parent.parent;else return t.parent.parent.parent.parent.parent.parent};e.prototype.getAffectedTerms=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(this.getParentMulFromExponentTerm(t[i][0]))}return e};e.prototype.getParentMulFromExponentTerm=function(t){if(t.is_group("exponent"))return t.parent.parent;else return t.parent.parent.parent.parent.parent};e.prototype.thereIsOneRange=function(t){return t.length===1};e.prototype.thereIsALonePower=function(t){return t.length===1&&t[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(t)};e.prototype.transformationWouldLeaveExponentOfOne=function(t){if(!t[0].is_group("mul","div")){return false}var e=t[0].parent;if(e.is_group("product")&&t.length+1===e.children.length){var i;for(var r=0;r<e.children.length;r++){var o=e.children[r];if(t.indexOf(o)===-1){i=o;break}}if(n.get_value(o.children[1])===1){return true}}else if(e.is_group("fraction")&&t.every(function(t){return t.is_group("div")})){var s=e.get_top();if(s.length===1&&n.get_value(s[0].children[1])===1){return true}}return false;
};e.prototype.allNodesAreMulsWithinSameProduct=function(t){var e;for(var i=0;i<t.length;i++){var r=t[i];if(!r.is_group("mul","div"))return false;if(!e)e=r.parent;else if(r.parent!==e)return false}return true};e.prototype.bindActionForLonePowerCases=function(t,e){var i;var r={all:-.5};try{var n=t[0];if(n.is_group("exponent")){var o=n.get_parent(2);if(o.is_group("brackets")&&!o.parent.is_group("power")){i=this.createBoundAction(n.get_root(),{nodes:t,target:o})}else return[]}else if(n.is_group("mul","div")){var s=n.get_parent(2),a=s.get_parent(1),h=a.get_parent(1),l=h.get_parent(1);if(!s.is_group("brackets")||!a.is_group("exponent")||!h.is_group("power"))return[];var u;if(!l.is_group("brackets","mul","div"))u=h;else if(l.is_group("brackets")&&!l.parent.is_group("power"))u=l;else if(l.is_group("mul","div")&&e>0){r.all=-1.5;u=l.parent}else if(l.is_group("mul","div")&&e<=0)u=h;else return[];i=this.createBoundAction(n.get_root(),{nodes:t,target:u,margin:r?r:null})}else return[]}catch(c){if(c==="invalid path")return[];else throw c}return[i]};e.prototype.bindActionForMultiplePowerCases=function(t,e){var i;if(e.length===0)return[];var r=this.getBestTarget(e);i=[this.createBoundAction(t[0].get_root(),{nodes:t,target:r})];return i};e.prototype.getEncompassingRange=function(e){var i=e[0].get_root(),r=this;try{var n=this.analyzeNodeStructure(e);if(n.length===0)return[];var o=n[0].prod,s=[];for(var a=0;a<o.children.length;a++){try{var h=o.get_child([a,1,1]);var l=this.getTargetRangesInExponent(h,n);l.forEach(function(t){s=s.concat(t)})}catch(u){if(u!=="invalid path")throw u}}return t.nodes_to_range(s)}catch(u){if(u!=="invalid path"&&u!=="wrong structure")throw u}return[]};e.prototype.analyzeNodeStructure=function(t){var e=i.groupNodeRanges(t);if(e.length===0)return[];var r=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:i.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<r.length;n++){var o=r[n];if(o.ascii!==r[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==r[0].prod)return[];for(var s=n+1;s<r.length;s++){if(o.exp===r[s].exp)return[]}}return r};e.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var r=e[0].ascii;var n=i.getRanges(r,null,t.children);if(n.length===0)return[];n=n.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul","div")&&i.get_parent(4)===t});return n.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};e.prototype.getBestTarget=function(t){var e;var i=t[0].parent;if(i.is_group("product")&&i.children.length>t.length||i.is_group("fraction")&&i.children.length-1>t.length){e=t}else{var r=t[0].parent.parent;if(r.is_group("brackets")&&!r.children[0].hidden)e=r;else e=t[0].parent}return e};return new e}();i.prototype.move_actions.push(gmath.actions.FactorPowerAction);gmath.actions.DistributePowerAction=function(){var e=function(t){Action.call(this,"distribute power");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i,r,n;try{if(this.nodesAreASingleExponent(t)){n=t[0];r=n.parent;i=r.children[0]}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){n=t[0].get_parent(3);r=n.get_parent(1);i=r.children[0]}else{return[]}}catch(o){if(o!=="invalid path")throw o;return[]}if(!n.is_group("exponent")||!r.is_group("power")||!i.is_group("brackets")){return[]}var i=i.children[1];if(i.is_group()&&!i.is_group("power")&&!i.is_group("brackets")&&!i.is_group("product")&&!i.is_group("fraction"))return[];return[this.createBoundAction(e,{nodes:t,target:i,side:"inside"})]};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent);var r=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var o=i.parent;var s=o.parent;this.addTouchedNodes(this.getOldTreeNode(o));t.remove_range(r);var a;if(n.is_group("product")||n.is_group("fraction")){a=n.get_top().concat(n.get_bottom());this.applyPowersToMulDivs(a,r)}else{a=[this.applyPowerToSingleTerm(n,r)];n=a[0]}if(o.children[1]){this.cleanup(o.children[1].children[0].children[1]);l.handle(o.children[1].children[0],true)}else{var h=o.remove();var u=new l(n);s.insert(h,u);u.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.applyPowersToMulDivs=function(t,e){for(var i=0;i<t.length;i++){var r=t[i].children[1];var n=this.applyPowerToSingleTerm(r,e)}};e.prototype.applyPowerToSingleTerm=function(t,e){var i;if(t.is_group("power")){i=this.applyPowerToPower(t,e)}else{i=this.applyPowerToNonPower(t,e)}return i};e.prototype.applyPowerToPower=function(e,i){var r=e;var n=t.clone(i);var o=this.extendPowerWithSelectedExponentTerms(r,n);this.extendNodeMap(this.nodes[0],o);this.updateXAndYDuringDragging(o);return r};e.prototype.applyPowerToNonPower=function(e,i){var r,n;r=e.parent;n=e.remove();var o;if(i[0].is_group("exponent"))o=t.clone(i[0]);else{var s=f.prototype.createGroup(),a=t.clone(i);this.appendAllContentsToProduct(s,a);o=new v(s)}var h=new g(e,o);r.insert(n,h);if(s){this.cleanup(s);l.handle(o.children[0],true)}this.mapDraggedExponentTermsToNewExponent(this.nodes,h.children[1]);this.updateXAndYDuringDragging(h);return h};e.prototype.mapDraggedExponentTermsToNewExponent=function(t,e){for(var i=0;i<t.length;i++){if(t[i].is_group("exponent")){this.extendNodeMap(t[i].get_mapping_to(e))}else{if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.extendNodeMap(t[i].get_mapping_to(e.children[0].children[1].children[i]))}else{this.extendNodeMap(t[i],e);this.extendNodeMap(t[i].children[1].get_mapping_to(e.children[0]))}}}};e.prototype.takeContentsOfBrackets=function(t){if(t.is_group("brackets")){t=t.children[1];t.remove()}return t};e.prototype.extendPowerWithSelectedExponentTerms=function(t,e){var i=t.children[1];var r=f.prototype.createGroup(),n=this.getContentMulsFromExponent(i);var o=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(r,n);this.appendAllContentsToProduct(r,o);i.append(r);this.cleanup(r);l.handle(r,true);this.mapDraggedExponentTermsToNewExponentTerms(this.nodes,i,o);return o};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i])}};e.prototype.mapDraggedExponentTermsToNewExponentTerms=function(t,e,i){if(t[0].is_group("mul")){for(var r=0;r<t.length;r++){this.extendNodeMap(t[r].get_mapping_to(i[r]))}}else if(t[0].is_group("exponent")){var n=t[0].children[0];if(n.is_group("brackets")&&n.children[1].is_group("product")){for(var r=0;r<n.children[1].children.length;r++){var o=n.children[1].children[r];this.extendNodeMap(t[0],i[r]);this.extendNodeMap(o.get_mapping_to(i[r]))}}else{if(n.is_group("brackets")&&!i[0].children[1].is_group("brackets")){this.extendNodeMap(n.children[1].get_mapping_to(i[0].children[1]))}else{this.extendNodeMap(n.get_mapping_to(i[0].children[1]))}}}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(i.is_group("brackets")&&i.children[0].hidden&&i.children[1].is_group("product")){var r=i.children[1].children.slice();t.remove_range(i.children[1].children);i.remove();return r}else if(i.is_group("brackets")&&i.children[0].hidden){var n=i.children[1];n.remove();i.remove();return[new f(n)]}else{i.remove();return[new f(i)]}};e.prototype.updateXAndYDuringDragging=function(t){var e;if(!Array.isArray(t))e=[t];else e=t.slice();for(var i=0;i<e.length;i++){e[i].update_x_during_dragging=true;e[i].update_y_during_dragging=true}};return new e}();i.prototype.move_actions.push(gmath.actions.DistributePowerAction);gmath.actions.combineStackedExponentsUpAction=function(){var e=function(t){Action.call(this,"combine stacked exponents up");if(t){this.nodes=t.nodes;this.target=t.target;this.side="around"}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length<1)return[];if(!this.validStructure(t))return[];var e=this.getBaseOfOuterPowerFromInnerExponentTerm(t);var i=e.parent.children[1];var r=[this.createBoundAction(t[0].get_root(),{nodes:t,target:i})];return r};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target),r=i.parent.children[0];this.addTouchedNodes(this.target.parent);this.extractSelectedExponentTermsFromInnerPower(e);var n=this.extendOuterExponentWithSelectedExponentTerms(r,e);this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,n);r.simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.validStructure=function(t){if(this.nodesAreASingleExponent(t)){return this.termsBelongToAPowerWithinAPower(t)}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){return this.termsBelongToAPowerWithinAPower(t)}else return false};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.termsBelongToAPowerWithinAPower=function(t){try{var e,i,r,n;if(t[0].is_group("exponent")){e=t[0];i=e.get_parent(1);r=i.get_parent(1);n=r.get_parent(1);if(!i.is_group("power")||!r.is_group("brackets")||!n.is_group("power"))return false}else{e=t[0].get_parent(3);i=e.get_parent(1);r=i.get_parent(1);n=r.get_parent(1);if(!e.is_group("exponent")||!i.is_group("power")||!r.is_group("brackets")||!n.is_group("power"))return false}}catch(o){if(o!=="invalid path")throw o;return false}return true};e.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(t){if(t[0].is_group("exponent"))return t[0].get_parent(2);else return t[0].get_parent(5)};e.prototype.extractSelectedExponentTermsFromInnerPower=function(e){if(e[0].is_group("exponent")){var i=e[0].parent,r=e[0],n=i.children[0],o=i.parent;var s=i.remove();n.remove();r.remove();o.insert(s,n)}else{var a=e[0].parent,h=a.parent;t.remove_range(e);this.cleanup(a)}};e.prototype.extendOuterExponentWithSelectedExponentTerms=function(t,e){var i=t.parent,r=i.children[1];var n=f.prototype.createGroup(),o=this.getContentMulsFromExponent(r);var s=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(n,o);this.appendAllContentsToProduct(n,s);r.append(n);this.cleanup(n);l.handle(n);return s};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i]);e[i].update_y_during_dragging=true}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(i.is_group("brackets")&&i.children[0].hidden&&i.children[1].is_group("product","fraction")){var r=i.children[1].children.slice();t.remove_range(i.children[1].children);i.remove();return r}else if(i.is_group("brackets")&&i.children[0].hidden){var n=i.children[1];n.remove();i.remove();return[new f(n)]}else{i.remove();return[new f(i)]}};e.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(t,e){for(var i=0;i<t.length;i++){for(var r=0;r<e.length;r++){if(r===0)this.updateNodeMap(t[i],e[r]);else this.extendNodeMap(t[i],e[r])}}};return new e}();i.prototype.move_actions.push(gmath.actions.combineStackedExponentsUpAction);gmath.actions.PowerFactorAndCombineStackedExponentsAction=function(){var t=function(t){Action.call(this,"factor power and combine stacked exponent up");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length<2)return[];var e=gmath.actions.FactorPowerAction.getAllAvailableActions(t);if(e.length===0)return[];var i=e[0];if(Array.isArray(i.target))return[];if(!i.target.is_group("brackets"))return[];if(!this.nodesAccountForEveryTermInProduct(i.target.children[1],t))return[];if(!i.target.parent.is_group("power"))return[];var r=i.target.parent.children[1];var n=this.createBoundAction(t[0].get_root(),{nodes:t,target:r,side:"inside"});return[n]};t.prototype.nodesAccountForEveryTermInProduct=function(t,e){var r=[];for(var n=0;n<e.length;n++){var o=e[n].parent;while(!o.is_group("power")&&!i.is_top_most(o)){o=o.parent}if(r.every(function(t){return t!==o})){r.push(o)}}return r.length===t.children.length};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.target.parent;this.addTouchedNodes(e);var i=this.getNewTreeNode(this.nodes);var r=gmath.actions.FactorPowerAction.getAllAvailableActions(i)[0];r.doInPlace();this.compose(r);var n=r.mapNodes(i);var o=gmath.actions.combineStackedExponentsUpAction.getAllAvailableActions(n)[0];o.doInPlace();this.compose(o);e=this.mapNodes(e)[0];l.handle(e.children[0],true);this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();i.prototype.move_actions.push(gmath.actions.PowerFactorAndCombineStackedExponentsAction);(function(){var e=function(t){Action.call(this,"polynomial expansion");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("exponent"))return false;if(!t.children[0]||!n.is_num(t.children[0]))return false;if(n.get_value(t.children[0])!==2&&n.get_value(t.children[0])!==3)return false;var e=t.parent,i=e.children[0];if(!i.is_group("brackets"))return false;if(!i.children[1].is_group("sum"))return false;return true};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var r=this.analyzeStructure(e);var n=this.formAddendsForExpandedPolynomial(r);n.sort(function(t,e){if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder>=e.degreeOfFirstOrder)return 0;if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder<e.degreeOfFirstOrder)return 1;if(t.firstOrder<e.firstOrder)return-1;if(t.firstOrder>e.firstOrder)return 1});this.replacePowerWithExpandedPolynomialSum(i,n);if(typeof t==="function")t(this);else return true};e.prototype.analyzeStructure=function(t){var e={};var i=t.parent,r=i.children[0],o=r.children[1];e.degree=n.get_value(t.children[0]);e.terms=o.children.slice();return e};e.prototype.formAddendsForExpandedPolynomial=function(t){var e;if(t.degree===2){e=this.formAddendsForDegreeOfTwo(t.terms)}else if(t.degree===3){e=this.formAddendsForDegreeOfThree(t.terms)}return e};e.prototype.formAddendsForDegreeOfTwo=function(e){var i=[];for(var r=0;r<e.length;r++){var o=e[r].children[1],s=t.clone(o);this.extendNodeMap(this.getOldTreeNode(o).get_mapping_to(s));var a={};a.addend=new d(new g(s,new n(2)));a.firstOrder=r;a.degreeOfFirstOrder=2;i.push(a)}for(var r=0;r<e.length-1;r++){for(var h=r+1;h<e.length;h++){var l=f.prototype.createGroup();l.append(new f(new n(2)));var u=0;var c=e[r].children[1],p=t.clone(c);this.extendNodeMap(this.getOldTreeNode(c).get_mapping_to(p));if(e[r].is_group("sub"))u=(u+1)%2;var v=e[h].children[1],m=t.clone(v);this.extendNodeMap(this.getOldTreeNode(v).get_mapping_to(m));if(e[h].is_group("sub"))u=(u+1)%2;if(n.get_value(p)!==1)l.append(new f(p));if(n.get_value(m)!==1)l.append(new f(m));var a={};a.addend=new d(l,u?"sub":"add");a.firstOrder=r;a.degreeOfFirstOrder=1;i.push(a)}}return i};e.prototype.formAddendsForDegreeOfThree=function(e){var i=[];for(var r=0;r<e.length;r++){var o=e[r].children[1],s=t.clone(o);this.extendNodeMap(this.getOldTreeNode(o).get_mapping_to(s));var a={};a.addend=new d(new g(s,new n(3)),e[r].value);a.firstOrder=r;a.degreeOfFirstOrder=3;i.push(a)}for(var r=0;r<e.length-1;r++){for(var h=r+1;h<e.length;h++){var l=e[r].children[1],u=e[h].children[1];var c=t.clone(l),p=t.clone(u);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(c));this.extendNodeMap(this.getOldTreeNode(u).get_mapping_to(p));var v=f.prototype.createGroup();v.append(new f(new n(3)));v.append(new f(new g(c,new n(2))));if(n.get_value(p)!==1)v.append(new f(p));var m={};m.addend=new d(v,u.parent.value);m.firstOrder=r;m.degreeOfFirstOrder=2;i.push(m);var _=t.clone(l),y=t.clone(u);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(_));this.extendNodeMap(this.getOldTreeNode(u).get_mapping_to(y));var w=f.prototype.createGroup();w.append(new f(new n(3)));if(n.get_value(_)!==1)w.append(new f(_));w.append(new f(new g(y,new n(2))));var x={};x.addend=new d(w,l.parent.value);x.firstOrder=r;x.degreeOfFirstOrder=1;i.push(x)}}for(var r=0;r<e.length-2;r++){for(var h=r+1;h<e.length-1;h++){for(var b=h+1;b<e.length;b++){var l=e[r].children[1],u=e[h].children[1],A=e[b].children[1];var N=t.clone(l),k=t.clone(u),M=t.clone(A);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(N));this.extendNodeMap(this.getOldTreeNode(u).get_mapping_to(k));this.extendNodeMap(this.getOldTreeNode(A).get_mapping_to(M));var T=f.prototype.createGroup();T.append(new f(new n(6)));if(n.get_value(N)!==1)T.append(new f(N));if(n.get_value(k)!==1)T.append(new f(k));if(n.get_value(M)!==1)T.append(new f(M));var L=0;if(e[r].is_group("sub"))L=(L+1)%2;if(e[h].is_group("sub"))L=(L+1)%2;if(e[b].is_group("sub"))L=(L+1)%2;var a={};a.addend=new d(T,L?"sub":"add");a.firstOrder=r;a.degreeOfFirstOrder=1;i.push(a)}}}return i};e.prototype.replacePowerWithExpandedPolynomialSum=function(t,e){var i=t.parent,r=t.remove();var n=d.prototype.createGroup();for(var o=0;o<e.length;o++){n.append(e[o].addend)}i.insert(r,n);this.applyPowers(e);this.cleanupAddends(e);l.handle(n,true);this.cleanup_cascade(n.parent)};e.prototype.applyPowers=function(t){for(var e=0;e<t.length;e++){var i=t[e].addend?t[e].addend.children[1]:t[e].children[1];if(i.is_group("power")){this.applyPower(t[e].addend?t[e].addend:t[e])}else if(i.is_group("product")){this.applyPowers(i.children.slice())}}};e.prototype.applyPower=function(t){var e=t.children[1],i=e.children[0],r=e.children[1];var n=gmath.actions.DistributePowerAction.getAllAvailableActions([r]);if(n.length>0){n[0].doInPlace();this.compose(n[0],false);if(t.children[1].is_group("brackets")){var o=t.children[1].children[1];o.remove();t.children[1].remove();t.append(o)}}var s=n[0]?n[0].mapNodes(r):[r];for(var a=0;a<s.length;a++){var h=s[a].getBestMatchingAction();if(h&&h.name!=="polynomial expansion"){var l=h.createBoundAction(this.newTree,{actor:s[a]});l.doInPlace();this.compose(l,false)}}};e.prototype.cleanupAddends=function(t){for(var e=0;e<t.length;e++){if(t[e].addend.children[1].is_group("product")){var i=t[e].addend.children[1].children.slice();for(var r=0;r<i.length;r++){this.cleanup(i[r])}}}};v.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"muldiv cleanup action");if(t)this.muldiv=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(e.hasProductChild(t))return true;if(t.parent.cleanupAction&&t.parent.cleanupAction.match(t.parent))return true;return false};e.hasProductChild=function(t){return(t.is_group("mul")||t.is_group("div"))&&t.children[1]&&t.children[1].is_group("product")};e.prototype.doInPlace=function(i){this.initNodeMap();var r=this.getNewTreeNode(this.muldiv);var n=r.parent;if(e.hasProductChild(r)){var o=r.children[1];var s=t.remove(r);this.updateNodeMap(this.muldiv,n);if(this.muldiv.is_group("div"))o.children.forEach(function(t){t.invert()});n.insert_range(s,o.children)}this.cleanup(n);if(typeof i==="function")i(this);else return this};f.prototype.cleanupAction=new e})();gmath.actions.MultiplyNumbersAction=function(){var t=function(t){Action.call(this,"Multiply numbers");this.is_join_action=true;if(t){if(t.interactionType==="drag"){this.interactionType=t.interactionType;this.delay=250;this.margin={x:.1};this.side="inside";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("mul"))return[];if(!n.is_num(t[0].children[1]))return[];var e=this.getOtherNumberMulsInSum(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherNumberMulsInSum=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group("mul")&&n.is_num(i.children[1])&&i.parent===e});return i};t.prototype.bindActionForEachTarget=function(t,e){var i=[];var r=t[0].get_root();for(var n=0;n<e.length;n++){i.push(this.createBoundAction(r,{nodes:t,target:e[n],interactionType:"drag"}))}return i};t.prototype.match=function(t){if(!t.ls)return false;if(t.ls.value!=t.value)return false;var e=t.ls.children[1],i=t.children[1];if(!(n.is_num(e)&&n.is_num(i)))return false;return true};t.prototype.transform=function(t){if(this.interactionType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var e=this.getNewTreeNode(this.sourceMul),i=this.getNewTreeNode(this.targetMul),r=e.parent;var o=i.children[1],s=e.children[1];var a=n.get_value(o)*n.get_value(s);var h=new f(new n(a),e.value);this.updateNodeMap(this.sourceMul,h);this.updateNodeMap(this.sourceMul.children[0],h.children[0]);if(!this.sourceMul.children[1].is_group("sign")&&h.children[1].is_group("sign")){this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1].children[1]))}else{this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1]))}this.updateNodeMap(this.targetMul,h);this.updateNodeMap(this.targetMul.children[0],h.children[0]);if(!this.targetMul.children[1].is_group("sign")&&h.children[1].is_group("sign")){this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1].children[1]))}else{this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1]))}var l=i.remove();r.insert(l,h);e.remove();this.cleanup(r);if(typeof t==="function")t(this);return this};f.prototype.add_action_handler(new t);return new t}();i.prototype.move_actions.push(gmath.actions.MultiplyNumbersAction);(function(){var e=function(t){Action.call(this,"Multiply powers");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.split=function(t){if(t.is_group("power"))return{base:t.children[0],exp:t.children[1]};else return{base:t,exp:new v(new n(1))}};e.prototype.match=function(t){if(t.is_group("power"))t=t.parent;if(!t.ls||!t.is_group("mul"))return false;var e=this.split(t.ls.children[1]),i=this.split(t.children[1]);if(!e||!i)return false;if(e.base.to_ascii()!=i.base.to_ascii()&&!(n.is_num(e.base)&&!e.exp.parent&&(n.get_value(e.base)===1||n.get_value(e.base)===-1)&&t.children[1].is_group("power")))return false;return true};e.prototype.transform=function(e){var i=this;if(this.actor.is_group("power"))this.actor=this.actor.parent;var r=this.getNewTreeNode(this.actor);var o=this.actor.ls;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var s=r.ls.children[1],a=r.children[1];if(h()){p()}else if(c()){p();f()}else{g()}function h(){return n.is_num(s)&&n.get_value(s)===1}function c(){return n.is_num(s)&&n.get_value(s)===-1}function p(){r.ls.remove()}function f(){a.remove();var t=new u(a);r.append(t);i.updateNodeMap(o.children[1].get_mapping_to(t.children[0]))}function g(){var e=i.actor.children[0];i.updateNodeMap(i.actor,s.parent);i.updateNodeMap(i.actor.children[0],s.parent.children[0]);if(s.is_group("power")&&a.is_group("power")){i.updateNodeMap(i.actor.children[1].children[0].get_mapping_to(s.children[0]))}else if(s.is_group("power")){i.updateNodeMap(i.actor.children[1].get_mapping_to(s.children[0]))}else if(a.is_group("power")){i.updateNodeMap(i.actor.children[1].children[0].get_mapping_to(s))}else{i.updateNodeMap(i.actor.children[1].get_mapping_to(s))}if(!s.is_group("power")){var r=v.prototype.createGroup();var o=s.parent;var h=t.remove(s);r.append(s);r.append(new v(new n(1)));t.insert(o,h,r);s=r}var u=i.split(s),c=i.split(a);t.remove(a.parent);var p=u.exp.children[0],f;if(p.is_group("brackets")&&p.children[0].hidden&&p.children[1].is_group("sum")){f=p.children[1]}else{var o=p.parent;t.remove(p);if(p.is_group("brackets")&&p.children[0].hidden){p=p.children[1];p.remove()}f=d.prototype.createGroup();f.append(new d(p));o.append(f)}var g=1;if(c.exp.children[0].is_group("brackets")&&c.exp.children[0].children[0].hidden&&c.exp.children[0].children[1].is_group("sum")){f.append_range(c.exp.children[0].children[1].children);g=c.exp.children[0].children[1].children.length}else f.append(new d(c.exp.children[0]));l.handle(f);i.updateNodeMap(e,f.children[f.children.length-g].children[0])}this.cleanup(r.parent);if(typeof e==="function")e(this);else return true};var i=new e;f.prototype.add_action_handler(i);g.prototype.add_action_handler(i)})();(function(){var e=function(t){Action.call(this,"negation");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){if(n.get_value(t.children[1])===-1&&t.ls)return true;if(t.ls&&t.ls.children&&n.get_value(t.ls.children[1])===-1)return true;return false};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var r=this;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var s=function(e,i){var n=i.children[1],s=r.getOldTreeNode(e),a=s.children[1],h=r.getOldTreeNode(i);t.remove(e);if(n.is_group("sign")&&n.children[1]&&!n.children[1].is_group("sign")){var l=n.children[1];r.updateNodeMap(h.children[1].children[0],l);r.updateNodeMap(a,l);r.updateNodeMap(a.children[0],l);r.updateNodeMap(a.children[1],l);n.replace_with(l)}else{var c=new u;c.append(new o("-"));r.updateNodeMap(a,c);r.updateNodeMap(a.children[0],c.children[0]);r.updateNodeMap(a.children[1],n);n.remove();c.append(n);i.append(c)}r.updateNodeMap(s,i);r.updateNodeMap(s.children[0],i.children[0])};if(n.get_value(i.children[1])===-1&&i.ls){s(i,i.ls);this.cleanup(i.ls)}else{s(i.ls,i);this.cleanup(i)}if(typeof e==="function")e(this);return this};f.prototype.add_action_handler(new e)})();gmath.actions.MultiplyFractionsAction=function(){var e=function(t){Action.call(this,"multiply fractions");this.priority=1;if(t){if(t.interactionType==="drag"){this.interactionType=t.interactionType;this.delay=250;this.margin={x:.1};this.side="inside";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("product","fraction"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var r=e.get_root(),n=this;return i.map(function(e){return n.createBoundAction(r,{nodes:t,target:e,interactionType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(t.value!==e.value)return false;var i=t.parent;if(e.parent!==i)return false;var r=t.children[1],n=e.children[1];if(!(r.is_group("fraction")&&n.is_group("fraction")))return false;if(!i.is_group("fraction","product"))return false;return true};e.prototype.transform=function(e){if(this.interactionType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var i=this.getNewTreeNode(this.sourceMul),r=this.getNewTreeNode(this.targetMul),n=i.parent,o,s,a;if(i.parent.children.indexOf(i)<r.parent.children.indexOf(r)){o=i,s=r,a=0}else{o=r,s=i,a=1}var h=n;var u=o.children[1],c=s.children[1];var d=this.sourceMul.children[1];this.updateNodeMap(d.get_fraction_bar(),u.get_fraction_bar());this.updateNodeMap(this.sourceMul,o);this.updateNodeMap(this.sourceMul.children[0],o.children[0]);t.remove(s);var p=c.get_top(),f=c.get_bottom();for(var g=0;g<p.length;g++)u.append(p[g]);for(var g=0;g<f.length;g++)u.append(f[g]);for(var g=0;g<u.children.length;g++){var v=u.children[g];if(v.has_children())l.handle(v.children[1])}this.cleanup(h);if(typeof e==="function")e(this);return this};f.prototype.add_action_handler(new e);return new e}();i.prototype.move_actions.push(gmath.actions.MultiplyFractionsAction);gmath.actions.AddFractionsAction=function(){var e=function(t){Action.call(this,"add fractions");this.priority=1;if(t){if(t.interactionType==="drag"){this.interactionType=t.interactionType;this.delay=250;this.margin={x:.1};this.side="inside";this.nodes=t.nodes;this.target=t.target}this.actor=t.actor}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("sum"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var r=e.get_root(),n=this;return i.map(function(e){return n.createBoundAction(r,{nodes:t,target:e,interactionType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(!t.parent.is_group("sum"))return false;if(t.parent!==e.parent)return false;var i=t.children[1],r=e.children[1];if(!(i.is_group("fraction")&&r.is_group("fraction")))return false;var n=function(t){return t.to_ascii()};var o=i.get_bottom(),s=r.get_bottom();if(o.map(n).join("")!==s.map(n).join(""))return false;return true};e.prototype.transform=function(e){if(this.interactionType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.getNewTreeNode(this.sourceAddend),r=this.getNewTreeNode(this.targetAddend),n=i.parent;var s=i.children[1];var a=s.get_bottom();var h,u,c;if(i.parent.children.indexOf(i)<r.parent.children.indexOf(r)){h=i,u=r,c=0}else{h=r,u=i,c=1}var g=n;var v=h.children[1],m=u.children[1];var _=this.getOldTreeNode(h),y=this.getOldTreeNode(u);var w=t.remove(h);t.remove(u);t.remove(v);t.remove(m);var x=v.get_bottom();this.updateNodeMap(s.get_fraction_bar(),v.get_fraction_bar());for(var b=0;b<a.length;b++){this.updateNodeMap(a[b].get_mapping_to(x[b]))}var A=this;var N=function(e,i){t.remove_range(e);var r;if(e.length==1){r=new d(e[0].children[1],i.value)}else{var n=new p;t.insert_range(n,0,e);r=new d(n,i.value)}l.handle(r.children[1],true);A.updateNodeMap(i,r);A.updateNodeMap(i.children[0],r.children[0]);return r};h=N(v.get_top(),_);u=N(m.get_top(),y);var k=h.createGroup();k.append(h);k.append(u);var M=new f(M);var T=new o("*");t.append(M,T);t.append(M,k);v.append(M);var L=new d(v,"add");t.insert(g,w,L);L.ls=L.parent.children[L.parent.children.indexOf(L)-1];this.updateNodeMap(this.sourceAddend,L);l.handle(k);this.cleanup(h);this.cleanup(u);this.cleanup(g);if(typeof e==="function")e(this);else return true};d.prototype.add_action_handler(new e);return new e}();i.prototype.move_actions.push(gmath.actions.AddFractionsAction);gmath.actions.FractionCancelTermsAction=function(){var e=function(t){Action.call(this,"cancel numbers in a fraction");this.delay=400;this.side="inside";if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){return e.getAllAvailableActions.call(this,t)};e.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!t.every(function(t){return t.is_group("mul","div")}))return[];var i=e.findTopLevelGroupForCanceling(t);
if(!i)return[];var r=e.findOtherContendersInStructure(t,i);if(r.length===0)return[];var n=this;r=r.filter(function(i){return e.match.call(n,t[0],i)});var o=t[0].get_root();return r.map(function(e){return n.createBoundAction(o,{nodes:t,target:e})})};e.findTopLevelGroupForCanceling=function(t){var i;if((i=e.nodesAreInAFractionWithinAProduct(t))||(i=e.nodesAreInAProductThatContainsAFraction(t))||(i=e.nodesAreInAFraction(t))){return i}else{return false}};e.findOtherContendersInStructure=function(t,i){var r;var n=t[0].is_group("mul")?"div":"mul";r=i.filter(function(t){return t.is_group(n)&&e.nodeIsCorrectLevelRelativeToTopLevelGroup(t,i)});return r};e.nodesAreInAFractionWithinAProduct=function(t){var e=t[0].parent;if(e.is_group("fraction")&&e.parent&&e.parent.is_group("mul")&&e.parent.parent.is_group("product")){return e.parent.parent}else{return false}};e.nodesAreInAProductThatContainsAFraction=function(t){var e=t[0].parent;if(e.is_group("product")&&e.children.some(function(t){return t.children[1].is_group("fraction")})){return e}else{return false}};e.nodesAreInAFraction=function(t){var e=t[0].parent;if(e.is_group("fraction")){return e}else{return false}};e.nodeIsCorrectLevelRelativeToTopLevelGroup=function(t,e){return t.parent===e||t.parent.parent.parent===e};e.match=function(t,e){var i=this.getBoundTransformation(t,e);if(i){return true}else{return false}};e.prototype.transform=function(t){e.transform.call(this,t)};e.transform=function(t){var i=this.getNewTreeNode(this.nodes)[0],r=this.getNewTreeNode(this.target);this.addTouchedNodes(this.nodes[0]);this.addTouchedNodes(this.target);var n=e.findTopLevelGroupForCanceling([i]);e.performCancel.call(this,i,r);e.cleanStructure.call(this,n);if(typeof t==="function")t(this);else return true};e.performCancel=function(t,e){var i=this.getBoundTransformation(t,e);if(i){i()}else{throw"Failed to find canceling transformation in transform function."}};e.cleanStructure=function(t){var e=this;if(t.is_group("product")){t.children.forEach(function(t){if(t.children[1].is_group("fraction")){e.cleanup(t.children[1]);e.cleanup(t)}})}else{this.cleanup(t)}if(!i.is_top_most(t)){l.handle(t.parent,true)}};e.prototype.getBoundTransformation=function(t,e){var i=this;var r=t.is_group("mul")?t:e,o=e.is_group("div")?e:t;var s=n.is_num(r.children[1]),a=n.is_num(o.children[1]),h=s&&!this.numberContainsDecimalTerm(r.children[1]),l=a&&!this.numberContainsDecimalTerm(o.children[1]);if(a&&(n.get_value(o.children[1])===0||n.get_value(o.children[1])===-0)){return false}if(r.children[1].to_ascii()===o.children[1].to_ascii()){return function(){i.cancelTerms(r,o)}}if(l&&n.get_value(o.children[1])===1){return function(){i.removeDivOne(r,o)}}if(l&&n.get_value(o.children[1])===-1){return function(){i.applyNegativeToMulNum(r,o)}}if(this.termIsNegativeXOfX(r.children[1],o.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(r,o)}}if(this.termIsNegativeXOfX(o.children[1],r.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(o,r)}}if(h&&l&&this.termsAreMultiples(r,o)){return function(){i.factorizeTerms(r,o)}}if(this.bothTermsAreNegative(r,o)){return function(){i.extractSigns(r,o)}}return false};e.prototype.cancelTerms=function(t,e){var i=this;this.getOldTreeNode(t).for_each(function(e){i.updateNodeMap(e,t.parent)});this.getOldTreeNode(e).for_each(function(t){i.updateNodeMap(t,e.parent)});t.remove();e.remove()};e.prototype.removeDivOne=function(t,e){var i=this.getOldTreeNode(e);e.remove();this.updateNodeMap(i,t);this.updateNodeMap(i.children[0],t.children[0]);this.updateNodeMap(i.children[1].get_mapping_to(t.children[1]))};e.prototype.applyNegativeToMulNum=function(t,e){if(t.children[1].is_group("sign")){t.children[1].replace_with(t.children[1].children[1])}else{var i=e.children[1];i.remove();i.children[1].remove();var r=t.children[1];r.remove();t.append(i);i.append(r)}e.remove()};e.prototype.termIsNegativeXOfX=function(t,e){return t.is_group("sign")&&t.children[1].to_ascii()===e.to_ascii()};e.prototype.cancelTermsAndReplaceMulDiv1NumWithNegativeOne=function(t,e){var i=t.children[1].children[1],r=new n(1);this.updateNodeMap(this.getOldTreeNode(i).get_mapping_to(r));i.replace_with(r);e.remove()};e.prototype.termsAreMultiples=function(t,e){var i=t.get_root();var r=i.numeric_value(t.children[1]),n=i.numeric_value(e.children[1]);if(!r||!n)return false;if(this.val1IsAMultipleOfVal2(r,n))return true;if(this.val1IsAMultipleOfVal2(n,r))return true;if(this.getGCD(r,n)!==1)return true;return false};e.prototype.factorizeTerms=function(t,e){var i=t.get_root();var r=i.numeric_value(t.children[1]),n=i.numeric_value(e.children[1]);if(!r||!n)return false;var o=this.getOldTreeNode(t),s=this.getOldTreeNode(e);var a=this.mulIsLeftOfDiv(t,e);if(this.val1IsAMultipleOfVal2(r,n)){var h=a?this.splitIntoFactors(t,o,n,Math.floor(r/n))[0]:this.splitIntoFactors(t,o,Math.floor(r/n),n)[1];e.update_x_during_dragging=true;e.update_y_during_dragging=true;if(this.nodes[0].is_group("mul")){this.reselectNodeAfterAction(h)}}else if(this.val1IsAMultipleOfVal2(n,r)){var h=a?this.splitIntoFactors(e,s,Math.floor(n/r),r)[1]:this.splitIntoFactors(e,s,r,Math.floor(n/r))[0];t.update_y_during_dragging=true;t.update_x_during_dragging=true;if(this.nodes[0].is_group("div")){this.reselectNodeAfterAction(h)}}else{var l=this.getGCD(r,n);var u;if(this.target.is_group("mul")){a?this.splitIntoFactors(t,o,Math.floor(r/l),l):this.splitIntoFactors(t,o,l,Math.floor(r/l));u=a?this.splitIntoFactors(e,s,Math.floor(n/l),l)[1]:this.splitIntoFactors(e,s,l,Math.floor(n/l))[0]}else{u=a?this.splitIntoFactors(t,o,l,Math.floor(r/l))[0]:this.splitIntoFactors(t,o,Math.floor(r/l),l)[1];a?this.splitIntoFactors(e,s,Math.floor(n/l),l):this.splitIntoFactors(e,s,l,Math.floor(n/l))}this.reselectNodeAfterAction(u)}};e.prototype.mulIsLeftOfDiv=function(t,e){if(t.parent===e.parent)return true;var i,r;if(t.parent.is_group("product")){i=t}else{i=t.parent.parent}r=e.parent.parent;var n=i.parent;return n.children.indexOf(i)<=n.children.indexOf(r)};e.prototype.splitIntoFactors=function(e,i,r,o){var s=new f(new n(r),e.value),a=new f(isNaN(o)?t.clone(e.children[1].children[1]):new n(o),e.value);this.updateNodeMap(i.get_mapping_to(s));this.extendNodeMap(i.get_mapping_to(a));var h=e.remove();e.parent.insert(h,s);e.parent.insert(h,a);s.update_x_during_dragging=true;s.update_y_during_dragging=true;a.update_x_during_dragging=true;a.update_y_during_dragging=true;return[s,a]};e.prototype.bothTermsAreNegative=function(t,e){return t.children[1].is_group("sign")&&e.children[1].is_group("sign")};e.prototype.extractSigns=function(t,e){var i=t.get_root();var r=this.getOldTreeNode(t),n=this.getOldTreeNode(e);var o=this.splitIntoFactors(t,r,-1,Math.floor(i.numeric_value(t.children[1])/-1))[0],s=this.splitIntoFactors(e,n,-1,Math.floor(i.numeric_value(e.children[1])/-1))[0];if(this.nodes[0].is_group("mul")){this.reselectNodeAfterAction(o)}else{this.reselectNodeAfterAction(s)}};e.prototype.val1IsAMultipleOfVal2=function(t,e){return Math.abs(t)>=Math.abs(e)&&Math.abs(e)!==1&&t%e===0};e.prototype.getGCD=function(t,e){if(t<0)t=-t;if(e<0)e=-e;if(e>t){var i=t;t=e;e=i}while(true){t%=e;if(t==0)return e;e%=t;if(e==0)return t}};e.prototype.numberContainsDecimalTerm=function(t){return n.get_value(t)!==Math.floor(n.get_value(t))};return new e}();i.prototype.move_actions.push(gmath.actions.FractionCancelTermsAction);gmath.actions.FractionCancelPowersAction=function(){var e=function(t){Action.call(this,"cancel powers in a fraction");this.delay=400;if(t){this.nodes=t.nodes;this.target=t.target;this.side="inside"}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){return gmath.actions.FractionCancelTermsAction.getAllAvailableActions.call(this,t)};e.prototype.transform=function(t){gmath.actions.FractionCancelTermsAction.transform.call(this,t)};e.prototype.getBoundTransformation=function(t,e){var i=this;var r=t.is_group("mul")?t:e,n=e.is_group("div")?e:t;if(!r.children[1].is_group("power")&&!n.children[1].is_group("power"))return false;if(this.termsHaveTheSameBase(r.children[1],n.children[1])){return function(){i.factorizePowers(r,n)}}};e.prototype.termsHaveTheSameBase=function(t,e){var i=t.is_group("power")?t.children[0]:t,r=e.is_group("power")?e.children[0]:e;return i.to_ascii()===r.to_ascii()};e.prototype.factorizePowers=function(t,e){var i=this.nodes[0].is_group("mul")?t:e,r=this.target.is_group("mul")?t:e;var o=i.children[1],s=r.children[1];var a=this.getOldExponentTermFromPower(s),h=this.getOldExponentTermFromPower(o);var l=o.is_group("power");var u=this.sourceIsLeftOfTarget(i,r);if(!o.is_group("power")){o=this.reinterpretTermAsPower(o)}if(!s.is_group("power")){s=this.reinterpretTermAsPower(s)}var c=o.children[1].children[0],d=s.children[1].children[0];if(c.is_group("brackets"))c=c.children[1];if(d.is_group("brackets"))d=d.children[1];this.modifyTargetExponentByExponent(a,d,h,c);var p=this.insertNewPowerNextToTarget(r,o,h,c,u);if(!l){o.replace_with(o.children[0]);p.replace_with(p.children[0])}if(n.is_num(s.children[1].children[0])&&n.get_value(s.children[1].children[0])===1){s.replace_with(s.children[0])}};e.prototype.sourceIsLeftOfTarget=function(t,e){if(t.parent===e.parent)return true;var i,r;i=t.parent.is_group("product")?t:t.parent.parent;r=e.parent.is_group("product")?e:e.parent.parent;var n=i.parent;return n.children.indexOf(i)<=n.children.indexOf(r)};e.prototype.getOldExponentTermFromPower=function(t){if(!t.is_group("power")){return null}var e=this.getOldTreeNode(t);var i=e.children[1].children[0];if(i.is_group("brackets")){i=i.children[1]}return i};e.prototype.reinterpretTermAsPower=function(t){var e=t.parent,i=t.remove();var r=v.prototype.createGroup();r.append(t);r.append(new v(new n(1)));this.updateNodeMap(t,r);e.insert(i,r);return r};e.prototype.modifyTargetExponentByExponent=function(t,e,i,r){if(!n.is_num(e)||!n.is_num(r)){this.convertTargetExponentIntoSum(e,i,r)}else{this.subtractExponentValues(t,e,i,r)}};e.prototype.convertTargetExponentIntoSum=function(t,e,i){var r=t.parent,n=t.remove();var o=d.prototype.createGroup();o.append(new d(t));o.append(new d(i.clone(),"sub"));r.insert(n,o);this.cleanup(o.children[1]);this.cleanup(o.children[0]);l.handle(o);if(e&&e.is_group("sum")){for(var s=0;s<e.children.length;s++){this.extendNodeMap(e.children[e.children.length-s-1].get_mapping_to(o.children[o.children.length-s-1]))}}else if(e){this.extendNodeMap(e.get_mapping_to(o.children[o.children.length-1].children[1]))}};e.prototype.subtractExponentValues=function(t,e,i,r){var o=e.replace_with(new n(n.get_value(e)-n.get_value(r)));if(t){this.extendNodeMap(t.get_mapping_to(o))}if(i){this.extendNodeMap(i.get_mapping_to(o))}};e.prototype.insertNewPowerNextToTarget=function(e,i,r,n,o){var s=new g(t.clone(i.children[0]),t.clone(n));l.handle(s.children[1].children[0]);this.extendNodeMap(this.getOldTreeNode(e.children[1]),s);this.extendNodeMap((this.target.children[1].is_group("power")?this.target.children[1].children[0]:this.target.children[1]).get_mapping_to(s.children[0]));if(r){this.extendNodeMap(r.get_mapping_to(s.children[1].children[0].is_group("brackets")?s.children[1].children[0].children[1]:s.children[1].children[0]))}var a=o?e.parent.children.indexOf(e):e.parent.children.indexOf(e)+1;e.parent.insert(a,new f(s,e.value));return s};e.prototype.removeExponentOfOne=function(t){t.replace_with(t.children[0])};return new e}();i.prototype.move_actions.push(gmath.actions.FractionCancelPowersAction);(function(){var t=function(t){Action.call(this,"cancel numerator and denominator");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;var e=t.get_top();var i=t.get_bottom();if(e.length!==1||i.length!==1)return false;e=e[0],i=i[0];return n.is_num(e.children[1])&&n.is_num(i.children[1])&&n.get_value(i.children[1])!==0&&n.get_value(i.children[1])!==-0};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);var i=e.parent;this.addTouchedNodes(this.actor);var r=e.get_top();var o=e.get_bottom();r=r[0],o=o[0];var s=n.get_value(r.children[1])/n.get_value(o.children[1]);s=Math.round(100*s)/100;var a=new n(s);if(r.children[1]instanceof u||o.children[1]instanceof u){this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(a));this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(a))}else{this.updateNodeMap(this.actor.get_mapping_to(a))}var h=e.remove();i.insert(h,a);if(typeof t==="function")t(this);else return true};p.prototype.add_action_handler(new t);return new t})();(function(){var e=function(t){Action.call(this,"product-fraction cleanup action");if(t)this.productFraction=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.get_top().length,i=t.get_bottom().length;if(e===0&&i===0)return true;if(t.value==="product"&&i>0)return true;if(t.value==="fraction"&&i===0)return true;if(t.value==="fraction"&&e===0)return true;if(e===1&&i===0)return true;return false};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.productFraction);var r=i.get_top().length,s=i.get_bottom().length,a;var h;if(r===0&&s===0){var u=new n(1);a=t.get_mapping_between(this.productFraction,u);this.updateNodeMap(a);t.replace(i,u);h=true}if(!h&&this.productFraction.value==="product"&&s>0){i.invert()}if(!h&&this.productFraction.value==="fraction"&&s===0){i.invert()}if(this.productFraction.value==="fraction"&&r===0){if(!(this.productFraction.children[0]instanceof o))t.insert(i,0,new o("//"));t.insert(i,0,new f(new n(1)))}if(r===1&&s===0){var c=i.get_top()[0].children[1];this.updateNodeMap(this.productFraction,c);this.updateNodeMap(this.productFraction.children[0],c);this.updateNodeMap(this.productFraction.children[0].children[0],c);t.replace(i,c);if(c.parent.is_group("brackets"))l.handle(c.parent,true);else l.handle(c,true)}if(typeof e==="function")e(this);else return this};p.prototype.cleanupAction=new e})();gmath.actions.SplitExponentsAction=function(){var e=function(t){Action.call(this,"split exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.match(t[0]))return[];if(t.length===t[0].parent.children.length)return[];var e=t[0].get_root(),i=t[0].parent.parent.parent.parent;return[this.createBoundAction(e,{nodes:t,target:i,side:"left-of"}),this.createBoundAction(e,{nodes:t,target:i,side:"right-of"})]};e.prototype.match=function(t){try{var e=(t.is_group("add")||t.is_group("sub"))&&t.parent.parent.parent.is_group("exponent");return e}catch(i){return false}};e.prototype.transform=function(t){this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target);var r;if(e[0].parent.children.indexOf(this.nodes[0])===0){r=e[0].parent.children[e.length].children[0]}else{r=e[0].parent.children[0].children[0]}var n=i,o=n.parent;var s=n.remove();this.extractNodesFromPowerExponentSum(e);var a=this.createSplittedOffPower(e);var h=this.placePowersIntoProduct(n,a);var u=this.nodes[0].children[0];this.extendNodeMap(u,a.parent.children[0]);this.extendNodeMap(r,n.parent.children[0]);for(var c=0;c<this.nodes.length;c++){this.updateNodeMap(this.nodes[c],a.parent)}if(o.is_group("mul")||o.is_group("div")){this.extendNodeMap(this.getOldTreeNode(o.children[0]),a.parent.children[0])}o.insert(s,h);this.cleanup(h.children[0].children[1].children[1].children[0].children[1]);this.cleanup(h.children[1].children[1].children[1].children[0].children[1]);l.handle(h.children[0].children[1].children[1].children[0],true);l.handle(h.children[1].children[1].children[1].children[0],true);this.cleanup(o);a.children[1].simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.extractNodesFromPowerExponentSum=function(e){t.remove_range(e)};e.prototype.createSplittedOffPower=function(e){var i=this.target.children[0];var r=v.prototype.createGroup(),n=t.clone(i);this.extendNodeMap(i,n);r.append(n);var o=d.prototype.createGroup();o.append_range(e);var s=new v(o);r.append(s);return r};e.prototype.placePowersIntoProduct=function(t,e){var i=f.prototype.createGroup();i.append(new f(t));var r=new f(e);if(this.side==="left-of")i.insert(0,r);else i.append(r);return i};return new e}();i.prototype.move_actions.push(gmath.actions.SplitExponentsAction);gmath.actions.UniteExponentsAction=function(){var e=function(t){Action.call(this,"unite exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length!==1)return e;if(!(t[0].is_group("mul")||t[0].is_group("div")))return e;var i=t[0].get_root(),r=t[0].parent.children.slice();r.splice(r.indexOf(t[0]),1);var n=this.getBaseStringFromNode(t[0].children[1]);for(var o=0;o<r.length;o++){if(t[0].value===r[o].value&&this.match(r[o].children[1],n))e.push(this.createBoundAction(i,{nodes:t,target:r[o].children[1].children[1],side:"around"}))}return e};e.prototype.getBaseStringFromNode=function(t){if(t.is_group("power"))return t.children[0].to_ascii();return t.to_ascii()};e.prototype.match=function(t,e){if(!t.is_group("power"))return false;return t.children[0].to_ascii()===e};e.prototype.transform=function(t){var e=this;this.addTouchedNodes(this.nodes[0]);this.addTouchedNodes(this.target.parent.parent);var i=this.getNewTreeNode(this.nodes)[0],r=this.getNewTreeNode(this.target);var n=i.parent,o=this.getDirectionOfDrag(i,r);i.remove();var s=this.extractAddendsFromDraggedNode(i);this.updateNodeMap(this.nodes[0],s);this.extendNodeMap(this.nodes[0].children[0],s[0].children[0]);if(this.nodes[0].children[1].is_group("power")){this.updateNodeMap(this.nodes[0].children[1].children[0],this.target.parent.children[0])}else{this.updateNodeMap(this.nodes[0].children[1],this.target.parent.children[0])}this.insertAddendsIntoTargetExponent(s,r,o);this.cleanup(n);if(typeof t==="function")t(this);else return true};e.prototype.getDirectionOfDrag=function(t,e){var i=t.parent.children.indexOf(t),r=t.parent.children.indexOf(e.parent.parent);return r>i};e.prototype.extractAddendsFromDraggedNode=function(e){var i=[];var r=e.children[1];if(!r.is_group("power")){i.push(new d(new n(1)))}else{var o=r.children[1].children[0];if(o.is_group("brackets")&&o.children[1].is_group("sum")){i=o.children[1].children.slice();t.remove_range(i)}else{o.remove();i.push(new d(o))}}return i};e.prototype.insertAddendsIntoTargetExponent=function(t,e,i){var r=e.children[0];if(!(r.is_group("brackets")&&r.children[1].is_group("sum"))){this.reinterpretExponentToBeASum(e);r=e.children[0]}this.extendNodeMap(this.getOldTreeNode(e.parent.parent.children[0]),r.children[1].children[0].children[0]);if(i)r.children[1].insert_range(0,t);else r.children[1].append_range(t)};e.prototype.reinterpretExponentToBeASum=function(t){var e=t.children[0];e.remove();var i=d.prototype.createGroup();i.append(new d(e));var r=new l(i);t.append(r)};return new e}();i.prototype.move_actions.push(gmath.actions.UniteExponentsAction);SplitNumberAction=function(){var t=function(t){Action.call(this,"n => (n-1) + 1");this.priority=0;if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t instanceof n&&t.value>1};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var r=e.remove();e.value--;var o=d.prototype.createGroup();o.append(new d(e));o.append(new d(new n(1)));this.resultNodes=o.children.slice();this.updateNodeMap(this.actor.get_mapping_to(o));i.insert(r,o);l.handle(o);this.cleanup(i);if(typeof t==="function")t(this);return true};return new t}();SplitProductAction=function(){var e=function(t){Action.call(this,"n*x => (n-1)*x + x");this.priority=1;if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("mul")&&t.children[1]instanceof n&&t.children[1].value>1&&t.rs};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),r=i.parent,n=i.children[1];this.addTouchedNodes(this.actor);n.value--;var o=r.children.slice(r.children.indexOf(i));var s=this.getOldTreeNode(o);var a=t.remove_range(o);var h=d.prototype.createGroup();var l=f.prototype.createGroup();var u=f.prototype.createGroup();var c;if(n.value===1){i.remove();o=o.slice(1);l.insert_range(0,o);c=t.clone(o);u.insert_range(0,c);this.extendNodeMap(t.get_mapping_between(s.slice(1),c))}else{l.insert_range(0,o);c=t.clone(o);u.insert_range(0,c);u.children[0].remove();this.extendNodeMap(t.get_mapping_between(s,c))}h.append(new d(l));h.append(new d(u));var p=new f(h);r.insert(a,p);this.cleanup(l);this.cleanup(u);var g=r.parent;if(this.cleanup(r))this.cleanup(g);if(typeof e==="function")e(this);return true};e.prototype.mapIndex=function(){map={};return function(t){return map[t]}};return new e}();SplitPowerAction=function(){var e=function(t){Action.call(this,"x^n => x^(n-1) * x");this.priority=2;if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&t.children[0]instanceof n&&t.children[0].value>=1};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),r=i.parent,n=r.parent;this.addTouchedNodes(this.actor);var o=r.remove();var s=f.prototype.createGroup();s.append(new f(r));var a=t.clone(r.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(a));s.append(new f(a));var h=i.children[0];h.value--;this.extendNodeMap(this.actor.children[0],a.parent);if(h.value===1){var l=r.children[0];r.remove();s.children[0].append(l);this.extendNodeMap(this.actor.children[0],l.parent)}else if(h.value===0){s.children[0].remove()}this.resultNodes=s.children.slice();n.insert(o,s);this.cleanup(n);if(typeof e==="function")e(this);return true};return new e}();SplitPowerSumAction=function(){var e=function(t){Action.call(this,"x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)");this.priority=3;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&(t.children[0].is_group("brackets")&&t.children[0].children[1].is_group("sum")||t.children[0].is_group("sum"))};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),r=i.parent,n=r.parent,o=i.children[0];if(o.is_group("brackets"))o=o.children[1];var s=o.children[o.children.length-1],a=this.getOldTreeNode(s.children[0]);this.addTouchedNodes(this.actor.parent);var h=r.remove();var l=f.prototype.createGroup();l.append(new f(r));var u=t.clone(r);l.append(new f(u));u.children[1].children[0].remove();s.remove();var c=s.createGroup();c.append(s);u.children[1].append(c);n.insert(h,l);if(a.parent.is_group("add"))this.updateNodeMap(a,l.children[1].children[0]);else this.extendNodeMap(a,l.children[1].children[0]);this.cleanup(s.parent);this.cleanup(o);this.cleanup(n);if(typeof e==="function")e(this);return true};return new e}();gmath.actions.DistributeIntoBracketsAction=function(){var e=function(t){Action.call(this,"distribute");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length===0)return e;var i=t[0].get_root();if(!t[0].is_group("mul")&&!t[0].is_group("div"))return[];var r=this;function n(n){if(n.children[1]&&n.children[1].is_group("brackets")){o=n.children[1].children[1];if(r.match(t,o,"around"))e.push(r.createBoundAction(i,{nodes:t,target:o,side:"around"}))}}var o=t[0];while(o=o.ls)n(o);o=t[t.length-1];while(o=o.rs)n(o);return e};e.prototype.match=function(t,e,i){if(t.length===0)return false;if(e.value==="("||e.value===")")return false;var r=e.parent;if(!r.parent)return false;var n=r.parent.value;if(n!=="mul"&&n!=="div")return false;for(var o=0;o<t.length;o++)if(t[o].value!==n)return false;if(r.parent.parent!==t[0].parent)return false;if(!r.is_group("brackets"))return false;if(!r.children[1].is_group("sum"))return false;if(!t[0].commutative)return false;if(i==="left-of"&&r.ls===t[t.length-1])return false;if(i==="right-of"&&r.rs===t[0])return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var r=this.getNewTreeNode(this.target);var n=this.target.parent.children[0],o=this.target.parent.children[2];var s=r.parent;var a;if(i[i.length-1].rs&&i[i.length-1].rs.children[1]&&i[i.length-1].rs.children[1]===s){a="left"}if(i[0].ls&&i[0].ls.children[1]===s){a="right"}var h=s.parent.parent,u=s.children[1];t.remove_range(i);this.distributeIntoSum(u,i,a);if(h.cleanupAction)this.cleanup(h);var c=u.parent;if(!c.is_group("brackets")||c.is_group("brackets")&&c.parent.is_group("mul","div")&&c.parent.parent.is_group("fraction")&&(c.parent.is_group("mul")?c.parent.parent.get_top().length===1:c.parent.parent.get_bottom().length===1)){var d=u.remove();var p=new l(u);t.insert(c,d,p);this.updateNodeMap(n.parent,p);this.updateNodeMap(n,p.children[0]);this.updateNodeMap(o,p.children[2]);p.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.distributeIntoSum=function(e,i,r){var o=e.children.length;var s=function(t){if(t.is_group("div"))t.invert()};for(var a=0;a<o;a++){var h=e.children[a].children[1],l,u;h.remove();if(h.is_group("product"))l=h;else{l=new p;l.append(new f(h))}if(r==="left"&&a===0||r==="right"&&a===o-1){u=i}else u=t.clone(i);u.forEach(s);this.extendNodeMap(t.get_mapping_between(this.nodes,u));{var c=r==="left"?1:l.children.length-1;if(l.children[c])l.children[c].simplify=true}var d=r==="left"?0:l.children.length;l.insert_range(d,u);e.children[a].append(l);if(i.some(function(t){return t.is_group("mul")&&n.is_num(t.children[1])})){l.children.forEach(function(t){t.simplify=false});l.simplify=true}for(var g=0;g<u.length;g++){t.for_each(function(t){t.update_x_during_dragging=true;t.update_y_during_dragging=false},u[g])}}};return new e}();i.prototype.move_actions.push(gmath.actions.DistributeIntoBracketsAction);gmath.actions.FactorOutOfBracketsAction=function(){var e=function(t){Action.call(this,"factor out");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],i=t[0];while(i.parent&&!i.is_group("brackets"))i=i.parent;if(this.match(t)){e.push(this.bindLeftSideAction(i,t));e.push(this.bindRightSideAction(i,t))}return e};e.prototype.nodesAreAllAddends=function(t,e){if(!t.is_group("sum"))return false;return t.children.length===e.length};e.prototype.bindLeftSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[0],side:"left-of"})};e.prototype.bindRightSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[2],side:"right-of"})};e.prototype.getContainingBrackets=function(t){try{var e=null;for(var i=0;i<t.length;i++){var r=t[i][0];var n=r.is_group("mul")?r.get_parent(4):r.get_parent(3);if(!n||!n.is_group("brackets")||n.children[0].hidden)return null;if(!e)e=n;else if(e!==n)return null}return e}catch(o){return null}};e.prototype.match=function(e,r){var n=i.groupNodeRanges(e);var o=this.getContainingBrackets(n);if(!o)return false;if(r&&!(o.children[0]===r||o.children[2]===r))return false;if(!this.nodesAreAllAddends(o.children[1],n))return false;var s=n[0].length;n.forEach(function(t){if(t.length!==s)return false});for(var a=0;a<s;a++){var h;if(n[0][a].value==="mul")h=n[0][a].children[1].to_ascii();else h=n[0][a].to_ascii();for(var l=0;l<n.length;l++){var u;if(n[l][a].value==="mul")u=n[l][a].children[1].to_ascii();else u=n[l][a].to_ascii();if(u!==h)return false}}var c=t.get_cca(e);return c.is_group("sum")&&c.parent===o};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes);var r=this.findBracketGroup(e);var n=i.groupNodeRanges(e);var o=n.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(n);var s=this.factor(r,n,o);if(s.is_group("brackets")&&l.is_optional(s)){var a=s.parent;l.handle(s,true);s=a}if(s.cleanupAction)this.cleanup(s);if(typeof t==="function")t(this);else return true};e.prototype.findBracketGroup=function(t){var e=t[0];if(e&&e.parent&&e.parent.parent&&e.parent.parent.is_group("sum")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent;if(e&&e.parent&&e.parent.is_group("product")&&e.parent.parent&&e.parent.parent.parent&&e.parent.parent.parent.is_group("sum")&&e.parent.parent.parent.parent&&e.parent.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."};e.prototype.removeRangesFromSum=function(e){for(var i=0;i<e.length;i++){var r=e[i];var o=e[i][0].parent;if(r.length===o.children.length){var s=o.parent;o.remove();t.remove_range(r);s.append(new n(1));this.cleanup(s)}else if(o.value==="add"||o.value==="sub"&&r.length===1){r[0].remove();o.append(new n(1))}else{t.remove_range(e[i]);this.cleanup(o)}}};e.prototype.factor=function(t,e,i){return this.replaceBracketGroupWithFactoredProduct(t,e,i)};e.prototype.replaceBracketGroupWithFactoredProduct=function(e,i,r){var n=f.prototype.createGroup();var o=e.parent;var s=e.remove();var a;if(this.side==="left-of"){a=i[0];if(a.length===1&&a[0].value!=="mul"){a=[new f(a[0])]}n.append_range(a);n.append(new f(e));for(var h=0;h<r.length;h++){if(r[h].length===1&&!r[h][0].is_group("mul")){this.updateNodeMap(r[h][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(r[h],a))}}}else{a=i[i.length-1];if(a.length===1&&a[0].value!=="mul"){a=[new f(a[0])]}n.append(new f(e));n.append_range(a);for(var h=0;h<r.length;h++){if(r[h].length===1&&!r[h][0].is_group("mul")){this.updateNodeMap(r[h][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(r[h],a))}}}t.insert(o,s,n);return o};e.prototype.mapIndex=function(){return function(){}};return new e}();i.prototype.move_actions.push(gmath.actions.FactorOutOfBracketsAction);i.prototype.SubstitutionAction=function(){var e=function(t){Action.call(this,"substitution");this.auto_collapse=true;if(t){this.sourceEq=t.source;this.target=t.target}};gmath.inherit(Action,e);e.prototype.rebind=function(t,e,i){if(this.sourceEq===i){this.sourceEq=t}else if(this.oldTree===i){var r=new Action;r.node_map=e;this.oldTree=t;this.target=r.mapNodes(this.target)[0]}else throw"wrong old tree during rebinding an action!"};e.prototype.getAllAvailableActions=function(t,e){var i=this.findAllMatches(t,e);var r=[];for(var n=0;n<i.length;n++){var o=e.SubstitutionAction.createBoundAction(e,{source:t,target:i[n]});r.push(o)}return r};e.prototype.match=function(t,e){if(e.length===0||e[0].fixed)return false;if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return false;var i=t.children[0].to_ascii();var r=h(i);return r(e)};function i(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function r(t){return t.is_group()&&t.commutative&&t.associative}function n(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(r(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length!==1)return"";var e=t[0].to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e}e.prototype.findAllMatches=function(t,e){if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return[];if(!e.parent)e=e.children[0];var i=t.children[0].to_ascii();var r=e.filterRange(h(i));r=r.filter(function(t){return t.length>0&&!t[0].fixed});return r};e.prototype.transform=function(e){var i=this.target,r=i.map(this.getNewTreeNode.bind(this));var n=r[0].parent;var o=t.remove_range(r);var s=t.clone(this.sourceEq.children[0].children[2]);if(r.length>1){s=new r[0].constructor(s)}if(this.sourceIsASignGroupOrHasALeadingNegativeCoefficient(this.sourceEq)&&r[0].is_group("sub")){s=new d(s)}n.insert(o,s);var a=this.cleanup(s);if(!a)l.handle(s);this.cleanup(n);
if(typeof e==="function")e(this);return true};e.prototype.sourceIsASignGroupOrHasALeadingNegativeCoefficient=function(t){var e=t.children[0].children[0];if(e.is_group("sign"))return true;else if(e.is_group("product")&&e.children[0].children[1].is_group("sign"))return true;return false};function s(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length}function a(t){return t.parent}function h(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(a(e[0].parent)&&s(e))return false;return i(e)===t||n(e)===t||o(e)===t}}return new e}();TriggerFactoringAction=function(){var t=function(t){Action.call(this,"general factoring");this.priority=0;this.side="around";if(t){this.DLOfSum=t.dl;this.viewOfSum=t.view;this.target=t.sum;this.callback=t.callback}};gmath.inherit(Action,t);t.prototype.match=function(t,i){return e(t,i)};t.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var e=function(t,e){var i;i=r(t,e);i=s(i,t);var n=[];for(var o=0;o<i.length;o++){if(i[o].length===0)return false}for(var o=0;o<i.length;o++){if(i[o])n.push(i[o][i[o].length-1])}for(var o=0;o<n.length;o++){if(!Array.isArray(n[o])&&n[o].parent.value!=="add"&&n[o].parent.value!=="sub")n[o]=n[o].parent}return n.length===t.children.length?n:false};var i=function(t,e){var i=[];t.for_each(function(t){var r=t.to_ascii();if(r.slice(0,1)==="*")r=r.substr(1);if(!t.hidden&&r===e)i.push(t);else{var n=[t];while(r.length<e.length&&t.commutative&&t.rs){t=t.rs;r+=t.to_ascii();n.push(t)}if(r===e)i.push(n)}});return i};var r=function(t,e){var r=[];for(var n=0;n<t.children.length;n++){var o=t.children[n],s=o.children[1];r.push(i(s,e.to_ascii()))}return r};function o(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var s=function(t,e){var i=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var r=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var n=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!n(t[o]))e=false}else{return i(t)||r(t)}return e};for(var s=0;s<t.length;s++){t[s]=t[s].filter(o)}return t};var a=function(t,e){var i=l(t),r=p(h(i));var n=e.deconstruct();return v(r,n)};var h=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(t[i].slice())}return e};var l=function(t){var e=[];for(var i=0;i<t.children.length;i++){e.push(u(t.children[i]))}return e};var u=function(t){var e=t.children[1];if(t.value==="add")return e.deconstruct();else return d(e.deconstruct())};var c=function(t){t.push(new n(1));return t};var d=function(t){t.push(new n(-1));return t};var p=function(t){var e=t[0].slice();for(var i=0;i<t.length;i++){f(e,t[i])}return e};var f=function(t,e){for(var i=0;i<t.length;){if(g(t[i],e))t.splice(i,1);else i++}};var g=function(t,e){var i=t.to_ascii();var r=true;for(var n=0;n<e.length;){if(i===e[n].to_ascii()){r=false;e.splice(n,1);return r}else{n++}}return r};var v=function(t,e){var i=true;for(var r=0;r<e.length;r++){if(g(e[r],t)){i=false}}return i};return new t}();gmath.rules=gmath.rules||{};gmath.rules.distributes=function(e,i,r){r=r||"both";var n=e.prototype.value+" "+(r=="both"?"":r+"-")+"distributes over "+i.prototype.value;var o=function(r){var n,s;if(r=="both"){if(!this.is_group(e.prototype.name))return false;return o.call(this,"left")||o.call(this,"right")}else if(r=="left"){n=this;s=this.ls}else if(r=="right"){n=this.ls;s=this}else throw"direction must be left, right or both, not '"+r+"'";if(!(s instanceof e))return;if(!n)return false;var h=n.children[1];if(h.is_group("brackets"))h=h.children[1];if(!h.is_group(i.prototype.group_name))return false;t.remove(s);t.for_each(function(t){t.no_anim=true},s);for(var u=0;u<h.children.length;u++){var c=h.children[u];var d=c.children[1];var p=t.clone(s);if(d instanceof a&&d.children[0]instanceof e){if(r=="left")t.insert(d,0,p);else t.append(d,p)}else{var f=e.prototype.createGroup();t.remove(d);var g=new e(d);t.replace(g.children[0],t.clone(this.children[0]));t.append(f,r=="left"?p:g);t.append(f,r=="left"?g:p);t.append(c,f);l.handle(f)}}n.clean_up();return true};e.prototype.add_action_handler({name:n,run:function(){return o.call(this,r)}})};gmath.rules=gmath.rules||{};gmath.rules.inverse_operation=function(e,i){e.prototype.inverse=i.prototype.value;i.prototype.inverse=e.prototype.value;var r=function(){if(!this.ls)return false;if(this.ls instanceof this.getInverse()&&this.children[1].to_ascii()==this.ls.children[1].to_ascii()){t.remove(this.ls);var i=t.remove(this);t.insert(this.parent,i,new e(t.clone(this.identity_element)));this.parent.clean_up();return true}return false};e.prototype.add_action_handler({name:"inverse elements cancel out each other",run:r});i.prototype.add_action_handler({name:"inverse elements cancel out each other",run:r})};gmath.rules=gmath.rules||{};gmath.rules.identity_element=function(t,e){t.prototype.identity_element=e;var i=e.to_ascii()+" is the identity element of "+t.prototype.value;var r=e.to_ascii();var n=function(t){Action.call(this,i);if(t)this.actor=t.actor};gmath.inherit(Action,n);function o(e){return e&&e instanceof t&&e.children.length==2&&e.children[1].to_ascii()==r}n.prototype.match=function(t){return o(t)||o(t.ls)};n.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(o(e)){this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(e.ls||e.rs));e.remove()}else{this.addTouchedNodes(this.actor.ls);this.updateNodeMap(this.actor.ls.get_mapping_to(e));e.ls.remove()}this.cleanup_cascade(e.parent);if(typeof t==="function")t(this);else return true};t.prototype.add_action_handler(new n)};gmath.rules=gmath.rules||{};gmath.rules.zero_element=function(t,e){t.prototype.zero_element=e;var i=e.to_ascii();var r=i+" is the zero element of "+t.prototype.value;var n=function(t){Action.call(this,r);if(t)this.actor=t.actor};gmath.inherit(Action,n);function o(e){return e&&e instanceof t&&e.children.length==2&&e.children[1].to_ascii()==i}n.prototype.match=function(t){if(!t.ls)return false;return o(t)||o(t.ls)};n.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(o(e)){this.addTouchedNodes(this.actor.ls);this.updateNodeMap(this.actor.ls.get_mapping_to(e));e.ls.remove()}else{this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(e.ls));e.remove()}this.cleanup(e.parent);if(typeof t==="function")t(this);else return true};gmath.actions.ZeroAction=new n;t.prototype.add_action_handler(new n)};gmath.rules=gmath.rules||{};gmath.rules.init_all=function(){gmath.rules.identity_element(d,new n(0));gmath.rules.identity_element(f,new n(1));gmath.rules.zero_element(f,new n(0));gmath.rules.identity_element(y,new m("T"));gmath.rules.zero_element(y,new m("F"));gmath.rules.identity_element(x,new m("F"));gmath.rules.zero_element(x,new m("T"))};gmath.rules.init_all();mtouch_events=function(){var t=k(m,"tap","dbltap","hold","drag","mdrag","touch","release"),e=null,i=[],r={},n=[],o="mouse",s="client",a=null,h=false,l=250,u=10*10,c=500,d=10,p=d*d,f=400,g=20,v=gmath.uid();function m(){e=this;m.connected(true)}m.connected=function(t){if(arguments.length==0)return h;e.on("touchstart."+v,t?y:null).on("mousedown."+v,t?_:null).on("touchmove."+v,t?w:null).on("touchend."+v,t?x:null).on("touchcancel."+v,t?x:null);h=t;return this};m.call=function(t){t.apply(m,arguments);return this};m.frame=function(t){if(arguments.length===0)return s;s=t;return this};m.origin=function(t){if(arguments.length===0)return a;a=t;return this};m.hold_time=function(t){if(arguments.length===0)return c;c=t;return this};m.hold_max_dist=function(t){if(arguments.length===0)return d;d=t;p=d*d;return this};m.dbltap_max_dist=function(t){if(arguments.length===0)return g;g=t;return this};function _(){if(!N(d3.event))return;var t=d3.select(window);var e=this,i=arguments;t.on("mousemove.mtouch",function(){w.apply(e,i)});t.on("mouseup.mtouch",function(){t.on("mousemove.mtouch",null);t.on("mouseup.mtouch",null);x.apply(e,i)});y.apply(this,arguments)}function y(){d3.event.preventDefault();var e=this,n=t.of(e,arguments),o=A();var s=a?a.apply(this,arguments):null;for(var h=0,l=o.length;h<l;h++){var u=new b(o[h].identifier,n,e,s);i.push(u);r[o[h].identifier]=u;n({type:"touch",finger:u,fingers:i})}}function w(){d3.event.preventDefault();var e=this,n=t.of(e,arguments),o=A();for(var s=0,a=i.length;s<a;s++)i[s].changed=false;var h=[];for(var s=0,a=o.length;s<a;s++){var l=r[o[s].identifier];if(!l)continue;l.move(n);h.push(l)}n({type:"mdrag",dragged_fingers:h,fingers:i})}function x(){d3.event.preventDefault();var e=this,n=t.of(e,arguments),o=A();for(var s=0,a=o.length;s<a;s++){var h=r[o[s].identifier];if(!h)continue;h.end(n);delete r[o[s].identifier];i=d3.values(r);n({type:"release",finger:h,fingers:i})}}function b(t,e,i,r){this.id=t;this.target=i;this.event=e;this.parent=i.parentNode;this.timeStamp0=d3.event.timeStamp;this.timeStamp=this.timeStamp0;this.hold_timer=setTimeout(this.held.bind(this),c);this.pos=r?r.slice():D(this.id,s);this.pos0=[this.pos[0],this.pos[1]];this.pos_client=D(this.id,"client");this.dist_x=0;this.dist_y=0;this.dx=0;this.dy=0;this.dt=0;this.changed=true;this.gesture=null}b.prototype.cancel_hold=function(){if(this.hold_timer)clearTimeout(this.hold_timer);this.hold_timer=null};b.prototype.held=function(){this.event({type:"hold",finger:this,fingers:i});this.hold_timer=null};b.prototype.move=function(t){this.changed=true;this.event=t;var e=D(this.id,"client"),r=d3.event.timeStamp;this.dx=e[0]-this.pos_client[0];this.dy=e[1]-this.pos_client[1];this.pos[0]+=this.dx;this.pos[1]+=this.dy;this.dist_x=this.pos[0]-this.pos0[0];this.dist_y=this.pos[1]-this.pos0[1];this.pos_client=e;this.dt=r-this.timeStamp;this.timeStamp=r;if(this.dist_x*this.dist_x+this.dist_y*this.dist_y>p){this.cancel_hold()}if(this.gesture)return;t({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:i})};b.prototype.end=function(t){var e=d3.event.timeStamp-this.timeStamp0;if(e<=l&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=u){if(M(d3.event.timeStamp,this.pos[0],this.pos[1])){t({type:"dbltap",finger:this,fingers:i})}else{t({type:"tap",finger:this,fingers:i})}}this.cancel_hold()};function A(){return d3.event.changedTouches||[{identifier:o}]}function N(t){if("buttons"in t)return t.buttons===1;else if("which"in t)return t.which===1;else return t.button===1}function M(t,e,i){var r=-1,o=[e,i];n=n.filter(function(e,i){if(t-e.timeStamp<=f&&S(e.pos,o)<=g)r=i;return e.timeStamp-t<=f&&r!==i});if(r===-1)n.push({timeStamp:t,pos:o});return r!==-1}function L(t){if(a)return a();else return D(t,s)}function D(t,e){if(e==="client"){if(t===o)return[d3.event.clientX,d3.event.clientY];for(var i=0;i<d3.event.touches.length;i++){var r=d3.event.touches[i];if(r.identifier===t)return[r.clientX,r.clientY]}}else{if(t===o)return T(e,d3.event);for(var i=0;i<d3.event.touches.length;i++){var r=d3.event.touches[i];if(r.identifier===t)return T(e,r)}}}function S(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(m,t,"on")};function k(t){var e=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));e.of=function(i,r){return function(n){try{var o=n.sourceEvent=d3.event;n.target=t;d3.event=n;e[n.type].apply(i,r)}finally{d3.event=o}}};return e}gmath.d3_eventDispatch=k;var M=0;if(typeof window!=="undefined")M=/WebKit/.test(window.navigator.userAgent)?-1:0;function T(t,e){var i=t.ownerSVGElement||t;if(i.createSVGPoint){var r=i.createSVGPoint();if(M<0&&(window.scrollX||window.scrollY)){i=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var n=i[0][0].getScreenCTM();M=!(n.f||n.e);i.remove()}if(M)r.x=e.pageX,r.y=e.pageY;else r.x=e.clientX,r.y=e.clientY;r=r.matrixTransform(t.getScreenCTM().inverse());return[r.x,r.y]}var o=t.getBoundingClientRect();return[e.clientX-o.left-t.clientLeft,e.clientY-o.top-t.clientTop]}drag_behavior=function(){var t=k(u,"drag","drag-start","drag-end"),e=[],i=false,r,n,o,s,a=10,h=5,l=true;var u=function(){this.on("touch.drag",c).on("mdrag.drag",d).on("release.drag",p)};u.min_single_dist=function(t){if(arguments.length===0)return a;a=t;return this};u.min_double_dist=function(t){if(arguments.length===0)return h;h=t;return this};u.allow_double_drag=function(t){if(arguments.length===0)return l;l=t;return this};var c=function(){if(e.length===2||l&&e.length===1)return;e.push(d3.event.finger);if(e.length===2){r=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];n=[r[0],r[1]];s=o=f(e[0].pos,e[1].pos)}else{r=[e[0].pos[0],e[0].pos[1]];n=[r[0],r[1]];o=s=0}};var d=function(){if(e.length===0)return;var l,u=t.of(this,arguments);if(e.length===1){if(!e[0].changed)return;l=[e[0].pos[0],e[0].pos[1]];if(!i&&f(r,n)>=a){i=true;u({type:"drag-start",fingers:e,pos0:r,pos:n,dist0:o,dist:s})}}else{if(!e[0].changed&&!e[1].changed)return;l=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];s=f(e[0].pos,e[1].pos);if(!i&&f(r,n)>=h){i=true;u({type:"drag-start",fingers:e,pos0:r,pos:n,dist0:o,dist:s})}}if(i)u({type:"drag",fingers:e,pos0:r,pos:l,dist0:o,dist:s,dx:l[0]-n[0],dy:l[1]-n[1]});n=l};var p=function(){if(e.length===0)return;var o=d3.event.finger;var s=e.indexOf(o);if(s===-1)return;e.splice(s,1);if(!i)return;if(e.length===1){r=[e[0].pos[0],e[0].pos[1]];n=[r[0],r[1]]}if(e.length===0){i=false;t.of(this,arguments)({type:"drag-end"})}};function f(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(u,t,"on")};var L=function(t,e){if(typeof e==="undefined")e=1e3;var i={},r=[];i.fonts=[];i.map={};i.finished=false;i.success=false;i.svg=d3.select("body").append("svg").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px"});i.on_fonts_loaded=function(t){if(this.finished)t(this.success);else{r.push(t)}};var n=function(){i.loadSizes();for(var t=0;t<r.length;t++){r[t](this.success)}r=[]};i.add_fonts=function(t){var e=false;t.forEach(function(t){var r=o(t);if(r)t.id=r.id;else{t.id=gmath.uid();i.fonts.push(t);e=true}});if(!e)return;i.wait_for_fonts()};var o=function(t){for(var e=0;e<i.fonts.length;e++){var r=i.fonts[e];if(r.style===t.style&&r.family===t.family&&r.weight===t.weight)return r}return null};i.wait_for_fonts=function(){this.finished=false;this.success=false;this.fonts.unshift({family:"serif"});var t=this.svg.selectAll("text.temp").data(this.fonts).enter().append("text").classed("temp",true).attr("font-size","100px").attr("font-family",function(t){return"'"+t.family+"', serif"}).attr("font-style",function(t){return t.style}).attr("font-weight",function(t){return t.weight}).text("012abc");this.fonts.shift();var i=Date.now();var r=this;var o=setInterval(function(){var s=[],a=true;t.each(function(t,e){s[e]=this.getBBox().width});for(var h=1;h<s.length;h++){if(s[h]===s[0])a=false}var l=Date.now()-i;if(!a&&l<=e)return;r.success=a;r.finished=true;t.remove();clearInterval(o);n()},20)};i.loadSizes=function(t,e){t=t||"xyz0123456789()=+-*^∗·•−,.";e=e||this.fonts;var i=[];for(var r=0;r<e.length;r++){if(!this.map[e[r].id]){this.map[e[r].id]={}}for(var n=0;n<t.length;n++){var o={font:e[r],"char":t[n],width:0,height:0};this.map[e[r].id][t[n]]=o;i.push(o)}}this.svg.selectAll(".hiddenChars").data(i).enter().append("text").attr("font-size","100px").attr("font-family",function(t){return t.font.family}).attr("font-style",function(t){return t.font.style}).attr("font-weight",function(t){return t.font.weight}).text(function(t){return t.char}).each(function(t){var e=this.getBBox();t.width=e.width;t.height=e.height}).remove()};i.width=function(t,e,i){var r=0,n=t.toString();for(var o=0;o<n.length;o++){if(!this.map[i.id]||!this.map[i.id][n[o]])this.loadSizes(n[o],[i]);r+=this.map[i.id][n[o]].width}return r*e/100};i.height=function(t,e,i){var r=0,n=t.toString();for(var o=0;o<n.length;o++){if(!this.map[i.id]||!this.map[i.id][n[o]])this.loadSizes(n[o],[i]);r=Math.max(this.map[i.id][n[o]].height,r)}return r*e/100};i.add_fonts(t);return i};transform_behavior=function(){var t=k(m,"transform","transformend","transformstart"),e=[],i=0,r=0,n=0,o=1,s={scale:true,translate:true,rotate:true},a=true,h,l,u,c,d,p,f,g,v;var m=function(){this.on("touch.transform",_).on("mdrag.transform",y).on("release.transform",w)};m.transform=function(t){if(!arguments.length)return{scale:o,rotate:n,translate:[i,r]};if("scale"in t)o=t.scale;if("rotate"in t)n=t.rotate;if("translate"in t){i=t.translate[0];r=t.translate[1]}return m};m.one_finger_drag=function(t){if(!arguments.length)return a;a=t;return m};m.allow_translate=function(t){if(!arguments.length)return s.translate;s.translate=t;return m};m.allow_scale=function(t){if(!arguments.length)return s.scale;s.scale=t;return m};m.allow_rotate=function(t){if(!arguments.length)return s.rotate;s.rotate=t;return m};var _=function(){if(e.length===2)return;e.push(d3.event.finger);if(e.length===1&&a){h=l=[e[0].pos[0],e[0].pos[1]];u=A(l);t.of(this,arguments)({type:"transformstart"})}if(e.length===2){h=l=T(e[0].pos,e[1].pos);c=d=M(e[0].pos,e[1].pos);p=f=L(e[0].pos,e[1].pos);u=A(l);g=o;v=n}};var y=function(){if(e.length===0)return;if(!d3.event.dragged_fingers.some(function(t){return t.changed}))return;if(e.length===1){if(!a)return;if(s.translate)h=[e[0].pos[0],e[0].pos[1]];N(h,u)}if(e.length===2){if(s.scale)c=M(e[0].pos,e[1].pos);if(s.translate)h=T(e[0].pos,e[1].pos);if(s.rotate)p=L(e[0].pos,e[1].pos);x()}t.of(this,arguments)({type:"transform",fingers:e,transform:{scale:o,rotate:n,translate:[i,r]}})};var w=function(){if(e.length===0)return;var i=d3.event.finger;var r=e.indexOf(i);if(r===-1)return;e.splice(r,1);if(e.length===0){t.of(this,arguments)({type:"transformend"})}if(e.length===1){h=l=[e[0].pos[0],e[0].pos[1]];u=A(l)}};var x=function(){if(s.rotate)n=v+(p-f);if(s.scale)o=g*c/d;if(s.translate||s.rotate||s.scale)N(h,u)};var b=function(t){var e=Math.cos(n),s=Math.sin(n);var a=t[0]*e-t[1]*s,h=t[1]*e+t[0]*s;return[a*o+i,h*o+r]};var A=function(t){var e=(t[0]-i)/o,s=(t[1]-r)/o;var a=Math.cos(-n),h=Math.sin(-n);return[e*a-s*h,s*a+e*h]};var N=function(t,e){e=b(e);i+=t[0]-e[0];r+=t[1]-e[1]};function M(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function T(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function L(t,e){return Math.atan2(t[1]-e[1],t[0]-e[0])}return d3.rebind(m,t,"on")};gmath.transform_behavior=transform_behavior;var D={};D.draw=function(t,e,i){var r=t.selectAll(".target_area").data(e?e:[]);r.enter().append("rect").classed("target_area",true).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"});r.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});r.exit().remove();var n=t.selectAll(".source_area").data(i?[i]:[]);n.enter().append("rect").classed("source_area",true).style({fill:"none",stroke:"steelblue","stroke-width":2});n.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});n.exit().remove()};D.getBoundingBox=function(t,e,i){if(arguments.length<2)e=1;var r=Infinity,n=-Infinity,o=Infinity,s=-Infinity;for(var a=0;a<t.length;a++){var h=t[a];if(h.hidden)continue;var l=i?h.x0||0:h.x,u=i?h.y0||0:h.y;r=Math.min(r,h.sel_box.x+l);n=Math.max(n,h.sel_box.x+l+h.sel_box.width);o=Math.min(o,h.sel_box.y+u);s=Math.max(s,h.sel_box.y+u+h.sel_box.height)}var c=n-r,d=s-o;return{x:r+c*(1-e)/2,y:o+d*(1-e)/2,width:c*e,height:d*e}};D.setTargetRegions=function(t,e){t.forEach(function(t){var i=t.target;switch(t.side){case"left-of":t.x=i.sel_box.x+i.x-.5;t.width=1;t.y=i.sel_box.y+i.y;t.height=i.sel_box.height;break;case"right-of":t.x=i.sel_box.x+i.x+i.sel_box.width-.5;t.width=1;t.y=i.sel_box.y+i.y;t.height=i.sel_box.height;break;case"below":t.x=i.sel_box.x+i.x;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y+i.sel_box.height-.5;t.height=1;break;case"above":t.x=i.sel_box.x+i.x;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y-.5;t.height=1;break;default:if(Array.isArray(i)){var r=D.getBoundingBox(t.target);t.x=r.x;t.width=r.width;t.y=r.y;t.height=r.height}else{t.x=i.sel_box.x+i.x;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y;t.height=i.sel_box.height}break}D.adjustTargetBoxByMargin(t,e);if(t.offset){t.x+=t.offset.x;t.y+=t.offset.y}});D.extendExtremeTargetBoxes(t)};D.adjustTargetBoxByMargin=function(t,e){if(!t.margin)return;var i=0,r=0,n=0,o=0;if(t.margin.all){i=r=n=o=t.margin.all}if(t.margin.x){i=r=t.margin.x}if(t.margin.y){n=o=t.margin.y}if(t.margin.x1)i=t.margin.x1;if(t.margin.y1)n=t.margin.y1;if(t.margin.x2)r=t.margin.x2;if(t.margin.y2)o=t.margin.y2;i*=e;n*=e;r*=e;o*=e;t.x+=i;t.width-=r+i;t.y+=n;t.height-=o+n;if(t.width<=0){t.x+=-i>-r?-t.width/2:t.width/2;t.width=1}if(t.height<=0){t.y+=-n>-o?-t.height/2:t.height/2;t.height=1}};D.extendExtremeTargetBoxes=function(t){var e,i;var r;for(var n=0;n<t.length;n++){var o=t[n];if(!o.nodes)continue;if(!r)r=D.getBoundingBox(o.nodes,1,true);if(!e&&o.x+o.width<r.x||e&&o.x<e.x&&o.x+o.width<r.x)e=o;if(!i&&r.x+r.width<o.x||i&&i.x<o.x&&r.x+r.width<o.x)i=o}if(e&&e.side!=="inside"){e.x-=1e3;e.width+=1e3;e.y-=500;e.height+=1e3}if(i&&i.side!=="inside"){i.width+=1e3;i.y-=500;i.height+=1e3}};D.getHits=function(t,e){return t.filter(function(t){return t.side!=="outside"&&D.overlaps(t,e)}).concat(t.filter(function(t){return t.side==="outside"&&!D.overlaps(t,e)}))};D.getBestHit=function(t,e){var i=D.getHits(t,e);return D.getHighestPriorityHit(i,e)};D.getEnclosingRectForSourceLineEndpoint=function(t){return{xmin:t.B.x-2,ymin:t.B.y-2,xmax:t.B.x+2,ymax:t.B.y+2}};D.overlaps=function(t,e){return(t.x>=e.x&&t.x<=e.x+e.width||t.x+t.width>=e.x&&t.x+t.width<=e.x+e.width||t.x<=e.x&&t.x+t.width>=e.x+e.width)&&(t.y>=e.y&&t.y<=e.y+e.height||t.y+t.height>=e.y&&t.y+t.height<=e.y+e.height||t.y<=e.y&&t.y+t.height>=e.y+e.height)};D.getHighestPriorityHit=function(t,e){var i=null;for(var r=0;r<t.length;r++){var n=t[r];if(!i)i=n;else if(i.side==="outside")i=n;else if(n.priority>i.priority)i=n;else if(n.priority===i.priority){if(D.getCenterDist(n,e)<D.getCenterDist(i,e))i=n}}return i};D.getCenterDist=function(t,e){var i=t.x+t.width/2-e.x-e.width/2,r=t.y+t.height/2-e.y-e.height/2;return Math.sqrt(i*i+r*r)};D.getOverlapArea=function(t,e){var i=Math.max(t.x,e.x)-Math.min(t.x+t.width,e.x+e.width),r=Math.max(t.y,e.y)-Math.min(t.y+t.height,e.y+e.height);return Math.max(0,i)*Math.max(0,r)};var S=function(t,e){this.view=t;this.alm=t.model;this.nodes=[];this.line={A:{},B:{}};this.line_el=null;this.interaction_handler=e;this.action=gmath.actions.FractionCancelAction};S.prototype.check=function(t,e){return t.fingers.length==1&&e.length==0};S.prototype.start=function(t,e){this.line_el=this.view.main.append("line").classed("cancel-fraction",true).style("stroke",this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");this.nodes=[];this.line.A.x=this.line.B.x=t[0];this.line.A.y=this.line.B.y=t[1];return[]};S.prototype.update=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;var e=this.process_selection(this.get_crossed_nodes());var i=true;if(this.nodes.length!=e.length)i=false;else for(var r=0;r<this.nodes.length;r++)i=i&&this.nodes[r]==e[r];if(!i)this.interaction_handler.highlight_nodes(e);this.nodes=e;this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};S.prototype.end=function(){this.line_el.remove();var t=this.nodes[0],e;if(this.nodes.length===3&&this.nodes[1].value==="//")e=this.nodes[2];else if(this.nodes.length===2)e=this.nodes[1];if(e&&this.action.match(t,e)){var i=this.actions.createBoundAction(this.alm,{nodes:[e],target:t});this.alm.performAction(i,null,"cancel fraction")}this.nodes=[]};S.prototype.process_selection=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0].parent];var r=t.get_cca(e);if(r.is_group("fraction")){var n=[];for(var o=0;o<e.length;o++){var s=e[o];while(s.parent!=r)s=s.parent;if(s.value=="//"&&r.get_bottom().length!=1)continue;if(n.indexOf(s)==-1)n.push(s)}return n}else return[r]};S.prototype.get_crossed_nodes=function(){var e=[];var i=t.get_leaf_nodes(this.alm);for(var r=0;r<i.length;r++){var n=i[r];if(!n.hidden&&this.intersects(n))e.push(n)}return e};S.prototype.intersects=function(t){var e=this.line.A,i=this.line.B;var r=t.sel_box.x+t.x,n=t.sel_box.x+t.sel_box.width+t.x;var o=t.sel_box.y+t.y,s=t.sel_box.y+t.sel_box.height+t.y;if(e.x<r&&i.x<r)return false;if(e.x>n&&i.x>n)return false;if(e.y<o&&i.y<o)return false;if(e.y>s&&i.y>s)return false;var a=function(t,r){return(e.x-i.x)*(e.y-r)-(e.y-i.y)*(e.x-t)<0};if(a(r,o)!=a(n,o))return true;if(a(n,o)!=a(r,s))return true;if(a(r,s)!=a(n,s))return true;return false};var E=function(t,e){this.default_precision=1;this.interaction_handler=e;this.precision=null;this.view=t;this.dy=0;this.pixels_per_unit=50;this.node=null;this.value=null;this.value0=null};E.prototype.check=function(t){var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};E.prototype.start=function(t,e){this.old_anim_dur=this.view.options.dur;this.view.options.dur=0;this.node=this.process_selection(e);if(!this.node)return[];if(this.node&&this.node.precision)this.precision=this.node.precision;else this.precision=this.default_precision;this.dy=0;this.value=this.value0=this.view.model.numeric_value(this.node);return[this.node]};E.prototype.update=function(t){if(!this.node||!t.dy)return;this.dy+=t.dy;var e=-this.dy/this.pixels_per_unit;this.set_value(this.value0+e)};E.prototype.set_value=function(t){t=+t.toFixed(this.precision);if(t===this.value)return;this.value=t;var e=this.view.model.numeric_value(this.node,t);if(e instanceof n){e.scrubbingThisNum=true;e.precision=this.precision}else if(e.is_group("add","sub","sign")){e.children[1].scrubbingThisNum=true;e.children[1].precision=this.precision}if(e!==this.node){this.interaction_handler.highlight_nodes(this.start(null,[e]))}};E.prototype.end=function(){if(this.node){if(this.node instanceof n)delete this.node.scrubbingThisNum;if(this.node.is_group("add","sub","sign"))delete this.node.children[1].scrubbingThisNum;this.view.update_all()}this.view.options.dur=this.old_anim_dur;this.node=null};E.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof n&&e(i))return i.parent;return null}var r=t[0];if(r instanceof n){if(e(r.parent))return r.parent;else return r}else if(e(r))return r;return null};var P=function(t,e,i){this.send_events=true;this.events=d3.dispatch("tap","drag_start","drag","drag_end","touch","release","hold","inspect_node","keyup","keydown");this.view=t;this.recorder=i;this.mode="transform";this.interactive=e;this.init();if(!e)this.set_interactive(false);this.selected_nodes=[];this.handlers={transform:[new H(this.view,this),new K(this.view,this),new V(this.view,this),new j(this.view,this),new W(this.view,this)],inspect:[new E(this.view,this)],link:[new Z(this.view,this)]};this.active_handler=null;this.finger_vis=null};P.prototype.getHandlerByClass=function(t){var e=function(e){return e instanceof t};for(var i in this.handlers){var r=this.handlers[i].filter(e);if(r.length>0)return r[0]}};P.prototype.end_of_interaction=function(){this.view.model.finishInteraction()};P.prototype.init=function(){var t=this.view.main.node();this.mtouch=mtouch_events().frame(t);this.view.event_receiver.call(this.mtouch);this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null)).on("hold",this.on_hold.bind(this,null));var e=drag_behavior().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(e);this.uid=gmath.uid();d3.select(document).on("keydown."+this.uid,this.on_keydown.bind(this,null));d3.select(document).on("keyup."+this.uid,this.on_keyup.bind(this,null))};P.prototype.abort_interaction=function(){if(this.active_handler)this.active_handler.end();this.active_handler=null;this.selected_nodes=[]};P.prototype.set_mode=function(t){if(t!=="transform"&&t!=="inspect"&&t!=="link")throw"unknown interaction mode!";this.mode=t;if(!this.interactive)this.mtouch.connected(this.mode==="inspect")};P.prototype.set_interactive=function(t){this.interactive=!!t;if(this.mode==="inspect")this.mtouch.connected(true);else this.mtouch.connected(this.interactive)};P.prototype.select_new_handler=function(t){var e=this.handlers[this.mode]||[];for(var i=0;i<e.length;i++){var r=e[i];if(r.check(t,this.selected_nodes)){this.active_handler=r;this.selected_nodes=r.start(t.pos,this.selected_nodes);this.highlight_nodes();return}}};P.prototype.on_keydown=function(t){var e=t||d3.event;if(e.keyCode!==32)return;if(this.spaceBarDown)return;this.spaceBarDown=true;if(this.send_events)this.events.keydown(new I("down",e,this.uid))};P.prototype.on_keyup=function(t){var e=t||d3.event;if(e.keyCode!==32)return;this.spaceBarDown=false;if(this.send_events)this.events.keyup(new I("up",e))};P.prototype.on_tap=function(t){var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.tap(new F(e,this.uid));if(this.active_handler){console.error("should not happen");this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();this.active_handler=null}if(e.shiftKey)return;var i=this.get_closest_node_at(e.finger.pos);if(i)i=this.getFirstUnfixedParent(i);if(!i)return;var r=this;if(this.mode==="inspect")this.events.inspect_node({node:i});if(this.mode==="transform"){this.view.model.process_operator(i,function(){r.selected_nodes=[];r.highlight_nodes();r.end_of_interaction()})}};P.prototype.on_hold=function(t){var e=this.selectInputEvent(t,d3.event);if(this.active_handler||this.mode!=="transform"){return}if(this.send_events)this.events.hold(new B(e,this.uid));var i=this.get_closest_node_at(e.finger.pos);if(!i){return}if(this.view.options.replace_value_on&&gmath.actions.RewriteNumberWithKeyboardAction.match(i)){var r=gmath.actions.RewriteNumberWithKeyboardAction.createBoundAction(this.view.model,{actor:i});this.view.model.performAction(r)}};P.prototype.getFirstUnfixedParent=function(t){while(t.fixed&&t.parent&&!i.is_top_most(t.parent))t=t.parent;return t};P.prototype.selectInputEvent=function(t,e){if(t)return t;var i=e;while(i.sourceEvent)i=i.sourceEvent;e.shiftKey=i.shiftKey;e.altKey=i.altKey;return e};P.prototype.on_drag_start=function(e){if(!this.interactive&&this.mode!=="inspect")return;var i=this.selectInputEvent(e,d3.event);if(this.send_events)this.events.drag_start(new C(i,this.uid));if(this.active_handler)return;if(this.selected_nodes.length>1){this.selected_nodes=t.nodes_to_range(this.selected_nodes)}this.select_new_handler(i)};P.prototype.update_fingers=function(t,e){if(!this.finger_sel){var i=this.view.svg.node();while(i.tagName.toLowerCase()!=="svg")i=i.parentNode;this.finger_sel=d3.select(i).selectAll(".finger");var r=d3.touches(i,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];var n=d3.touches(this.view.svg.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[n[0]-r[0],n[1]-r[1]];this.finger_vis_start=Date.now()}var o=this.finger_sel.data(t);if(!e){o.enter().append("circle").classed("finger",true).attr("r",25).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5})}var s=this.dpos_finger_vis;o.attr("cx",function(t){return t.pos[0]-s[0]}).attr("cy",function(t){return t.pos[1]-s[1]});o.transition().ease("bounce").attr("r",17);var a=this.finger_vis_start;o.exit().transition().delay(Math.max(0,250-(Date.now()-a))).style("opacity",1e-4).remove();this.finger_sel=o.size()===0?null:o};P.prototype.on_drag=function(t){if(!this.interactive&&this.mode!=="inspect")return;
var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.drag(new R(e,this.uid));if(t)this.update_fingers(t.fingers,true);if(!this.active_handler)this.select_new_handler(e);if(this.active_handler)this.active_handler.update(e)};P.prototype.on_drag_end=function(){if(!this.interactive&&this.mode!=="inspect")return;if(this.send_events)this.events.drag_end(new z(this.uid));if(!this.active_handler)return;this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();var t=this.active_handler instanceof H;this.active_handler=null;if(!t)this.end_of_interaction()};P.prototype.on_touch=function(t){if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.touch(new q(e,this.uid));if(t)this.update_fingers(t.fingers);if(this.active_handler)return;if(e.fingers.length===1){var i=this.get_user_selection(e.fingers[0],null,e);if(e.shiftKey){this.selected_nodes=gmath.array.xor(this.selected_nodes,i)}else{if(!gmath.array.containsAll(this.selected_nodes,i)){this.selected_nodes=i}}}else if(e.fingers.length===2){this.selected_nodes=this.get_user_selection(e.fingers[0],e.fingers[1],e)}this.highlight_nodes()};P.prototype.on_release=function(t){if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.release(new G(e,this.uid));if(t)this.update_fingers(t.fingers);if(e.fingers.length===0&&!e.shiftKey){this.selected_nodes=[];this.highlight_nodes()}};P.prototype.get_user_selection=function(e,r,n){var o;if(r)o=this.get_nodes_between(e.pos,r.pos);else{var s=this.get_closest_node_at(e.pos);if(!s)return[];s=this.getFirstUnfixedParent(s);if(n.altKey||this.spaceBarDown){while(s.parent.parent&&!s.parent.commutative)s=s.parent;var a=s.parent.parent;if(a&&a.is_group("fraction")){o=s.parent.is_group("mul")?a.get_top():a.get_bottom()}else if(s.parent.commutative)o=[s.parent.parent];else o=i.is_top_most(s.parent)?[s]:[s.parent]}else o=[s]}return t.nodes_to_range(o)};P.prototype.highlight_nodes=function(e){if(!e)e=this.selected_nodes;var i=this.view;t.for_each(function(t){t.selected=false},i.model.children);for(var r=0;r<e.length;r++)e[r].selected=true;i.renderer.set_style(i.model.children,true);i.update_style()};P.prototype.get_hits=function(e){var i=e[0],r=e[1];return t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&i<=t.x+t.sel_box.x+t.sel_box.width&&i>=t.x+t.sel_box.x&&r<=t.y+t.sel_box.y+t.sel_box.height&&r>=t.y+t.sel_box.y})};P.prototype.get_closest_node_at=function(t){var e=null,i=Infinity;var r=t[0],n=t[1];var o=this.get_hits(t);for(var s=0;s<o.length;s++){if(o[s].hidden)continue;var a=o[s].x-r;var h=o[s].y-o[s].baseline_shift-n;var l=a*a+h*h;if(l<i){i=l;e=o[s]}}return e};P.prototype.get_nodes_between=function(e,i){var r=0;return t.get_leaf_nodes(this.view.model).filter(function(t){if(t.hidden||!t.sel_box||t.value=="//")return false;var n=[t.x+t.sel_box.x+t.sel_box.width/2,t.y+t.sel_box.y+t.sel_box.height/2];var o=O(e,i,n);var s=t.sel_box.width/4+t.sel_box.height/4;if(o.len==0)return o.dist<=s+r;return o.k>=0&&o.k<=1&&o.dist<=s+r})};var O=function(t,e,i){var r,n,o=.5;var s=[e[0]-t[0],e[1]-t[1]];var a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(a<1e-6){r=t[0]-i[0];n=t[1]-i[1];a=0}else{var h=[i[0]-t[0],i[1]-t[1]];var o=(s[0]*h[0]+s[1]*h[1])/a;var r,n;if(o<0){r=t[0]-i[0];n=t[1]-i[1]}else if(o>a){r=e[0]-i[0];n=e[1]-i[1]}else{r=t[0]+o*s[0]/a-i[0];n=t[1]+o*s[1]/a-i[1]}}return{dist:Math.sqrt(r*r+n*n),k:o/a,len:a}};var C=function(t,e){this.type="drag_start";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.dist=t.dist;this.dist0=t.dist0;if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers={length:t.fingers.length}};var F=function(t,e){this.type="tap";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var I=function(t,e,i){this.type="key"+t;this.performee=i;this.performee_type="interaction-handler";this.time=Date.now();this.keyCode=e.keyCode};var B=function(t,e){this.type="hold";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var R=function(t,e){this.type="drag";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.dx=t.dx;this.dy=t.dy;this.dist=t.dist;this.dist0=t.dist0;this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var z=function(t){this.type="drag_end";this.performee=t;this.performee_type="interaction-handler";this.time=Date.now()};var q=function(t,e){this.type="touch";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var G=function(t,e){this.type="release";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var j=function(t){this.view=t;this.alm=this.view.model;this.nodes=[];this.node_ids=[];this.joined=false;this.unjoined_state=null};j.prototype.check=function(t){return t.dist-t.dist0<-15};j.prototype.start=function(t,e){this.nodes=this.proccess_selection(e);this.node_ids=this.nodes.map(function(t){return t.id});return this.nodes};j.prototype.update=function(e){if(this.joined){if(e.dist>3*e.dist0/4+10)this.unjoin();return}if(this.nodes.length<1||e.dist>3*e.dist0/4)return;var i=this.nodes[0].commutative?1:0;this.unjoined_state=t.clone(this.alm.children[0],true);this.unjoined_state.parent=this.alm;this.joined=true;var r=this;var n=function(t){r.alm.process_operator(r.nodes[t],function(){if(t+1<r.nodes.length)n(t+1);else r.nodes=[]})};n(i)};j.prototype.unjoin=function(){var e=this.alm;this.joined=false;e.children[0]=this.unjoined_state;e.changed();this.nodes=this.node_ids.map(function(i){return t.get_by_id(i,e.children)})};j.prototype.end=function(){this.nodes=[];this.node_ids=[];this.unjoined_state=null;this.joined=false};j.prototype.proccess_selection=function(t){if(t.length!==2)return t;if(!t[0].parent.commutative||!t[1].is_group())return t;return t[1].children.slice()};var H=function(t,e){this.view=t;this.alm=this.view.model;this.interaction_handler=e;this.initial_nodes=[];this.nodes=[];this.pos0=null;this.pos=null;this.box_el=null};H.prototype.check=function(t){return t.shiftKey};H.prototype.start=function(t,e){this.pos0=t.slice();this.pos=t.slice();this.initBox();this.initial_nodes=e;return e};H.prototype.update=function(t){this.pos[0]+=t.dx;this.pos[1]+=t.dy;this.updateBox();var e=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);if(gmath.array.isPermutation(e,this.nodes))return;this.nodes=e;this.highlight()};H.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)};H.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")};H.prototype.getNodesInRect=function(e,i,r,n){var o=Math.min(e,r),s=Math.max(e,r);var a=Math.min(i,n),h=Math.max(i,n);var l=t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&o<=t.x+t.sel_box.x+t.sel_box.width&&s>=t.x+t.sel_box.x&&a<=t.y+t.sel_box.y+t.sel_box.height&&h>=t.y+t.sel_box.y});return l};H.nodeIsNotFractionBar=function(t){return t.value!=="//"};H.prototype.highlight=function(){this.interaction_handler.highlight_nodes(gmath.array.mergedNew(this.initial_nodes,this.nodes))};H.prototype.end=function(){this.box_el.remove();return gmath.array.mergedNew(this.initial_nodes,this.nodes).filter(H.nodeIsNotFractionBar)};var W=function(t,e){this.view=t;this.nodes=null;this.splitted=false;this.new_state=null;this.prevDist=null;this.interaction_handler=e;this.actions=[SplitNumberAction,SplitProductAction,SplitPowerAction,SplitPowerSumAction,RemoveBracketsAction]};W.prototype.check=function(t){return t.dist-t.dist0>15};W.prototype.start=function(t,e){this.prevDist=null;this.nodes=e;return this.nodes||[]};W.prototype.end=function(){this.node=null;this.splitted=false};W.prototype.getBestAction=function(t,e,i){var r=i;this.actions.forEach(function(i){if(r&&i.priority<=r.priority)return;if(i.match(e))r=i.createBoundAction(t,{actor:e})});for(var n=e.children.length-1;n>=0;n--){var o=e.children[n];var s=this.getBestAction(t,o,r);if(s)r=s}return r};W.prototype.split=function(e,i){var r;for(var n=i.length-1;n>=0;n--){r=this.getBestAction(e,i[n],r)}if(!r)return false;e.performAction(r);var o=t.nodes_to_range(r.mapNodes(r.actor));return o};W.prototype.update=function(t){if(!this.nodes)return;if(this.prevDist!==null&&t.dist-this.prevDist<=30)return;var e=this.split(this.view.model,this.nodes);if(!e)return;this.prevDist=t.dist;this.nodes=e;this.interaction_handler.highlight_nodes(this.nodes)};var V=function(t,e){this.id=gmath.uid();this.view=t;this.interaction_handler=e;this.dl=t.options.derivation_list;this.dx=0;this.dy=0;this.nodes=[];this.smooshedNodes=[];this.smooshing=false;this.bbox=null;this.actions=[];this.target_areas=null;this.active=false};V.show_target_areas=false;V.prototype.check=function(t,e){var i=t.pos0[0]-t.pos[0],r=t.pos0[1]-t.pos[1];if(t.fingers.length===1&&e.length===0)return false;return i*i+r*r>=8*8};V.prototype.isActive=function(){return this.active};V.prototype.start=function(t,e,i){if(this.dl)this.dl.setLastHandleVisibility(false);var r=gmath.extend({reselect_nodes:true,move_nodes:true},i);this.active=true;this.center=t.slice();this.nodes=r.reselect_nodes?this.process_selection(e):e;this.interaction_handler.events.on("keydown."+this.id,this.selectNodesOneLevelUp.bind(this));this.do_not_move_nodes=!r.move_nodes;for(var n=0;n<this.nodes.length;n++){var o=this.nodes[n];o.dragging=true;o.x0=o.x;o.y0=o.y}if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.setupActions(r.actions);return this.nodes};V.prototype.selectNodesOneLevelUp=function(){if(this.nodes.length===0||!t.is_range(this.nodes))return;if(this.nodes[0].parent.is_root())return;if(this.smooshing){this.cancelSmooshing()}var e=[];for(var i=0;i<this.nodes.length;i++){if(e.indexOf(this.nodes[i].parent!==-1)){e.push(this.nodes[i].parent)}}e=this.process_selection(e);if(this.nodes.some(function(t){return e.indexOf(t)!==-1})){return}this.nodes.forEach(function(t){t.dragging=false});var r={x:this.nodes[0].x-this.nodes[0].x0,y:this.nodes[0].y-this.nodes[0].y0};for(var i=0;i<e.length;i++){var n=e[i];n.dragging=true;n.x+=r.x;n.y+=r.y;n.x0=n.x;n.y0=n.y}this.nodes=e;if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.interaction_handler.highlight_nodes(this.nodes);this.view.update_positions();this.view.renderer.set_position(this.nodes);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.setupActions();this.view.update_positions();return this.nodes};V.prototype.update=function(e){var i=e.dx,r=e.dy,n=this;if(!this.do_not_move_nodes){t.for_each(function(t){if(n.smooshedNodes.length===0||n.smooshedNodes.every(function(e){return e.indexOf(t)===-1})){t.x+=i;t.y+=r}else{console.log(t.stringify())}},this.nodes);this.smooshedNodes.forEach(function(e){t.for_each(function(t){t.x+=i;t.y+=r},e)})}this.bbox.x+=i;this.bbox.y+=r;this.center[0]+=i;this.center[1]+=r;if(this.smooshing){this.view.updateSmooshIndicator(this.center)}if(V.show_target_areas)D.draw(this.view.main,this.actions,this.bbox);var o=D.getBestHit(this.actions,this.bbox);if(o&&o.delay&&!o.timeoutID)this.applyTimeout(o);else if(o&&!o.delay&&!o.timeoutID)this.performAction(o);else if(!o)this.stopAllTimeouts();this.view.update_positions();if(this.smooshing){this.view.updateSmooshed(this.smooshedNodes)}};V.prototype.reorderInRanges=function(t){if(t.length<2)return t;var e=t[0].get_root();var i=0;e.for_each(function(t){t.order_num=i++});return t.sort(function(t,e){return t.order_num-e.order_num})};V.prototype.performAction=function(e){this.stopAllTimeouts();var i=this.view.model.getNodes("=",0),r;if(i)r={x:i.x,y:i.y};console.log(e.name);this.view.model.performAction(e);if(this.dl)this.dl.setLastHandleVisibility(false);var n=e.new_selection?e.new_selection:e.mapNodes(this.nodes);this.reorderInRanges(n);n=this.process_each_selection(n);if(this.smooshedNodes.length>0&&!e.is_join_action){this.cancelSmooshing()}var o=true,s;if(this.nodes.length!==n.length)o=false;else for(s=0;s<this.nodes.length;s++)o=o&&this.nodes[s]===n[s];if(!o){if(e.is_join_action){this.addSmooshedNodes(e);this.view.enterSmooshed(this.smooshedNodes);this.shrinkNewSmooshedNodes();this.positionSmooshedNodesInWheel();this.view.updateSmooshed(this.smooshedNodes)}this.interaction_handler.highlight_nodes(n);for(s=0;s<this.nodes.length;s++)this.nodes[s].dragging=false;e.newTree.for_each(function(t){t.dragging=false});for(s=0;s<n.length;s++)n[s].dragging=true;this.correctNodePositions(n,e);this.view.model.hide_nodes();if(e.is_join_action)for(s=0;s<n.length;s++)t.for_each(function(t){t.hidden=true},n[s])}this.nodes=n;this.updateNodePositionsAroundTarget(e);this.view.update_style();this.setupActions();this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.view.update_positions()};V.prototype.addSmooshedNodes=function(e){var i=function(i){var r=t.get_leaf_nodes(i);r=r.map(function(t){return e.initial_node_map[t.id][0]});if(r.length>0)r[0].hidden=false;return r};this.smooshing=true;if(this.smooshedNodes.length===0){this.smooshedNodes.push(i(e.nodes))}this.smooshedNodes.push(i([e.target]))};V.prototype.shrinkNewSmooshedNodes=function(){var t=this;if(this.smooshedNodes.length===2){this.smooshedNodes=this.smooshedNodes.map(t.shrinkSmooshedNodesGroup.bind(t))}else{var e=this.smooshedNodes[this.smooshedNodes.length-1];e=this.shrinkSmooshedNodesGroup(e)}};V.prototype.shrinkSmooshedNodesGroup=function(e){var i=e[0].parent;i.size=i.size*this.view.options.smooshed_nodes_shrink_factor;t.for_each(function(t){t.size=i.size},i);this.view.renderer.set_position([i],true);return e};V.prototype.positionSmooshedNodesInWheel=function(){var t=this.smooshedNodes.length,e=this.calculatePositionOnCircleForEachGroup(t);for(var i=0;i<this.smooshedNodes.length;i++){var r=this.smooshedNodes[i],n=r[0].parent;n.x=this.center[0]+n.width/2;n.y=this.center[1]+n.height/2;n.x+=e[i][0];n.y+=e[i][1];var o=n.children.slice();this.view.renderer.set_position(o,false)}};V.prototype.calculatePositionOnCircleForEachGroup=function(t){var e=this.view.options.font_size;var i=360/t,r=270,n=r;var o=[r];for(var s=0;s<t-1;s++){n+=i;n=(n+360)%360;o.push(n)}var a=function(t){return t*Math.PI/180};return o.map(function(t){return[e*Math.cos(a(t)),e*Math.sin(a(t))]})};V.prototype.cancelSmooshing=function(){this.smooshing=false;this.smooshedNodes=[];this.view.exitSmooshed();this.view.exitSmooshIndicator()};V.prototype.setupActions=function(t){if(this.smooshing){var e=this.view.options.font_size*.1;this.bbox={x:this.center[0]-e,y:this.center[1]-e,width:2*e,height:2*e};this.view.enterSmooshIndicator(this.center)}else{this.bbox=D.getBoundingBox(this.nodes,0);this.bbox.x-=5;this.bbox.width=10;this.bbox.y-=8;this.bbox.height=16}this.actions=t||this.view.model.getMoveActions(this.nodes);if(!this.view.options.enable_drag_to_join)this.actions=this.actions.filter(function(t){return!t.is_join_action});D.setTargetRegions(this.actions,this.view.options.font_size);if(V.show_target_areas)D.draw(this.view.main,this.actions,this.bbox)};V.prototype.updateNodePositionsAroundEquals=function(e){var i=this.view.model.getNodes("=",0);if(i){var r=e.x-i.x,n=e.y-i.y;console.log("dx",r,"dy",n);var o=t.select_all(this.nodes);this.view.model.children[0].for_each(function(t){if(o.indexOf(t)!==-1){t.x0+=r;t.y0+=n}else{t.x+=r;t.y+=n}})}this.view.update_positions()};V.prototype.correctNodePositions=function(e,i){if(i.makes_no_changes)return;var r=null;for(var n=0;n<this.nodes.length;n++){var o=i.mapNodes(this.nodes[n]);if(o.length!==1&&i.name!=="composed action of inverting terms across an equation and commuting"&&i.name!=="invert terms across equation")continue;r=t.select_first(function(t){return t===o[0]},e);if(r)break}if(r){var s={x:r.x-r.x0,y:r.y-r.y0};t.for_each(function(t){if(t.x===t.x0&&t.y===t.y0){t.x+=s.x;t.y+=s.y}},e)}if(i.is_join_action){var a=this;e.forEach(function(t){t.y+=a.center[1]})}};V.prototype.updateNodePositionsAroundTarget=function(e){if(e.makes_no_changes)return;var r;if(e.is_join_action){var n=0;for(var o=0;o<this.nodes[0].children.length;o++){n+=this.nodes[0].children[o].sel_box.width}r=this.center[0]+n/2-this.nodes[0].x0}else{r=this.nodes[0].x-this.nodes[0].x0}var s=e.newTree.filter(function(t){return!t.dragging});s=s.filter(function(t){var e=t.parent;if(e){while(!i.is_top_most(e)){if(e.dragging)return false;e=e.parent}}return true});s.forEach(function(t){t.x+=r;t.x0+=r});var a=e.newTree.filter(function(t){return t.dragging});if(!e.is_join_action){t.for_each(function(t){t.x0+=r},a)}else{t.for_each(function(t){t.x+=r;t.x0+=r},a)}};V.prototype.end=function(){this.interaction_handler.events.on("keydown",null);if(this.dl)this.dl.setLastHandleVisibility(true);this.stopAllTimeouts();t.for_each(function(t){t.selected=false;t.dragging=false},this.view.model.children);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.cancelSmooshing();this.view.model.hide_nodes();this.nodes=[];this.actions=[];this.bbox=null;this.view.update_all();if(V.show_target_areas)D.draw(this.view.main);this.active=false};V.prototype.applyTimeout=function(t){var e=this;t.timeoutID=setTimeout(function(){e.performAction(t)},t.delay)};V.prototype.stopAllTimeouts=function(){for(var t=0;t<this.actions.length;t++){var e=this.actions[t];if(e.timeoutID){clearTimeout(e.timeoutID);e.timeoutID=null}}};V.prototype.process_each_selection=function(t){if(t.length===0)return[];var e=i.groupNodeRanges(t);var r=this;var n=[];e.map(function(t){return r.process_selection(t)}).forEach(function(t){n=gmath.array.mergedNew(n,t)});return n};V.prototype.process_selection=function(t){var e=t.slice();if(e.length===0)return[];if(e[0].commutative){var r=e[0].parent;if(e.length<r.children.length)return e;else e=[r]}var n=e[0];while(!i.is_top_most(n)&&!n.parent.is_group("equals")&&!n.commutative&&!n.is_group("exponent")&&!n.parent.is_group("param"))n=n.parent;if(n.parent&&n.parent.is_group("equals")&&n.value=="=")n=n.parent;return[n]};gmath.DragHandler=V;var K=function(t,e){this.interaction_handler=e;this.dl=t.options.derivation_list;this.view=t;this.line={A:{},B:{}};this.line_el=null;this.bbox=null;this.otherLines=[];this.otherLine_els=[];this.targets=[];this.processed_color="rgb(200,200,200)"};K.prototype.check=function(t,e){if(!this.view.options.substitution_on)return false;if(t.fingers.length===1&&e.length===1&&e[0].value==="="){return true}return false};K.prototype.start=function(t){this.collectSurroundingsInfo();this.highlightAllPotentialActions();this.initializeLine({x:t[0],y:t[1]});return[]};K.prototype.update=function(t){var e=[];this.targets.forEach(function(t){e=e.concat(t.potentialActions)});D.draw(this.view.main,e,this.bbox);this.updateLineObject(t);this.collectPassedOverNodes();this.highlightAllPotentialActions();this.updateLineElement(this.line_el,this.line)};K.prototype.end=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t];if(e.results.length>0)this.performSubstitution(e)}this.eraseInfoAndCleanBoard()};K.prototype.collectSurroundingsInfo=function(){this.derivationLists=this.dl.getAllDLs().slice();this.ignoreSourceDerivationList();this.activeRows=this.derivationLists.map(function(t){return t.getLastRow()});this.algebraModels=this.derivationLists.map(function(t){return t.getLastModel()});this.targets=this.organizeDataIntoTargets()};K.prototype.ignoreSourceDerivationList=function(){this.derivationLists.splice(this.derivationLists.indexOf(this.dl),1)};K.prototype.organizeDataIntoTargets=function(){var t=[];for(var e=0;e<this.derivationLists.length;e++){var i=this.getAllAvailableActions(this.algebraModels[e],this.derivationLists[e]);var r={dl:this.derivationLists[e],row:this.activeRows[e],model:this.algebraModels[e],potentialActions:i,results:[]};t.push(r)}return t};K.prototype.getAllAvailableActions=function(t,e){var i=this.view.model.SubstitutionAction.getAllAvailableActions(this.view.model,t);var r=this.dl.getLastRow(),n=this.dl.pos[0]+r.pos[0],o=this.dl.pos[1]+r.pos[1];for(var s=0;s<i.length;s++){var a=e.getLastRow();if(this.dl.coordinator&&e.coordinator){var h=this.dl.coordinator.getOffset(this.dl,e);i[s].offset={x:e.pos[0]+a.pos[0]-n+h[0],y:e.pos[1]+a.pos[1]-o+h[1]}}else{i[s].offset={x:e.pos[0]+a.pos[0]-n,y:e.pos[1]+a.pos[1]-o}}}D.setTargetRegions(i);return i};K.prototype.highlightAllPotentialActions=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t].potentialActions;var i=[];for(var r=0;r<e.length;r++)i=i.concat(e[r].target);this.targets[t].row.view.interaction_handler.highlight_nodes(i)}};K.prototype.initializeLine=function(t){this.line_el=this.makeLineElement();var e=this.calculateCenterOfEqualsSymbol();this.line.A.x=e.x;this.line.A.y=e.y;this.line.B.x=t.x;this.line.B.y=t.y;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};K.prototype.makeLineElement=function(t){var e=this.view.main.append("line").classed("substitution",true).style("stroke",t?this.processed_color:this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");return e};K.prototype.calculateCenterOfEqualsSymbol=function(){var t=this.dl,e=t.getLastModel(),i=e.get_child([0,1]);var r=i.x+i.sel_box.x+i.sel_box.width/2,n=i.y+i.sel_box.y+i.sel_box.height/2;return{x:r,y:n}};K.prototype.updateLineObject=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};K.prototype.updateLineElement=function(t,e){t.attr("x1",e.A.x).attr("y1",e.A.y).attr("x2",e.B.x).attr("y2",e.B.y)};K.prototype.collectPassedOverNodes=function(){for(var t=0;t<this.targets.length;t++){this.findMatchingEndpointNodes(this.targets[t])}};K.prototype.findMatchingEndpointNodes=function(t){var e=D.getBestHit(t.potentialActions,this.bbox);if(!e)return;this.removeNodesFromPotentialActionsList(e,t);t.results.push(e);this.drawLine(e,t)};K.prototype.removeNodesFromPotentialActionsList=function(t,e){e.potentialActions.splice(e.potentialActions.indexOf(t),1)};K.prototype.drawLine=function(t,e){var i={x:t.x+t.width/2,y:t.y+t.height/2};var r={A:{x:this.line.A.x,y:this.line.A.y},B:i};var n=this.makeLineElement(e);this.updateLineElement(n,r);this.otherLines.push(r);this.otherLine_els.push(n)};K.prototype.performSubstitution=function(t){var e=t.results;if(e.length===0)return;var i=t.model;for(var r=0;r<e.length;r++){i=i.performAction(e[r]);for(var n=r+1;n<e.length;n++){e[n].oldTree=i;e[n].target=e[r].mapNodes(e[n].target)}}i.finishInteraction()};K.prototype.eraseInfoAndCleanBoard=function(){this.removeAllLineElements();this.unhighlightAllNodes();this.otherLines=[];this.otherLine_els=[];this.targets=[]};K.prototype.removeAllLineElements=function(){this.line_el.remove();for(var t=0;t<this.otherLine_els.length;t++){this.otherLine_els[t].remove()}D.draw(this.view.main)};K.prototype.unhighlightAllNodes=function(){for(var t=0;t<this.targets.length;t++){this.targets[t].row.view.interaction_handler.highlight_nodes([])}};var Z=function(t,e){this.interaction_handler=e;this.view=t;this.model=t.model;this.node=null;this.line=null;this.value=null;this.hitbox={};this.dl=t.options.derivation_list;this.dls=null;this.target=null};Z.prototype.check=function(t){var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};Z.prototype.start=function(t,e){this.node=this.process_selection(e);this.line=d3.select("svg").append("line").attr("stroke","blue");if(!this.node)return[];this.node.dragging=true;this.value=this.view.model.numeric_value(this.node);this.hitbox={x:this.node.x0+this.node.get_root().options.pos[0]-5,y:this.node.y0+this.node.get_root().options.pos[1]-5,width:10,height:10};this.dls=this.dl.getAllDLs().slice();this.target=null;return[this.node]};Z.prototype.update=function(t){this.hitbox.x+=t.dx;this.hitbox.y+=t.dy;var e=[],i=this;this.dls.forEach(function(t){if(t.id===this.dl.id){var i=t.getLastModel(),r=i.filter(function(t){return!t.has_children()});r.forEach(function(i){var r=D.getBoundingBox([i]);if(r.x&&r.y){r.x+=t.pos[0];r.y+=t.pos[1];r.target=i;e.push(r)}})}});D.draw(d3.select("svg"),e,this.hitbox);this.target=D.getBestHit(e,this.hitbox);this.line.attr({x1:this.node.x0+this.node.get_root().options.pos[0]-this.node.width/4,y1:this.node.y0+this.node.get_root().options.pos[1]-this.node.height/4,x2:this.hitbox.x+5,y2:this.hitbox.y+5})};Z.prototype.end=function(){if(this.target){this.target.target.get_root().numeric_value(this.target.target,this.node.get_root().numeric_value(this.node));this.interaction_handler.events.link(this.node,this.target.target)}this.line.remove();D.draw(d3.select("svg"));this.node=null};Z.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof n&&e(i))return i.parent;return null}var r=t[0];if(r instanceof n){if(e(r.parent))return r.parent;else return r}else if(e(r))return r;return null};DLCoordinator=function(){this.dls=[]};DLCoordinator.prototype.addDL=function(t){this.dls.push(t);if(t.coordinator)coordinator.removeDL(t);t.coordinator=this};DLCoordinator.prototype.removeDL=function(t){var e=this.dls.indexOf(t);if(e===-1)throw"I don't know about this DL, so I can't remove it.";this.dls.splice(e,1)};DLCoordinator.prototype.subscribeToCanvasModel=function(t){var e=this;var i=t.dls();var r=null;for(var n=0;n<i.length;n++){e.addDL(i[n])}t.on("create",function(t){if(t.target_type==="dl")e.addDL(t.target)});t.on("remove",function(t){if(t.target_type==="dl")e.removeDL(t.target)})};DLCoordinator.prototype.getPositionOnPage=function(t){var e,i;if(t.options.standalone==true){e=t.container().getBoundingClientRect().left;i=t.container().getBoundingClientRect().top}else{e=t.svg.node().viewportElement.getBoundingClientRect().left;i=t.svg.node().viewportElement.getBoundingClientRect().top}return[e,i]};DLCoordinator.prototype.getOffset=function(t,e){var i=this;var r=i.getPositionOnPage(t);var n=i.getPositionOnPage(e);return[n[0]-r[0],n[1]-r[1]]};var U=function(t,e,i){this.id=gmath.uid();this.model=t;this.events=d3.dispatch("updated");this.model.events.on("change."+this.id,this.onChange.bind(this));this.svg=e;this.main=null;this.initializeOptions(i);this.is_animating=0;this.afterAnimationCallbacks=[]};gmath.AlgebraView=U;U.prototype.bindToModel=function(t,e){if(this.model)this.model.events.on("change."+this.id,null);this.model=t;this.model.events.on("change."+this.id,this.onChange.bind(this));if(e&&this.main){this.main.selectAll("g.math").each(function(t){var i=e[t.id];if(!t.deleted&&i&&i.length===1&&!i[0].has_children())d3.select(this).datum(i[0])});this.main.selectAll("g.math_shadow").each(function(t){var i=e[t.id];if(!t.deleted&&i&&i.length===1&&!i[0].has_children())d3.select(this).datum(i[0])})}};U.defaultOptions={font_size:80,auto_update:true,color:"#333",selection_color:"#ff8c00",inactive_color:"gray",fraction_size_factor:.7,exp_size_factor:.7,subscript_size_factor:.7,smooshed_nodes_shrink_factor:.5,debug_lines:false,debug_draw:false,dur:300,easing_fn:"cubic-in-out",pos:[0,0],interaction_mode:"transform",v_align:"alphabetic",h_align:"center",background_color:"none",bg_visible:false,shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:true,event_receiver:null,normal_font:{family:"Crimson Text"},italic_font:{family:"Crimson Text Italics"},font_baseline_shift:.24,font_ascent:.73,font_descent:.18,slanted_div_bar:false,div_bar_height:.056,wiggle_dur:200,wiggle_deg:10,wiggle_random_delay:100,show_node_targets:true,shadow_node_stroke:"#888",shadow_node_stroke_width:.75,shadow_node_fill:"white",enable_drag_to_join:true};U.prototype.onChange=function(t){if(t.old_model!==t.new_model){this.bindToModel(t.new_model,t.node_map);if(this.options.auto_update)this.update_all(true)}else{if(this.options.auto_update)this.update_all(false)}};U.prototype.callAfterAnimation=function(t){if(!this.is_animating)t();else this.afterAnimationCallbacks.push(t)};U.prototype.animationFinished=function(){this.is_animating=Math.max(0,this.is_animating-1);if(this.is_animating>0)return;this.afterAnimationCallbacks.forEach(function(t){t()});this.afterAnimationCallbacks=[]};U.prototype.initializeOptions=function(t){t=t||{};var e=gmath.extend({},U.defaultOptions);e.pos=e.pos.slice();e.padding=gmath.extend({},e.padding);e.normal_font=gmath.extend({},e.normal_font);e.italic_font=gmath.extend({},e.italic_font);this.options=gmath.extend(e,t);if(t.padding){var i=t.padding;if(typeof i==="number"){this.options.padding={left:i,right:i,top:i,bottom:i}}else gmath.extend(this.options.padding,i)}};U.prototype.init=function(t){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")");this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden");this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).style("visibility",this.options.bg_visible?"visible":"hidden");if(this.options.event_receiver){this.event_receiver=d3.select(this.options.event_receiver)}else{this.event_receiver=this.main}this.event_receiver.style("pointer-events","visible");if(this.options.debug_lines){this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue");this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")}this.renderer=new rt(this,this.options.h_align,this.options.v_align);this.interaction_handler=new P(this,this.options.interactive);this.main.classed("interactive",this.options.interactive);this.interaction_handler.set_mode(this.options.interaction_mode);var e=[this.options.normal_font,this.options.italic_font];if(!U.fontloader){U.fontloader=L(e,2e3);this.fontloader=U.fontloader}else{this.fontloader=U.fontloader;this.fontloader.add_fonts(e)}var i=this;this.fontloader.on_fonts_loaded(function(){i.update_all(true);if(t)t()})};U.prototype.interactive=function(t){if(arguments.length===0)return this.options.interactive;this.options.interactive=t;this.interaction_handler.set_interactive(t);this.main.classed("interactive",this.options.interactive);return this};U.prototype.wiggle=function(t,e){if(!Array.isArray(t))t=[t];var i=[];for(var r=0;r<t.length;r++){var n=t[r].split(":");var o=n.length===1?this.model.getRanges(n[0]):this.model.getRanges(n[0],Number(n[1])-1);if(o)i=i.concat(o)}var s=gmath.array.flatten(i);if(s.length===0)return;this.wiggleNodes(s,e);this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,false))};U.prototype.wiggleNodes=function(t,e){
if(arguments.length<2)e=true;if(!t)t=this.model.children;if(!Array.isArray(t))t=[t];var i=[];t.forEach(function(t){if(t.has_children())i=i.concat(t.get_leaf_nodes());else i.push(t)});var r=this.node_sel.filter(function(t){return i.indexOf(t)!==-1}).select("g.offset");var n=this.options;var o=function(t,e,i){var r=d3.interpolate(t,e);return function(t){var e=U.getCenter(t);return function(t){return"rotate("+r(t)+" "+e+")"}}};function s(t){d3.select(this).transition().duration(n.wiggle_dur).attrTween("transform",o(n.wiggle_deg,-n.wiggle_deg)).transition().duration(n.wiggle_dur).attrTween("transform",o(-n.wiggle_deg,n.wiggle_deg)).each("end",s)}if(e){r.transition().delay(function(){return Math.random()*n.wiggle_random_delay}).duration(n.wiggle_dur/2).attrTween("transform",o(0,n.wiggle_deg)).each("end",s)}else{r.interrupt().transition().attr("transform",null)}};U.getCenter=function(t){var e=t.sel_box;return[e.x+e.width/2,-t.size*.24]};U.prototype.reposition=function(t){var e=this;e.renderer.set_position(e.model.children,true);e.update_existing()};U.prototype.enterSmooshed=function(t){var e=this;var i=this.main.selectAll("g.math_smooshed").data(gmath.array.flatten(t),function(t){return t.id});var r=i.enter().insert("g","g").classed("math_smooshed",true).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("opacity",.6);r.append("g").classed("offset",true);r.select("g.offset").append("rect").attr("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true);r.select("g.offset").append("text").attr("font-family",function(t){return e.get_font(t).family}).attr("font-weight",function(t){return e.get_font(t).weight}).attr("font-style",function(t){return e.get_font(t).style}).attr("font-size",function(t){return t.size+"px"}).attr("fill",function(t){return e.options.selection_color}).attr("opacity",function(t){return t.hidden?1e-5:1}).text(function(t){return t.to_string()});r.select("text").transition().duration(this.options.dur).ease(this.options.easing_fn).attr("font-size",function(t){return t.size*e.options.smooshed_nodes_shrink_factor+"px"})};U.prototype.updateSmooshed=function(t){var e=this;var i=this.main.selectAll("g.math_smooshed").data(gmath.array.flatten(t),function(t){return t.id});i.transition().duration(this.options.dur).ease("circle-out").attr("transform",function(t){return"translate("+t.x+","+t.y+")"})};U.prototype.exitSmooshed=function(){this.main.selectAll("g.math_smooshed").data([]).exit().remove()};U.prototype.enterSmooshIndicator=function(t){var e=this.main.selectAll(".smooshIndicator").data([t]);var i=e.enter();i.insert("circle").classed("smooshIndicator",true).attr("transform",function(t){return"translate("+t[0]+","+t[1]+")"}).attr("r",5).style({fill:this.options.selection_color,opacity:.5})};U.prototype.updateSmooshIndicator=function(t){var e=this.main.selectAll(".smooshIndicator").data([t]);e.attr("transform",function(t){return"translate("+t[0]+","+t[1]+")"})};U.prototype.exitSmooshIndicator=function(){var t=this.main.select(".smooshIndicator").data([]).exit().remove()};U.prototype.update_all=function(t){var e=this.options.dur;if(t)this.options.dur=0;this.renderer.set_style(this.model.children);this.renderer.set_position(this.model.children,true);this.enter_and_exit("normal");this.update_existing("normal");this.events.updated({type:"updated",source:this,sender_id:this.id});this.is_animating++;setTimeout(this.animationFinished.bind(this),this.options.dur);this.options.dur=e};U.prototype.enter_and_exit=function(t){var e;if(t==="normal"){e=this.getNormalNodesSelection()}else if(t==="shadow"){e=this.getShadowNodesSelection()}else{throw"No node type specified for node visualization -- AlgebraView.js/enter_and_exit"}if(e.length>0){this._enter(e,t);e.selectAll("g.math text").on("hold",function(t){var e=t.datum();if(!gmath.actions.splitNumberWithKeyboardAction.match(e))return;var i=gmath.actions.splitNumberWithKeyboardAction.createBoundAction(e.get_root(),{actor:e});e.get_root().performAction(i,null,true)});this._exit(e,t)}};U.prototype.getNormalNodesSelection=function(){var e=this.main.selectAll("g.math").data(t.get_leaf_nodes(this.model.children),function(t){return t.id});return e};U.prototype.getShadowNodesSelection=function(){if(!this.options.show_node_targets){return[]}var e=this.model.filter(function(t){return t.dragging});var i=t.filter(function(t){return!t.has_children()},e);var r=this.main.selectAll("g.math_shadow").data(i,function(t){return t.id});return r};U.prototype._enter=function(t,e){var i=this;var r;if(e==="normal"){r=t.enter().append("g").classed("math",true).attr("id",function(t){return t.id}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}else{r=t.enter().insert("g","g.math").classed("math_shadow",true).attr("transform",function(t){return"translate("+t.x0+","+t.y0+")"}).each(function(t){t.shadow_deleted=false})}r.append("g").classed("offset",true);r.select("g.offset").append("rect").attr("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true).style("pointer-events","all");var n=r.filter(function(t){return t.value==="//"}).select("g.offset");var o=n.append("line").style("stroke-linecap","round").call(Q,this.options.slanted_div_bar,e).attr("opacity",function(t){return e==="normal"?t.no_anim&&!t.hidden?1:1e-5:t.hidden||t.hide_after_drop?0:1});var s=r.select("g.offset").append("text").attr("font-family",function(t){return i.get_font(t).family}).attr("font-weight",function(t){return i.get_font(t).weight}).attr("font-style",function(t){return i.get_font(t).style}).attr("font-size",function(t){return t.size+"px"}).style("pointer-events","none");if(e==="normal"){s.attr("stroke","none").attr("fill",function(t){return t.color}).attr("opacity",function(t){return t.no_anim&&!t.hidden?1:1e-5}).text(function(t){return t.to_string()});if(this.options.debug_draw)this.debugDraw(r);t.each(function(t){return t.no_anim=false})}else{s.style("stroke",i.options.shadow_node_stroke).style("stroke-width",i.options.shadow_node_stroke_width).style("fill",i.options.shadow_node_fill).attr("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}return r};U.prototype._exit=function(t,e){var i=this;var r=t.exit().each(function(t){if(e==="normal"){t.deleted=true}else{t.shadow_deleted=true}}).transition().ease("linear").duration(function(t){return t.no_anim?0:i.options.dur}).attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"}).remove();r.select("*").attr("opacity",1e-5);if(e==="normal"){this.node_sel=t}};U.prototype.update_existing=function(t){var e=this;var i=this.svg.selectAll(t==="normal"?"g.math":"g.math_shadow").filter(function(e){if(t==="normal")return!e.deleted;else return!e.shadow_deleted});var r=i.transition().duration(this.options.dur).ease(this.options.easing_fn);if(t==="normal"){r.attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})}else{r.attr("transform",function(t){return"translate("+(t.x0||0)+","+(t.y0||0)+")"})}var n=i.select("text").transition().duration(0).text(function(t){return t.to_string()}).transition().duration(this.options.dur).ease("linear").attr("font-size",function(t){return t.size+"px"});if(t==="normal"){n.attr("fill",function(t){return t.color}).attr("opacity",function(t){return t.hidden?1e-5:1})}else{n.attr("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}var o=t==="normal"?i.select("line"):i.filter(function(t){return t.value==="//"}).select("line");o.transition().duration(this.options.dur).ease("linear").call(Q,this.options.slanted_div_bar,t).attr("opacity",function(e){if(t==="normal")return e.hidden?1e-5:1;else return e.hidden||e.hide_after_drop?0:1});if(t==="normal"){i.select("rect").attr("x",function(t){return t.sel_box?t.sel_box.x:0}).attr("y",function(t){return t.sel_box?t.sel_box.y:0}).attr("width",function(t){return t.hidden||!t.sel_box?0:t.sel_box.width}).attr("height",function(t){return t.hidden||!t.sel_box?0:t.sel_box.height});this.update_background()}return true};U.prototype.update_background=function(t){var e=this.model.children[0];var i=this.getBBox();if(e&&!e.dragging){this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).attr(i);this.shadow_rect.transition().duration(t?0:this.options.dur).attr(i)}};U.prototype.set_background_visible=function(t){this.options.bg_visible=!!t;this.border_rect.style("visibility",t?"visible":"hidden")};U.prototype.getBBox=function(t){t=t||{};var e=this.model.children[0];if(!e||!e.sel_box)return{x:0,y:0,width:0,height:0};var i={};var r=this.options.padding;i.x=e.sel_box.x+(e.dragging?e.x0:e.x)-(t.no_padding?0:r.left);i.y=e.sel_box.y+(e.dragging?e.y0:e.y)-(t.no_padding?0:r.top);i.width=e.sel_box.width+(t.no_padding?0:r.left+r.right);i.height=e.sel_box.height+(t.no_padding?0:r.top+r.bottom);return i};U.prototype.update_positions=function(){this.node_sel.transition().duration(this.options.dur).ease("circle-out").attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})};U.prototype.update_style=function(t){this.node_sel.select("text").transition().duration(t?0:this.options.dur).ease("linear").attr("font-size",function(t){return t.size+"px"}).attr("fill",function(t){return t.color}).attr("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1});this.node_sel.select("line").transition().duration(t?0:this.options.dur).ease("linear").call(Q,this.options.slanted_div_bar).attr("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1})};function Q(t,e,i){t.attr("x1",0).attr("x2",function(t){return t.width}).style("stroke-width",function(t){return i==="normal"||!i?t.height:t.height/2}).style("stroke",function(t){return i==="normal"||!i?t.color:"#ddd"});if(e){t.attr("y1",function(t){return.2*t.height}).attr("y2",function(t){return-.2*t.height})}}U.prototype.force_refresh=function(){var t=this.svg.node();t.style.display="none";t.style.display="block"};U.prototype.get_utf8=function(t){var e={"-":"−","*":"·","/":""};if(t.value in e)return e[t.value];if(typeof t.value=="number"&&t.value<0)return e["-"]+Math.abs(t.value);return t.value};U.prototype.get_font=function(t){return t instanceof s?this.options.italic_font:this.options.normal_font};U.prototype.get_width=function(t){return this.fontloader.width(t.to_string(),t.size,get_font(t))};U.prototype.debugDraw=function(t){var e=this;t.select("g.offset").append("rect").style("stroke","orange").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return t.size*e.options.font_descent-.5},height:1});t.select("g.offset").append("rect").style("stroke","green").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_ascent-.5},height:1});t.select("g.offset").append("rect").style("stroke","blue").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_baseline_shift-.5},height:1})};DerivationList=function(t,e,i){this.id=e.id||gmath.uid();this.events=d3.dispatch("added_line","change","end-of-interaction","inspect_node");this.dl_events=d3.dispatch("drag","touch","release","hold");this.row_events=d3.dispatch("drag","touch","tap","release","clone","pack_state");this.dims={};this.initializeOptions(e);this.canvas_model=e.canvas_model;this.svgg=null;this.bg_rect=null;if(this.options.visualized){this.container(t);this.adjustPosition(e.pos);this.pos=this.options.pos.slice();this.svgg.attr("transform","translate("+this.pos+")")}this.rows=[];this.curr_drag_handler=null;this.curr_target_model=null;this.hovering=false;this.curr_interaction_type="none";this.mouse_hovering=false;this.interactionMode="undecided";this.clone=null;this.delete_mode=false;var r=this;this.addLineFromExpressions(this.options.eq.split("\\\\"),function(){if(r.options.visualized){r.startWiggle(r.options.wiggle)}if(i)i(r)});dl=this};gmath.DerivationList=DerivationList;DerivationList.defaultOptions={eq:"",visualized:true,pos:[300,200],debug_lines:false,visualize_derivations:"none",visualize_derivations_method:"all",embedded:true,border_radius:0,v_align:"center",h_align:"equals",padding:{left:10,right:45,top:7,bottom:3},dl_padding:{left:25,right:5,top:5,bottom:5},handle_pos:"right",handle_stroke_color:"#ddd",row_border_color:"#ddd",row_background_color:"white",font_size:50,collapsed_mode:false,draggable:true,no_history:false,hide_handles:false,break_off_dist:50,wiggle:[],auto_resize_container:false,keep_in_container:true,substitution_on:true,replace_value_on:false,hoverable:false,auto_collapse_repeated_actions:true,auto_simplify_distributions:true,interaction_mode:"transform",send_events:true,mappings_color:"#E6F3DE",mappings_active_node_color:"rgb(194, 219, 179)",mappings_rect_radius:6,mappings_joint_width:16,mappings_joint_length:8,mappings_line_thickness:6,show_bg:true,bg_rect_style:{fill:"none",stroke:"none","stroke-dasharray":null,opacity:.9},bg_rect_active_style:{fill:"white",stroke:"silver",opacity:.9},bg_rect_hovering_style:{fill:"#ddf"},row_transition_dur:250};DerivationList.prototype.toJSON=function(){return gmath.extend(gmath.deepCopy(this.options),{id:this.id,type:"DerivationList",pos:this.pos})};DerivationList.prototype.initializeOptions=function(t){t=t||{};var e=gmath.extend({},DerivationList.defaultOptions);e.pos=e.pos.slice();e.padding=gmath.extend({},e.padding);if(t.standalone)e.show_bg=false;this.options=gmath.extend(e,t);if(!("hide_handles"in t)&&t.no_history){this.options.hide_handles=!this.options.draggable}};DerivationList.prototype.container=function(t){var e=this;if(arguments.length===0)return this.svg.node();this.svg=d3.select(t);this.svgDims=this.getContainerDimensions();if(this.svgg)this.svg.node().appendChild(this.svgg.node());else{this.svgg=this.svg.append("g").classed("derivation-list",true).attr("id",this.id);var i=this.setupDLInteractionListeners();this.bg_rect=this.svgg.append("rect").datum(this).style("pointer-events","all").attr("visibility","hidden").call(i);this.svgg.on("mouseenter",this.setMouseHovering.bind(this,true)).on("mouseleave",this.setMouseHovering.bind(this,false))}return this};DerivationList.prototype.setupDLInteractionListeners=function(){var t=mtouch_events().origin(function(t){return t.pos.slice()}).on("drag",this.DLDrag.bind(this,null)).on("touch",this.DLTouch.bind(this,null)).on("release",this.DLRelease.bind(this,null)).on("hold",this.DLHold.bind(this,null));return t};DerivationList.prototype.DLDrag=function(t){var e=t||d3.event;if(!this.options.draggable)return;if(this.options.send_events)this.dl_events.drag(new DerivationList.DLDragEvent(this.id,e));this.pos[0]=e.x;this.pos[1]=e.y;if(!this.hovering)this.pos=this.keepInContainer(this.pos,this.dims);this.svgg.attr("transform","translate("+this.pos+")")};DerivationList.prototype.DLTouch=function(t){var e=t||d3.event;if(this.options.send_events)this.dl_events.touch(new DerivationList.DLTouchEvent(this.id,e));if(this.delete_mode){this.canvas_model.removeDL(this)}else{this.svgDims=this.getContainerDimensions();this.setCurrentInteractionType("DL")}};DerivationList.prototype.DLRelease=function(t){var e=t||d3.event;if(this.options.send_events)this.dl_events.touch(new DerivationList.DLReleaseEvent(this.id,e));this.setCurrentInteractionType("none")};DerivationList.prototype.DLHold=function(t){var e=t||d3.event;if(this.options.send_events)this.dl_events.touch(new DerivationList.DLHoldEvent(this.id,e));this.toggleHover();d3.event.finger.pos=this.pos.slice()};DerivationList.DLDragEvent=function(t,e){this.type="Drag";this.performee=t;this.performee_type="DL";this.time=Date.now();this.x=e.x;this.y=e.y};DerivationList.DLTouchEvent=function(t,e){this.type="Touch";this.performee=t;this.performee_type="DL";this.time=Date.now();this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.DLReleaseEvent=function(t,e){this.type="Release";this.performee=t;this.performee_type="DL";this.time=Date.now();if(e.altKey)this.altKey=e.altKey;if(e.shiftKey)this.shiftKey=e.shiftKey;this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.DLHoldEvent=function(t,e){this.type="Hold";this.performee=t;this.performee_type="DL";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};DerivationList.createStandalone=function(t,e,i){if(t instanceof String)t=d3.select(t).node();var r=d3.select(t);if(r.empty())return;var n=r.text();if(r.selectAll("*").empty())r.text("");var o=r.append("svg").style("width","100%").style("height","100%").style("overflow","visible");var s=gmath.extend({pos:["auto","auto"],v_align:"center",h_align:"center",no_history:true,no_handles:true,standalone:true,draggable:false},e);s.eq=s.eq||n;return new DerivationList(o.node(),s,i)};DerivationList.prototype.adjustPosition=function(t){var e=this.getContainerDimensions();if(this.options.pos[0]==="auto"){if(this.options.h_align==="center"||this.options.h_align==="equals")this.options.pos[0]=e.width/2;else if(this.options.h_align==="left")this.options.pos[0]=this.options.padding.left;else if(this.options.h_align==="right")this.options.pos[0]=e.width-this.options.padding.right}if(this.options.pos[1]==="auto"){if(this.options.v_align==="center"||this.options.v_align==="alphabetic")this.options.pos[1]=e.height/2;else if(this.options.v_align==="top")this.options.pos[1]=this.options.padding.top;else if(this.options.v_align==="bottom")this.options.pos[1]=e.height-this.options.padding.bottom}};DerivationList.prototype.remove=function(){this.svgg.remove()};DerivationList.prototype.addLineFromExpressions=function(t,e){for(var i=0;i<t.length;i++)this.addLineFromExpression(t[i],i===t.length-1?e:null)};DerivationList.prototype.addLineFromExpression=function(t,e){if(this.rows.length>0)this.deactivateRow(this.rows[this.rows.length-1]);this.addRowFromAscii(t,e)};DerivationList.prototype.startWiggle=function(t){var e=this.getLastView();e.wiggle(t,true)};DerivationList.prototype.setExpression=function(t,e){this.getLastModel().parseAndSet(t,e)};DerivationList.prototype.setInteractionMode=function(t){if(t!=="inspect")this.draw_mappings_for_nodes([]);if(t==="delete")this.delete_mode=true;else{this.delete_mode=false;this.rows.forEach(function(e){e.view.interaction_handler.set_mode(t)})}};DerivationList.prototype.singleLineMode=function(t){if(arguments.length===0)return this.options.collapsed_mode;if(t&&!this.options.collapsed_mode){var e=false;for(var i=0;i<this.rows.length-1;i++){if(!this.rows[i].hidden){e=true;this.hideRow(this.rows[i])}}if(e)this.layoutRows()}this.options.collapsed_mode=t;return this};DerivationList.prototype.getLastRow=function(){return this.rows[this.rows.length-1]};DerivationList.prototype.getRowByModel=function(t){for(var e=0;e<this.rows.length;e++){if(this.rows[e].model===t)return this.rows[e]}return null};DerivationList.prototype.getLastModel=function(){return this.getLastRow().model};DerivationList.prototype.getLastView=function(){return this.getLastRow().view};DerivationList.prototype.onChange=function(t){var e=this.getRowByModel(t.old_model);if(!e)return;if(t.new_model!==t.old_model){this.removeModelEventListeners(t.old_model);this.addModelEventListeners(t.new_model);e.model=t.new_model}if(this.options.visualized){this.updateRowBackground(e,true);this.updateHandlePos(e,true)}};DerivationList.prototype.onCreate=function(t){LinkCoordinator.links.push(new AlgebraModelLink(t.action.oldTree,t.action.newTree,t.action));if(t.action.name==="substitution"){LinkCoordinator.links.push(new AlgebraModelLink(t.action.sourceEq,t.action.newTree,t.action))}var e=this.getLastView();var i=this.getLastRow();var r=i.el,n=i.handle;var o=t.action.oldTree;o.for_each(function(t){t.dragging=false;t.selected=false});o.hide_nodes();var s=this.addRowFromAction(t.action);if(this.options.visualized){this.createViewForRow(i,gmath.object.merged(e.options,{interactive:false,pos:i.pos.slice()}))}this.events.added_line(gmath.extend({senderDL_id:this.id},t));if(this.options.visualized){this.hideRow(i)}};DerivationList.prototype.addRowFromAction=function(t){var e=t.newTree;if(this.options.visualized){var i=this.getLastView();i.bindToModel(e,t.initial_node_map);i.update_all()}var r=this.getLastRow();var n=this.createRow(e,t,r.el);n.view=r.view;n.handle=r.handle;if(!this.rowBeforeCurrActionSeq)this.rowBeforeCurrActionSeq=r;if(this.options.visualized){this.createRowHandle(n)}return n};DerivationList.prototype.createRow=function(t,e,i){var r=this.getLastRow();var n={model:t,action:e,view:null,el:i,handle:null,dims:r?gmath.extend({},r.dims):null,idx:this.rows.length,pos:r?r.pos.slice():[0,0]};if(i){i.datum(n);i.attr("id",t.id)}this.addModelEventListeners(t);this.rows.push(n);return n};DerivationList.prototype.addModelEventListeners=function(t){var e=this;t.events.on("end-of-interaction."+this.id,this.afterEndOfInteraction.bind(this));t.events.on("change."+this.id,this.onChange.bind(this));t.events.on("create."+this.id,this.onCreate.bind(this));t.events.on("change."+this.id,this.onChange.bind(this))};DerivationList.prototype.removeModelEventListeners=function(t){t.events.on("end-of-interaction."+this.id,null);t.events.on("node-changed."+this.id,null);t.events.on("create."+this.id,null);t.events.on("change."+this.id,null)};DerivationList.prototype.afterEndOfInteraction=function(t){var e=t.mathObject;var i=this.getRowByModel(e);var r=i.view.interaction_handler.mode;if(r==="inspect"){this.updateRowDimensionAfterInteraction(i)}if(r==="transform"){if(e!==this.getLastModel())return;this.events["end-of-interaction"](arguments);this.updateRowDimensionAfterInteraction(this.getLastRow());if(this.rowBeforeCurrActionSeq){var i=this.rowBeforeCurrActionSeq;this.joinRows(this.rows[i.idx+1],this.getLastRow());var n=this;if(!this.shouldHideRow(i)&&!(this.rows[i.idx+1]&&this.rows[i.idx+1].action&&this.rows[i.idx+1].action.auto_collapse)){this.getLastView().callAfterAnimation(function(){n.unhideRow(i);n.layoutRows()})}}this.rowBeforeCurrActionSeq=null}};DerivationList.prototype.joinRows=function(t,e){return;var i=[];for(var r=t.idx;r<=e.idx;r++)i.push(this.rows[r].action);if(i.length<2)return;var n=Action.createComposedAction(i,"move action");n.oldTree=t.oldTree;n.newTree=e.newTree;var o=t.idx,s=e.idx-t.idx;for(var r=0;r<s;r++)this.removeRow(this.rows[o]);e.action=n};DerivationList.prototype.addRowFromModel=function(t,e,i){var r=this.getLastRow();if(r)this.deactivateRow(r);var n=this.createRow(t,e);var o=r?r.pos.slice():[0,0];var s=this;if(this.options.visualized){this.createViewForRow(n,gmath.object.merged(this.options,{pos:o}),function(){s.events.added_line({senderDL_id:s.id,action:{name:"(DL) row added from model (only redo)",newTree:t}});s.layoutRows();if(i)i()})}return n};DerivationList.prototype.addRowFromAscii=function(t,e){return this.addRowFromModel(new i(t,this.options),null,e)};DerivationList.prototype.createViewForRow=function(t,e,i){var r=t;var n=r?this.svgg.insert("g","g.dl-line#"+r.model.id):this.svgg.append("g");n.classed("dl-line",true).attr("id",t.model.id).attr("transform","translate("+(e.pos||[0,0])+")").datum(t);t.el=n;e.pos=[0,0];e.border_color="none";e.background_color=this.options.row_background_color;if(this.options.standalone)e.event_receiver=this.svg.node();e.derivation_list=this;t.view=new U(t.model,n,e);var o=this;t.view.init(function(){t.view.interaction_handler.events.on("inspect_node."+o.id,function(t){o.events.inspect_node({node:t.node,dl:o})});t.view.interaction_handler.events.on("drag_start."+o.id,o.setCurrentInteractionType.bind(o,"AV"));t.view.interaction_handler.events.on("drag_end."+o.id,o.setCurrentInteractionType.bind(o,"none"));t.view.interaction_handler.events.on("touch."+o.id,function(){if(o.delete_mode)o.canvas_model.removeDL(o)});o.createRowHandle(t);o.updateRowDimensionAfterInteraction(t);if(i)i(o)})};DerivationList.prototype.updateHandlePos=function(t,e){if(this.options.no_handles)return;var i=this.getHandlePos(t.view);if(t.handle)t.handle.transition().ease(t.view.options.easing_fn).duration(e?0:t.view.options.dur).attr("transform","translate("+i+")")};DerivationList.prototype.getRowByView=function(t){return this.rows.filter(function(e){return e.view===t})[0]};DerivationList.prototype.updateRowDimensionAfterInteraction=function(t,e){var i=this.updateRowDimensions();if(i){for(var r=0;r<this.rows.length;r++){this.updateRowBackground(this.rows[r],e);this.updateHandlePos(this.rows[r],e)}this.moveIntoContainer()}else{this.updateRowBackground(t,e);this.updateHandlePos(t,e)}};DerivationList.prototype.shouldHideRow=function(t){if(t.idx===this.rows.length-1)return false;if(this.options.collapsed_mode)return true;var e=gmath.deepCopy(this.dims),i=0;this.rows.forEach(function(t){i+=t.dims.height});e.height=i;var r=this.keepInContainer(this.pos,e);if(this.pos[0]!==r[0]||this.pos[1]!==r[1]){return true}var n=this.rows[t.idx+1];if(this.options.auto_collapse_repeated_actions&&t.action&&n.action&&t.action.name===n.action.name)return true;return false};DerivationList.prototype.moveIntoContainer=function(t){if(!this.options.keep_in_container)return;if(this.hovering)return;if(arguments.length===0)t=true;var e=this.keepInContainer(this.pos,this.dims);if(e[0]===this.pos[0]&&e[1]===this.pos[1])return;this.pos=e;if(t)this.svgg.transition().attr("transform","translate("+this.pos+")");else this.svgg.attr("transform","translate("+this.pos+")")};DerivationList.prototype.getFinalVerticalPos=function(t,e,i){i=i||0;var r=this.rows[i].pos[1];for(var n=i+1;n<=t.idx;n++){if(this.rows[n-1].hidden&&!e)continue;r+=this.getVerticalAdvance(this.rows[n])}return r};DerivationList.prototype.isAboveFinalVerticalPos=function(t){return t.pos[1]<this.getFinalVerticalPos(t)};DerivationList.prototype.getUpmostPullableRow=function(t){var e;if(this.rows.length<2)return this.rows[0];if(this.isAboveFinalVerticalPos(this.rows[1])){e=0}else{for(e=t.idx;e>=0;e--){if(this.rows[e].hidden)break;if(!this.isAboveFinalVerticalPos(this.rows[e]))break}}if(e===t.idx)return null;return this.rows[e+1]};DerivationList.prototype.getHiddenAbove=function(t){var e=t.idx-1;if(this.rows[0].hidden)return this.rows[0];while(e>=0&&!this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleAbove=function(t){var e=t.idx-1;while(e>=0&&this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getDistanceFromHome=function(t){var e=t.pos[0]-t.drag_pos[0],i=t.pos[1]-t.drag_pos[1];return Math.sqrt(e*e+i*i)};DerivationList.prototype.removeRowHandle=function(t){if(t.mtouch){t.mtouch.connected(false);delete t.mtouch}if(t.handle){t.handle.remove();delete t.handle}};DerivationList.prototype.createRowHandle=function(t){if(this.options.no_handles)return;t.mtouch=this.setupRowInteractionListeners(t);var e=this.getHandlePos(t.view);circles=t.el.selectAll(".handle").data([t,t]);circles.enter().append("circle").classed("handle",true).style({cursor:"pointer"}).call(t.mtouch).attr("transform","translate("+e+")").attr({fill:"white",stroke:this.options.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"});t.handle=circles;this.setRowHandleVisibility(t)};DerivationList.prototype.setupRowInteractionListeners=function(t){var e=this;var i=t.mtouch||mtouch_events().origin(function(t){return[e.pos[0]+t.pos[0],e.pos[1]+t.pos[1]]}).on("drag",this.rowDrag.bind(this)).on("touch",this.rowTouch.bind(this)).on("tap",this.rowTap.bind(this)).on("release",this.rowDragend.bind(this));return i};DerivationList.prototype.rowTouch=function(t){var e=t.row?this.rows[t.row]:t;if(this.options.send_events&&isNaN(t.row))this.row_events.touch(new DerivationList.rowTouchEvent(d3.event,e.idx,this.id));this.setCurrentInteractionType("row");this.svgDims=this.getContainerDimensions();for(var i=0;i<this.rows.length;i++)this.showBackground(this.rows[i],i===e.idx);e.handle.attr({fill:"whitesmoke"})};DerivationList.prototype.rowTap=function(t){var e=t.row?this.rows[t.row]:t;if(this.options.send_events&&isNaN(t.row))this.row_events.tap(new DerivationList.rowTapEvent(d3.event,e.idx,this.id));var i=this;if(!gmath.actions.editLineAction.match(e.model))return;var r=gmath.actions.editLineAction.createBoundAction(e.model,{actor:e.model});e.model.performAction(r,function(){i.updateRowDimensionAfterInteraction(e)},true)};DerivationList.rowTouchEvent=function(t,e,i){this.type="Touch";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.rowTapEvent=function(t,e,i){this.type="Tap";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.prototype.toggleHover=function(t){if(arguments.length===0)t=true;if(this.hovering){this.hovering=false;this.updateBGStyle();this.remove();var e=this.svgg.node();var i=this.original_container;delete this.original_container;var r=i.node().appendChild(e);this.unhoverRemove.remove();this.svg=i;if(t){var n=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=n;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")");this.svgDims=this.getContainerDimensions();this.moveIntoContainer()}else{if(this.options.hoverable==false)return;this.hovering=true;this.updateBGStyle();this.remove();var e=this.svgg.node();var a=d3.select("#hovering");var h=a.select("g");var l=h.append("g");this.unhoverRemove=l;this.original_container=this.svg;this.svg=h;var r=l.node().appendChild(e);if(t){var n=d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=n;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")")}this.layoutRows()};DerivationList.prototype.updateRowBackground=function(t,e){var i=t.dims.x-this.dims.x-this.options.dl_padding.left,r=this.dims.x+this.dims.width-t.dims.x-t.dims.width-this.options.dl_padding.right;t.view.options.padding={left:i,right:r,top:this.options.padding.top,bottom:this.options.padding.bottom};t.view.update_background(e)};DerivationList.prototype.showBackground=function(t,e){t.view.options.border_color=e?this.options.row_border_color:"none";this.updateRowBackground(t);t.view.set_background_visible(true)};DerivationList.prototype.hideBackground=function(t){t.view.set_background_visible(false)};DerivationList.prototype.getHandlePos=function(t){var e=t.getBBox({no_padding:true});var i=this.options.handle_pos==="left"?e.x-20:e.x+e.width+25;return[i,e.y+e.height/2]};DerivationList.prototype.setLastHandleVisibility=function(t){this.setRowHandleVisibility(this.getLastRow(),t)};DerivationList.prototype.updateHandleVisibilities=function(){for(var t=0;t<this.rows.length;t++){this.setRowHandleVisibility(this.rows[t])}};DerivationList.prototype.setRowHandleVisibility=function(t,e){if(this.options.no_handles||!t||!t.handle)return;if(arguments.length<2)e=true;var i=this.rows,r=this.options.hide_handles;var n=this;t.handle.each(function(t,o){if(r||!e||n.curr_interaction_type==="AV"){d3.select(this).attr("visibility","hidden");return}if(t.idx&&i[t.idx-1].hidden){d3.select(this).attr({visibility:"visible",cx:3-6*o})}else{d3.select(this).attr({visibility:o===0?"visible":"hidden",cx:0})}})};DerivationList.prototype.countVisibleRows=function(){var t=0;for(var e=0;e<this.rows.length;e++)if(!this.rows[e].hidden)t++;return t};DerivationList.prototype.hideRow=function(t){if(t.hidden)return;t.hidden=true;if(t.view)t.view.options.auto_update=false;if(!this.options.collapsed_mode){this.updateRowDimensions()}t.el.attr("display","none");this.setRowHandleVisibility(this.rows[t.idx+1])};DerivationList.prototype.unhideRow=function(t){if(!t.hidden)return;this.singleLineMode(false);
t.hidden=false;if(t.view){t.view.options.auto_update=true;t.view.update_all(true)}this.updateRowDimensions();t.el.attr("display",null);this.setRowHandleVisibility(this.rows[t.idx+1])};DerivationList.prototype.deactivateRow=function(t){t.view.interactive(false);t.model.for_each(function(t){t.dragging=false;t.selected=false});t.view.update_all()};DerivationList.prototype.updateRowDimensions=function(){var t=Infinity,e=Infinity,i=-Infinity,r=-Infinity;this.rows.forEach(function(n){if(!n.hidden){n.dims=n.view.getBBox({no_padding:true});n.dims.y-=n.view.options.padding.top;n.dims.height+=n.view.options.padding.top+n.view.options.padding.bottom+1;t=Math.min(t,n.dims.x+n.pos[0]);e=Math.min(e,n.dims.y+n.pos[1]);i=Math.max(i,n.dims.x+n.dims.width+n.pos[0]);r=Math.max(r,n.dims.y+n.dims.height+n.pos[1])}});t-=this.options.dl_padding.left+this.options.padding.left;i+=this.options.dl_padding.right+this.options.padding.right;e-=this.options.dl_padding.top;r+=this.options.dl_padding.bottom;var n=this.dims.x!==t||this.dims.y!==e||this.dims.width!==i-t||this.dims.height!==r-e;this.dims={x:t,y:e,width:i-t,height:r-e};if(n)this.rowDimensionsHaveChanged();return n};DerivationList.prototype.rowDimensionsHaveChanged=function(){if(this.options.auto_resize_container){this.svg.style("height",this.dims.height+this.dims.y+this.pos[1]+"px")}this.bg_rect.attr(this.dims);this.updateBGStyle();this.rows.forEach(this.updateRowBackground.bind(this))};DerivationList.prototype.setCurrentInteractionType=function(t){if(this.curr_interaction_type!==t){this.curr_interaction_type=t;if(this.options.visualized){this.updateBGStyle();this.updateHandleVisibilities()}}};DerivationList.prototype.setMouseHovering=function(t){if(this.mouse_hovering!==t){this.mouse_hovering=t;if(this.delete_mode){this.options.bg_rect_active_style={stroke:t?"red":"silver"}}this.updateBGStyle()}};DerivationList.prototype.updateBGStyle=function(){if(this.options.show_bg)this.bg_rect.attr("visibility",null);else return;if(this.mouse_hovering&&this.curr_interaction_type!=="AV"||this.curr_interaction_type==="DL"||this.curr_interaction_type==="row"){this.bg_rect.style(this.options.bg_rect_active_style)}else{this.bg_rect.style(this.options.bg_rect_style)}if(this.hovering)this.bg_rect.style(this.options.bg_rect_hovering_style)};DerivationList.prototype.getVerticalAdvance=function(t){if(t.idx===0)return 0;var e=this.options.v_align;if(e==="center"){return this.rows[t.idx-1].dims.height/2+t.dims.height/2}else if(e==="top"){return this.rows[t.idx-1].dims.height}else if(e==="bottom"||e==="alphabetic"){return t.dims.height}};DerivationList.prototype.layoutRows=function(){this.updateRowDimensions();var t=this.rows[0].pos,e=t[0],i=t[1],r=this;this.rows[0].idx=0;for(var n=1;n<this.rows.length;n++){var o=this.rows[n];o.idx=n;if(!this.rows[n-1].hidden)i+=this.getVerticalAdvance(o);if(o.dragging)continue;var s=o.pos;if(s[0]!==e||s[1]!==i){s[0]=e;s[1]=i;s=s;this.showBackground(o);console.log(this.options.row_transition_dur);o.el.transition().duration(this.options.row_transition_dur).attr("transform","translate("+s+")").each("end",function(t){r.hideBackground(t)})}}this.svgg.selectAll(".dl-line").sort(function(t,e){return t.idx-e.idx});this.updateRowDimensions()};DerivationList.prototype.getContainerDimensions=function(){var t=this.svg.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;return t.getBoundingClientRect()};DerivationList.prototype.keepInContainer=function(t,e,i){if(typeof i==="undefined")i=1;var r=function(t,e,i){if(t>e)return t;return i<t?t:i>e?e:i};var n=r(-e.x,this.svgDims.width-(e.width+e.x+i),t[0]),o=r(-e.y,this.svgDims.height-(e.height+e.y+i),t[1]);return[n,o]};DerivationList.prototype.removeRow=function(t){for(var e=t.idx+1;e<this.rows.length;e++)this.rows[e].idx--;this.rows.splice(t.idx,1);this.removeRowHandle(t);t.el.remove();t.model.events.on("end-of-interaction."+this.id,null);t.model.events.on("change."+this.id,null);t.model.events.on("create."+this.id,null)};DerivationList.prototype.undo=function(){if(this.rows.length<1)return;var t=this.getLastRow();this.removeRow(t);var e=this.getLastRow();var i=this.options.collapsed_mode;if(e){this.unhideRow(e);e.view.interactive(true);e.view.update_all()}this.updateRowDimensions();this.singleLineMode(i);return t};DerivationList.prototype.redo=function(t){if(this.rows.length>0&&this.options.collapsed_mode){this.hideRow(this.rows[this.rows.length-1])}this.addRowFromModel(t.model,t.action)};DerivationList.prototype.getAllDLs=function(){if(this.coordinator)return this.coordinator.dls;if(this.canvas_model)return this.canvas_model.dls();return[this]};DerivationList.prototype.draw_mappings_for_nodes=function(t){this.hideAllNodeMappings();if(t.length===0)return;var e=!t.some(function(t){return t.is_group("sym")});this.draw_forward_mappings(t,e);this.draw_backward_mappings(t,e);var i=this.getRowByModel(t[0].get_root());this.draw_node_backgrounds(t,i,true)};DerivationList.prototype.get_combined_action=function(t,e){if(t.idx+1===e.idx)return e.action;var i=[];for(var r=t.idx+1;r<=e.idx;r++)i.push(this.rows[r].action);return Action.createComposedAction(i)};DerivationList.prototype.get_next_visible_row=function(t){for(var e=t.idx+1;e<this.rows.length;e++){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.get_prev_visible_row=function(t){for(var e=t.idx-1;e>=0;e--){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.draw_forward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),r=this.get_next_visible_row(i);if(!r)return;var n=this.get_combined_action(i,r);var o=[];t.forEach(function(t){var i=n.mapNodes([t]);if(i.length===0)o.push({source_node:t});else i.forEach(function(i){if(e&&i.is_group("sym"))return;if(i.has_children())return;o.push({source_node:t,target_node:i})});t.was_removed=i.length===0});this.draw_mapping_lines(o,i,r);var s=n.mapNodes(t);if(e)s=s.filter(function(t){return!t.is_group("sym")});this.draw_forward_mappings(s,e);this.draw_node_backgrounds(s,r)};DerivationList.prototype.draw_backward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),r=this.get_prev_visible_row(i);if(!r)return;var n=this.get_combined_action(r,i);t.forEach(function(t){t.was_created=true});var o=[];var s=[];r.model.children[0].for_each(function(i){if(i.has_children())return;if(e&&i.is_group("sym"))return;var r=n.mapNodes([i]);var a=false;r.forEach(function(e){if(t.indexOf(e)!==-1){o.push({source_node:i,target_node:e});a=true;e.was_created=false}});if(a)s.push(i)});this.draw_mapping_lines(o,r,i);this.draw_backward_mappings(s,e);this.draw_node_backgrounds(s,r)};DerivationList.prototype.draw_node_backgrounds=function(t,e,i){var r=i?this.options.mappings_active_node_color:this.options.mappings_color;var n=function(){return r};e.view.main.selectAll(".selector").attr({rx:this.options.mappings_rect_radius,ry:this.options.mappings_rect_radius}).style("fill",n).style("stroke","none").attr("visibility",function(e){return t.indexOf(e)===-1?"hidden":null})};DerivationList.prototype.hideAllNodeMappings=function(){this.rows.forEach(function(t){t.view.main.selectAll(".selector").attr("visibility","hidden");t.view.main.selectAll(".mapping_line").attr("visibility","hidden")})};DerivationList.prototype.draw_mapping_lines=function(t,e,i){var r=i.pos[0]-e.pos[0];var n=i.pos[1]-e.pos[1];e.view.main.selectAll(".mapping_line");var o=this.options.mappings_color;var s=e.view.main.selectAll(".mapping_line").data(t);s.enter().insert("path",".math");s.attr("class","mapping_line").call(this.update_organic_path.bind(this),r,n).style("fill",o).style("stroke",o).attr("visibility",function(t){if(!t.source_node||!t.target_node)return"hidden";return t.source_node.hidden||t.target_node.hidden?"hidden":null});s.exit().remove()};DerivationList.prototype.update_organic_path=function(t,e,i){function r(t){return t.x.toFixed(4)+" "+t.y.toFixed(4)+" "}var n=this.options.mappings_rect_radius;var o=this;t.attr("d",function(t){if(!t.target_node||!t.source_node)return"M 0,0";var s=t.source_node.sel_box,a=t.source_node,h=t.target_node.sel_box,l=t.target_node;var u={x:s.x+a.x,y:s.y+a.y,width:s.width,height:s.height,r:n};var c={x:h.x+l.x+e,y:h.y+l.y+i,width:h.width,height:h.height,r:n};var d=o.createConnectorPath(u,c);var p=o.createConnectorPath(c,u);if(!d||!p)return"M 0 0";return"M "+r(d.base1)+"C "+r(d.base1_control)+r(d.joint1_control1)+r(d.joint1)+"L"+r(p.joint2)+"C "+r(p.joint2_control1)+r(p.base2_control)+r(p.base2)+"L "+r(p.base1)+"C "+r(p.base1_control)+r(p.joint1_control1)+r(p.joint1)+"L "+r(d.joint2)+"C "+r(d.joint2_control1)+r(d.base2_control)+r(d.base2)+"Z"})};DerivationList.prototype.createConnectorPath=function(t,e){var i=Math.min(this.options.mappings_joint_width,t.width*.9,e.width*.9,t.height*.9,e.height*.9);var r=Math.min(i/2,this.options.mappings_line_thickness);var n=this.options.mappings_joint_length;var o=new Point(t.x+t.width/2,t.y+t.height/2),s=new Point(e.x+e.width/2,e.y+e.height/2),a=s.Sub(o),h=[],l=[];if(D.overlaps(t,e))return null;var u=a.get_perpendicular();u.Normalize().Scale(i/2);var c=Point.intersect_inner_ray_with_rect(o.add(u),a,t);if(!c)return null;h.push(c.point);var d=c.point.add(c.tangent.scale(i/3));l.push({from:c.point,to:d});var p=Point.intersect_inner_ray_with_rect(o.sub(u),a,t);if(!p)return null;h.push(p.point);var f=p.point.add(p.tangent.scale(-i/3));l.push({from:p.point,to:f});u.Normalize().Scale(r/2);var g=Point.intersect_inner_ray_with_rect(o.add(u),a,t);if(!g)return null;var v=g.point.add(a.normalize().Scale(n));var m=Point.intersect_inner_ray_with_rect(o.sub(u),a,t);if(!m)return null;var _=m.point.add(a.normalize().Scale(n));h.push(v,_);var y=v.sub(a.normalize().Scale(n/2));var w=v.sub(a.normalize().Scale(-n/2));var x=_.sub(a.normalize().Scale(n/2));var b=_.sub(a.normalize().Scale(-n/2));l.push({from:v,to:y},{from:v,to:w},{from:_,to:x},{from:_,to:b});return{pts:h,lines:l,base1:c.point,base2:p.point,joint1:v,joint2:_,joint1_control1:y,joint1_control2:w,joint2_control1:x,joint2_control2:b,base1_control:d,base2_control:f}};DerivationList.prototype.getDragHandler=function(t){return t.interaction_handler.getHandlerByClass(V)};DerivationList.prototype.handleFactoringGesture=function(t,e,i){if(t.idx!==this.rows.length-1)return;console.log("row:",t.model.stringify(),"; dx & dy:",e,i,"; row.abs_pos:",t.abs_pos,"; this.pos:",this.pos);if(!this.curr_drag_handler)this.curr_drag_handler=this.getDragHandler(t.view);var r=this.curr_drag_handler;if(!t.abs_pos){t.abs_pos={x:t.pos[0]+this.pos[0],y:t.pos[1]+this.pos[1]};var n=this.getFactoringActions(t.model.children[0]);if(n.length>0){r.start(t.abs_pos,t.model.children,{reselect_nodes:false,actions:n,move_nodes:false})}}t.abs_pos.x+=e;t.abs_pos.y+=i;if(r.isActive())r.update({dx:e,dy:i});this.pos[0]+=e;this.pos[1]+=i;if(!this.hovering)this.pos=this.keepInContainer(this.pos,t.view.getBBox());this.svgg.attr("transform","translate("+this.pos+")");console.log("row:",t.model.stringify(),"; dx & dy:",e,i,"; row.abs_pos:",t.abs_pos,"; this.pos:",this.pos)};DerivationList.prototype.getFactoringActions=function(t){var e=function(t){return t.is_group("sum")&&t.parent.is_group("brackets")&&!t.fixed};var i=[],r=this;this.getAllDLs().forEach(function(t){if(t===r)return;var n=t.getLastRow();i.push({sums:n.model.filter(e),row:n,dl:t})});var n=[];for(var o=0;o<i.length;o++){var s=i[o];for(var a=0;a<s.sums.length;a++){var h=s.sums[a];if(TriggerFactoringAction.match(h,t)){var l=TriggerFactoringAction.createBoundAction(s.row.model,{dl:s.dl,view:s.row.view,sum:h,callback:this.factoringWasTriggered.bind(this)});var u;if(s.dl.coordinator&&this.coordinator){u=this.coordinator.getOffset(this,s.dl)}else{u=[0,0]}l.offset={x:s.dl.pos[0]+s.row.pos[0]-this.pos[0]-this.getLastRow().pos[0]+u[0],y:s.dl.pos[1]+s.row.pos[1]-this.pos[1]-this.getLastRow().pos[1]+u[1]};n.push(l)}}}return n};DerivationList.prototype.factoringWasTriggered=function(t,e,i){var r=this.getDragHandler(t);var n=X(e,this.getLastModel().children[0]);r.start(it(i),n,{reselect_nodes:false});this.curr_drag_handler=r;this.curr_target_model=i.getLastModel();this.svgg.attr("display","none")};var X=function(t,e){var i;i=J(t,e);i=et(i,t);var r=[];for(var n=0;n<i.length;n++){if(i[n].length===0)return false}for(var n=0;n<i.length;n++){if(i[n])r.push(i[n][i[n].length-1])}for(var n=0;n<r.length;n++){if(!Array.isArray(r[n])&&r[n].parent.value!=="add"&&r[n].parent.value!=="sub")r[n]=r[n].parent}if(r.length!==t.children.length)return false;var o=[];for(var n=0;n<r.length;n++){if(Array.isArray(r[n])){for(var s=0;s<r[n].length;s++){o.push(r[n][s])}}else{o.push(r[n])}}return o};var Y=function(t,e){var i=[];t.for_each(function(t){var r=t.to_ascii();if(r.slice(0,1)==="*")r=r.substr(1);if(!t.hidden&&r===e)i.push(t);else{var n=[t];while(r.length<e.length&&t.commutative&&t.rs){t=t.rs;r+=t.to_ascii();n.push(t)}if(r===e)i.push(n)}});return i};var J=function(t,e){var i=[];for(var r=0;r<t.children.length;r++){var n=t.children[r],o=n.children[1];i.push(Y(o,e.to_ascii()))}return i};function tt(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var et=function(t,e){var i=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var r=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var n=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!n(t[o]))e=false}else{return i(t)||r(t)}return e};for(var s=0;s<t.length;s++){t[s]=t[s].filter(o)}return t};var it=function(t){var e=t.getLastRow(),i=t.getLastView(),r=i.getBBox();var n=t.pos,o=e.pos,s=[r.x,r.y];var a=[n[0]+o[0]+s[0],n[1]+o[1]+s[1]];return a};DerivationList.prototype.rowDrag=function(t){var e;var i,r,n,o;var s=50,a,h;if(t.row){e=this.rows[t.row];i=t.x;r=t.dx;n=t.y;o=t.dy;a=Math.abs(t.dist_x);h=Math.abs(t.dist_y)}else{e=t;i=d3.event.x;r=d3.event.dx;n=d3.event.y;o=d3.event.dy;a=Math.abs(d3.event.finger.dist_x);h=Math.abs(d3.event.finger.dist_y)}if(this.options.send_events&&isNaN(t.row))this.row_events.drag(new DerivationList.rowDragEvent(d3.event,e.idx,this.id));if(this.interactionMode==="undecided"){if(a>s&&this.canvas_model)this.cloneLine(e,i,n);else if(h>s/2)this.interactionMode="pack"}if(this.interactionMode==="clone"&&(r||o)&&this.clone){this.handleCloneDrag(e,i,n)}if((this.interactionMode==="pack"||this.interactionMode==="undecided")&&e.idx!==0&&o!==0){this.handlePackArranging(e,n,o)}};DerivationList.rowDragEvent=function(t,e,i){this.type="Drag";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.x=t.x;this.dx=t.dx;this.y=t.y;this.dy=t.dy;this.x_offset=Math.abs(t.finger.dist_x);this.y_offset=Math.abs(t.finger.dist_y)};DerivationList.rowCloneEvent=function(t,e){this.type="Clone";this.performee=t;this.performee_type="row";this.eq=e.eq;this.pos=e.pos;this.dl_id=e.id};DerivationList.prototype.cloneLine=function(t,e,i){this.releaseRow(t);var r=gmath.extend({},this.options);r.pos=[e,i];r.eq=t.model.to_ascii();r.id=gmath.uid();if(this.options.send_events){this.row_events.clone(new DerivationList.rowCloneEvent(this.id,r))}this.clone=this.canvas_model.createDL(r);if(this.hovering){this.clone.pos=[e,i];this.clone.svgg.transition().duration(0).attr("transform","translate("+this.clone.pos+")");this.clone.toggleHover(false)}this.clone.setCurrentInteractionType("DL");this.interactionMode="clone"};DerivationList.prototype.handleCloneDrag=function(t,e,i){this.clone.DLDrag(d3.event);var r=this.pos[0]+t.pos[0]-this.clone.pos[0],n=this.pos[1]+t.pos[1]-this.clone.pos[1];this.clone_dist=Math.sqrt(r*r+n*n)};DerivationList.prototype.handlePackArranging=function(t,e,i){var r=this.rows[this.rows.length-1];var n;if(i>0){if(!this.isAboveFinalVerticalPos(t)){n=this.getHiddenAbove(t);if(!n)return;this.unhideRow(n);this.row_events.pack_state(new DerivationList.PackStateEvent(this));n=this.rows[n.idx+1]}else{n=this.getUpmostPullableRow(t)}}else{n=this.getVisibleAbove(t);if(!n)return;if(t.pos[1]<=n.pos[1]){this.hideRow(n);this.row_events.pack_state(new DerivationList.PackStateEvent(this));if(this.countVisibleRows()===1)this.singleLineMode(true)}else n=this.rows[n.idx+1]}for(var o=n.idx;o<=r.idx;o++){var s=this.rows[o];s.pos[1]=Math.min(this.getFinalVerticalPos(s),s.pos[1]+i);s.pos[1]=Math.max(o>t.idx?this.getFinalVerticalPos(s,false,t.idx):0,s.pos[1]);s.el.attr("transform","translate("+s.pos+")")}this.updateRowDimensions()};DerivationList.PackStateEvent=function(t){this.type="packState";this.performee=t.id;this.performee_type="row";this.time=Date.now();this.packState=t.rows.map(function(t){return t.hidden})};DerivationList.prototype.rowDragend=function(t){var e=t.row?this.rows[t.row]:t;if(this.options.send_events&&isNaN(t.row))this.row_events.release(new DerivationList.rowReleaseEvent(d3.event,e.idx,this.id));this.releaseRow(e);this.interactionMode="undecided";if(this.clone){if(this.clone_dist<50)this.canvas_model.removeDL(this.clone);else{this.clone.setMouseHovering(true);this.clone.setCurrentInteractionType("none")}this.clone=null}};DerivationList.rowReleaseEvent=function(t,e,i){this.type="Dragend";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.prototype.releaseRow=function(t){this.setCurrentInteractionType("none");if(this.curr_drag_handler){this.curr_drag_handler.end();this.curr_drag_handler=null}if(this.curr_target_model){this.curr_target_model.finishInteraction();this.current_target_model=null;this.canvas_model.removeDL(this)}else{for(var e=0;e<this.rows.length;e++)this.hideBackground(this.rows[e]);if(!this.options.no_handles)t.handle.attr({fill:"white"});this.draginfo=null;if(t.idx>0){var i=this.getFinalVerticalPos(t)-t.pos[1];var r=this.getVisibleAbove(t);if(r&&i>0&&i>.5*r.dims.height)this.hideRow(r);this.layoutRows()}}};var rt=function(t,e,i){this.view=t;this.h_align=e||"center";this.v_align=i||"alphabetic"};rt.prototype.set_style=function(t){var e=function(t,i,r){t.size=i;if(t.bigger)t.size*=1.5;if(t.smaller)t.size*=.67;t.color=t.selected?this.view.options.selection_color:r;if(t.has_children())for(var n=0;n<t.children.length;n++){if(t.is_group("fraction"))e.call(this,t.children[n],t.size*this.view.options.fraction_size_factor,t.color);else if(t.is_group("power")&&n===1)e.call(this,t.children[n],t.size*this.view.options.exp_size_factor,t.color);else if(t instanceof s&&t.has_children()&&n===1)e.call(this,t.children[n],t.size*this.view.options.subscript_size_factor,t.color);else e.call(this,t.children[n],t.size,t.color)}};for(var r=0;r<t.length;r++){var n=t[r];var o=i.is_top_most(n)||!n.size?this.view.options.font_size:n.size;var a=n.parent.color||(this.view.interactive()?this.view.options.color:this.view.options.inactive_color);e.call(this,n,o,a)}};rt.prototype.set_position=function(t,e){var r=this.view.options.font_baseline_shift,n=this.view.options.font_ascent,o=this.view.options.font_descent;var a=function(t){var e=t[0].parent;var r=0,n=0,o=0,s=0,a=0,h=t.length,l=t[0].hidden?0:t[0].lmar||0,u=t[h-1].hidden?0:t[h-1].rmar||0;for(var c=0;c<t.length;c++){var d=t[c];r+=d.hidden||d.hide_after_drop?0:d.width;s+=d.hidden?0:d.width;n=Math.max(n,d.hidden?0:d.ascent-d.rel_y);o=Math.max(o,d.hidden?0:d.descent+d.rel_y)}a=n+o;if(i.is_top_most(e)&&l){r-=l}var p=-r;for(var c=0;c<t.length;c++){var d=t[c];var f=c===0?0:d.lmar||0;var g=c===0?d.width-(d.lmar||0):d.width;var v=c===0?0:Math.min(t[c-1].rmar||0,f);r-=v;d.rel_x+=p+d.width+f-v;if(d.hidden||d.hide_after_drop)d.rel_x-=g-v;p+=d.hidden||d.hide_after_drop?0:g-v}if(i.is_top_most(e)&&p!==0){t.forEach(function(t){t.rel_x-=p})}return{width:r,height:a,ascent:n,descent:o,sel_box:{x:-r,width:r,y:-n,height:a},lmar:l,rmar:u}};var h=function(l){if(!l.has_children()){l.baseline_shift=r*l.size;if(l.value==="="){l.lmar=l.size/3;l.rmar=l.size/3}else if(l.value==="+"){l.lmar=l.size/6;l.rmar=l.size/6}else if(l.value==="-"&&!l.parent.is_group("sign")){l.lmar=l.parent.ls?l.size/6:0;l.rmar=l.size/6}else if(l.value===","){l.lmar=0;l.rmar=l.size/3}else{l.lmar=0;l.rmar=0}if(e){l.width=this.view.fontloader.width(l.to_string(),l.size,this.view.get_font(l));l.width+=l.lmar+l.rmar;l.ascent=n*l.size;l.descent=o*l.size;l.height=l.ascent+l.descent;l.sel_box={x:-l.lmar,width:l.width,y:-l.ascent,height:l.height}}if(t.indexOf(l)!==-1){if(!l.rel_x&&l.rel_x!==0)l.rel_x=-l.width;if(!l.rel_y&&l.rel_y!==0)l.rel_y=0}else{l.rel_x=-l.width;l.rel_y=0}return}if(t.indexOf(l)!=-1&&!i.is_top_most(l)){l.rel_x=l.rel_x||0;l.rel_y=l.rel_y||0}else{l.rel_x=0;l.rel_y=0}for(var u=0;u<l.children.length;u++)h.call(this,l.children[u]);if(l.is_group("fraction")){var c=[],d=[],p=null;var f=l.children[0];while(f){if(f.value=="mul")c.push(f);else if(f.value=="div")d.push(f);else p=f;f=f.rs}var g=a(c);var v=a(d);var m=-r*l.size;p.height=l.size*this.view.options.div_bar_height;p.width=Math.max(g.width,v.width)+l.size/8;p.ascent=p.height/2;p.descent=p.height/2;p.rel_y=m;p.rel_x=.1*l.size;p.sel_box={x:-.1*l.size,width:p.width+.2*l.size,y:-(n+o)*l.size/4,height:(n+o)*l.size/2};l.width=p.width+.2*l.size;l.ascent=g.height+p.height/2-m;l.descent=v.height+p.height/2+m;l.height=l.ascent+l.descent;l.rel_y=0;l.rel_x=-l.width;l.sel_box={x:0,width:l.width,y:-l.ascent,height:l.height};for(var u=0;u<c.length;u++){c[u].rel_y+=-g.descent-p.height/2+m;c[u].rel_x+=.5*(l.width+g.width)}for(var u=0;u<d.length;u++){d[u].rel_y+=v.ascent+p.height/2+m;d[u].rel_x+=.5*(l.width+v.width)}}else{if(l.is_group("power")){var _=l.children[0],y=l.children[1];y.rel_y-=_.ascent*.7}if(l instanceof s&&l.has_children()){var _=l.children[0],w=l.children[1];w.rel_y+=_.descent*.7}gmath.extend(l,a(l.children))}};for(var l=0;l<t.length;l++)h.call(this,t[l]);var u=function(t,e,i,r,n){if(t.dragging){t.x0=t.rel_x+e;t.y0=t.rel_y+i;if(t.update_x_during_dragging){t.x=t.x0;t.update_x_during_dragging=false}if(t.update_y_during_dragging){t.y=t.y0;t.update_y_during_dragging=false}}else{t.x=t.rel_x+e;t.y=t.rel_y+i;t.x0=t.rel_x+r;t.y0=t.rel_y+n}if(t.has_children())for(var o=0;o<t.children.length;o++){u.call(this,t.children[o],t.x,t.y,t.x0,t.y0)}};for(var l=0;l<t.length;l++){var c=t[l];if(i.is_top_most(c)){var d,p;switch(this.v_align){case"alphabetic":p=0;break;case"top":p=c.ascent-c.rel_y;break;case"center":p=-c.descent+c.height/2;break;case"bottom":p=-c.descent-c.rel_y;break}switch(this.h_align){case"left":d=c.width;break;case"center":d=c.width/2;break;case"equals":d=c.width/2;if(c.is_group("equals")){var f=c.children[1];var g=f.rel_x+f.sel_box.x+f.sel_box.width;d=-g}break;case"right":d=0;break}u.call(this,c,d,p,d,p)}else{u.call(this,c,c.parent.x||0,c.parent.y||0,c.parent.x0||0,c.parent.y0||0)}}};CreationBox=function(t,e,i){this.container=d3.select(t);this.pos0=e.slice();this.bbox={x:e[0],y:e[1],width:20,height:30};this.main_el=this.createVisualElement();this.setupListeners(this.main_el);this.shadow_el=this.createVisualElement().style("visibility","hidden");this.dl_getter=i;this.actions=[]};CreationBox.prototype.setCanvasController=function(t){this.canvas_controller=t};CreateDLAction=function(t,e){this.cc=e;this.size=this.cc.model().size();this.pos_fn=t;this.priority=-1;this.target={x:0,y:0,sel_box:{x:20,y:30,width:this.size.width-40,height:this.size.height-60}}};CreateDLAction.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};CreateDLAction.prototype.doInPlace=function(t){this.cc.inputDL(this.pos_fn());if(typeof t==="function")t(this);else return true};CreationBox.prototype.getTargetPos=function(){return[this.bbox.x+this.bbox.width/2,this.bbox.y+this.bbox.height/2]};CreationBox.prototype.getAvailableActions=function(){var t=[];if(this.canvas_controller)t.push(new CreateDLAction(this.getTargetPos.bind(this),this.canvas_controller));var e=this.dl_getter();for(var i=0;i<e.length;i++){var r=e[i],n=r.getLastRow();var o=n.model.children;var s=gmath.actions.FractionExtendAction.getAllAvailableActions(o).concat(gmath.actions.EquationFountain.getAllAvailableActions(o));for(var a=0;a<s.length;a++)s[a].offset={x:r.pos[0]+n.pos[0],y:r.pos[1]+n.pos[1]};t=t.concat(s)}D.setTargetRegions(t);return t};CreationBox.prototype.onDragStart=function(){this.actions=this.getAvailableActions();D.draw(this.container,this.actions,this.bbox);this.shadow_el.style("visibility",null)};CreationBox.prototype.onDrag=function(){this.shadow_el.attr({x:d3.event.pos[0],y:d3.event.pos[1]});this.bbox.x=d3.event.pos[0];this.bbox.y=d3.event.pos[1];D.draw(this.container,this.actions,this.bbox);this.current_hit=D.getBestHit(this.actions,this.bbox)};CreationBox.prototype.onDragEnd=function(){this.shadow_el.attr({x:this.pos0[0],y:this.pos0[1]});this.shadow_el.style("visibility","hidden");D.draw(this.container);if(this.current_hit){if(this.current_hit instanceof CreateDLAction)this.current_hit.doInPlace();else{var t=this.current_hit.target.get_root();t.performAction(this.current_hit,function(t){t.finishInteraction()})}}this.bbox.x=this.pos0[0];this.bbox.y=this.pos0[1]};CreationBox.prototype.createVisualElement=function(){var t=this.container.append("rect").datum(this).attr(this.bbox).style({fill:"white","fill-opacity":.67,stroke:"green","stroke-dasharray":"4,2",cursor:"pointer"});return t};CreationBox.prototype.setupListeners=function(t){var e=drag_behavior().on("drag-start",this.onDragStart.bind(this)).on("drag",this.onDrag.bind(this)).on("drag-end",this.onDragEnd.bind(this));var i=mtouch_events().origin(function(t){return[t.bbox.x,t.bbox.y]}).on("tap",nt).call(e);t.call(i)};function nt(){console.log(d3.event)}gmath.ui=gmath.ui||{};gmath.ui.Graph=function(){var t=function(t,e){this.id=e.id?e.id:gmath.uid();this.options=e||{};this.send_events=true;this.events=d3.dispatch("move","touch","drag","hold","release","resize","remove_geom","create_geom","geom_attr");this.interactive=this.options.interactive?this.options.interactive:true;this.container=d3.select(t);this.svg_dims=this.getContainerDimensions();this.view=e.view;this.main_g=null;this.geom_g=null;this.legs_g=null;this.size_g=null;this.move_el=null;this.fill_el=null;this.clip_el=null;this.evts_el=null;this.geoms=this.options.geoms||[];this.pos=this.options.pos||{x:0,y:0};this.size=this.options.size||{width:360,height:360};this.lims={min:100,max:600};this.domain=this.options.domain||[-5,5];this.x_domain=this.domain;this.y_domain=this.domain;this.x_range=d3.scale.linear().domain(this.x_domain);this.y_range=d3.scale.linear().domain(this.y_domain);this.x_axis=null;this.y_axis=null;this.x_axis_g=null;this.y_axis_g=null;this.x_axis_G=null;this.y_axis_G=null;this.x_lims=false;this.y_lims=false;this.tick_size=36;this.x_ticks=this.options.x_ticks||10;this.y_ticks=this.options.y_ticks||10;this.x_label=this.options.x_label||"x";this.y_label=this.options.y_label||"y";this.x_label_el=null;this.y_label_el=null;this.legs_sel=null;this.legs_ops=this.options.legs_ops||{width:160,height:90,fill:"whitesmoke"};this.legs_offset={width:0,height:0};this.move_offset=0;this.max_dist=this.options.max_dist||30;this.selection=null;this.dragging=false;this.drag_action=null;this.colors=d3.scale.category10();this.delete_mode=false;this.zoom=null;this.initial_pan=e.initial_pan||[0,0];this.initial_zoom=e.initial_zoom||1;this.margin=35;this.defaultMargin=this.margin;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Graph",geoms:this.geoms.filter(function(t){return!(t.type==="point"&&t.line)}),pos:this.pos,size:this.size,x_domain:this.x_domain,y_domain:this.y_domain,x_ticks:this.x_ticks,y_ticks:this.y_ticks,legs_ops:this.legs_ops,max_dist:this.max_dist,initial_pan:this.zoom.translate(),initial_zoom:this.zoom.scale()}};t.prototype.setInteractionMode=function(t){this.delete_mode=t==="delete"};t.prototype.setGeoms=function(t){this.geoms=t;return this.update()};t.prototype.getGeomByID=function(t){var e=this.geoms.filter(function(e){return e.id===t});return e[0]?e[0]:null};t.prototype.setPos=function(t,e){this.pos=t;this.main_g.attr("transform","translate("+this.pos.x+", "+this.pos.y+")");if(e)this.keepInContainer();return this};t.prototype.setSize=function(t){var e=this.zoom.translate(),i=this.zoom.scale();this.zoom.translate([0,0]);this.zoom.scale(1);this.size=t;var r=this.size.width/2/Math.abs(this.x_range.range()[0]),n=this.size.height/2/Math.abs(this.y_range.range()[0]);this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_range.domain([this.x_range.domain()[0]*r,this.x_range.domain()[1]*r]);this.y_range.domain([this.y_range.domain()[0]*n,this.y_range.domain()[1]*n]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(e).scale(i).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.update();this.zoomBehavior({translate:e})};t.prototype.setXDomain=function(t){this.x_range.domain(t);return this.update()};t.prototype.setYDomain=function(t){this.y_range.domain(t);return this.update()};t.prototype.inBounds=function(t,e){var i=this.pos.x-this.size.width/2,r=this.pos.x+this.size.width/2,n=this.pos.y-this.size.height/2,o=this.pos.y+this.size.height/2;if(t>i&&t<r&&e>n&&e<o)return true;return false};t.prototype.remove=function(){this.main_g.remove()};t.prototype.enableZoom=function(t){if(t)this.main_g.call(this.zoom);else{this.main_g.on(".zoom",null);d3.select(window).on("mousemove.zoom",null)}};t.prototype.zoomBehavior=function(t){var t=t||d3.event,e=this.size.width/2,i=this.size.height/2,r=this.zoom.translate();if(t.translate[0]<-(e-5)){var n=0;this.y_axis_g.selectAll(".tick").each(function(){var t=d3.select(this).select("text").node().getBBox().width;if(t>n)n=t});this.margin=Math.max(this.defaultMargin,15+n);this.y_axis_G.attr("transform","translate("+[-(e+5),0]+")");this.y_axis_g.attr("transform","translate("+[-(e+5),0]+")");this.y_label_el.attr({x:-(e+15),y:r[1]>=0?-(i+10):i+15});this.y_lims=true}else if(t.translate[0]>e-5){var n=0;this.y_axis_g.selectAll(".tick").each(function(){var t=d3.select(this).select("text").node().getBBox().width;if(t>n)n=t});var o=10+n;this.margin=Math.max(this.defaultMargin,15+n);this.y_axis_G.attr("transform","translate("+[e+o,0]+")");this.y_axis_g.attr("transform","translate("+[e+o,0]+")");this.y_label_el.attr({x:e+10,y:r[1]>=0?-(i+10):i+15});this.y_lims=true}else{this.margin=this.defaultMargin;this.y_axis_g.attr("transform","translate("+[t.translate[0],0]+")");this.y_label_el.attr({x:t.translate[0]-4,y:r[1]>=0?-(i+10):i+15});this.y_lims=false}if(t.translate[1]<-(i-5)){this.x_axis_G.attr("transform","translate("+[0,-(i+20)]+")");this.x_axis_g.attr("transform","translate("+[0,-(i+20)]+")");this.x_label_el.attr({x:r[0]>0?-(e+15):e+10,y:-(i+10)});this.x_lims=true}else if(t.translate[1]>i-5){this.x_axis_G.attr("transform","translate("+[0,i+5]+")");this.x_axis_g.attr("transform","translate("+[0,i+5]+")");this.x_label_el.attr({x:r[0]>0?-(e+15):e+10,y:i+15});this.x_lims=true}else{this.x_axis_g.attr("transform","translate("+[0,t.translate[1]]+")");this.x_label_el.attr({x:r[0]>0?-(e+15):e+10,y:t.translate[1]+4});this.x_lims=false}this.x_axis.ticks(this.size.width/this.tick_size);this.y_axis.ticks(this.size.height/this.tick_size);this.update()};t.prototype.init=function(){var t=this;this.main_g=this.container.append("g").classed("graph",true).attr("transform","translate("+this.pos.x+", "+this.pos.y+")").on("mouseenter",this.showMove.bind(this,null)).on("mouseleave",this.hideMove.bind(this,null));this.move_el=this.main_g.append("rect").classed("drag",true).style("opacity",0).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("fill","white");
var e=mtouch_events().frame(this.main_g.node()).on("touch",this.deleteMove.bind(this,null)).on("drag",this.move.bind(this,null)).on("release",function(){t.enableZoom(true);t.hideMove.bind(t);t.release()});this.move_el.call(e);this.fill_el=this.main_g.append("rect").classed("fill",true).style("fill","white");this.geom_g=this.main_g.append("g");var i=this.main_g.append("defs").append("clipPath").attr("id","clipPath");this.clip_el=i.append("rect");this.geom_g.attr("clip-path","url(#clipPath)");this.legs_g=this.main_g.append("g");this.evts_el=this.main_g.append("rect").classed("evts",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("pointer-events","all").style("fill","none").on("mousemove",this.hover.bind(this,null)).on("mouseenter",this.hideMove.bind(this,null)).on("mouseleave",this.showMove.bind(this,null));var r=mtouch_events().frame(this.main_g.node()).on("touch",this.touch.bind(this,null)).on("drag",this.drag.bind(this,null)).on("release",this.release.bind(this,null)).on("hold",this.hold.bind(this,null)).hold_time(1e3).hold_max_dist(2);this.evts_el.call(r);this.size_g=this.main_g.append("g").classed("size",true).style("pointer-events","all");var n=[[24,24],[24,15],[15,24]];for(var o=0;o<n.length;o++){this.size_g.append("circle").attr("cx",n[o][0]).attr("cy",n[o][1]).attr("r",4).style("fill","silver").style("opacity",.3)}var s=mtouch_events().frame(this.main_g.node()).on("touch",this.resize_touch.bind(this)).on("drag",this.resize.bind(this)).on("release",this.resize_release.bind(this));this.size_g.call(s);this.x_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.y_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");if(Math.abs(this.x_range.range()[0])<=Math.abs(this.y_range.range()[0])){var a=Math.abs(this.x_range.range()[0])/Math.abs(this.domain[0]),h=Math.abs(this.y_range.range()[0])/a;this.y_range.domain([-h,h]);this.y_axis.ticks(h*2)}else{var a=Math.abs(this.y_range.range()[0])/Math.abs(this.domain[0]),h=Math.abs(this.x_range.range()[0])/a;this.x_range.domain([-h,h]);this.x_axis.ticks(h*2)}this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(this.initial_pan).scale(this.initial_zoom).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.enableZoom(true);this.update();this.zoomBehavior({translate:this.initial_pan})};t.prototype.update=function(){this.x_axis_G.call(this.x_axis).style("display",this.x_lims?"block":"none").select("path").style("display","none");this.x_axis_g.call(this.x_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");e.style("display",e.text()*1===0?"none":"block")});this.y_axis_G.call(this.y_axis).style("display",this.y_lims?"block":"none").select("path").style("display","none");this.y_axis_g.call(this.y_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");e.style("display",e.text()*1===0?"none":"block")});this.x_axis_g.selectAll(".tick").select("line").attr("x1",0).attr("x2",0).attr("y1",-(this.size.height+20)).attr("y2",this.size.height+20).style("stroke","gainsboro").style("opacity",.8);var t=0;this.y_axis_g.selectAll(".tick").each(function(){var e=d3.select(this).select("text").node().getBBox().width;if(e>t)t=e});this.y_axis_g.selectAll(".tick").select("line").attr("x1",-(this.size.width+(10+t))).attr("x2",this.size.width+20).attr("y1",0).attr("y2",0).style("stroke","gainsboro").style("opacity",.8);this.x_label_el.text(this.x_label);this.y_label_el.text(this.y_label);this.geoms.forEach(function(t){t.update()});var e=this.x_range.range()[0],i=this.y_range.range()[0],r=this.x_range.range()[1],n=this.y_range.range()[1],o=Math.abs(r-e),s=Math.abs(n-i);this.move_el.attr({x:e-this.margin,y:Math.min(i,n)-this.margin}).attr("width",o+this.margin*2+this.legs_offset.width).attr("height",s+this.margin*2+this.legs_offset.height);this.fill_el.attr({x:e,y:Math.min(i,n)}).attr("width",o).attr("height",s);this.clip_el.attr({x:e,y:Math.min(i,n)}).attr("width",o).attr("height",s);this.evts_el.attr({x:e,y:Math.min(i,n)}).attr("width",o).attr("height",s);var a=this;this.size_g.attr("transform",function(){var t=a.x_range.range()[1],e=a.y_range.range()[0];return"translate("+(t-30)+","+(e-30)+")"});this.keepInContainer()};t.prototype.updateLegends=function(){this.legs_sel=this.legs_g.selectAll(".graph.legend").data(this.geoms);var t=this.legs_sel.enter().append("g").classed("graph.legend",true);t.append("rect").attr("rx",5).attr("ry",5).attr("width",this.legs_ops.width).attr("height",this.legs_ops.height).style("fill",this.legs_ops.fill);var e=t.append("g").attr("transform","translate(-20, 0)");var i={interaction_mode:"change",no_history:true,no_handles:true,draggable:false,bg_rect_style:{fill:"none",stroke:"none",opacity:0},bg_rect_activity_style:{fill:"none",stroke:"none",opacity:0},h_align:"left",v_align:"top"};t.each(function(t){var e=this.select("g").node();t.linkRepresentations(e,i)});var r=t.append("g");r.append("circle").attr("cx",this.legs_ops.width-15).attr("cy",15).attr("r",10).style("fill",function(t){return t.color});var n=mtouch_events().frame(this.main_g.node()).on("touch",function(t){this.legs_sel.filter(function(e){return t.id===e.id}).style("display","none");this.orderLegends()});r.call(n);var o=6*Math.sqrt(2)/2;r.append("line").attr({x1:this.legs_ops.width-15+o,y:15-o,x2:this.legs_ops.width-15-o,y:15+o}).style("stroke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");r.append("line").attr({x1:this.legs_ops.width-15-o,y:15-o,x2:this.legs_ops.width-15+o,y:15+o}).style("stoke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");this.legs_sel.exit().remove()};t.prototype.orderLegends=function(){var t=this.size.width/2+5,e=-this.size.height/2,i=0;this.legs_offset.width=0;this.legs_offset.height=0;this.legs_sel.attr("transform",function(r){var n=this.style("display"),o="translate("+t+", "+e+")";if(n==="block"){e+=this.legs_ops.height+5;i++}return o});if(i>0){this.legs_offset.width=this.legs_ops.width+5;if(e>this.size.height){this.legs_offset.height=this.size.height-e}}this.update()};t.prototype.move=function(t){var i=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.move(new e(this.id,i));if(!this.selection){if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}this.delta={x:this.pos.x-this.pos0.x,y:this.pos.y-this.pos0.y};var r=i.finger.dx,n=i.finger.dy;this.setPos({x:this.pos.x+r,y:this.pos.y+n},true);this.showMove();if(t&&t.finger){this.updateFingers([i.finger])}}};t.prototype.hover=function(){if(this.delete_mode){var t=d3.event.x-this.pos.x-this.margin,e=d3.event.y-this.pos.y-this.margin,i=this.getClosest(t,e);this.geoms.forEach(function(t){t.select(t===i?true:false,true)})}};t.prototype.showMove=function(){if(this.dragging)return;if(this.delete_mode)this.move_el.style("stroke","red");this.move_el.style("opacity",1);this.move_offset=this.margin};t.prototype.hideMove=function(){if(this.delete_mode)this.move_el.style("stroke","silver");this.move_el.style("opacity",0);this.move_offset=0};t.prototype.deleteMove=function(){this.svg_dims=this.getContainerDimensions();this.enableZoom(false);if(this.delete_mode)this.view.removeGraph(this)};t.prototype.touch=function(t){var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.touch(new i(this.id,e));if(t&&t.finger){this.updateFingers([e.finger])}var r=e.finger.pos[0],n=e.finger.pos[1];this.selection=this.getClosest(r,n);if(this.selection)this.enableZoom(false);if(this.delete_mode){if(this.selection){var o=this.selection.removeGroup();for(var s=0;s<o.length;s++){for(var a=0;a<this.geoms.length;a++){if(this.geoms[a].id===o[s])this.geoms.splice(a,1)}}}}else{if(this.selection&&this.selection.type==="point-slope"){var h=this;this.drag_action=function(){h.geoms.forEach(function(t){if(t.type==="point"&&t.id!==h.selection.id&&!t.line&&!t.intercept)t.showSnap()});h.drag_action=null}}}};t.prototype.drag=function(t){this.dragging=true;var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.drag(new r(this.id,e));if(t&&t.finger){this.updateFingers([e.finger],true)}var i=e.finger.pos[0],n=e.finger.pos[1];if(this.drag_action)this.drag_action();if(this.selection){if(this.selection.type==="point")this.selection.drag(e.finger.dx,e.finger.dy);else this.selection.drag(i,n)}};t.prototype.addGeom=function(t,e){var i;if(t==="Point"){i=new gmath.ui.Point(this.geom_g.node(),e)}else if(t==="SILine"){i=new gmath.ui.SILine(this.geom_g.node(),e)}this.geoms.push(i);return i};t.prototype.hold=function(t){var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.hold(new n(this.id,e));var i=e.finger.pos[0],r=e.finger.pos[1];this.selection=this.getClosest(i,r);if(!this.selection||this.selection.type!=="point"||this.selection.line){var o=Math.abs(this.x_range.invert(i))<.1?true:false,s={graph:this,pos:o?{x:0,y:this.y_range.invert(r)}:{x:this.x_range.invert(i),y:this.y_range.invert(r)},color:this.colors(this.geoms.length),intercept:o},a=new gmath.ui.Point(this.geom_g.node(),s);this.geoms.push(a);this.listenToGeom(a);this.selection=a}if(this.selection.type==="point"&&!this.selection.line){this.enableZoom(false);this.selection.showSnap();var h=this;this.drag_action=function(){h.selection.hideSnap();var t={graph:h,point:h.selection,color:h.selection.color},e=null;if(h.selection.intercept){e=new gmath.ui.SILine(h.geom_g.node(),t)}else{e=new gmath.ui.PSLine(h.geom_g.node(),t);h.geoms.forEach(function(t){if(t.type==="point"&&t.id!==h.selection.id&&!t.line&&!t.intercept)t.showSnap()})}h.geoms.push(e);this.listenToGeom(e);h.selection=e;h.drag_action=null}}else{this.selection=null;this.enableZoom(true)}};t.prototype.listenToGeom=function(t){var e=this;if(this.send_events){this.events.create_geom(gmath.extend(new a(t),{graph_id:e.id}))}t.events.on("remove",function(t){if(e.send_events){e.events.remove_geom(gmath.extend(t,{graph_id:e.id}))}})};t.prototype.release=function(t){this.dragging=false;var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.release(new o(this.id,e));this.updateFingers([]);var i=e.finger.pos[0],r=e.finger.pos[1],n=this;this.geoms.forEach(function(t){if(t.type==="point")t.hideSnap();if(n.selection&&n.selection.type==="point-slope"&&!t.line&&!t.intercept){if(t.distanceTo(i,r)<t.radius*2){t.setColor(n.selection.color);var e={graph:n,point_a:n.selection.point,point_b:t,color:n.selection.color},o=new gmath.ui.PPLine(n.geom_g.node(),e);n.selection.remove();for(var s=0;s<n.geoms.length;s++){if(n.geoms[s].id===n.selection.id)n.geoms.splice(s,1,o)}n.selected=o}}});if(this.selection){if(this.send_events){this.events.geom_attr(new gmath.extend(new h(this.selection),{graph_id:this.id}))}this.selection.release();this.selection=null;this.enableZoom(true)}this.drag_action=null;if(this.pos0){this.pos0=null}};t.prototype.resize_touch=function(){this.svg_dims=this.getContainerDimensions();this.enableZoom(false)};t.prototype.resize=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new s(this.id,e));if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}var i=e.finger.dx,r=e.finger.dy,n={width:this.size.width+i,height:this.size.height+r},o={x:this.pos.x+i/2,y:this.pos.y+r/2};if(n.width>=this.lims.min&&n.height>=this.lims.min&&n.width<=this.lims.max&&n.height<=this.lims.max&&n.width+this.margin*2<=this.svg_dims.width&&n.height+this.margin*2<=this.svg_dims.height){this.setSize(n);this.setPos(o,true)}if(t&&t.finger){this.updateFingers([e.finger])}};t.prototype.resize_release=function(){this.enableZoom(true)};t.prototype.getClosest=function(t,e){var i=this.max_dist,r=null;this.geoms.forEach(function(n){var o=n.distanceTo(t,e);if(o<=i){if(r&&r.type==="point"&&r.line&&r.line===n&&o<20){i=o}else{i=o;r=n}}});return r};t.prototype.getContainerDimensions=function(){var t=this.container.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;return t.getBoundingClientRect()};t.prototype.keepInContainer=function(){var t=this.pos.x,e=this.pos.y,i=this.size.width/2,r=this.size.height/2,n=this.legs_offset.width,o=this.legs_offset.height,s=this.move_offset,a=this.svg_dims.width,h=this.svg_dims.height,l=t<i+s+2?i+s+2:t+i+s+n+4>a?a-(i+n+s+4):t,u=e<r+s+2?r+s+2:e+r+s+o+4>h?h-(r+o+s+4):e;if(t!==l||e!==u)this.setPos({x:l,y:u},false)};var e=function(t,e){this.performee=t;this.performee_type="graph";this.type="move";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var i=function(t,e){this.performee=t;this.performee_type="graph";this.type="touch";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var r=function(t,e){this.performee=t;this.performee_type="graph";this.type="drag";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var n=function(t,e){this.performee=t;this.performee_type="graph";this.type="hold";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var o=function(t,e){this.performee=t;this.performee_type="graph";this.type="release";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var s=function(t,e){this.performee=t;this.type="resize";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var a=function(t){this.performee=t.id;this.performee_type=t.type;this.type="graphElementCreate";this.time=Date.now()};t.GraphElementRemoveEvent=function(t){this.performee=t.id;this.performee_type=t.type;this.type="graphElementRemove";this.time=Date.now()};var h=function(t){this.performee=t.id;this.performee_object=t;this.type="graphElementChange";this.time=Date.now()};t.prototype.updateFingers=function(t,e){if(!this.finger_sel){this.finger_vis_start=Date.now();this.finger_sel=this.main_g.selectAll(".finger")}var i=this.finger_sel.data(t);if(!e){i.enter().append("circle").classed("finger",true).attr("r",25).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5})}if(this.pos0){var r=this.pos.x-this.pos0.x,n=this.pos.y-this.pos0.y}var o=this;i.attr("cx",function(t){return o.pos0?t.pos[0]-r:t.pos[0]}).attr("cy",function(t){return o.pos0?t.pos[1]-n:t.pos[1]});i.transition().ease("bounce").attr("r",17);var s=this.finger_vis_start;i.exit().transition().delay(Math.max(0,250-(Date.now()-s))).style("opacity",1e-4).remove();this.finger_sel=i.size()===0?null:i};return t}();gmath.ui=gmath.ui||{};gmath.ui.SILine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","intercept","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=e.id||gmath.uid();this.intercept=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="slope-intercept";this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"SILine",graph:this.graph.id,intercept:this.intercept,slope:this.slope,color:this.color,width:this.width}};t.validSourceDL=function(t){var e=t.getLastRow().model.children[0];if(e.is_group("equals")){var i=e.children[0],r=e.children[2];if(s.is_var(i)&&i.value==="y"&&r.is_group("sum")){if(r.children.length===2){i=r.children[0];r=r.children[1];if(i.is_group("add","sub")&&r.is_group("add","sub")){i=i.children[1];r=r.children[1];if(i.is_group("product","fraction")&&n.is_num(r)){r=i.children[1];i=i.children[0];if(i.is_group("mul","div")&&r.is_group("mul","div")){i=i.children[1];r=r.children[1];if(n.is_num(i)&&s.is_var(r)&&r.value==="x"){return true}}}}}}}return false};t.prototype.linkToDL=function(t,e,i){var r=this,n=t.getLastModel(),o=e,s=i,a=t.rows[0].view;var h=function(t,e){if(t.selected!==e){t.selected=e;a.renderer.set_style([t]);a.update_style(true)}};var l=function(t,e){return function(){return h(t,e)}};var u=gmath.uid();var c=function(t){if(t.old_model!==n)throw"wrong old_model";if(t.new_model!==t.old_model){n.events.on("change."+u,null);n.events.on("end-of-interaction."+u,null);n=t.new_model;n.events.on("change."+u,c);n.events.on("end-of-interaction."+u,d)}o=t.node_map[o.id][0];s=t.node_map[s.id][0];var e=n.numeric_value(o);var i=n.numeric_value(s);if(e!==r.slope)r.setSlope(e);if(i!==r.intercept.pos.y)r.setIntercept({x:0,y:i})};var d=function(){r.release();r.intercept.release()};n.events.on("change."+u,c);n.events.on("end-of-interaction."+u,d);r.events.on("slope."+u,function(t){if(t!==n.numeric_value(o)){n.numeric_value(o,t);h(o,true)}}).on("release."+u,function(){h(o,false)});r.intercept.events.on("y."+u,function(t){if(t!==n.numeric_value(s)){n.numeric_value(s,t);h(s,true)}}).on("release."+u,function(){h(s,false)})};t.createGeomFromDL=function(t,e){var i=t.getLastRow().model,r=[0,2,0,1,0,1],n=[0,2,1],o=i.get_child(r),s=i.get_child(n),a=i.numeric_value(o),h=i.numeric_value(s),l={graph:e,pos:{x:0,y:h},color:e.colors(e.geoms.length),intercept:true},u=new gmath.ui.Point(e.geom_g.node(),l);e.geoms.push(u);l={graph:e,point:u,slope:a,color:u.color};var c=new gmath.ui.SILine(e.geom_g.node(),l);e.geoms.push(c);c.linkToDL(t,o,s)};t.prototype.createDLFromGeom=function(t){var e=this.slope,i=this.intercept.pos.y,r=i<0?""+i:"+"+i,n={eq:"y="+e+"x"+r,pos:t,interaction_mode:"inspect"},o=this.graph.view.createDL(n),s=o.getLastRow().model,a=[0,2,0,1,0,1],h=[0,2,1],l=s.get_child(a),u=s.get_child(h);this.linkToDL(o,l,u)};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.intercept.id).attr("id",this.id).classed("SILine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.intercept.line=this;return this.update()};t.prototype.setIntercept=function(t,e){this.intercept.setPos(t);this.update(e);this.events.intercept(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.intercept.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){var i=t-this.graph.x_range(this.intercept.pos.x),r=-e- -this.graph.y_range(this.intercept.pos.y);if(i!==0)this.setSlope(r/i)};t.prototype.release=function(){this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.intercept.pos.x),r=-this.graph.y_range(this.intercept.pos.y),n=this.graph.x_range(this.intercept.pos.x)+1,o=-this.graph.y_range(this.intercept.pos.y)+this.slope;return st(i,r,n,o,t,-e)};t.prototype.remove=function(){this.element.remove();if(this.intercept.line.id===this.id)this.intercept.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,d3.event));this.intercept.remove();this.element.remove();return[this.intercept.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.tween=function(t){var e=t||this.element,i=this.slope0,r=this.slope,n=this.graph.x_range,o=this.graph.y_range,s=this.intercept.pos.y,a=n.domain()[0],h=n.domain()[1],l=o.domain()[0],u=o.domain()[1],c=this;return function(t){var d=i+t*(r-i),p=ot(0,s,1,s+d,a,h,l,u);e.attr({x1:n(p[0].x),y1:o(p[0].y),x2:n(p[1].x),y2:o(p[1].y)});c.slope0=d}};return t}();function ot(t,e,i,r,n,o,s,a){var h={x:t,y:e},l={x:i,y:r},u=[h,l],c=h.y<l.y?[s,a]:[a,s],d=h.x<l.x?[n,o]:[o,n];if(h.x-l.x===0){return[{x:h.x,y:c[0]},{x:l.x,y:c[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);u.forEach(function(t,e){var i=c[e],r=t.x-(t.y-i)/f;if(r<n||r>o){r=d[e];i=t.y-f*(t.x-r)}p.push({x:r,y:i})});return p}}function st(t,e,i,r,n,o){var s=i-t,a=r-e;return Math.abs(a*n-s*o+i*e-r*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PPLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("point_a","point_b","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.point_a=e.point_a;this.point_b=e.point_b;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-point";this.init()};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point_a.id).attr("id",this.id).classed("PPLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.point_a.line=this;this.point_b.line=this;return this.update()};t.prototype.setPointA=function(t,e){this.point_a=t;this.update(e);this.events.point_a(t);return this};t.prototype.setPointB=function(t,e){this.point_b=t;this.update(e);this.events.point_b(t);return this};t.prototype.select=function(t,e){if(e){this.point_a.select(t);this.point_b.select(t)}this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(){};t.prototype.release=function(){};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point_a.pos.x),r=-this.graph.y_range(this.point_a.pos.y),n=this.graph.x_range(this.point_b.pos.x),o=-this.graph.y_range(this.point_b.pos.y);return st(i,r,n,o,t,-e)};t.prototype.remove=function(){this.element.remove();if(this.point_a.line.id===this.id)this.point_a.line=null;if(this.point_b.line.id===this.id)this.point_b.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,d3.event));this.point_a.remove();this.point_b.remove();this.element.remove();return[this.point_a.id,this.point_b.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.tween=function(){var t=this.element,e=this.graph.x_range,i=this.graph.y_range,r=this.point_a.pos.x,n=this.point_a.pos.y,o=this.point_b.pos.x,s=this.point_b.pos.y,a=e.domain()[0],h=e.domain()[1],l=i.domain()[0],u=i.domain()[1],c=this;return function(c){var d=ot(r,n,o,s,a,h,l,u);t.attr({x1:e(d[0].x),y1:i(d[0].y),x2:e(d[1].x),y2:i(d[1].y)})}};return t}();function ot(t,e,i,r,n,o,s,a){var h={x:t,y:e},l={x:i,y:r},u=[h,l],c=h.y<l.y?[s,a]:[a,s],d=h.x<l.x?[n,o]:[o,n];if(h.x-l.x===0){return[{x:h.x,y:c[0]},{x:l.x,y:c[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);u.forEach(function(t,e){var i=c[e],r=t.x-(t.y-i)/f;if(r<n||r>o){r=d[e];i=t.y-f*(t.x-r)}p.push({x:r,y:i})});return p}}function st(t,e,i,r,n,o){var s=i-t,a=r-e;return Math.abs(a*n-s*o+i*e-r*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PSLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","point","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.point=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-slope";this.init()};t.validSourceDL=function(t){var e=t.getLastRow().model.children[0];if(e.is_group("equals")){var i=e.children[0],r=e.children[2];if(i.is_group("sum")&&r.is_group("product","fraction")){if(i.children.length===2){r=i.children[1];i=i.children[0];if(i.is_group("add","sub")&&r.is_group("add","sub")){i=i.children[1];r=r.children[1];if(s.is_var(i)&&i.value==="y"&&n.is_num(r)){i=e.children[2].children[0];r=e.children[2].children[1];if(i.is_group("mul","div")&&r.is_group("mul","div")){i=i.children[1];r=r.children[1];if(n.is_num(i)&&r.is_group("brackets")){e=r.children[1];if(e.is_group("sum")){if(e.children.length===2){i=e.children[0];r=e.children[1];if(i.is_group("add","sub")&&r.is_group("add","sub")){i=i.children[1];r=r.children[1];if(s.is_var(i)&&i.value==="x"&&n.is_num(r)){return true}}}}}}}}}}}return false};t.prototype.linkToDL=function(t,e,i,r){var n=this,o=t.getLastModel(),s=e,a=i,h=r,l=t.rows[0].view;var u=function(t,e){if(t.selected!==e){t.selected=e;l.renderer.set_style([t]);l.update_style(true)}};var c=function(t,e){return function(){return u(t,e)}};var d=gmath.uid();var p=function(t){if(t.old_model!==o)throw"wrong old_model";if(t.new_model!==t.old_model){o.events.on("change."+d,null);o.events.on("end-of-interaction."+d,null);o=t.new_model;o.events.on("change."+d,p);o.events.on("end-of-interaction."+d,f)}s=t.node_map[s.id][0];a=t.node_map[a.id][0];h=t.node_map[h.id][0];var e=o.numeric_value(s);var i=o.numeric_value(a)*-1;var r=o.numeric_value(h)*-1;if(e!==n.slope)n.setSlope(e);if(i!==n.point.pos.x)n.setPoint({x:i,y:n.point.pos.y});if(r!==n.point.pos.y)n.setPoint({x:n.point.pos.x,y:r})};var f=function(){n.release();n.point.release()};o.events.on("change."+d,p);o.events.on("end-of-interaction."+d,f);n.events.on("slope."+d,function(t){if(t!==o.numeric_value(s)){o.numeric_value(s,t);u(s,true)}}).on("release."+d,function(){u(s,false)});n.point.events.on("x."+d,function(t){if(t!==o.numeric_value(a)){o.numeric_value(a,t*-1);u(a,true)}}).on("release."+d,function(){u(a,false)});n.point.events.on("y."+d,function(t){if(t!==o.numeric_value(h)){o.numeric_value(h,t*-1);u(h,true)}}).on("release."+d,function(){u(h,false)})};t.createGeomFromDL=function(t,e){var i=t.getLastRow().model,r=[0,2,0,1],n=[0,2,1,1,1,1,1],o=[0,0,1,1],s=i.get_child(r),a=i.get_child(n),h=i.get_child(o),l=i.numeric_value(s),u=i.numeric_value(a)*-1,c=i.numeric_value(h)*-1,d={graph:e,pos:{x:u,y:c},color:e.colors(e.geoms.length)},p=new gmath.ui.Point(e.geom_g.node(),d);e.geoms.push(p);d={graph:e,point:p,slope:l,color:p.color};var f=new gmath.ui.PSLine(e.geom_g.node(),d);e.geoms.push(f);f.linkToDL(t,s,a,h)};t.prototype.createDLFromGeom=function(t){var e=this.slope,i=this.point.pos.x,r=this.point.pos.y,n=i<=0?"+"+i*-1+"":"-"+i+"",o=r<=0?"+"+r*-1+"":"-"+r+"",s={eq:"y"+o+"="+e+"*(x"+n+")",pos:t,interaction_mode:"inspect"},a=this.graph.view.createDL(s),h=a.getLastModel(),l=[0,2,0,1],u=[0,2,1,1,1,1,1],c=[0,0,1,1],d=h.get_child(l),p=h.get_child(u),f=h.get_child(c);this.linkToDL(a,d,p,f)};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point.id).attr("id",this.id).classed("PSLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.point.line=this;return this.update()};t.prototype.setPoint=function(t,e){this.point.setPos(t);this.update(e);this.events.point(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.point.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){var i=t-this.graph.x_range(this.point.pos.x),r=-e- -this.graph.y_range(this.point.pos.y);if(i!==0)this.setSlope(r/i)};t.prototype.release=function(){this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point.pos.x),r=-this.graph.y_range(this.point.pos.y),n=this.graph.x_range(this.point.pos.x)+1,o=-this.graph.y_range(this.point.pos.y)+this.slope;return st(i,r,n,o,t,-e)};t.prototype.remove=function(){this.element.remove();if(this.point.line.id===this.id)this.point.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,d3.event));this.point.remove();this.element.remove();return[this.point.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.tween=function(t){var e=t||this.element,i=this.slope0,r=this.slope,n=this.graph.x_range,o=this.graph.y_range,s=this.point.pos.x,a=this.point.pos.y,h=n.domain()[0],l=n.domain()[1],u=o.domain()[0],c=o.domain()[1],d=this;return function(t){var p=i+t*(r-i),f=ot(s,a,s+1,a+p,h,l,u,c);e.attr({x1:n(f[0].x),y1:o(f[0].y),x2:n(f[1].x),y2:o(f[1].y)});d.slope0=p}};return t}();function ot(t,e,i,r,n,o,s,a){var h={x:t,y:e},l={x:i,y:r},u=[h,l],c=h.y<l.y?[s,a]:[a,s],d=h.x<l.x?[n,o]:[o,n];if(h.x-l.x===0){return[{x:h.x,y:c[0]},{x:l.x,y:c[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);u.forEach(function(t,e){var i=c[e],r=t.x-(t.y-i)/f;if(r<n||r>o){r=d[e];i=t.y-f*(t.x-r)}p.push({x:r,y:i})});return p}}function st(t,e,i,r,n,o){var s=i-t,a=r-e;return Math.abs(a*n-s*o+i*e-r*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.Link=function(){var t=function(){var t=d3.dispatch(),e=null,i=null,r=null,n=null,o=null,s=null,a=null;var h=function(t,r){e=d3.select(t);i=r;l();return this};h.container=function(t){if(arguments.length===0)return e;e=t;return this};h.model=function(t){if(arguments.length===0)return i;i=t;return this};h.a=function(t){if(arguments.length===0)return r;r=t;return this};h.b=function(t){if(arguments.length===0)return o;o=t;return this};h.update_el=function(){if(!r||!o)return;var t=u(r),e=u(o);t[0]+=r.width/2;t[1]-=r.y;e[0]+=o.width/2;e[1]-=o.y;a.attr("d",function(){var i=Math.random()>.5?1:-1;return"M "+t[0]+" "+t[1]+" "+"Q "+(t[0]+e[0])/2+" "+((t[1]+e[1])/2+Math.random()*300*i)+" "+e[0]+" "+e[1]})};h.show=function(t){a.style("visibility",t?"visible":"hidden")};h.link=function(){var t=r.get_root(),e=o.get_root(),i=gmath.uid(),n=gmath.uid();t.events.on("node-changed."+i,function(i){if(h.a().id===i.node.id){r=i.new_node;e.numeric_value(h.b(),t.numeric_value(h.a()))}});e.events.on("node-changed."+n,function(i){if(h.b().id===i.node.id){o=i.new_node;t.numeric_value(h.a(),e.numeric_value(h.b()))}})};h.unlink=function(){r.get_root().events.on("node-changed."+n,function(){return});o.get_root().events.on("node-changed."+s,function(){return})};var l=function(){a=e.append("path").attr("stroke","orange").attr("stroke-width","4px").attr("stroke-linecap","round").attr("fill","none").style("opacity",.5)};var u=function(t){var e=[0,0];if(t.children.length>0){t.children.forEach(function(t){var i=u(t);e[0]+=i[0];e[1]+=i[1]});e[0]=e[0]/t.children.length;e[1]=e[1]/t.children.length}else{var i=d3.select("#"+t.id);while(i.node().tagName!=="svg"){var r=d3.transform(i.attr("transform"));e[0]+=r.translate[0];e[1]+=r.translate[1];i=d3.select(i.node().parentNode)}}return e};return d3.rebind(h,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.Point=function(){var t=function(t,e){this.events=d3.dispatch("x","y","release","remove");this.container=d3.select(t);this.graph=e.graph;this.id=e.id||gmath.uid();this.element=null;this.pos=e.pos||{x:0,y:0};this.radius=e.radius||4;this.color=e.color||"black";this.type="point";this.intercept=e.intercept||false;this.line=null;this.snap_el=null;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Point",graph:this.graph.id,pos:this.pos,radius:this.radius,color:this.color,intercept:this.intercept}};t.validSourceDL=function(t){var e=t.getLastRow().model.children[0];if(e.is_group("brackets")){e=e.children[1];if(e.is_group("tuple")){var i=e.children[0],r=e.children[1];if(i.is_group("param")&&r.is_group("param")){i=i.children[1];r=r.children[1];if(n.is_num(i)&&n.is_num(r)){return true}}}}return false;
};t.prototype.linkToDL=function(t,e,i){var r=this,n=t.getLastModel(),o=e,s=i,a=t.rows[0].view;var h=function(t,e){if(t.selected!==e){t.selected=e;a.renderer.set_style([t]);a.update_style(true)}};var l=function(t,e){return function(){return h(t,e)}};var u=gmath.uid();var c=function(t){if(t.old_model!==n)throw"wrong old_model";if(t.new_model!==t.old_model){n.events.on("change."+u,null);n.events.on("end-of-interaction."+u,null);n=t.new_model;n.events.on("change."+u,c);n.events.on("end-of-interaction."+u,d)}o=t.node_map[o.id][0];s=t.node_map[s.id][0];var e=n.numeric_value(o);var i=n.numeric_value(s);if(e!==r.pos.x)r.setPos({x:e,y:r.pos.y});if(i!==r.pos.y)r.setPos({x:r.pos.x,y:i})};var d=function(){r.release()};n.events.on("change."+u,c);n.events.on("end-of-interaction."+u,d);r.events.on("x."+u,function(t){if(t!==n.numeric_value(o)){n.numeric_value(o,t);h(o,true)}}).on("release."+u,function(){h(o,false)});r.events.on("y."+u,function(t){if(t!==n.numeric_value(s)){n.numeric_value(s,t);h(s,true)}}).on("release."+u,function(){h(s,false)})};t.createGeomFromDL=function(t,e){var i=t.getLastRow().model,r=[0,1,0,1],n=[0,1,1,1],o=i.get_child(r),s=i.get_child(n),a=i.numeric_value(o),h=i.numeric_value(s),l={graph:e,pos:{x:a,y:h},color:e.colors(e.geoms.length),intercept:a===0?true:false},u=new gmath.ui.Point(e.geom_g.node(),l);e.geoms.push(u);u.linkToDL(t,o,s)};t.prototype.createDLFromGeom=function(t){var e=this.pos.x,i=this.pos.y,r={eq:"("+e+","+i+")",pos:t,interaction_mode:"inspect"},n=this.graph.view.createDL(r),o=n.getLastModel(),s=[0,1,0,1],a=[0,1,1,1],h=o.get_child(s),l=o.get_child(a);this.linkToDL(n,h,l)};t.prototype.init=function(){this.snap_el=this.container.append("circle").style("opacity",0);this.element=this.container.append("circle").attr("id",this.id);this.update()};t.prototype.setPos=function(t){if(t.x!==this.pos.x)this.events.x(t.x);if(t.y!==this.pos.y)this.events.y(t.y);this.pos=t;this.update();return this};t.prototype.setRadius=function(t){this.radius=t;this.update();return this};t.prototype.setColor=function(t){this.color=t;this.update();return this};t.prototype.select=function(t,e){if(this.intercept){this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)}else this.element.style("fill",t?d3.rgb(this.color).brighter():this.color);if(this.line&&e)this.line.select(t)};t.prototype.showSnap=function(){this.snap_el.style("opacity",.3)};t.prototype.hideSnap=function(){this.snap_el.style("opacity",0)};t.prototype.drag=function(t,e){var i=this.intercept?0:this.graph.x_range.invert(this.graph.x_range(this.pos.x)+t),r=this.graph.y_range.invert(this.graph.y_range(this.pos.y)+e);this.setPos({x:i,y:r})};t.prototype.release=function(){this.events.release()};t.prototype.distanceTo=function(t,e){var i=t-this.graph.x_range(this.pos.x),r=e-this.graph.y_range(this.pos.y),n=Math.sqrt(i*i+r*r);return Math.max(0,n-this.radius)};t.prototype.remove=function(){this.element.remove();return this.id};t.prototype.removeGroup=function(){if(this.line)return this.line.removeGroup();if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,d3.event));this.element.remove();return[this.id]};t.prototype.update=function(){this.snap_el.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius*2).style("fill",this.color);this.element.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius).style("fill",this.intercept?"white":this.color).style("stroke",this.intercept?this.color:"none");if(this.line)this.line.update();return this};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasParser=function(){CanvasParser={};CanvasParser.parse=function(t,e){return JSON.parse(e,function(e,i){if(i&&i.type==="Graph")return CanvasParser.parseGraph(t,i);if(i&&i.type==="DerivationList")return CanvasParser.parseDL(t,i);else return i})};CanvasParser.parseDL=function(t,e){return t.model.createDL(e)};CanvasParser.parseGraph=function(t,e){var i=e.geoms;e.geoms=null;var r=t.model.createGraph(e);i.forEach(function(t){if(t.type==="Point")CanvasParser.parsePoint(r,t);else if(t.type==="SILine")CanvasParser.parseSILine(r,t)})};CanvasParser.parsePoint=function(t,e){e.graph=t;return t.addGeom(e.type,e)};CanvasParser.parseSILine=function(t,e){var i=CanvasParser.parsePoint(t,e.intercept);e.point=i;e.graph=t;var r=t.addGeom(e.type,e);i.line=r;return r};return CanvasParser}();gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=gmath.uid();this.oid=e.oid;this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.line=typeof d3==="undefined"?null:d3.svg.line();t.prototype.init=function(){var t=null;if(this.oid)t="#"+this.oid;this.element=this.container.insert("path",t).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,i=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=i;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,i){i=i||20;var r=[];var n=function(t){var n=e[0][0];var o=e[0][1];var s=0;var h=0;if(t.length===1){if(!a(t[0][0],t[0][1],n,o,i)){r.push(t);return}}var l;while(s<t.length-1){var u=t[s];var p=t[s+1];var f=a(u[0],u[1],n,o,i);var g=a(p[0],p[1],n,o,i);if(f&&g){s++;h=s}else if(f&&!g){var v=c(u[0],u[1],p[0],p[1],n,o,i);if(v){t[s]=v;h=s}else{s++}}else if(!f&&g){var v=c(p[0],p[1],u[0],u[1],n,o,i);if(v){l=t.slice(h,s+1);l.push(v);r.push(l)}s++;h=s}else{var m=d(u[0],u[1],p[0],p[1],n,o,i);if(m){l=t.slice(h,s+1);if(l[l.length-1][0]!==m[0][0]||l[l.length-1][1]!==m[0][1]){l.push(m[0])}if(l.length>1)r.push(l);t[s]=m[1];if(t[s+1]&&t[s+1][0]==m[1][0]&&t[s+1][1]==m[1][1])s++;h=s}else{s++}}}if(h!==s){l=t.slice(h,t.length);if(l){r.push(l)}}};var s=function(t,n){if(t.path){i=i+t.width/2;var t=t.path}var o=e[n];var s=e[n+1];var n=0;var a=0;if(t.length===1){var h=l(t[0][0],t[0][1],o[0],o[1],s[0],s[1],i);if(h.indexOf(1)===-1){r.push(t);return}}var u;while(n<t.length-1){var c=t[n];var d=t[n+1];var h=l(c[0],c[1],o[0],o[1],s[0],s[1],i);var p=l(d[0],d[1],o[0],o[1],s[0],s[1],i);if(h.indexOf(1)!==-1&&p.indexOf(1)!==-1){n++;a=n}else if(h.indexOf(1)!==-1&&p.indexOf(1)===-1){var v=f(c[0],c[1],h,d[0],d[1],o[0],o[1],s[0],s[1],i);if(v){t[n]=v;a=n}else{n++}}else if(h.indexOf(1)===-1&&p.indexOf(1)!==-1){var v=f(d[0],d[1],p,c[0],c[1],o[0],o[1],s[0],s[1],i);if(v){u=t.slice(a,n+1);u.push(v);r.push(u);n++;a=n}else{n++}}else{var m=g(c[0],c[1],d[0],d[1],o[0],o[1],s[0],s[1],i);if(m){u=t.slice(a,n+1);if(u[u.length-1][0]!==m[0][0]||u[u.length-1][1]!==m[0][1]){u.push(m[0])}if(u.length>1)r.push(u);t[n]=m[1];if(t[n+1]&&t[n+1][0]==m[1][0]&&t[n+1][1]==m[1][1])n++;a=n}else{n++}}}if(a!==n){u=t.slice(a,t.length);if(u){r.push(u)}}};e=o({path:e});if(e.length===1){for(var h=0;h<t.length;h++){n(t[h])}t=r}else{for(var u=0;u<e.length-1;u++){for(var h=0;h<t.length;h++){s(t[h],u)}t=r;r=[]}}for(var p=0;p<t.length;p++){for(var v=0;v<t[p].length;v++){t[p][v][0]=Math.round(t[p][v][0]);t[p][v][1]=Math.round(t[p][v][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function i(t){document.write("[");for(var i=0;i<t.length-1;i++){e(t[i]);document.write(",<br />")}e(t[i]);document.write("]")}function r(t,e){if(t.path){var t=t.path}var i="";i+="[";for(var r=0;r<t.length-1;r++){i+="["+t[r][0]+","+t[r][1]+"],"}i+="["+t[r][0]+","+t[r][1]+"]";i+="]";if(e){console.log(i)}else{return i}}function n(t){nt="";nt+="[";for(var e=0;e<t.length-1;e++){nt+=r(t[e],0);nt+=","}nt+=r(t[e],0);nt+="]";console.log(nt)}function o(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function s(t,e,i,r){return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-e,2))}function a(t,e,i,r,n){var o=s(t,e,i,r);if(o<n)return 1;else return 0}function h(t,e,i,r,n,o,s){var a=[n-i,o-r];var h=[t-i,e-r];var l=[-a[1],a[0]];var u=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var c=[l[0]/u,l[1]/u];var d=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var p=[a[0]/d,a[1]/d];var f=h[0]*p[0]+h[1]*p[1];if(f<=0||f>=d)return 0;var g=h[0]*c[0]+h[1]*c[1];if(g>=s||g<=-s)return 0;return 1}function l(t,e,i,r,n,o,s){var l=[];l.push(a(t,e,i,r,s));l.push(a(t,e,n,o,s));l.push(h(t,e,i,r,n,o,s));return l}function u(t,e,i,r,n){var o=[i-t,r-e];var s=[-o[1],o[0]];var a=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var h=[s[0]/a,s[1]/a];var l=[t+n*h[0],e+n*h[1]];var u=[t-n*h[0],e-n*h[1]];var c=[i-n*h[0],r-n*h[1]];var d=[i+n*h[0],r+n*h[1]];return[l,u,c,d]}function c(t,e,i,r,n,o,s){var a=[n-t,o-e];var h=[i-t,r-e];var l=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var u=[h[0]/l,h[1]/l];var c=a[0]*u[0]+a[1]*u[1];var d=[t+c*u[0],e+c*u[1]];var p=Math.sqrt(Math.pow(n-d[0],2)+Math.pow(o-d[1],2));var f;if(p===0){f=s}else{var f=Math.sqrt(Math.pow(s,2)-Math.pow(p,2))}var g=[t+c*u[0]+f*u[0],e+c*u[1]+f*u[1]];if(g[0]===t&&g[1]===e)return null;return g}function d(t,e,i,r,n,o,s){var a=[n-t,o-e];var h=[i-t,r-e];var l=[-h[1],h[0]];var u=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var c=[l[0]/u,l[1]/u];var d=a[0]*c[0]+a[1]*c[1];var p=_([t,e],[i,r],[n,o]);var f=v([p[0]-n,p[1]-o]);if(f>=s)return null;var g=Math.sqrt(Math.pow(s,2)-Math.pow(d,2));var m=[n-d*c[0],o-d*c[1]];var y=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var w=[h[0]/y,h[1]/y];var x=[[m[0]-w[0]*g,m[1]-w[1]*g],[m[0]+w[0]*g,m[1]+w[1]*g]];if(x[0][0]===t&&x[0][1]===e)return null;return x}function p(t,e,i,r,n,o,s,a){var h,l,u,c;h=i-t;l=r-e;u=s-n;c=a-o;var d,p;if(-u*l+h*c===0)return null;d=(-l*(t-n)+h*(e-o))/(-u*l+h*c);p=(u*(e-o)-c*(t-n))/(-u*l+h*c);if(d>=0&&d<=1&&p>=0&&p<=1){var f=t+p*h;var g=e+p*l;return[f,g]}return null}function f(t,e,i,r,n,o,a,h,l,f){var g=u(o,a,h,l,f);var v=[];if(i[0]&&!i[1]){v.push(c(t,e,r,n,o,a,f));v.push(p(t,e,r,n,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,r,n,g[1][0],g[1][1],g[2][0],g[2][1]));var m=d(t,e,r,n,h,l,f);if(m)v.push(m[0],m[1])}else if(!i[0]&&i[1]){v.push(c(t,e,r,n,h,l,f));v.push(p(t,e,r,n,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,r,n,g[1][0],g[1][1],g[2][0],g[2][1]));var m=d(t,e,r,n,o,a,f);if(m)v.push(m[0],m[1])}else if(i[0]&&i[1]){v.push(c(t,e,r,n,o,a,f));v.push(p(t,e,r,n,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,r,n,g[1][0],g[1][1],g[2][0],g[2][1]));v.push(c(t,e,r,n,h,l,f))}else{var m=d(t,e,r,n,h,l,f);var _=d(t,e,r,n,o,a,f);if(m)v.push(m[0],m[1]);if(_)v.push(_[0],_[1]);v.push(p(t,e,r,n,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,r,n,g[1][0],g[1][1],g[2][0],g[2][1]))}var y=[t,e];for(var w=0;w<v.length;w++){if(v[w]){if(s(v[w][0],v[w][1],r,n)<s(y[0],y[1],r,n)){y=v[w]}}}if(y[0]===t&&y[1]===e)return null;return y}function g(t,e,i,r,n,o,a,h,l){var c=u(n,o,a,h,l);var f=[];var g=d(t,e,i,r,n,o,l);if(g)f.push(g[0],g[1]);g=d(t,e,i,r,a,h,l);if(g)f.push(g[0],g[1]);f.push(p(t,e,i,r,c[0][0],c[0][1],c[3][0],c[3][1]));f.push(p(t,e,i,r,c[1][0],c[1][1],c[2][0],c[2][1]));var v=[i,r];var m=[t,e];for(var _=0;_<f.length;_++){if(f[_]){if(s(f[_][0],f[_][1],t,e)<s(v[0],v[1],t,e)){v=f[_]}}}for(var y=0;y<f.length;y++){if(f[y]){if(s(f[y][0],f[y][1],i,r)<s(m[0],m[1],i,r)){m=f[y]}}}if(v[0]===i&&v[1]===r||m[0]===t&&m[1]===e)return null;else return[v,m]}var v=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var m=1e-6;var _=function(t,e,i){var r=[e[0]-t[0],e[1]-t[1]],n=v(r);if(n<m)return t;var o=[i[0]-t[0],i[1]-t[1]];var s=(r[0]*o[0]+r[1]*o[1])/n;if(s<0)return t;if(s>n)return e;return[t[0]+r[0]*s/n,t[1]+r[1]*s/n]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,i){url="http://dlandy.psych.indiana.edu:7031/server.js";var r={components:e.map(t),resultTypes:["LATEX"]};var n={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(r)};var o=$.post(url,n.equationInput);o.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);i(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var t=function(t,e,i){this.container=t;this.controller=e;this.view=i;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};t.prototype.setPos=function(t){this.pos=t;this.element.attr("transform","translate("+t[0]+","+t[1]+")")};t.prototype.setVisible=function(t){this.visible=t;this.element.style("display",t?null:"none")};t.prototype.init=function(){var t=this,e={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};this.buttons.push({action:function(e){t.controller.inputDL(e)},icon:function(t){var e=t.append("g").attr("transform","translate(0,10)").append("g");var r=new i("f_x",{});var n=new U(r,e,{font_size:"35",inactive_color:"black",interactive:false});n.init();return e},color:t.colors(0)});this.buttons.push({action:function(e){var i={pos:{x:e[0],y:e[1]}};t.view.createGraph(i,t.view)},icon:function(t){var i=t.append("g").attr("transform","translate(2,0)");var r=i.append("g").style("opacity",.5).style("shape-rendering","crispedges");r.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(e);r.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(e);r.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(e);i.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(e).style("stroke-width",1.5);return i},color:t.colors(1)});this.button_rads=Math.PI*2/this.buttons.length;var r=this.button_rads,n=this.inner_radius,o=this.outer_radius;this.element=this.container.append("g");this.button_els=this.element.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(t,e){var i=Math.cos(r*e)*n,s=-Math.sin(r*e)*n,a=Math.cos(r*e)*o,h=-Math.sin(r*e)*o,l=Math.cos(r*(e+1))*o,u=-Math.sin(r*(e+1))*o,c=Math.cos(r*(e+1))*n,d=-Math.sin(r*(e+1))*n;return"M"+i+","+s+"L"+a+","+h+"A"+o+","+o+" 0 0,0 "+l+","+u+"L"+c+","+d+"A"+n+","+n+" 0 0,1 "+i+","+s+"Z"}).style("fill",function(t){return t.color}).style("opacity",.8);this.button_els.each(function(t,e){var i=d3.select(this),s=t.icon(i);s.attr("transform",function(){var t=Math.cos(r*(e+.5))*(n+(o-n)/2),i=-Math.sin(r*(e+.5))*(n+(o-n)/2);return"translate("+t+", "+i+")"})})};t.prototype.detectHit=function(t){var e=this,i=this.button_rads,r=this.inner_radius,n=this.outer_radius,o=-1;this.button_els.each(function(s,a){var h=Math.sqrt(Math.pow(t[0]-e.pos[0],2)+Math.pow(t[1]-e.pos[1],2)),l=Math.atan2(-t[1]+e.pos[1],t[0]-e.pos[0]);if(l<0)l+=Math.PI*2;if(h>r&&h<n&&l>i*a&&l<i*(a+1))o=a});return o};t.prototype.highlight=function(t){var e=this.detectHit(t);this.button_els.each(function(t,i){var r=d3.select(this).select("path");if(e===i)r.transition().duration(30).style("fill",d3.rgb(t.color).brighter(.6));else r.transition().duration(30).style("fill",t.color)})};t.prototype.performAction=function(t){var e=this.detectHit(t);this.button_els.each(function(i,r){if(r===e)i.action(t)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){CanvasController=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","entered_term");var i=gmath.uid(),r=t,n=null,o="draw",s=true,a,h=1500,l=null,u=r.paths().length,c=2,d=50,p=null,f="black",g=null,v=0,m=null,_=null,y=false,w=[],x=-1,b=false,A=null,N=null,k=null;function M(t){if(b){b=false;return}x+=1;w[x]=t;w.length=x+1}var T=function(){t.on("create."+i,function(t){if(t.target_type==="dl"){var e=t.target;M({type:"create_dl",dl:e});e.events.on("added_line."+i,function(){if(e.rows.length>1){M({type:"math",dl:e})}})}}).on("mode."+i,function(t){if(t.mode==="link"){k=r.container().append("rect").attr("width","100%").attr("height","100%").style("fill","none").style("pointer-events","all");var e=mtouch_events().frame(k.node()).on("touch",I.bind(this,null)).on("drag",B.bind(this,null)).on("release",R.bind(this,null)).on("hold",F.bind(this,null));k.call(e)}else{if(k){k.remove();k=null}}});A=new gmath.ui.holdUI(r.container(),T,r);A.setVisible(false);g=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});mtouch=mtouch_events().on("touch",I.bind(this,null)).on("drag",B.bind(this,null)).on("release",R.bind(this,null)).on("hold",F.bind(this,null)).hold_max_dist(5).hold_time(500).call(g);if(typeof Keyboard!=="undefined"&&typeof $!=="undefined"){n=Keyboard();n.width(800).position("center").on("done",q).on("cancel",G)()}var e=r.container().insert("rect","#g_graphs").style({fill:"none","pointer-events":"all"}).attr("width","100%").attr("height","100%").call(mtouch);mtouch.frame(e.node());r.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",j);return this};T.id=i;T.model=function(t){if(arguments.length===0)return r;r=t;return this};T.mode=function(t){if(arguments.length===0)return o;if(t==="draw"&&!a)return this;o=t;return this};T.color=function(t){if(arguments.length===0)return f;f=t;return this};T.markerRadius=function(t){if(arguments.length===0)return c;c=t;return this};T.eraserRadius=function(t){if(arguments.length===0)return d;d=t;return this};T.hwr_delay=function(t){if(arguments.length===0)return h;h=t;return this};T.tx_behavior=function(){return g};T.hwr=function(t){if(!arguments.length)return s;if(s===t)return T;s=t;u=r.paths.length;if(!s)T.cancelHWR();return T};T.drawing=function(t){if(!arguments.length)return a;a=t;return this};T.scheduleHWR=function(){if(!l){l=setTimeout(T.performHWR,h);e.start_hwr()}};T.cancelHWR=function(t){if(!t)u=r.paths.length;if(l){clearTimeout(l);l=null;e.stop_hwr()}};T.performHWR=function(){l=null;e.stop_hwr();if(u>r.paths().length-1)return;var t=r.paths().slice(u),i=false,n=[];gm_hwr_request(t,function(e,o){if(e)console.log(e);var s=t[0].points[0];try{i=r.createDL({pos:s,eq:o})}catch(a){return}var h=function(t){try{r.removePath(t);n.push(t)}catch(e){return}};for(var l=0;l<t.length;l++){h(t[l])}u=r.paths().length;if(i&&n.length>0){M({type:"convert",removed_paths:n,added_dl:i})}});u=r.paths().length};T.scroll=function(t){if(arguments.length===0)return v;v=Math.min(0,t);g.transform({translate:[0,v]});r.paths_container().attr("transform","translate(0,"+v+")");r.dls_container().attr("transform","translate(0,"+v+")");e.scroll(v);return this};T.undo=function(){if(x===-1)return;var t=w[x];console.log("undo",t.type);x--;if(t.type==="draw"){r.removePath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){r.addPath(t)});t.added.forEach(function(t){r.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_before;r.updatePath(t.path)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){r.addPath(t)});this.undo()}else if(t.type==="math"){t.undone_row=t.dl.undo();var i=w[x]}else if(t.type==="create_dl"){r.removeDL(t.dl)}e.undone({type:"undone",action:t})};T.redo=function(){if(w.length<=x+1)return;x+=1;var t=w[x];console.log("redo",t.type);if(t.type==="draw"){r.addPath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){r.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_after;r.updatePath(t.path)});t.added.forEach(function(t){r.addPath(t)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){r.removePath(t)})}else if(t.type=="math"){b=true;t.dl.redo(t.undone_row)}else if(t.type=="create_dl"){b=true;r.addDL(t.dl)}e.redone({type:"redone",action:t})};T.font_smaller=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t/1.2>12)this.set_font_size(t/1.2)};T.font_larger=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t*1.2<160)this.set_font_size(t*1.2)};T.set_font_size=function(t){DerivationList.defaultOptions.font_size=t;r.dls().forEach(function(e){e.rows.forEach(function(i){i.view.options.font_size=t;i.view.update_all(true);e.updateHandlePos(i,true)});e.layoutRows()})};var L=function(t){return r.createPath({points:[[t[0],t[1]-v]],color:o==="draw"?f:"white",width:o==="draw"?2*c:2*d})};var D=function(t){this.type="hold";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var S=function(t){this.type="touch";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],pos0:[t.finger.pos0[0],t.finger.pos0[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var E=function(t){this.type="drag";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var P=function(t){this.type="release";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var O=function(t){this.type="enteredTerm";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.eq=t.eq;this.dl_id=t.id;this.options=t};var C=function(t){this.type="enteredGraph";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=t};var F=function(t){var i=t||d3.event;if(!t&&d3.event){e.hold(new D(d3.event))}if(y)return;if(o!=="draw"&&a)return;if(N)return;if(m){T.undo();m=null}A.setPos(i.finger.pos.slice());A.setVisible(true)};T.hold=F;var I=function(t){var i=t||d3.event;if(!t&&d3.event){e.touch(new S(d3.event))}if(r.interactionMode()==="link"){var n=i.finger.pos[0],s=i.finger.pos[1],h=false;r.dls().forEach(function(t){var e=t.pos[0]+t.dims.x,i=e+t.dims.width,r=t.pos[1]+t.dims.y,o=r+t.dims.height;if(n>e&&n<i&&s>r&&s<o)h=true});r.graphs().forEach(function(t){if(t.inBounds(n,s))h=true});if(h){N=r.container().append("g");N.append("line").attr("id","linkline").attr("x1",n).attr("y1",s).attr("x2",n).attr("y2",s).style("stroke","gainsboro").style("stroke-width",5);N.append("circle").attr("id","linkstart").attr("cx",n).attr("cy",s).attr("r",10).style("fill","gainsboro").style("stroke","silver").style("stroke-width",2);N.append("circle").attr("id","linkend").attr("cx",n).attr("cy",s).attr("r",10).style("fill","gainsboro").style("stroke","silver").style("stroke-width",2)}}else{if(r.interactionMode()==="delete")r.interactionMode("transform");else{if(!a)return;if(i.fingers.length>1){y=true;if(m){T.undo();m=null}return}var l=i.finger.pos0.slice();l[1]-=v;T.cancelHWR(true);m=L(i.finger.pos0);if(o==="draw")M({type:"draw",path:m});if(o==="erase"){p=r.paths_container().append("circle").attr({cx:l[0],cy:l[1],r:d}).style({stroke:"silver",fill:"white"})}}}};T.touch=I;var B=function(t){var i=t||d3.event;if(!t&&d3.event){e.drag(new E(d3.event))}if(N){var n=i.finger.pos[0],s=i.finger.pos[1];N.select("#linkline").attr("x2",n).attr("y2",s);N.select("#linkend").attr("cx",n).attr("cy",s)}else{if(A.visible){A.highlight(i.finger.pos.slice())}if(!m||y||!a)return;var h=i.finger.pos.slice();h[1]-=v;m.points.push(h);r.updatePath(m);if(o==="erase")p.attr({cx:h[0],cy:h[1]})}};T.drag=B;var R=function(t){var i=t||d3.event;if(!t&&d3.event){e.release(new P(d3.event))}if(N){var a=N.select("#linkstart").attr("cx"),h=N.select("#linkstart").attr("cy"),l=i.finger.pos[0],u=i.finger.pos[1],c=null,d="canvas",f=null,g="canvas";r.graphs().forEach(function(t){if(t.inBounds(a,h)){c=t.getClosest(a-t.pos.x,h-t.pos.y);if(c)d="geom"}if(t.inBounds(l,u)){f=t;g="graph"}});r.dls().forEach(function(t){var e=t.pos[0]+t.dims.x,i=e+t.dims.width,r=t.pos[1]+t.dims.y,n=r+t.dims.height;if(a>e&&a<i&&h>r&&h<n){c=t;d="dl"}if(l>e&&l<i&&u>r&&u<n){f=t;g="dl"}});if(d==="geom"&&g==="canvas"){c.createDLFromGeom([l,u])}if(d==="dl"&&g==="graph"){if(gmath.ui.SILine.validSourceDL(c)){gmath.ui.SILine.createGeomFromDL(c,f)}if(gmath.ui.PSLine.validSourceDL(c)){gmath.ui.PSLine.createGeomFromDL(c,f)}if(gmath.ui.Point.validSourceDL(c)){gmath.ui.Point.createGeomFromDL(c,f)}}N.remove();N=null}if(y){if(i.fingers.length===0)y=false;return}if(A){A.performAction(i.finger.pos.slice());A.setVisible(false)}if(!m)return;if(o==="draw"){if(s&&(!n||!n.visible()))T.scheduleHWR()}else if(o==="erase"){p.remove();z()}m=null};T.release=R;var z=function(){var t=r.paths().slice(),e=t[t.length-1],i=[],n=[],o=[];t.forEach(function(t,s){if(t===e)return;var a=d+t.width/2;var h=gm_erase_paths([t.points],e.points,a);if(h.length===0){n.push(t);r.removePath(t)}else{o.push({path:t,points_before:t.points.slice(),points_after:h[0].slice()});t.points=h[0];r.updatePath(t);for(var l=1;l<h.length;l++){var u=r.createPath({points:h[l],color:t.color,width:t.width,oid:t.id});i.push(u)}}});r.removePath(e);M({type:"erase",removed:n,modified:o,added:i})};T.inputDL=function(t){if(!n)return;T.cancelHWR(true);_={pos:[t[0],t[1]-v]};n.caption("Please enter a number, equation, or expression.").latex("").visible(true)};var q=function(t){n.visible(false);if(t==="")return;_.eq=t;_.id=gmath.uid();e.entered_term(new O(_));var i;try{i=r.createDL(_)}catch(o){console.log(o)}finally{_=null}};var G=function(){n.visible(false)};function j(){var t=d3.event;t.preventDefault();var e=d3.mouse(svg.node());var i=H(t.dataTransfer)||W(t.dataTransfer);if(!i){console.log("could not parse drop data",data);return}i=i.replace(/\\end{alignat}/g,"");i=i.replace(/\&\\\,/g,"");i=i.replace(/\\\,/g,"");i=i.replace(/\&/g,"");i=i.replace(/\\begin{alignat}{[0-9]*}/g,"");i=i.replace(/\\\;/g,"");i=i.replace(/[.,\s\\]+$/,"");var n=i.split("\\\\");if(i.length===0)return;try{r.createDLs(n,{pos:e,collapsed_mode:n.length>1})}catch(o){console.log("Could not parse equation!",o)}}function H(t){var e=t.getData("text/html");var i=document.createElement("div");var r=d3.select(i).html(e).select("img");return r.size()===1?r.attr("alt"):null}function W(t){return t.getData("text/plain")}return d3.rebind(T,e,"on")};return CanvasController}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){CanvasModelView=function(){var t=d3.dispatch("create","update","remove","reset","mode"),e=[],i=[],r=[],n=[],o=null,s,a,h,l,u=false,c=["transform","inspect","link","delete"],d=0;function p(t){t.dl.draw_mappings_for_nodes([t.node])}var f=function(t){o=t;h=o.append("g").attr("id","g_graphs");a=o.append("g").attr("id","g_paths");s=o.append("g").attr("id","g_dls");l=o.append("g").attr("id","g_links");return this};f.addDL=function(e){if(i.indexOf(e)!==-1)throw"dl is already in this model";e.options.canvas_model=f;e.container(s.node());i.push(e);t.create({type:"create",target_type:"dl",target:e});e.events.on("inspect_node",p);return e};f.createDL=function(e,r){e.canvas_model=f;var n=new DerivationList(s.node(),e,r);i.push(n);t.create({type:"create",target_type:"dl",target:n});n.events.on("inspect_node",p);return n};f.createDLs=function(t,e,i){var r=0;n();function n(o){if(r===t.length){if(i)i()}else{if(o)e.pos[1]+=o.dims.height;var s=gmath.deepCopy(e);s.eq=t[r++];f.createDL(s,n)}}};f.removeDL=function(e){g(i,e);e.remove();t.remove({type:"remove",target_type:"dl",target:e})};f.addPath=function(i){if(e.indexOf(i)!==-1)throw"path is already in this model";i.setContainer(a);i.init();e.push(i);t.create({type:"create",target_type:"path",target:i});return i};f.createPath=function(i){var r=new gmath.ui.Path(a.node(),i);e.push(r);t.create({type:"create",target_type:"path",target:r});return r};f.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};f.removePath=function(i){g(e,i);i.remove();t.remove({type:"remove",target_type:"path",target:i})};f.createGraph=function(e){e.view=f;var i=new gmath.ui.Graph(h.node(),e);r.push(i);t.create({type:"create",target_type:"graph",target:i});return i};f.removeGraph=function(e){g(r,e);e.remove();t.remove({type:"remove",target_type:"graph",target:e})};f.createLink=function(e,i){var r=(new gmath.ui.Link).a(e).b(i);r(l.node(),f);r.link();n.push(r);t.create({type:"create",target_type:"link",target:r});return r};var g=function(t,e){var i=t.indexOf(e);if(i===-1)throw"no element "+e;t.splice(i,1)};f.dls=function(e){if(!arguments.length)return i;for(var r=0;r<i.length;r++)i[r].remove();i=e.slice();for(var r=0;r<i.length;r++){i[r].container(s);i[r].init()}t.reset({target_type:"dl",target:i.slice()})};f.graphs=function(){return r};f.graphs=function(t){if(!arguments.length)return r};f.links=function(){return n};f.getElementsOfType=function(t){if(t==="graph")return r;if(t==="dl")return i;if(t==="link")return n};f.paths=function(i){if(!arguments.length)return e;for(var r=0;r<e.length;r++)e[r].remove();e=i.slice();for(var r=0;r<e.length;r++){e[r].setContainer(a);e[r].init()}t.reset({target_type:"path",target:e.slice()})};f.container=function(){return o};f.dls_container=function(t){if(!arguments.length)return s;s=t;return this};f.paths_container=function(t){if(!arguments.length)return a;a=t;return this};f.graphs_container=function(t){if(!arguments.length)return h;h=t;return this};f.links_container=function(t){if(!arguments.length)return l;l=t;return this};f.size=function(){var t=o.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;var e=t.getBoundingClientRect();return{width:e.width,height:e.height}};f.interactionMode=function(e){if(arguments.length===0)return c[d];d=c.indexOf(e);o.select("rect").style("fill",e==="delete"?"whitesmoke":"none");i.forEach(function(t){t.setInteractionMode(e)});r.forEach(function(t){t.setInteractionMode(e)});t.mode({type:"mode",mode:e});return this};f.switchMode=function(){f.interactionMode(c[++d%c.length]);t.mode({type:"mode",mode:c[d]})};return d3.rebind(f,t,"on")};return CanvasModelView}();gmath.ui=gmath.ui||{};gmath.ui.CanvasFactory=function(){var t=function(e,i){this.container=d3.select(e);this.options=gmath.object.merged(t.defaultOptions,i);this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr);this.init();if(this.options.initialState){gmath.ui.CanvasParser.parse(this,this.options.initialState)}};t.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};t.prototype.init=function(){this.id=gmath.uid();this.tools=this.container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style({"margin-bottom":"10px"});if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.draw_btns)this.appendButtonGroup(this.options.draw_btns,this.onButton);if(this.options.hwr&&this.options.hwr_btn){var t=this.appendButtonGroup([this.options.hwr_btn],this.onButton);this.controller.on("start_hwr",function(){t.classed("btn-info",true)}).on("stop_hwr",function(){t.classed("btn-info",false)})}if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var i=[];i.push(this.options.font_smaller_btn);i.push(this.options.font_larger_btn);this.appendButtonGroup(i,this.onButton);
}if(this.options.fullscreen_btn){this.appendButtonGroup([this.options.fullscreen_btn],this.onButton)}var r=this.tools.node().getBoundingClientRect().height;if(r===0)r={xs:46,sm:64}[this.options.btn_size]||72;this.svg=this.container.append("svg").style("width",this.options.width).style("height","calc("+this.options.height+" - "+(r+10)+"px)").style("display","block").style("overflow","visible");this.svgg=this.svg.append("g");this.svgg.call(this.model).call(this.controller)};t.prototype.onButton=function(t){console.log(t);this.events.button({button:{label:t.label,state:t.state},time:Date.now()});this.updateButton(t);if(t.label==="undo")this.controller.undo();if(t.label==="redo")this.controller.redo();if(t.label==="HWR")this.controller.hwr(t.state);if(t.label==="transform")this.model.interactionMode("transform");if(t.label==="scrub")this.model.interactionMode("inspect");if(t.label==="link")this.model.interactionMode("link");if(t.label==="delete")this.model.interactionMode("delete");if(t.label==="draw")this.controller.mode("draw");if(t.label==="erase")this.controller.mode("erase");if(t.label==="fullscreen"&&t.state===true)this.launchFullScreen();if(t.label==="fullscreen"&&t.state===false)this.cancelFullScreen();if(!(t.label==="HWR"&&t.state===true))this.controller.cancelHWR();if(t.label==="larger")this.controller.font_larger();if(t.label==="smaller")this.controller.font_smaller()};t.prototype.launchFullScreen=function(t){t=t||document.body;if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullscreen)t.webkitRequestFullscreen();else if(t.msRequestFullscreen)t.msRequestFullscreen()};t.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};t.prototype.updateButton=function(t){this.tools.select("button#"+t.label).datum(t).each(function(t){if(t.type==="toggle"){t.state=!t.state;d3.select(this).classed("active",t.state)}else if(t.type==="radio"){var e=this;d3.select(this.parentNode).selectAll("button").each(function(t){t.state=e===this}).classed("active",function(t){return t.state})}})};t.prototype.appendButtonElement=function(t,e){var i=this;var r=t.append("button").attr("id",function(t){return t.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",i.options.btn_size==="xs").classed("btn-sm",i.options.btn_size==="sm").classed("active",function(t){return t.state}).style("min-width","4em");if(e)r.on("click",e.bind(this));if(this.options.display_icons){var n=r.filter(function(t){return t.icon});n.append("i").attr("class",function(t){return t.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("transform",function(t){return t.flip==="x"?"rotateX(180deg)":t.flip==="y"?"rotateY(180deg)":t.flip==="xy"?"rotateZ(180deg)":null});n.append("br")}if(this.options.display_labels){r.append("span").text(function(t){return t.label}).style("color","#555")}};t.prototype.appendButtonGroup=function(t,e){var i=this.tools.append("div").attr({"class":"btn-group",role:t[0].group}).classed("pull-right",t[0].pull_right).selectAll("button").data(t);i.enter().call(this.appendButtonElement.bind(this),e);return i};t.defaultOptions={width:"100%",height:"100%",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-resize-vertical"},{type:"radio",group:"mode",state:false,label:"link",icon:"glyphicon glyphicon-link"},{type:"radio",group:"mode",state:false,label:"delete",icon:"glyphicon glyphicon-trash"}],draw_btns:[{type:"radio",group:"draw",state:true,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"}]};return t}();Main=function(t,e,i){var r=gmath.uid(),n=t||{exclude:[]},o=[{p:"#84BF41",s:"#D0E4B9",t:"silver",q:"white"},{p:"#84BF41",s:"gainsboro",t:"silver",q:"white"},{p:"#D0E4B9",s:"#84BF41",t:"silver",q:"white"}],s=0,a=347,h=20,l,u,c,d,p,f,g,v,m,_,y,w,x,b,A;var N,k;var M;if(typeof e==="undefined"){var T=document.body,L=document.documentElement;k=Math.max(T.scrollHeight,T.offsetHeight,L.clientHeight,L.scrollHeight,L.offsetHeight);k+="px";N=document.body.clientWidth+"px";M=d3.select("body")}else{M=d3.select(e);if(typeof i==="undefined"){N=M[0][0].clientWidth+"px";k=M[0][0].clientHeight+"px"}else{N=i[0];k=i[1]}}var D=function(t){if(n.exclude)return!(n.exclude.indexOf(t)>-1);if(n.include)return n.include.indexOf(t)>-1};A=M.append("svg").attr("width",N).attr("height",k).style("margin-left","auto").style("margin-right","auto").style("display","block").style("overflow","visible");var S=A.node().clientWidth;var E=A.node().clientHeight;M[0][0].parentNode.onresize=function(){};var P=function(){return l.selectTiny()};var O=function(t){var e=t.dls_container().node().getBBox(),i=t.paths_container().node().getBBox(),r=e.height+e.y,n=i.height+i.y;l.selectPage().height=Math.max(r,n);l.sizeTinys()};var C=function(t,e){var i=function(){var i=e.selectAll("#"+t.id);setTimeout(function(){var r=t.svgg.selectAll("#"+t.id);r[0].forEach(function(t){var i=t.cloneNode(true);e.node().appendChild(i)});i.remove()},1e3)};i();t.events.on("change."+this.id,i);t.events.on("line_added."+this.id,i)};b=gmath.ui.CanvasModelView().on("create",function(t){if(!l)return;if(t.target_type=="dl"){C(t.target,P())}else if(t.target_type=="path"){t.target.renderOnto(P())}O(b)}).on("update",function(t){if(!l)return;t.target.renderOnto(P());O(b)}).on("remove",function(t){if(!l)return;P().selectAll("#"+t.target.id).remove()}).on("reset",function(t){if(!l)return;var e=P();if(t.target_type=="dl"){e.selectAll(".derivation-list").remove();t.target.forEach(function(t){C(t,e)})}else if(t.target_type=="path"){e.selectAll("path").remove();t.target.forEach(function(t){t.renderOnto(e)})}});x=gmath.ui.CanvasController(b).on("scroll",function(t){if(!l)return;l.selectPage().transform.translate[1]=t;l.sizeTinys()}).on("start_hwr",function(){if(!_)return;_.animating(true)}).on("stop_hwr",function(){if(!_)return;_.animating(false)});if("drawing"in t)x.drawing(t.drawing);if(D("pages")){l=gmath.ui.Pages(b,o[s]).on("transform",function(t){x.scroll(t.translate[1])}).on("focus",function(){x.cancelHWR()});a+=51}if(D("markers")&&x.drawing()){u=gmath.ui.Markers(o[s]).pos([a,E-75]).on("eraser",function(t){x.mode("erase");x.eraserRadius(t)}).on("marker",function(t,e){x.mode("draw");x.markerRadius(e);x.color(t)}).on("focus",function(){x.cancelHWR()})}if(D("markerssidebar")&&!u){c=gmath.ui.Markerssidebar(o[s]).pos([a,E-75]).on("eraser",function(t){x.mode("erase");x.eraserRadius(t)}).on("marker",function(t,e){x.mode("draw");x.markerRadius(e);x.color(t)}).on("focus",function(){x.cancelHWR()})}if(D("download")&&l){p=gmath.ui.Download(o[s]).pos([S-75,h]).on("download",function(){x.cancelHWR();l.download()});h+=55}if(D("upload")&&l){f=gmath.ui.Upload(o[s]).pos([S-75,h]).on("upload",function(t){l.upload(t)}).on("focus",function(){x.cancelHWR()});h+=55}if(D("undo")){g=gmath.ui.Undo(o[s]).pos([S-75,h]).on("undo",function(t){setTimeout(function(){x.undo()},1)});h+=55}if(D("redo")){v=gmath.ui.Redo(o[s]).pos([S-75,h]).on("redo",function(t){setTimeout(function(){x.redo()},1)});h+=55}if(D("scroll")){m=gmath.ui.Scroll(o[s],x).pos([S-75,h]).on("scroll",function(t){if(l){l.selectPage().transform={translate:[0,t]};l.sizeTinys()}else{x.scroll(t)}}).on("focus",function(){x.cancelHWR()});h+=90}if(D("switchmode")){d=gmath.ui.Switchmode(o[s],x).pos([S-75,h]).on("switchMode",function(t){setTimeout(function(){b.switchMode()},1)});h+=55}if(D("hwr")){_=gmath.ui.HWRUI(o[s]).pos([S-75,E-75]).on("hwr",function(t){x.hwr(t)})}if(D("drawerasetoggle")&&!u){y=gmath.ui.DrawEraseToggle(o[s]).pos([a,603]).on("mode",function(t){x.mode(t)}).on("focus",function(){x.cancelHWR()})}var F=A.append("g");if(b)F.call(b);if(x)F.call(x);if(l)F.call(l);if(u)F.call(u);if(c)F.call(c);if(d)F.call(d);if(p)F.call(p);if(f)F.call(f);if(g)F.call(g);if(v)F.call(v);if(m)F.call(m);if(_)F.call(_);if(y)F.call(y);if(D("creationbox")){w=new CreationBox(F.node(),[20,20],b.dls);w.setCanvasController(x)}if(n.objects){for(var I=0;I<n.objects.length;I++){var B=n.objects[I],R;if(B.type==="dl"){R=b.createDL}else if(B.type==="graph"){R=b.createGraph}else{console.warn("(Main) Unsupported object type requested upon initialization.");break}R(B.options)}}return{svg:A,cmodel:b,ccontroller:x,pages:l,markers:u,markerssidebar:c,switchmode:d,download:p,upload:f,undo:g,redo:v,scroll:m,hwr:_,drawerasetoggle:y,creationbox:w}};Pages=function(t,e){var i=d3.dispatch("transform","focus"),r=null,n=null,o=[1280,720],s=[],a=[],h=95,l=function(t){var e=h/(o[0]-h);if(arguments.length===0){return e}return t*e},u=null,c=null,d=false,p=null,f=null,g=null,v=null;var m=function(t){_(t);return this};m.res=function(t){if(arguments.length===0)return o;o[0]=t[0];o[1]=t[1];return this};m.tWidth=function(t){if(arguments.length===0)return h;h=t;return this};m.download=function(){var t=[],e=u.id;s.forEach(function(e){var i={};i.height=e.height;i.id=e.id;i.paths=e.paths;i.dls=[];e.dls.forEach(function(t){i.dls.push(t.options)});i.transform=e.transform;t.push(i)});var i=new Blob([JSON.stringify({pages:t,tinys:a,cid:u.id})],{type:"application/json"});saveAs(i,"gmath-session.json");s.forEach(function(t){if(t.id===e){A(t)}})};m.upload=function(r){s=r.pages;a=r.tinys;g=f.selectAll(".t_el").data(a);g.exit().remove();g.enter().append("svg").classed("t_el",true).call(x());g.append("rect").attr("fill",e.q);g.append("g").attr("transform"," translate ("+l(-h)+", 0) scale("+l()+")");g.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",h-2).attr("stroke",e.p).attr("stroke-width",2).attr("fill","none").attr("display","none");v=f.selectAll(".t_progress").data(a);v.enter().append("svg").classed("t_progress",true).attr("x",h+1);v.append("rect").classed("bg",true).attr("width",4).attr("fill",e.t);v.append("rect").classed("bar",true).attr("width",4).attr("height",l(o[1])+4).attr("fill",e.p);for(var n=s.length-1;n>-1;n--){u=s[n];c=a[n];t.paths(u.paths);t.dls(u.dls);i.transform(u.transform)}s.forEach(function(t){if(t.id===r.cid){A(t)}});D()};m.selectTiny=function(t){if(arguments.length===0){t=c}return g.filter(function(e){return e.id===t.id}).select("g")};m.selectPage=function(t){if(arguments.length===0){return u}s.forEach(function(e){if(e.id===t.id){return e}})};m.sizeTinys=function(){D()};m.t_sel=function(){return g};function _(t){r=t;r.append("rect").attr("x",0).attr("y",0).attr("width",h+7).attr("height",o[1]).attr("fill",e.s);r.append("rect").attr("x",h+7).attr("y",0).attr("width",1).attr("height",o[1]).attr("fill",e.t);f=r.append("g").attr("transform","translate(1, 0)");var s=mtouch_events().frame(r.node()).on("tap",function(){i.focus();N()});n=r.append("g").attr("transform","translate(1, "+(o[1]-51)+")").call(s);n.append("rect").attr("rx",5).attr("ry",5).attr("width",h+5).attr("height",50).attr("fill",e.q);var a=(h+5)/2;n.append("path").attr("d","M "+a+" 13 L "+a+" 37 M "+(a-12)+" 25 L "+(a+12)+" 25").style("stroke-width",6).style("stroke-linecap","round").style("stroke",e.s);b()}function y(t){return{id:t?t:gmath.uid(),transform:{scale:1,rotate:0,translate:[0,0]},height:o[1],paths:[],dls:[]}}function w(t,e){return{id:t,index:e,y:0,height:l(o[1])}}function x(){return mtouch_events().frame(r.node()).on("tap",function(t){i.focus();k(t)}).on("drag",function(t){i.focus();M(t)}).on("release",function(t){i.focus();T(t)})}function b(){u=y();c=w(u.id,s.length);s.push(u);a.push(c);g=f.selectAll(".t_el").data(a);g.enter().append("svg").classed("t_el",true).call(x());g.append("rect").attr("fill",e.q);g.append("g").attr("transform"," translate ("+l(-h)+", 0) scale("+l()+")");g.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",h-2).attr("stroke",e.p).attr("stroke-width",2).attr("fill","none").attr("display","none");v=f.selectAll(".t_progress").data(a);v.enter().append("svg").classed("t_progress",true).attr("x",h+1);v.append("rect").classed("bg",true).attr("width",4).attr("fill",e.t);v.append("rect").classed("bar",true).attr("width",4).attr("height",l(o[1])+4).attr("fill",e.p);t.paths(u.paths);t.dls(u.dls);i.transform(u.transform);D()}function A(e){u.paths=t.paths();u.dls=t.dls();u=e;t.paths(u.paths);t.dls(u.dls);i.transform(u.transform);a.forEach(function(t){if(t.id===e.id){c=t}})}function N(){b()}function k(t){var e=d3.event.finger.pos;s.forEach(function(i){if(i.id===t.id){e[1]=(e[1]-t.y)/l()-o[1]/2;var r=i.height-o[1];if(e[1]>r)e[1]=r;if(e[1]<0)e[1]=0;i.transform.translate=[0,e[1]*-1];A(i);D()}})}function M(t){if(!d){d=true;L(t);g.sort(function(e,i){return e.id===t.id?1:-1});v.sort(function(e,i){return e.id===t.id?1:-1});s.forEach(function(e){if(e.id===t.id){A(e)}})}t.y+=d3.event.finger.dy;t.y=t.y<-10?-10:t.y;g.filter(function(e){return e.id===t.id}).attr("y",t.y);v.filter(function(e){return e.id===t.id}).attr("y",t.y)}function T(t){if(d){var e=t.index;a.forEach(function(i){var r=i.index;if(t.id!==i.id){var n=i.y+i.height/2;if(r>e&&t.y>=n){i.index=r-1;t.index=r}if(r<e&&t.y<=n){i.index=r+1;t.index=t.index===e?r:t.index}}});a.sort(function(t,e){return t.index-e.index});D();d=false}}function L(t){g.selectAll(".focus").attr("display","none");g.filter(function(e){return e.id===t.id}).select(".focus").attr("height",function(t){return t.height-2}).attr("display","block");v.selectAll(".bar").attr("display","none");v.filter(function(e){return e.id===t.id}).select(".bar").attr("display","block")}function D(){var t=null,e=u.height,i=o[1]-u.transform.translate[1];c.height=l(Math.max(i,e))+l(50);a.forEach(function(e){e.y=t?t.y+t.height+1:1;t=e});g.attr("y",function(t){return t.y}).attr("width",h).attr("height",function(t){return t.height}).select("rect").attr("x",0).attr("y",0).attr("width",h).attr("height",function(t){return t.height}).attr("stroke","none").attr("stroke-width",0);v.attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).select(".bg").attr("height",function(t){return t.height});v.filter(function(t){return t.id===u.id}).select(".bar").attr("y",function(t){return-1*l(u.transform.translate[1])});L(c)}return d3.rebind(m,i,"on")};gmath.ui=gmath.ui||{};gmath.ui.Pages=Pages;Markers=function(t){var e=d3.dispatch("marker","eraser","focus");var i=null,r=0,n=0,o=.75,s=null,a=null,h=["black","red","green","blue",t.s,t.s,t.s],l=0,u=["red","chocolate","orange","gold","yellow","lime","yellowgreen","green","turquoise","blue","navy","purple","fuchsia"],c=200*o,d=c/2,p=70*o,f=15*o,g=6,v=50,m=50,_="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",y="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",w="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",x="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",b=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],A=-1,N=null,k=null,M=null,T=null,L=null,D=null,S=1,E=1;var P=function(t){i=t;O();return this};P.pos=function(t){if(arguments.length==0)return[r,n];r=t[0];n=t[1];if(i)C();return this};P.marker=function(t){if(arguments.length==0)return l;I(t);return this};P.color=function(){return h[l]};P.scale=function(t){if(arguments.length==0)return o;o=t;return this};function O(){var r=mtouch_events().frame(i.node()).on("tap",function(t,i){e.focus();I(i)}).on("hold",function(t,i){e.focus();B(t,i)});var n=mtouch_events().frame(i.node()).on("tap",function(t){e.focus();R(t)});var s=mtouch_events().frame(i.node()).on("drag",function(t){e.focus();z(t)});var a=mtouch_events().frame(i.node()).on("tap",function(t){e.focus();q(t)});N=i.selectAll(".marker_els").data(h);N.enter().append("svg").classed("marker_els",true).call(r);N.append("path").classed("pathhead",true).attr("d",_).attr("transform","scale("+o*.5+")").style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"}).style("stroke-width","6").style("stroke-linejoin","round");N.append("path").classed("pathBody",true).attr("d",y).attr("transform","scale("+o*.5+")").style("fill",t.q).style("stroke",function(t){return t}).style("stroke-width","6").style("stroke-linejoin","round");T=i.append("svg").classed("pallete",true).style("display","none");var l=T.append("g");l.append("path").attr("d","M 0 "+d+" L "+c+" "+d+" L "+d+" "+(c+10)+" L 0 "+d+" Z").style("fill",t.s);l.append("circle").attr("cx",d).attr("cy",d).attr("r",d).style("fill",t.s);var v=T.selectAll(".pallete_els").data(u);v.enter().append("circle").classed("pallete_els",true).attr("cx",function(t,e){return d+Math.cos(2*(e+1)*Math.PI/u.length)*p}).attr("cy",function(t,e){return d+Math.sin(2*(e+1)*Math.PI/u.length)*p}).attr("r",f).style("fill",function(t){return t}).call(n);k=i.append("svg").call(s);scale_bg=k.append("circle").attr("cx",m+3.75+1.25).attr("cy",m+3.75+1.25).attr("r",m+1.875+1.25).attr("transform","scale("+o*.8+")").attr("stroke",t.s).attr("stroke-width",3.75).attr("fill",t.q);scaler=k.append("circle").attr("cx",m+3.75+1.25).attr("cy",m+3.75+1.25).attr("r",g).attr("transform","scale("+o*.8+")").attr("fill",t.s);M=i.append("svg").call(a);M.append("path").attr("transform","scale("+o+")").attr("d",b[0]).attr("fill",t.t);M.append("path").attr("transform","scale("+o+")").attr("d",b[1]).attr("fill",t.s);M.append("path").attr("transform","scale("+o+")").attr("d",b[2]).attr("fill",t.p);C();D=m*o*.8;L=[k.attr("x")*1+D+4,k.attr("y")*1+D+4];I(0)}function C(){N.attr("x",function(t,e){return r+e*o*60}).attr("y",n);k.attr("x",r+h.length*o*60).attr("y",n+o*8-4);M.attr("x",r+h.length*o*60+90).attr("y",n+o*5);T.attr("y",n-c-15)}function F(e){N.select(".pathhead").attr("d",function(t,i){return i===e?w:_}).style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"});N.select(".pathBody").attr("d",function(t,i){return i===e?x:y}).style("stroke",function(t){return t});if(e!==-1)M.select("#eraser").style("fill",h[l]);T.style("display","none");A=-1}var I=function(i){if(i<-1||i>=h.length||h[i]==t.s)return;l=i;F(i);if(i!==-1){scaler.attr("r",g).attr("fill",t.s);scale_bg.attr("fill",t.q);e.marker(h[i],g*.8*S)}};function B(t,e){if(e!==0){var i=N.filter(function(t,i){return i===e}),r=i.attr("x")*1,n=i.node().getBBox().width/2;T.attr("x",r+n-d+o*5).style("display","block");A=e}}function R(t){h[A]=t;N=i.selectAll(".marker_els").data(h);I(A)}function z(t){var i=d3.event.finger.pos,r=Math.sqrt(Math.pow(L[0]-i[0],2)+Math.pow(L[1]-i[1],2)),n=r/D;if(n>1)n=1;if(n<.12)n=.12;if(l>-1){g=D*n/o/.8;e.marker(h[l],g*.8*S)}else{v=D*n/o/.8;e.eraser(v*.8*E)}scaler.attr("r",m*n)}function q(i){I(-1);scaler.attr("r",v).attr("fill",t.q);scale_bg.attr("fill",t.s);e.eraser(v*.8*E)}return d3.rebind(P,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Markers=Markers;Markerssidebar=function(t){var e=d3.dispatch("marker","eraser","focus");var i=null,r=0,n=0,o=1,s=null,a=null,h=["black"],l=0,u=["red","chocolate","orange","gold","yellow","lime","yellowgreen","green","turquoise","blue","navy","purple","fuchsia"],c=200*o,d=c/2,p=70*o,f=15*o,g=6,v=50,m=50,_="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",y="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",w="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",x="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",b=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],A=-1,N=null,k=null,M=null,T=null,L=null,D=null,S=1,E=1;var P=function(t){i=t;O();return this};P.pos=function(t){if(arguments.length==0)return[r,n];r=t[0];n=t[1];if(i)C();return this};P.marker=function(t){if(arguments.length==0)return l;I(t);return this};P.color=function(){return h[l]};P.scale=function(t){if(arguments.length==0)return o;o=t;return this};function O(){var r=mtouch_events().frame(i.node()).on("tap",function(t,i){e.focus();I(i)}).on("hold",function(t,i){e.focus();B(t,i)});var n=mtouch_events().frame(i.node()).on("tap",function(t){e.focus();R(t)});var s=mtouch_events().frame(i.node()).on("drag",function(t){e.focus();z(t)});var a=mtouch_events().frame(i.node()).on("tap",function(t){e.focus();q(t)});N=i.selectAll(".marker_els").data(h);N.enter().append("svg").classed("marker_els",true).call(r);N.append("path").classed("pathhead",true).attr("d",_).attr("transform","scale("+o*.5+")").style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"}).style("stroke-width","6").style("stroke-linejoin","round");N.append("path").classed("pathBody",true).attr("d",y).attr("transform","scale("+o*.5+")").style("fill",t.q).style("stroke",function(t){return t}).style("stroke-width","6").style("stroke-linejoin","round");T=i.append("svg").classed("pallete",true).style("display","none");var l=T.append("g");l.append("path").attr("d","M 0 "+d+" L "+c+" "+d+" L "+d+" "+(c+10)+" L 0 "+d+" Z").style("fill",t.s);l.append("circle").attr("cx",d).attr("cy",d).attr("r",d).style("fill",t.s);var g=T.selectAll(".pallete_els").data(u);g.enter().append("circle").classed("pallete_els",true).attr("cx",function(t,e){return d+Math.cos(2*(e+1)*Math.PI/u.length)*p}).attr("cy",function(t,e){return d+Math.sin(2*(e+1)*Math.PI/u.length)*p}).attr("r",f).style("fill",function(t){return t}).call(n);M=i.append("svg").call(a);M.append("path").attr("d",b[0]).attr("fill",t.t);M.append("path").attr("d",b[1]).attr("fill",t.s);M.append("path").attr("d",b[2]).attr("fill",t.p);C();D=m*o*.8;I(0)}function C(){N.attr("x",function(t,e){return r+e*o*60}).attr("y",n);M.attr("x",r+h.length*o*60).attr("y",n+o*5);T.attr("y",n-c-15)}function F(e){N.select(".pathhead").attr("d",function(t,i){return i===e?w:_}).style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"});N.select(".pathBody").attr("d",function(t,i){return i===e?x:y}).style("stroke",function(t){return t});if(e!==-1)M.select("#eraser").style("fill",h[l]);T.style("display","none");A=-1}var I=function(i){if(i<-1||i>=h.length||h[i]==t.s)return;l=i;F(i);if(i!==-1){e.marker(h[i],g*.3*S)}};function B(t,e){if(e!==0){var i=N.filter(function(t,i){return i===e}),r=i.attr("x")*1,n=i.node().getBBox().width/2;T.attr("x",r+n-d+o*5).style("display","block");A=e}}function R(t){h[A]=t;N=i.selectAll(".marker_els").data(h);I(A)}function z(t){var i=d3.event.finger.pos,r=Math.sqrt(Math.pow(L[0]-i[0],2)+Math.pow(L[1]-i[1],2)),n=r/D;if(n>1)n=1;if(n<.12)n=.12;if(l>-1){g=D*n/o/.8;e.marker(h[l],g*.8*S)}else{v=D*n/o/.8;e.eraser(v*.8*E)}scaler.attr("r",m*n)}function q(t){I(-1);e.eraser(v*.8*E)}return d3.rebind(P,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Markerssidebar=Markerssidebar;Switchmode=function(t){var e=d3.dispatch("switchMode");var i=null,r=null,n=[0,0];var o=function(t){i=t;s();return this};o.pos=function(t){n=t;if(r){r.attr("x",n[0]).attr("y",n[1])}return this};var s=function(){r=i.append("svg").attr("x",n[0]).attr("y",n[1]).attr("id","modeButton").on("click",function(){e.switchMode()});r.append("rect").attr({width:50,height:50,rx:5,ry:5,fill:t.s});r.append("text").attr({x:25,y:25}).style({"text-anchor":"middle",fill:"white"}).text("transform")};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Switchmode=Switchmode;Undo=function(t){var e=d3.dispatch("undo");var i=null,r=null,n=[0,0];var o=function(t){i=t;s();return this};o.pos=function(t){n=t;if(r){r.attr("x",n[0]).attr("y",n[1])}return this};var s=function(){r=i.append("svg").attr("x",n[0]).attr("y",n[1]).on("click",function(){console.log("undo");e.undo()});r.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);r.append("path").attr("d","M 15 50 Q 15 85 50 85 Q 85 85 85 50 Q 85 15 50 15").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none");r.append("path").attr("d","M 50 10 L 50 20 L 40 15 L 50 10 Z").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill",t.q)};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Undo=Undo;Redo=function(t){var e=d3.dispatch("redo");var i=null,r=null,n=[0,0];var o=function(t){i=t;s();return this};o.pos=function(t){n=t;if(r){r.attr("x",n[0]).attr("y",n[1])}return this};var s=function(){r=i.append("svg").attr("x",n[0]).attr("y",n[1]).on("click",function(){e.redo()});r.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);r.append("path").attr("d","M 15 50 Q 15 85 50 85 Q 85 85 85 50 Q 85 15 50 15").attr("transform","translate(50,0)scale(-0.5,0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none");r.append("path").attr("d","M 50 10 L 50 20 L 40 15 L 50 10 Z").attr("transform","translate(50,0)scale(-0.5,0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill",t.q)};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Redo=Redo;Scroll=function(t,e){var i=d3.dispatch("focus","scroll");var r=null,n=null,o=null,s=[0,0],a=false,h=42,l=null,u=false;var c=function(t){r=t;d();return this};c.pos=function(t){s=t;if(n){n.attr("x",s[0]).attr("y",s[1])}return this};var d=function(){var a=mtouch_events().frame(r.node()).on("drag",function(){i.focus();f()}).on("release",g).call(e.tx_behavior());n=r.append("svg").attr("x",s[0]).attr("y",s[1]);n.append("rect").attr("width",50).attr("height",84).attr("fill","none");n.append("rect").attr("x",20).attr("y",2).attr("width",10).attr("height",80).attr("rx",5).attr("ry",5).attr("fill",t.s);o=n.append("circle").attr("cx",25).attr("cy",42).attr("r",15).attr("fill",t.q).attr("stroke",t.s).attr("stroke-width",3).call(a)};var p=function(t,e){return Math.pow(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2),.5)};var f=function(){var t=d3.event.finger.pos.slice();if(p(t,s)>200&&u){g()}else{h=t[1]-s[1];if(h<17)h=17;if(h>67)h=67;o.attr("cy",h)}if(!a){a=true;l=setInterval(function(){var t=42-h,r=e.scroll()+t;if(r>0)r=0;e.scroll(r);i.scroll(r)},20)}};var g=function(){o.attr("cy",42);a=false;clearInterval(l)};return d3.rebind(c,i,"on")};gmath.ui=gmath.ui||{};gmath.ui.Scroll=Scroll;Download=function(t){var e=d3.dispatch("download");var i=null,r=null,n=[0,0];var o=function(t){i=t;s();return this};o.pos=function(t){n=t;if(r){r.attr("x",n[0]).attr("y",n[1])}return this};var s=function(){r=i.append("svg").attr("x",n[0]).attr("y",n[1]).on("click",function(){e.download()});r.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);r.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Download=Download;Upload=function(t){var e=d3.dispatch("upload","focus");var i=null,r=null,n=[0,0];var o=function(t){i=t;s();return this};o.pos=function(t){n=t;if(r){r.attr("x",n[0]).attr("y",n[1])}return this};var s=function(){d3.select("html").append("input").attr("id","upload").attr("type","file").style("display","none");d3.select("#upload").node().addEventListener("change",a);r=i.append("svg").attr("x",n[0]).attr("y",n[1]).on("click",function(){e.focus();h()});r.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);r.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5) rotate(180 50 50)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};var a=function(t){var i=t.target.files[0];if(!i.name.match(/\.json$/)){console.log("Uploading requires a .JSON file.");return}else{var r=new FileReader;r.onload=function(t){return function(t){e.upload(JSON.parse(t.target.result))}}(i);r.readAsText(i)}};var h=function(){d3.select("#upload").node().click()};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Upload=Upload;HWRUI=function(t){var e=d3.dispatch("hwr");var i=null,r=null,n=[0,0],o=true,s=false;var a=function(t){i=t;l();return this};a.pos=function(t){if(!arguments.length)return n;n=t.slice();if(r)r.attr("transform","translate("+n+")");return a};a.animating=function(t){if(!arguments.length)return s;if(s===t)return a;s=t;if(s)r.call(h);else r.interrupt().attr("transform","translate("+n+")").transition();return a};var h=function(t){var e=t.node().getBBox();var i=" "+e.width/2+" "+e.height/2;t.transition().duration(100).attr("transform","translate("+n+")rotate(-5"+i+")").each("end",r);function r(){t.transition().duration(200).attr("transform","translate("+n+")rotate(5"+i+")").transition().duration(200).attr("transform","translate("+n+")rotate(-5"+i+")").each("end",r)}};a.state=function(i){if(!arguments.length)return o;o=i;if(r){r.select("rect").attr("fill",o?t.s:t.t)}e.hwr(o);return a};a.toggle=function(){a.state(!o)};var l=function(){r=i.append("g").attr("transform","translate("+n+")").on("click",a.toggle).style("cursor","pointer");r.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",o?t.s:"silver");r.append("text").text("HWR").attr("x",25).attr("y",30).attr("font-family","arial").attr("text-anchor","middle").attr("fill",t.q)};return d3.rebind(a,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.HWRUI=HWRUI;DrawEraseToggle=function(t){var e=d3.dispatch("mode","focus");var i=null,r=0,n=0,o="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",s="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",a="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",h="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",l=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],u=null,c=null,d=null,p=true;var f=function(t){i=t;g();return this};f.pos=function(t){if(arguments.length==0)return[r,n];r=t[0];n=t[1];if(i)v(p);return this};function g(){var r=mtouch_events().frame(i.node()).on("tap",function(){e.focus();p=!p;_(p)});u=i.append("svg").call(r);u.append("circle").attr("cx",50).attr("cy",50).attr("r",48).style("fill","whitesmoke").style("stroke","silver").style("stroke-width",1);c=u.append("svg");c.append("path").classed("pathhead",true).attr("d",o).style("fill","black").style("stroke","black").style("stroke-width","6").style("stroke-linejoin","round");c.append("path").classed("pathBody",true).attr("d",s).style("fill",t.q).style("stroke","black").style("stroke-width","6").style("stroke-linejoin","round");d=u.append("svg");d.append("path").attr("d",l[0]).attr("fill",t.t);d.append("path").attr("d",l[1]).attr("fill",t.s);
d.append("path").attr("d",l[2]).attr("fill",t.p);_(p)}var v=function(t){u.attr("x",r).attr("y",n);c.attr("x",t?18:22).attr("y",t?21:30);c.selectAll("path").attr("transform",t?"scale(0.3)":"scale(0.2)");d.attr("x",t?47:42).attr("y",t?33:28);d.selectAll("path").attr("transform",t?"scale(0.4)":"scale(0.5)")};var m=function(t){c.select(".pathhead").attr("d",t?a:o);c.select(".pathBody").attr("d",t?h:s)};var _=function(t){m(t);v(t);if(t){e.mode("draw")}else{e.mode("erase")}};return d3.rebind(f,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.DrawEraseToggle=DrawEraseToggle;Keyboard=function(){var t="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var e="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var i=d3.dispatch("done","cancel","change"),r="",n=false,o,s,a=null,h=null,l=null,u=900,c,d,p,f,g,v,m="center",_=null;var y=function(){b();v=mtouch_events().on("touch",M).on("release",T).on("hold",L).hold_time(750);A();N();if(r!="")o.mathquill("write",r);return this};function w(t){i[t](o.mathquill("latex"))}y.width=function(t){if(arguments.length==0)return u;u=t;if(a)N();return this};y.latex=function(t){if(arguments.length==0){if(o)r=o.mathquill("latex");return r}else{r=t;if(o)o.mathquill("latex",t);return this}};y.visible=function(t){if(arguments.length==0)return n;if(n==t)return this;n=t;if(!a)return this;if(n){a.style("display","block");s.focus()}else a.style("display","none");return this};y.position=function(t){if(arguments.length==0)return m;if(m==t)return this;m=t;if(!a)return this;a.call(P,m);return this};y.caption=function(t){if(arguments.length===0)return _;_=t;if(!l)return this;if(!_)l.style("display","none");else{l.text(t);l.style("display",null)}return this};var x=function(){var t=11*130+10*10+2*10+2*10,e=3*110+20+10+2*10+2*10,i=u/t;d=130*i;f=10*i;p=110*i;c=e*i};var b=function(){g=[];g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.formula={type:"formula",col:2,row:0,cols:6};g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"0",type:"key",col:0,row:1});g.push({name:"1",type:"key",col:1,row:1});g.push({name:"2",type:"key",col:2,row:1});g.push({name:"3",type:"key",col:3,row:1});g.push({name:"4",type:"key",col:4,row:1});g.push({name:"+",type:"key",col:5,row:1});g.push({name:"*",type:"key",val:"*",col:6,row:1,dy:"0.3em"});g.push({name:"(",type:"key",col:7,row:1});g.push({name:")",type:"key",col:8,row:1});g.push({name:"n",type:"key",col:9,row:1});g.push({name:"^",type:"key",col:10,row:1});g.push({name:"5",type:"key",col:0,row:2});g.push({name:"6",type:"key",col:1,row:2});g.push({name:"7",type:"key",col:2,row:2});g.push({name:"8",type:"key",col:3,row:2});g.push({name:"9",type:"key",col:4,row:2});g.push({name:"−",type:"key",val:"-",col:5,row:2});g.push({name:"÷",type:"key",val:"/",col:6,row:2});g.push({name:"=",type:"key",col:7,row:2});g.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5})};var A=function(){a=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",n?"block":"none");l=a.append("div").attr("id","caption").style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:"80%",margin:"auto","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:_?null:"none"}).text(_);h=a.append("div").classed("keyboard",true);o=h.append("div").attr("id","formula").datum(g.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");o=$(o.node()).mathquill("editable");s=o.find("textarea");if(n)s.focus();d3.select(s[0]).on("keyup",function(){if(d3.event.keyCode===13)w("done")});k();var t=h.selectAll(".key").data(g).enter().append("div").classed("key",true).call(v);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var N=function(){x();a.call(P,m);h.style("height",c+"px").style("width",u+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":f*1.5+"px "+f*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",f+"px solid #DDD").style("border-radius",f+"px").call(D,f).select("#mq_div").style("border-radius",f+"px").style("width",function(t){return(t.cols||1)*d+((t.cols||1)-1)*f+"px"}).call(E).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",f).style("font-size",p/2+p/10+"px").style("padding-top",3*f-2+"px").style("padding-bottom",2*f+"px").style("border","none").style("min-height",function(t){return(t.rows||1)*p+((t.rows||1)-1)*f-5*f+"px"}).style("width","100%");h.selectAll(".key").call(D).call(S).call(E);h.selectAll(".backspace-key path").attr("d",t).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+d/2+","+p/2+")scale("+.12*f+")");h.selectAll(".arrow-key path").attr("d",e).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(t){var e={left:-90,up:0,right:90,down:180}[t.dir];return"translate("+d/2+","+p/4+")scale("+.05*f+")rotate("+e+")"});h.selectAll(".normal-key span").text(function(t){return t.name}).style("line-height",p+"px").filter(function(t){return t.dy}).style("display","inline-block").style("margin-top",function(t){return t.dy})};var k=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))h.select(".textarea textarea").attr("readonly","readonly")};var M=function(t){d3.select(this).style("background","gray");if(t.type==="formula")return;s.focus();if(t.type==="key"){var e=t.val||t.name;var i=e.charCodeAt(0);s.val(e);s.trigger($.Event("keydown",{which:i}));s.trigger($.Event("keypress",{which:i}));w("change")}else if(t.type==="backspace"){s.trigger($.Event("keydown",{which:8}));w("change")}else if(t.type==="event"){w(t.event)}else if(t.type==="arrow"){var i={left:37,up:38,right:39,down:40}[t.dir];s.trigger($.Event("keydown",{which:i}));w("change")}};var T=function(t){d3.select(this).style("background",t.type=="key"||t.type=="formula"?"white":"silver")};var L=function(t){if(t.type!=="backspace")return;o.mathquill("latex","");s.focus()};var D=function(t,e){e=e||0;t.style("position","absolute").style("left",function(t){return t.col*(d+f)+2*f-e+"px"}).style("bottom",function(t){return(2-t.row)*(p+f)+(t.row==0?f:0)+2*f-e+"px"})};var S=function(t,e,i){e=e||0;i=i||0;t.style("width",function(t){return(t.cols||1)*d+((t.cols||1)-1)*f-2*e+"px"}).style("height",function(t){return(t.rows||1)*p+((t.rows||1)-1)*f-2*i+"px"})};var E=function(t){t.style("border-radius",f+"px").style("font-size",p/2+"px").style("background",function(t){return t.type=="key"||t.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var P=function(t,e){if(e==="center"){t.style("margin-left",-u/2+"px");t.style("left","50%");t.style("right",null)}else if(e==="left"){t.style("margin-left",0);t.style("left",0);t.style("right",null)}else if(e==="right"){t.style("margin-left",0);t.style("left",null);t.style("right",0)}else{t.style("margin-left",-u/2+"px");t.style("left",e);t.style("right",null)}};return d3.rebind(y,i,"on")};tryGMCreate=function(t,e,i,r){var n=e.indexOf("tfrac")!==-1;var o=t.insert("svg",".mwe-math-fallback-png-inline").style("overflow","visible").style({width:i,height:r}),s={font_size:20,h_align:"left",v_align:"top",background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},color:"green",pos:[0,0],id:gmath.uid(),eq:e,standalone:true,no_handles:true,no_history:true,fraction_size_factor:n?.7:1};var a=gmath.uid();var h=new DerivationList(o.node(),s);var l=function(t){var e=t.target;var i=e.getLastView().getBBox();e.svg.style({width:i.width+"px",height:i.height+"px"})};h.events.on("change."+a,l);l({target:h})};GMify=function(t){if(t){var e=d3.select("html").append("div").attr("id","gmbanner").style("width","100%").style("height","99px").style("background-color","rgba(245, 245, 245, 1.0)").style("border-bottom","1px green solid").style("position","absolute").style("top",-100).style("left",0).style("z-index",9999);var i=e.append("center");i.append("img").attr("src","http://graspablemath.com/demos/wiki/minilogo.png").style("margin-top","15px");i.append("p").text("Graspable Math").style("color","green").style("font-family","cambria").style("font-size","36px").style("vertical-align","-16px").style("text-shadow","1px 1px silver").style("display","inline");var r=0;var n=setInterval(function(){r+=2;e.style("top",r-100+"px");if(r===100){clearInterval(n)}},1);var o=setTimeout(function(){r=0;var t=setInterval(function(){r+=1;e.style("top",-r+"px");if(r===100){clearInterval(t)}},2);clearTimeout(o)},4e3)}var s=d3.selectAll("code");s.each(function(){var t=d3.select(this);var e=t.html();console.log(e);try{t.html("");tryGMCreate(t,e,"200px","100px")}catch(i){console.log("caught error:",i);console.log("Could not convert code snippet. Tried:",e);console.log(t.node());console.log("")}});var a=d3.selectAll("img.tex");var h=0;coordinator=new DLCoordinator;a.each(function(){var t=d3.select(this),e=t.attr("alt");var i=e.search(/\\begin|\\det|\\overrightarrow|\\cdots|\\cup|\\mid|\\in|_/);if(i!==-1){console.log("cant parse",e);return}e=e.replace(/\s/g,"");e=e.replace(/\\,|\\$|[,.]|/g,"");var r=e.indexOf("tfrac")!==-1;e=e.replace(/\\tfrac/g,"\\frac");if(this.parentNode.childElementCount>1){$(this).wrap("<div></div>")}try{var n=d3.select(this.parentNode).style("display","inline-block");var o={font_size:20,h_align:"left",v_align:"top",background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},pos:[0,0],color:"green",id:gmath.uid(),eq:e,no_handles:true,no_history:true,fraction_size_factor:r?.7:1};var s=function(t){var e=t.callingDl;var i=e.dims.width+"px";var r=e.dims.height+5+"px";d3.select(e.container().parentNode).style("width",i).style("height",r)};var a=gmath.uid();var h=DerivationList.createStandalone(n.node(),o,function(t){s({callingDl:t})});coordinator.addDL(h);h.getLastModel().events.on("change."+a,function(t){s({callingDl:h})});t.remove()}catch(l){console.log("caught error:",l);console.log("Could not convert img with alt text:",t.attr("alt"),", tried:",e);var u=this.parentNode.childNodes;for(var c=0;c<u.length;c++){if(u[c].nodeName=="svg"){u[c].remove()}}}});return true};wikiSidebar=function(){if(d3.select("#wikiBar").node()==null){DerivationList.defaultOptions.hoverable=true;i();var t;var e=r();n();o();a();l();d3.select("head").append("style").attr("type","text/css").html("#wikiBar button:hover { background-color: #bbb; }"+"#wikiBar button { background-color: #ddd; }");u()}else if(d3.select("#wikiBar").node().clientWidth==0){d3.select("#wikiBar").style("width","20%");h()}else if(d3.select("#wikiBar").node().clientWidth>0){d3.select("#wikiBar").style("width","0px");h()}function i(){d3.select("body").append("span").style({postition:"absolute",visibility:"hidden","font-family":"Crimson Text"}).text("gm");d3.select("body").append("span").style({postition:"absolute",visibility:"hidden","font-family":"Crimson Text Italics"}).text("gm")}function r(){$("body").children().wrapAll("<div id='originalPage'></div>");t=d3.select("#originalPage").node().clientHeight;if(t<window.innerHeight)t=window.innerHeight;var e=d3.select("body").append("div").attr("id","wikiBar").style({width:"20%",height:'contentHeight + "px"',background:"white",position:"absolute",top:"0",right:"0","z-index":"200",display:"block"});return e}function n(){var t=e.append("a").style({position:"fixed",display:"block",top:0,width:"inherit",background:"whitesmoke","text-align":"center","z-index":201,"text-decoration":"none"}).attr({href:"http://graspablemath.com/stable/tutorial/",target:"_blank"});t.append("img").attr("src","http://graspablemath.com/gm-logo@2.png").style({height:"30px",padding:"8px 5px 8px 16px","vertical-align":"-12px"});t.append("span").text("Graspable Math").style({"font-family":"Lato","font-size":"20px","font-weight":"400",color:"#676965",margin:"0",padding:"0","padding-top":"5px"})}function o(){var t=e.append("div").style({position:"fixed",top:"45px",width:"inherit",background:"whitesmoke","padding-bottom":"8px","border-bottom":"1px solid #ccc","text-align":"center","z-index":"201"});t.append("input").attr("type","text").on("keypress",function(){var t=d3.event.which||d3.event.keyCode;if(t!==13)return;s(this.value);this.value=""}).style({width:"calc(100% - 100px)","font-size":"16px","line-height":"1.5em",color:"gray","max-width":"300px"});t.append("button").text("OK").on("click",function(){var e=t.select("input").node();s(e.value);e.value=""}).style({"margin-left":"5px",width:"50px",display:"inline-block","font-size":"16px","line-height":"1.5em","border-radius":"3px",border:"1px solid silver",height:"30px",cursor:"pointer"})}function s(t){if(!t){console.log("could not get data",data);return}math_str=t.replace(/[.,\s\\]+$/,"");if(math_str.length===0)return;try{verticalPos=document.body.scrollTop+120;wm.createDL({eq:math_str,pos:[100,verticalPos]})}catch(e){console.log("could not parse expression because",e)}}function a(){var i=e.append("div").attr("id","resizeDiv").style({position:"absolute",left:"0px",width:"10px",height:t+"px",background:"silver",cursor:"ew-resize","z-index":"200"});var r=d3.behavior.drag().on("drag",function(){var t=d3.mouse(this.parentNode)[0];var i=d3.select("#wikiBar").node().clientWidth;t=Math.max(250,t*-1+i);h();e.style("width",t+"px")});i.call(r)}function h(){var e=document.getElementById("wikiBar").clientWidth;var i=document.body.clientWidth-e;d3.select("#originalPage").style("width",i+"px");if(typeof markers!="undefined")markers.pos([d3.select("#wikiBar").node().clientWidth/2-60,$(window).height()-180+document.body.scrollTop]);t=d3.select("#originalPage").node().clientHeight;if(t<window.innerHeight)t=window.innerHeight;d3.select("#wikiBar").style("height",t+"px");d3.select("#resizeDiv").style("height",t+"px")}function l(){var t=d3.select("#wikiBar").insert("svg").attr("id","hovering").style({overflow:"visible",width:"100px",height:"100px",position:"fixed",left:"0",top:"0","z-index":"200"});t.append("g")}function u(){components=Main({drawing:false},"#wikiBar",["100%","100%"]);components.ccontroller.markerRadius(2);markers=components.markerssidebar;erase=components.erase;svg=components.svg;svg.attr("id","wikiMainSvg").style({position:"absolute","margin-top":"85px","margin-left":"10px",height:"calc(100% - 85px)",width:"calc(100% - 10px)",overflow:"visible"});wm=components.cmodel;coordinator=new DLCoordinator;coordinator.subscribeToCanvasModel(wm);window.onscroll=function(){if(typeof markers!="undefined")markers.pos([d3.select("#wikiBar").node().clientWidth/2-60,$(window).height()-180+document.body.scrollTop])};h()}};gmath.Tree=t;if(typeof module==="object"&&module.exports){module.exports=gmath}else{this.gmath=gmath}})();
